<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>k3sé›†ç¾¤ä½¿ç”¨æœ¬åœ°DNSç¼“å­˜ï¼ˆnode local dnsï¼‰</title>
    <link href="/2025/06/08/k3s-with-nodelocaldns/"/>
    <url>/2025/06/08/k3s-with-nodelocaldns/</url>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>K3sé›†ç¾¤å†…é›†æˆäº†CoreDNSä½œä¸ºkube-dnsï¼Œé»˜è®¤IPä¸º10.43.0.10ã€‚å½“Podçš„dnsç±»å‹ä¸º<code>ClusterFirst</code>&#x2F;<code>ClusterFirstWithHostNet</code>æ—¶ï¼Œåœ¨å®¹å™¨å†…å¯ä»¥é€šè¿‡<code>&lt;serviceå&gt;.&lt;namespaceå&gt;.svc.cluster.local</code>åŸŸåè®¿é—®é›†ç¾¤å†…çš„serviceï¼ˆåé¢å‡ æ®µå¯ä»¥çœç•¥ï¼‰ï¼Œè€Œä¸å†éœ€è¦ä½¿ç”¨cluster ipæˆ–node portã€‚</p><p>ç¬”è€…çš„K3sé›†ç¾¤æœ‰è·¨çœä»½çš„å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡tailscaleè™šæ‹Ÿå±€åŸŸç½‘é€šä¿¡ã€‚tailscaleä½¿ç”¨UDPåè®®ä¼ è¾“æ•°æ®ï¼Œè€Œè¿è¥å•†å¯¹è·¨çœçš„UDPæµé‡å¾€å¾€ä¼šé‡‡å–QoSé™æµç­–ç•¥ã€‚</p><p>ç¬”è€…è§‚å¯Ÿåˆ°çš„ç°è±¡æ˜¯ï¼Œå½“K3sçš„CoreDNSå®ä¾‹éƒ¨ç½²åœ¨çœä»½Aæ—¶ï¼Œé‚£ä¹ˆå¤„äºçœä»½Bçš„éƒ¨åˆ†Podåœ¨è§£æé›†ç¾¤å†…serviceåŸŸåæ—¶ï¼Œå®¹æ˜“å‡ºç°è§£æé€Ÿåº¦æ…¢ã€ç”šè‡³è§£æå¤±è´¥çš„æƒ…å†µï¼Œè¿™ç‚¹å¾ˆæ˜¯è®©ç¬”è€…å¤´ç–¼ã€‚</p><p>å’ŒAIæ¢è®¨æ–¹æ¡ˆåï¼ŒAIæå‡ºå¯ä»¥ä½¿ç”¨K8sçš„<code>NodeLocal DNSCache</code>ï¼ˆä»¥ä¸‹ç®€ç§°localdnsï¼‰æ¥å»ºç«‹æœ¬åœ°DNSç¼“å­˜ï¼Œä¿è¯åŸŸåè§£æçš„ç¨³å®šæ€§ã€‚ä½†é»˜è®¤çš„localdnsé…ç½®å¹¶ä¸å…¼å®¹K3sï¼Œç¬”è€…ç»è¿‡ä¸€ç•ªæ‘¸ç´¢å¾—å‡ºäº†å…¼å®¹k3sé›†ç¾¤çš„localdnsé…ç½®ï¼Œç”¨æœ¬æ–‡ä½œä¸ºè®°å½•ã€‚</p><h1 id="localdnsé…ç½®"><a href="#localdnsé…ç½®" class="headerlink" title="localdnsé…ç½®"></a>localdnsé…ç½®</h1><p>K8sé»˜è®¤çš„localdnsé…ç½®å¯åœ¨<a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml">Github</a>ä¸ŠæŸ¥çœ‹ã€‚å†…å®¹è¾ƒå¤šï¼Œä½†å¯¹äºK3såœºæ™¯æ¥è¯´åªéœ€è¦æœ‰ä¸¤ä¸ªå…³é”®é…ç½®ã€‚</p><h2 id="ConfigMapé…ç½®"><a href="#ConfigMapé…ç½®" class="headerlink" title="ConfigMapé…ç½®"></a>ConfigMapé…ç½®</h2><p>localdnsä½¿ç”¨çš„ä¹Ÿæ˜¯CoreDNSï¼Œæ‰€ä»¥åœ¨ConfigMapé‡Œç¼–å†™Corefileå³å¯ã€‚ä¸»ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>ç›‘å¬169.254.20.10:53ï¼Œå¤„ç†å‘æ¥çš„DNSè¯·æ±‚ï¼Œå¹¶å¼€å¯æ—¥å¿—&#x2F;ç¼“å­˜ç­‰åŠŸèƒ½</li><li>å¦‚æœè¯·æ±‚åŸŸåæ˜¯<code>cluster.local.</code>ç»“å°¾ï¼Œåˆ™è½¬å‘åˆ°K3sè‡ªèº«çš„CoreDNS<code>10.43.0.10</code></li><li>å¦åˆ™å°†è¯·æ±‚è½¬å‘åˆ°å…¬å…±DNS<code>119.29.29.29</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">data:</span><br>    <span class="hljs-attr">Corefile:</span> <span class="hljs-string">&quot;.:53 &#123;\n    bind 169.254.20.10\n\n\tforward cluster.local. 10.43.0.10 &#123;\n        force_tcp\n    &#125;\n    forward . 119.29.29.29\n\n    reload\n    log\n    loop\n    errors\n    cache 30\n    prometheus :9253\n&#125;&quot;</span><br></code></pre></td></tr></table></figure><h2 id="DaemonSeté…ç½®"><a href="#DaemonSeté…ç½®" class="headerlink" title="DaemonSeté…ç½®"></a>DaemonSeté…ç½®</h2><p>è¦åœ¨æ¯å°æœºå™¨ä¸Šéƒ¨ç½²ä¸€ä¸ªlocaldnså®ä¾‹ï¼Œä½¿ç”¨å¦‚ä¸‹DaemonSeté…ç½®å³å¯ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;9253&quot;</span><br>        <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">system-node-critical</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">node-local-dns</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">Default</span>  <span class="hljs-comment"># Don&#x27;t use cluster DNS.</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;CriticalAddonsOnly&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-cache</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/dns/k8s-dns-node-cache:1.26.4</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">25m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">5Mi</span><br>        <span class="hljs-attr">args:</span> [ <span class="hljs-string">&quot;-localip&quot;</span>, <span class="hljs-string">&quot;169.254.20.10&quot;</span>, <span class="hljs-string">&quot;-conf&quot;</span>, <span class="hljs-string">&quot;/etc/Corefile&quot;</span> ]<br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">add:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">NET_ADMIN</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">dns</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">dns-tcp</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9253</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/xtables.lock</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">xtables-lock</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/coredns</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">xtables-lock</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/run/xtables.lock</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">FileOrCreate</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>          <span class="hljs-attr">items:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">Corefile</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">Corefile.base</span><br></code></pre></td></tr></table></figure><h2 id="ç¡®è®¤éƒ¨ç½²çŠ¶æ€"><a href="#ç¡®è®¤éƒ¨ç½²çŠ¶æ€" class="headerlink" title="ç¡®è®¤éƒ¨ç½²çŠ¶æ€"></a>ç¡®è®¤éƒ¨ç½²çŠ¶æ€</h2><p>å¯é€šè¿‡<code>kubectl get pods -n kube-system</code>å‘½ä»¤ç¡®è®¤localdnséƒ¨ç½²çŠ¶æ€</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">NAME                                      READY   STATUS    RESTARTS   AGE<br>...çœç•¥<br><span class="hljs-keyword">node</span><span class="hljs-title">-local-dns-56v44</span>                      <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">45s</span><br><span class="hljs-keyword">node</span><span class="hljs-title">-local-dns-7tnrs</span>                      <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">41s</span><br><span class="hljs-keyword">node</span><span class="hljs-title">-local-dns-j74kr</span>                      <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">45s</span><br><span class="hljs-keyword">node</span><span class="hljs-title">-local-dns-pk9kt</span>                      <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">45s</span><br><span class="hljs-keyword">node</span><span class="hljs-title">-local-dns-vghvz</span>                      <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">45s</span><br></code></pre></td></tr></table></figure><h1 id="K3sé…ç½®"><a href="#K3sé…ç½®" class="headerlink" title="K3sé…ç½®"></a>K3sé…ç½®</h1><p>ä¿®æ”¹æ–‡ä»¶<code>/etc/rancher/k3s/config.yaml</code>ï¼Œåœ¨kubeleté…ç½®ä¸­è®¾ç½®<code>cluster-dns</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kubelet-arg:</span><br>  <span class="hljs-comment"># çœç•¥å…¶å®ƒ   </span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--cluster-dns=169.254.20.10&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯K3sæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo systemctl daemon-reload<br>sudo systemctl restart k3s <span class="hljs-comment"># ä¸»èŠ‚ç‚¹</span><br>sudo systemctl restart k3s-agent <span class="hljs-comment"># ä»èŠ‚ç‚¹</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºçš„Podï¼Œå½“dnsç±»å‹ä¸º<code>ClusterFirst</code>&#x2F;<code>ClusterFirstWithHostNet</code>æ—¶ï¼Œå°±ä¼šä½¿ç”¨æœ¬åœ°çš„localdnsè§£æserviceåŸŸåï¼Œè€Œä¸æ˜¯é»˜è®¤çš„<code>10.43.0.10</code>ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024å¹´åº¦æ€»ç»“</title>
    <link href="/2024/12/30/2024-summary/"/>
    <url>/2024/12/30/2024-summary/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>2024å¹´ï¼Œæˆ‘åœ¨é•¿æ²™åº¦è¿‡äº†å®Œæ•´çš„ä¸€å¹´ã€‚å³å°†28å²çš„å…³å£ï¼Œæˆ‘å›æœ›è¿‡å»çš„ä¸€å¹´ï¼Œå‘ç°è‡ªå·±ä¼¼ä¹æ²¡æ€ä¹ˆå˜ï¼Œä½†å¥½åœ¨æ›´è®¤æ¸…äº†è‡ªå·±ä¸€äº›ã€‚</p><h1 id="1-èº«ä½“å¥åº·"><a href="#1-èº«ä½“å¥åº·" class="headerlink" title="1. èº«ä½“å¥åº·"></a>1. èº«ä½“å¥åº·</h1><p>å¤§æ¦‚ä¼°ç®—ï¼Œä»Šå¹´æˆ‘è¿åŠ¨çš„æ¬¡æ•°è¶…è¿‡äº†100æ¬¡â€”â€”ç›¸æ¯”å»å¹´æ²¡æœ‰å‡ºç°å¤§å¹…åº¦ä¸‹é™ï¼›æˆ‘åœ¨å¥åº·ä¸ŠæŠ•èµ„çš„é‡‘é’±ç›¸æ¯”å»å¹´ä¹Ÿæœ‰å°å¹…ä¸Šæ¶¨ã€‚å¯æƒœçš„æ˜¯æœ€è¿‘æˆ‘çš„èº«ä½“çŠ¶æ€å®åœ¨ç³Ÿç³•ï¼šæ‰“é¼¾åŠ é‡ã€ç¡çœ è´¨é‡å·®ã€è§†åŠ›ä¸‹é™ç­‰ç­‰ã€‚ç°åœ¨å›æƒ³èµ·æ¥ï¼Œæˆ‘çš„æƒ°æ€§æ¸æ¸å äº†ä¸Šé£ï¼šè¿åŠ¨ä¸å†é‚£ä¹ˆè§„å¾‹å’ŒæŠ•å…¥ã€æ‡’äºå»åšçœ¼ç§‘ç­‰å¤æŸ¥ï¼Œç”šè‡³è¿åº”è¯¥è¦æŒ‰æ—¶åƒçš„è¯éƒ½æ²¡é‚£ä¹ˆä¸Šå¿ƒäº†ã€‚å°±åƒä¸€ç›´åœ¨æ¨çŸ³å¤´çš„è¥¿è¥¿å¼—æ–¯ä¸€æ ·ï¼Œå°†èº«ä½“ç»´æŒåœ¨ç›¸å¯¹å¥åº·çš„æƒ…å†µæ˜¯æˆ‘ä¸æ¯«ä¸èƒ½æ‡ˆæ€ çš„äº‹æƒ…ğŸ¥²</p><h1 id="2-ç²¾ç¥ç”Ÿæ´»"><a href="#2-ç²¾ç¥ç”Ÿæ´»" class="headerlink" title="2. ç²¾ç¥ç”Ÿæ´»"></a>2. ç²¾ç¥ç”Ÿæ´»</h1><p>ä»Šå¹´æˆ‘åœ¨è±†ç“£ä¸Šæ ‡è®°çœ‹è¿‡äº†30éƒ¨å½±è§†ä½œå“ã€20æœ¬ä¹¦ï¼Œå‚åŠ äº†çˆ¬å±±ã€è¯»ä¹¦ä¼šã€æ¡Œæ¸¸ã€è§‚å½±ç­‰ç­‰çº¿ä¸‹æ´»åŠ¨ï¼Œå¾ˆé«˜å…´çœ‹åˆ°è‡ªå·±å¯¹è¿™ä¸ªä¸–ç•Œçš„å¥½å¥‡å¿ƒå’Œçƒ­çˆ±è¿˜æ²¡æœ‰å‡é€€ã€‚å¹´ä¸­è‡ªå»ºçš„ä»£ç ä»“åº“æ›´æ˜¯å‚¬åŒ–äº†æˆ‘å¯¹ä»£ç çš„çƒ­çˆ±ï¼ŒåŠå¹´å†…900å¤šæ¬¡æäº¤ï¼Œå¹³å‡æ¯å¤©5æ¬¡ã€‚å½“ç„¶ä»£ä»·æ˜¯æŒ¤å äº†å…¶å®ƒæ´»åŠ¨çš„æ—¶é—´ï¼Œæ¯”å¦‚åŠ¨æ¼«&#x2F;æ¸¸æˆï¼›è€Œä¸”æ²‰è¿·ä»£ç ä¹Ÿæ˜¯é€ æˆè§†åŠ›ä¸‹é™çš„é‡è¦å› ç´ ã€‚ä½†æ€»ä½“è€Œè¨€ï¼Œä»Šå¹´åœ¨è¿™æ–¹é¢è¿‡å¾—æŒºå¼€å¿ƒğŸ˜Š</p><h1 id="3-äººé™…äº¤å¾€"><a href="#3-äººé™…äº¤å¾€" class="headerlink" title="3. äººé™…äº¤å¾€"></a>3. äººé™…äº¤å¾€</h1><p>äººé™…å…³ç³»æ˜¯æˆ‘å»å¹´é€‰æ‹©ä»ä¸Šæµ·å›åˆ°é•¿æ²™çš„é‡è¦å› ç´ ã€‚åœ¨é•¿æ²™çš„è¿™ä¸€å¹´é‡Œï¼Œæˆ‘è·å¾—çš„ä¸œè¥¿å’Œå½“åˆçš„è®¾æƒ³æ¯”è¾ƒæ¥è¿‘ï¼šèƒ½å¾ˆæ–¹ä¾¿è§åˆ°çˆ¶æ¯ã€æ‰¾å¤§å­¦åŒå­¦ç©ï¼›å¿ƒæƒ…æ›´åŠ å®‰å®šï¼›ç”šè‡³è¿˜æœ‰äº†ä¸¤æ®µæ‹çˆ±ç»å†â€”â€”å³ä½¿æ—¶é—´éƒ½ä¸ç®—é•¿ã€‚å½“æˆ‘å†å›è¿‡å¤´å»çœ‹æ—¶ï¼Œæˆ‘æƒ³ä»ä¸­è·å¾—ä»€ä¹ˆã€å…¶åœ¨â€œä»€ä¹ˆæ„æˆäº†æˆ‘â€é‡Œçš„æ¯”ä¾‹ï¼Œå’Œä¹‹å‰çš„è®¾æƒ³ç¨å¾®æœ‰ä¸€äº›å‡ºå…¥ã€‚å¹´åˆæˆ‘è¯»çš„ä¹¦ã€Šå¦‚ä½•é¿å…å­¤ç‹¬ç»ˆè€ã€‹å¯¹æˆ‘å½±å“å¾ˆå¤§ï¼Œç°åœ¨æˆ‘æ²¡é‚£ä¹ˆå®³æ€•â€œå­¤ç‹¬ç»ˆè€â€è¿™å››ä¸ªå­—äº†ğŸ¤¯</p><h1 id="4-èŒä¸šå’Œä¸ªäººæˆå°±"><a href="#4-èŒä¸šå’Œä¸ªäººæˆå°±" class="headerlink" title="4. èŒä¸šå’Œä¸ªäººæˆå°±"></a>4. èŒä¸šå’Œä¸ªäººæˆå°±</h1><p>ä»èŒä¸šå‘å±•çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘åœ¨é•¿æ²™çš„çŠ¶æ€å’Œä¹‹å‰åœ¨ä¸Šæµ·çš„çŠ¶æ€æœ‰æ˜æ˜¾è½å·®ï¼Œä¸ç®¡æ˜¯è–ªèµ„å›æŠ¥ã€ä¸ªäººæˆé•¿ã€è¿˜æ˜¯å‘å±•ç©ºé—´éƒ½æ˜¯å¦‚æ­¤ï¼Œä½†æˆ‘åè€Œèƒ½å¦ç„¶æ¥å—ã€‚ä¸€éƒ¨åˆ†åŸå› æ˜¯ä»Šå¹´å¼€å§‹çš„ç‹¬ç«‹å¼€å‘ä¹‹è·¯å¸¦ç»™äº†æˆ‘å¾ˆå¤šæˆå°±æ„Ÿï¼šæ­£å¼è¿è¥çš„ä¸¤ä¸ªäº’è”ç½‘äº§å“ä¸­ï¼Œå…¶ä¸­ä¸€ä¸ªç•¥æœ‰ç›ˆä½™ï¼Œå¦ä¸€ä¸ªè¾¹é™…æˆæœ¬ä½ä¸”å³å°†å¼€å§‹å•†ä¸šåŒ–ã€‚å¦ä¸€éƒ¨åˆ†åŸå› æ˜¯ã€Šé‡æ–°å®šä¹‰å…¬å¸ã€‹è®©æˆ‘å¼ºçƒˆæ„Ÿå—åˆ°ï¼Œæˆ‘å¯èƒ½å¹¶ä¸æ˜¯é‚£ç§ä¹äºä¸”å–„äºå›¢é˜Ÿåä½œçš„åˆ›æ„ç²¾è‹±ï¼Œå¯»æ‰¾æœ€é€‚åˆè‡ªå·±çš„è·¯æœªå°ä¸å¯ğŸ’ª</p><h1 id="5-é‡‘é’±å’Œè´¢åŠ¡"><a href="#5-é‡‘é’±å’Œè´¢åŠ¡" class="headerlink" title="5. é‡‘é’±å’Œè´¢åŠ¡"></a>5. é‡‘é’±å’Œè´¢åŠ¡</h1><p>å’Œå»å¹´ç›¸æ¯”ï¼Œä»Šå¹´æˆ‘çš„æ”¶å…¥å‡ ä¹è…°æ–©ï¼Œè€Œæ”¯å‡ºåªå‡å°‘äº†25%ï¼Œå¿…é¡»æ‰¿è®¤æˆ‘çš„æ”¯å‡ºé¡¹ç›®é‡Œè¿˜æœ‰ä¸å°‘å¯ä¼˜åŒ–çš„ç©ºé—´ã€‚ä¸‹åŠå¹´æˆ‘è¯»äº†ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹å’Œã€Šé‡‘é’±å¿ƒç†å­¦ã€‹ï¼Œå®ƒä»¬æŒ‡å¼•äº†æˆ‘æœªæ¥çš„è´¢åŠ¡è§„åˆ’ã€‚é‡‘é’±èƒ½ç»™æˆ‘å¸¦æ¥çš„æœ€å¤§ä»·å€¼æ˜¯æ—¶é—´è‡ªç”±ï¼Œè€Œæˆ‘ä»Šå¹´åšçš„è¿™äº›å†³ç­–ï¼ˆå®šæŠ•æŒ‡æ•°åŸºé‡‘ã€è°ƒé«˜æƒç›Šèµ„äº§æ¯”ä¾‹ã€å¢åŠ æ¸¯è‚¡&#x2F;ç¾è‚¡æŠ•èµ„æ¸ é“ï¼‰è®©æˆ‘æœ‰è‡ªä¿¡èƒ½è¶Šæ¥è¶Šæ¥è¿‘è¿™ä¸ªç»“æœã€‚æ¥ä¸‹æ¥é‡è§†å‚¨è“„ã€ä¼˜åŒ–å¼€æ”¯ï¼Œæœªæ¥å‡ å¹´æ…¢æ…¢å˜å¯ŒğŸ¤‘</p><h1 id="å°¾å£°"><a href="#å°¾å£°" class="headerlink" title="å°¾å£°"></a>å°¾å£°</h1><p>ç†æ¸…è¿‡å»ä¸€å¹´è‡ªå·±çš„ç”Ÿæ´»ï¼Œä¹Ÿæ˜¯åœ¨çœ‹æ¸…æœªæ¥é“è·¯çš„æ–¹å‘ã€‚æ„¿çœ‹åˆ°è¿™é‡Œçš„ä½ æ˜å¹´ä¹Ÿèƒ½æœç€è‡ªå·±è®¤å¯çš„æ–¹å‘å‰è¡Œ~</p>]]></content>
    
    
    
    <tags>
      
      <tag>ç”Ÿæ´»</tag>
      
      <tag>æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤§æ¨¡å‹Tools(Function Calling)å®ç”¨æ€§åˆ†æ - ä»¥åª’ä½“ä¿¡æ¯è§£æä¸ºä¾‹</title>
    <link href="/2024/09/21/parcticality-analysis-of-llm-tools/"/>
    <url>/2024/09/21/parcticality-analysis-of-llm-tools/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€èƒŒæ™¯"><a href="#ä¸€ã€èƒŒæ™¯" class="headerlink" title="ä¸€ã€èƒŒæ™¯"></a>ä¸€ã€èƒŒæ™¯</h1><p>ä½œä¸ºä¸€ä¸ªå–œæ¬¢æ”¶é›†å½±è§†èµ„æºçš„äººï¼Œç¬”è€…é¢ä¸´çš„ä¸€ä¸ªä»»åŠ¡æ˜¯ï¼šä»æ–‡ä»¶åä¸­è§£æå‡ºæ ¼å¼åŒ–çš„åª’ä½“ä¿¡æ¯ï¼ˆä¿¡æ¯æºç»Ÿä¸€ä¸º<a href="https://www.themoviedb.org/?language=zh-CN">The Movie Database (TMDB)</a>ï¼‰ï¼Œæ–¹ä¾¿æ•´ç†æ–‡ä»¶ï¼Œå¦‚ï¼š</p><table><thead><tr><th>æ–‡ä»¶å</th><th>æ ¼å¼åŒ–ä¿¡æ¯</th></tr></thead><tbody><tr><td>Young.Woman.and.the.Sea.2024.2160p.DSNP.WEB-DL.H265.HDR.DDP5.1.Atmos-ADWeb.mkv</td><td><code>&#123;&#39;title&#39;: &#39;æ³³è€…ä¹‹å¿ƒ&#39;, &#39;genre&#39;: &#39;movie&#39;, &#39;year&#39;: 2024&#125;</code></td></tr><tr><td>ã€å‹•ç•«ç˜‹ã€‘ç‰©èªç³»åˆ— ç¬¬å¤–å­£ï¼†ç¬¬æ€ªå­£[9][1080P].mp4</td><td><code>&#123;&#39;title&#39;: &#39;ç‰©è¯­ç³»åˆ—&#39;, &#39;genre&#39;: &#39;tv(anime)&#39;, &#39;year&#39;: 2009, &#39;tv_season_num&#39;: 5, &#39;tv_episode&#39;: 9&#125;</code></td></tr></tbody></table><p>é‚£ä¹ˆï¼Œåœ¨ç»™å®šæ–‡ä»¶åçš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼Œä»¥ä¸‹ç®€ç§°å¤§æ¨¡å‹ï¼‰ + TMDB APIæ¥å®Œæˆåª’ä½“ä¿¡æ¯çš„è§£æå·¥ä½œå‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« åº”è¿è€Œç”Ÿã€‚</p><blockquote><p>å½“ç„¶ï¼Œè§£æåª’ä½“ä¿¡æ¯ + æ•´ç†åª’ä½“æ–‡ä»¶ï¼ˆæˆ–è€…è¯´åª’ä½“æ–‡ä»¶åˆ®å‰Šï¼‰ï¼Œå·²ç»æœ‰å¾ˆå¤šç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œå¦‚<code>nas-tools</code>ã€<code>jellyfin</code>ï¼Œç¬”è€…æ›´å¤šæ˜¯æƒ³æ¢ç´¢å¤§æ¨¡å‹çš„å¯èƒ½æ€§ã€‚</p></blockquote><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs erlang"><span class="hljs-string">&quot;å¤ªé•¿ä¸çœ‹&quot;</span>çš„æ€»ç»“ï¼š<br>- qwen-plus-latest <span class="hljs-params">(qwen <span class="hljs-number">2.5</span>)</span> å¼ºäº deepseek-chat <span class="hljs-params">(v2.<span class="hljs-number">5</span>)</span>ï¼Œgpt-4o-mini/gemini-1.<span class="hljs-number">5</span>-flashè½å<br>- Tools<span class="hljs-params">(Function Calling)</span>åœ¨æœºå™¨é—´äº¤äº’ä¸å¥½ç”¨ï¼Œç¬”è€…çš„JSONè°ƒç”¨æ¨¡å¼æ•ˆç‡&amp;æ•ˆæœæ›´ä¼˜ã€‚<br></code></pre></td></tr></table></figure><h1 id="äºŒã€æ–¹æ¡ˆé€‰æ‹©"><a href="#äºŒã€æ–¹æ¡ˆé€‰æ‹©" class="headerlink" title="äºŒã€æ–¹æ¡ˆé€‰æ‹©"></a>äºŒã€æ–¹æ¡ˆé€‰æ‹©</h1><p>ä»<code>æ–‡ä»¶å</code>åˆ°<code>åª’ä½“ä¿¡æ¯</code>ï¼Œå¤§è‡´åˆ†ä¸ºè¿™å‡ æ­¥ï¼š</p><ol><li><p>ä»æ–‡ä»¶åä¸­è§£æå…³é”®å­—ï¼Œå»tmdbæœç´¢ï¼Œè·å¾—æ ‡é¢˜ã€åˆ†ç±»ä¿¡æ¯ï¼›</p></li><li><p>å¦‚æœæ˜¯ç”µè§†å‰§ä¸”æ ‡é¢˜é‡Œæ²¡æœ‰å­£åº¦ç¼–å·ï¼Œåˆ™éœ€è¦å»tmdbæŸ¥è¯¢å­£åº¦ä¿¡æ¯ï¼Œç¡®å®šè¿™æ˜¯ç¬¬å‡ å­£ï¼›</p></li><li><p>å¦‚æœæ˜¯ç”µè§†å‰§ï¼Œè¿˜éœ€è¦ä»æ ‡é¢˜é‡Œè§£æè¿™æ˜¯è¯¥å­£åº¦çš„ç¬¬å‡ é›†ã€‚</p></li></ol><p>æŒ‰è¿™ä¸ªæ€è·¯ï¼Œå¤§æ¦‚æœ‰3ç§è§£å†³æ–¹æ¡ˆï¼š</p><h2 id="1-ä»£ç æ§åˆ¶æµç¨‹"><a href="#1-ä»£ç æ§åˆ¶æµç¨‹" class="headerlink" title="1. ä»£ç æ§åˆ¶æµç¨‹"></a>1. ä»£ç æ§åˆ¶æµç¨‹</h2><p>è°ƒç”¨tmdb apiç­‰æ­¥éª¤ç”±ä»£ç æ§åˆ¶ï¼Œå¤§æ¨¡å‹åªè´Ÿè´£</p><ul><li>ä»æ–‡ä»¶åä¸­è§£æå‡ºæ ‡é¢˜ã€å­£åº¦ä¿¡æ¯ã€é›†æ•°ä¿¡æ¯ï¼›</li><li>å½“tmdbæœå‡ºå¤šä¸ªç»“æœæ—¶ï¼Œé€‰æ‹©æœ€åŒ¹é…çš„ä¸€ä¸ªï¼›</li><li>å½“tmdbæŸ¥è¯¢åˆ°å­£åº¦ä¿¡æ¯åï¼Œé€‰æ‹©æœ€åŒ¹é…çš„ä¸€ä¸ªã€‚</li></ul><p>ä»£ç å¼€å‘é‡è¾ƒå¤§ï¼Œæ²¡æœ‰ç”¨åˆ°å¤§æ¨¡å‹çš„è§„åˆ’èƒ½åŠ›ã€‚ä¸è€ƒè™‘è¯¥æ–¹æ¡ˆã€‚</p><h2 id="2-å®šä¹‰å‡½æ•°-Toolsè°ƒç”¨"><a href="#2-å®šä¹‰å‡½æ•°-Toolsè°ƒç”¨" class="headerlink" title="2. å®šä¹‰å‡½æ•°+Toolsè°ƒç”¨"></a>2. å®šä¹‰å‡½æ•°+Toolsè°ƒç”¨</h2><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›å‡½æ•°ï¼šæœç´¢tmdbçš„å‡½æ•°ã€æŸ¥è¯¢två­£åº¦ä¿¡æ¯çš„å‡½æ•°ï¼Œä¼ å…¥æ–‡ä»¶ååè®©å¤§æ¨¡å‹åˆ¤æ–­éœ€è¦è°ƒç”¨å“ªäº›å‡½æ•°ï¼Œæœ€ç»ˆå¾—åˆ°åª’ä½“ä¿¡æ¯ã€‚</p><p>OpenAIåœ¨2023å¹´6æœˆå‘å¸ƒäº†<a href="https://platform.openai.com/docs/guides/function-calling">Function Calling</a>ï¼Œéšåå„å®¶å¤§æ¨¡å‹å‚å•†å¼€å§‹è·Ÿè¿›ã€‚ç›®å‰è¯¥åŠŸèƒ½é€æ¸æ”¹åä¸º<code>Tools</code>ã€‚ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">tools = [<br>    &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>        <span class="hljs-string">&quot;function&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;get_delivery_date&quot;</span>,<br>            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Get the delivery date for a customer&#x27;s order. Call this whenever you need to know the delivery date, for example when a customer asks &#x27;Where is my package&#x27;&quot;</span>,<br>            <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;object&quot;</span>,<br>                <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;order_id&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                        <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;The customer&#x27;s order ID.&quot;</span>,<br>                    &#125;,<br>                &#125;,<br>                <span class="hljs-string">&quot;required&quot;</span>: [<span class="hljs-string">&quot;order_id&quot;</span>],<br>                <span class="hljs-string">&quot;additionalProperties&quot;</span>: <span class="hljs-literal">False</span>,<br>            &#125;,<br>        &#125;<br>    &#125;<br>]<br><br>messages = [<br>    &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;You are a helpful customer support assistant. Use the supplied tools to assist the user.&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Hi, can you tell me the delivery date for my order?&quot;</span>&#125;<br>]<br><br>response = openai.chat.completions.create(<br>    model=<span class="hljs-string">&quot;gpt-4o&quot;</span>,<br>    messages=messages,<br>    tools=tools,<br>)<br></code></pre></td></tr></table></figure><h2 id="3-å®šä¹‰å‡½æ•°-JSONè°ƒç”¨"><a href="#3-å®šä¹‰å‡½æ•°-JSONè°ƒç”¨" class="headerlink" title="3. å®šä¹‰å‡½æ•°+JSONè°ƒç”¨"></a>3. å®šä¹‰å‡½æ•°+JSONè°ƒç”¨</h2><p>Toolsçš„æ ¸å¿ƒé€»è¾‘æ˜¯å°†å‡½æ•°å£°æ˜&#x2F;å‡½æ•°è°ƒç”¨æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„å­—æ®µæ¥ä¼ é€’ã€‚ä¼˜ç‚¹æ˜¯åœ¨äººæœºå¯¹è¯æ—¶èƒ½éšè—å‡½æ•°è°ƒç”¨çš„ç»†èŠ‚ï¼›ç¼ºç‚¹æ˜¯å¯¹æ¨¡å‹èƒ½åŠ›ï¼ˆæ›´ç›´æ¥åœ°è¯´æ˜¯è®­ç»ƒ&#x2F;å¾®è°ƒçš„æ•°æ®é›†ï¼‰æœ‰æ›´é«˜è¦æ±‚ã€‚ç¬”è€…ä¸»è¦æ˜¯APIåœºæ™¯ï¼Œæ›´å–œæ¬¢å°†å‡½æ•°å£°æ˜&#x2F;å‡½æ•°è°ƒç”¨æ”¾åˆ°messageè®°å½•å†…ï¼Œå¯¹æ¨¡å‹å…¼å®¹æ€§æ›´å¥½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">functions = &#123;<br>    <span class="hljs-string">&quot;tmdb_search&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;keyword&quot;</span>: <span class="hljs-string">&quot;string, tmdb search keyword, not include year&quot;</span>,<br>    &#125;,<br>    <span class="hljs-string">&quot;tv_season_info&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;tmdb_id&quot;</span>: <span class="hljs-string">&quot;int, tmdb tv id&quot;</span>,<br>    &#125;,<br>    <span class="hljs-string">&quot;done&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;string, media title&quot;</span>,<br>        <span class="hljs-string">&quot;genre&quot;</span>: <span class="hljs-string">&quot;string, media genre&quot;</span>,<br>        <span class="hljs-string">&quot;year&quot;</span>: <span class="hljs-string">&quot;int, media year&quot;</span>,<br>        <span class="hljs-string">&quot;tv_season_num&quot;</span>: <span class="hljs-string">&quot;int, tv season number&quot;</span>,<br>        <span class="hljs-string">&quot;tv_episode&quot;</span>: <span class="hljs-string">&quot;int, tv episode number&quot;</span>,<br>    &#125;,<br>&#125;<br>payload = &#123;<br>    <span class="hljs-string">&quot;model&quot;</span>: llm_model,<br>    <span class="hljs-string">&quot;messages&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&#x27;ä½ æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨å™¨ï¼Œæ“…é•¿åŸºäºä¸Šä¸‹æ–‡ï¼Œè¿”å›JSONæ ¼å¼çš„è°ƒç”¨ä¿¡æ¯ï¼š`&#123;&quot;function&quot;:&quot;xxx&quot;,&quot;arguments&quot;:&#123;&quot;key&quot;: &quot;value&quot;&#125;&#125;`ã€‚&#x27;</span><br>            + <span class="hljs-string">&quot;æˆ‘ä¼šæä¾›ä¸€ä¸ªæ–‡ä»¶åï¼Œä½ çš„ç›®æ ‡æ˜¯è·å–åª’ä½“æ–‡ä»¶çš„title, genre, year, tv_season_num, tv_episodeï¼Œå¹¶è°ƒç”¨doneå‡½æ•°ã€‚ä½ å¯ä»¥è°ƒç”¨tmdb_searchå’Œtv_season_infoå‡½æ•°æ¥è·å–tmdbä¿¡æ¯ã€‚&quot;</span>,<br>        &#125;,<br>        &#123;<br>            <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>            <span class="hljs-string">&quot;content&quot;</span>: json.dumps(functions, ensure_ascii=<span class="hljs-literal">False</span>),<br>        &#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: filename&#125;,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€ä»£ç "><a href="#ä¸‰ã€ä»£ç " class="headerlink" title="ä¸‰ã€ä»£ç "></a>ä¸‰ã€ä»£ç </h1><h2 id="1-å®šä¹‰å‡½æ•°"><a href="#1-å®šä¹‰å‡½æ•°" class="headerlink" title="1. å®šä¹‰å‡½æ•°"></a>1. å®šä¹‰å‡½æ•°</h2><p>é¦–å…ˆå®šä¹‰ä¸¤ä¸ªå‡½æ•°ï¼šæœç´¢tmdbã€æŸ¥è¯¢å­£åº¦ä¿¡æ¯ã€‚å‡½æ•°éƒ½å¾ˆç®€å•ï¼Œè°ƒç”¨tmdb API + å°†APIè¿”å›å€¼è½¬æˆæƒ³è¦çš„æ ¼å¼ã€‚</p><p>æ³¨æ„ç‚¹ï¼šç”±äºtmdbçš„search apiï¼Œå…³é”®å­—å‚æ•°ä¸æ”¯æŒä¼ å…¥å¹´ä»½ï¼Œæ‰€ä»¥åœ¨å°†å‡½æ•°å®šä¹‰ä¼ ç»™å¤§æ¨¡å‹æ—¶éœ€è¦å¼ºè°ƒè¿™ä¸€ç‚¹ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python">tmdb_api_key = os.environ[<span class="hljs-string">&quot;tmdb_api_key&quot;</span>]<br>tmdb_hds = &#123;<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer &quot;</span> + tmdb_api_key,<br>&#125;<br>session = requests_cache.CachedSession()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tmdb_search</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    url = <span class="hljs-string">&quot;https://api.themoviedb.org/3/search/multi&quot;</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;query&quot;</span>: keyword,<br>        <span class="hljs-string">&quot;include_adult&quot;</span>: <span class="hljs-literal">True</span>,<br>        <span class="hljs-string">&quot;language&quot;</span>: <span class="hljs-string">&quot;zh&quot;</span>,<br>    &#125;<br>    resp = session.get(url, headers=tmdb_hds, params=params, timeout=<span class="hljs-number">10</span>)<br>    resp.raise_for_status()<br>    jr = resp.json()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> jr[<span class="hljs-string">&quot;results&quot;</span>]:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;not found&quot;</span><br><br>    choices = []<br>    <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> jr[<span class="hljs-string">&quot;results&quot;</span>]:<br>        info = []<br>        release_year = res.get(<span class="hljs-string">&quot;release_date&quot;</span>, res.get(<span class="hljs-string">&quot;first_air_date&quot;</span>))[:<span class="hljs-number">4</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> release_year:<br>            <span class="hljs-keyword">continue</span><br>        media_type = res[<span class="hljs-string">&quot;media_type&quot;</span>]<br>        orig_lang = res.get(<span class="hljs-string">&quot;original_language&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>        anime_genre = <span class="hljs-number">16</span><br>        <span class="hljs-keyword">if</span> media_type == <span class="hljs-string">&quot;tv&quot;</span> <span class="hljs-keyword">and</span> orig_lang == <span class="hljs-string">&quot;ja&quot;</span> <span class="hljs-keyword">and</span> anime_genre <span class="hljs-keyword">in</span> res[<span class="hljs-string">&quot;genre_ids&quot;</span>]:<br>            media_type = <span class="hljs-string">&quot;tv(anime)&quot;</span><br>        info.append(<span class="hljs-string">f&#x27;name: <span class="hljs-subst">&#123;res.get(<span class="hljs-string">&quot;name&quot;</span>, res.get(<span class="hljs-string">&quot;title&quot;</span>))&#125;</span>&#x27;</span>)<br>        info.append(<span class="hljs-string">f&quot;year: <span class="hljs-subst">&#123;release_year&#125;</span>&quot;</span>)<br>        info.append(<span class="hljs-string">f&quot;genre: <span class="hljs-subst">&#123;media_type&#125;</span>&quot;</span>)<br>        info.append(<span class="hljs-string">f&quot;id: <span class="hljs-subst">&#123;res[<span class="hljs-string">&#x27;id&#x27;</span>]&#125;</span>&quot;</span>)<br>        info.append(<span class="hljs-string">f&quot;popularity: <span class="hljs-subst">&#123;res[<span class="hljs-string">&#x27;popularity&#x27;</span>]&#125;</span>&quot;</span>)<br>        choices.append(<span class="hljs-string">&quot;\n&quot;</span>.join(info))<br>    choices_text = <span class="hljs-string">&quot;\n\n&quot;</span>.join(choices)<br>    <span class="hljs-keyword">return</span> choices_text<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tv_season_info</span>(<span class="hljs-params">tmdb_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    url = <span class="hljs-string">f&quot;https://api.themoviedb.org/3/tv/<span class="hljs-subst">&#123;tmdb_id&#125;</span>?language=zh&quot;</span><br>    resp = session.get(url, headers=tmdb_hds, timeout=<span class="hljs-number">10</span>)<br>    resp.raise_for_status()<br>    jr = resp.json()<br>    seasons = resp.json()[<span class="hljs-string">&quot;seasons&quot;</span>]<br>    choices = [<span class="hljs-string">f&quot;title: <span class="hljs-subst">&#123;jr[<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>]<br>    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> seasons:<br>        info = []<br>        info.append(<span class="hljs-string">f&quot;tv_season_num: <span class="hljs-subst">&#123;s[<span class="hljs-string">&#x27;season_number&#x27;</span>]&#125;</span>&quot;</span>)<br>        info.append(<span class="hljs-string">f&quot;name: <span class="hljs-subst">&#123;s[<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)<br>        choices.append(<span class="hljs-string">&quot;, &quot;</span>.join(info))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(choices)<br></code></pre></td></tr></table></figure><h2 id="2-Toolsè°ƒç”¨"><a href="#2-Toolsè°ƒç”¨" class="headerlink" title="2. Toolsè°ƒç”¨"></a>2. Toolsè°ƒç”¨</h2><p>Toolsç®—æ˜¯ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼Œç¬”è€…å‚è€ƒDeepseekçš„æ–‡æ¡£ï¼ˆ<a href="https://platform.deepseek.com/api-docs/zh-cn/function_calling/">Function Calling | DeepSeek API Docs</a>ï¼‰ç¼–å†™äº†å¦‚ä¸‹ä»£ç ã€‚è€ƒè™‘åˆ°ç”¨JSONæ ¼å¼è¿”å›ä¼šé™ä½å¤§æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ï¼Œæ‰€ä»¥ç¬”è€…è¿™é‡Œå…ˆç”¨è‡ªç„¶è¯­è¨€å’Œå¤§æ¨¡å‹äº¤äº’ï¼Œæœ‰ç»“æœåå†è°ƒç”¨ä¸€æ¬¡å¤§æ¨¡å‹å°†åª’ä½“ä¿¡æ¯æå–ä¸ºJSONï¼Œç”¨æ¶ˆè€—æ›´å¤štokenæ¢å–å‡†ç¡®ç‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_tools</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>):<br>    token_usage = defaultdict(<span class="hljs-built_in">int</span>)<br>    payload = &#123;<br>        <span class="hljs-string">&quot;model&quot;</span>: llm_model,<br>        <span class="hljs-string">&quot;messages&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªæ•é”çš„åª’ä½“æ–‡ä»¶æ•´ç†å‘˜ï¼Œèƒ½é€šè¿‡æŸ¥è¯¢TMDBæ¥è·å–åª’ä½“æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬åˆ†ç±»ã€æ ‡é¢˜ã€å¹´ä»½ã€två­£åº¦ã€tvé›†æ•°ã€‚&quot;</span>,<br>            &#125;,<br>            &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: filename&#125;,<br>        ],<br>        <span class="hljs-string">&quot;tools&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>                <span class="hljs-string">&quot;function&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;tmdb_search&quot;</span>,<br>                    <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;search media info from TMDB&quot;</span>,<br>                    <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;object&quot;</span>,<br>                        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;search keyword, not include year&quot;</span>,<br>                            &#125;<br>                        &#125;,<br>                        <span class="hljs-string">&quot;required&quot;</span>: [<span class="hljs-string">&quot;keyword&quot;</span>],<br>                    &#125;,<br>                &#125;,<br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>                <span class="hljs-string">&quot;function&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;tv_season_info&quot;</span>,<br>                    <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;get tv season info from TMDB&quot;</span>,<br>                    <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;object&quot;</span>,<br>                        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;tmdb_id&quot;</span>: &#123;<br>                                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;tmdb tv id&quot;</span>,<br>                            &#125;,<br>                        &#125;,<br>                        <span class="hljs-string">&quot;required&quot;</span>: [<span class="hljs-string">&quot;tmdb_id&quot;</span>],<br>                    &#125;,<br>                &#125;,<br>            &#125;,<br>        ],<br>    &#125;<br>    results: t.<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [filename]<br>    <span class="hljs-comment"># results: t.List[str] = []</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        resp = session.post(llm_url, json=payload, timeout=<span class="hljs-number">30</span>)<br>        resp.raise_for_status()<br>        jr = resp.json()<br>        message = jr[<span class="hljs-string">&quot;choices&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;message&quot;</span>]<br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> jr[<span class="hljs-string">&quot;usage&quot;</span>].items():<br>            token_usage[k] += v<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;message&quot;</span>, message)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">&quot;tool_calls&quot;</span>]:<br>            results.append(message[<span class="hljs-string">&quot;content&quot;</span>])<br>            <span class="hljs-keyword">break</span><br>        payload[<span class="hljs-string">&quot;messages&quot;</span>].append(message)<br>        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> message[<span class="hljs-string">&quot;tool_calls&quot;</span>]:<br>            info = tool_call[<span class="hljs-string">&quot;function&quot;</span>]<br>            args = info[<span class="hljs-string">&quot;arguments&quot;</span>]<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(args, <span class="hljs-built_in">str</span>):<br>                args = json.loads(args)<br>            <span class="hljs-keyword">if</span> info[<span class="hljs-string">&quot;name&quot;</span>] == <span class="hljs-string">&quot;tmdb_search&quot;</span>:<br>                res = tmdb_search(**args)<br>            <span class="hljs-keyword">elif</span> info[<span class="hljs-string">&quot;name&quot;</span>] == <span class="hljs-string">&quot;tv_season_info&quot;</span>:<br>                res = tv_season_info(**args)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;unknown function: <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;tool call&quot;</span>, info[<span class="hljs-string">&quot;name&quot;</span>], res)<br>            results.append(res)<br>            payload[<span class="hljs-string">&quot;messages&quot;</span>].append(<br>                &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;tool&quot;</span>, <span class="hljs-string">&quot;tool_call_id&quot;</span>: tool_call[<span class="hljs-string">&quot;id&quot;</span>], <span class="hljs-string">&quot;content&quot;</span>: res&#125;<br>            )<br><br>    payload = &#123;<br>        <span class="hljs-string">&quot;model&quot;</span>: llm_model,<br>        <span class="hljs-string">&quot;messages&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªæ–‡æœ¬è§£æå™¨ï¼Œæ“…é•¿ä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œå¹¶ç”¨JSONæ ¼å¼è¾“å‡ºã€‚ä½ éœ€è¦æå–çš„ä¿¡æ¯ä¸ºï¼štitle(str), genre(str), year(int), tv_season_num(int), tv_episode(int)&quot;</span>,<br>            &#125;,<br>            &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: json.dumps(results, ensure_ascii=<span class="hljs-literal">False</span>)&#125;,<br>        ],<br>    &#125;<br>    resp = session.post(llm_url, json=payload, timeout=<span class="hljs-number">30</span>)<br>    resp.raise_for_status()<br>    jr = resp.json()<br>    resp_text: <span class="hljs-built_in">str</span> = jr[<span class="hljs-string">&quot;choices&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;message&quot;</span>][<span class="hljs-string">&quot;content&quot;</span>]<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> jr[<span class="hljs-string">&quot;usage&quot;</span>].items():<br>        token_usage[k] += v<br><br>    resp_text = resp_text[resp_text.find(<span class="hljs-string">&quot;&#123;&quot;</span>) :]<br>    resp_text = resp_text[: resp_text.rfind(<span class="hljs-string">&quot;&#125;&quot;</span>) + <span class="hljs-number">1</span>]<br>    <span class="hljs-built_in">print</span>(resp_text)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;usage&quot;</span>, token_usage)<br></code></pre></td></tr></table></figure><h2 id="3-JSONè°ƒç”¨"><a href="#3-JSONè°ƒç”¨" class="headerlink" title="3. JSONè°ƒç”¨"></a>3. JSONè°ƒç”¨</h2><p>JSONè°ƒç”¨çš„ç‰ˆæœ¬ç›¸æ¯”Toolsè°ƒç”¨çš„ç‰ˆæœ¬æ›´ç®€æ´ï¼Œä¸»è¦æ˜¯ï¼š</p><ol><li>ä¼ ç»™å¤§æ¨¡å‹çš„å‡½æ•°å®šä¹‰ï¼Œä»ç»“æ„ä¸Šæ¥è¯´æ›´ç®€æ´</li><li>å¤§æ¨¡å‹ç›´æ¥è¿”å›JSONæ ¼å¼çš„å‡½æ•°è°ƒç”¨ï¼Œè§£æèµ·æ¥æ›´ç®€å•</li><li>å¤§æ¨¡å‹å§‹ç»ˆè¾“å‡ºJSONï¼Œä¸éœ€è¦åœ¨ç»“æŸåå†è§£æä¸€æ¬¡ã€‚</li></ol><p>å…³é”®ç‚¹ï¼šå‡½æ•°çš„è¿”å›å€¼åœ¨ä¼ ç»™å¤§æ¨¡å‹ä¹‹å‰ï¼Œæœ€å¥½åŠ ä¸Šå‰ç¼€å¼ºè°ƒæ¥æå‡å‡†ç¡®ç‡ï¼š<code>res = f&quot;è°ƒç”¨&#123;jr[&#39;function&#39;]&#125;çš„è¿”å›å€¼ï¼š\n&#123;res&#125;&quot;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clean_json</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    text = text[text.find(<span class="hljs-string">&quot;&#123;&quot;</span>) :]<br>    text = text[: text.rfind(<span class="hljs-string">&quot;&#125;&quot;</span>) + <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> text<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_fc</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>):<br>    usage = defaultdict(<span class="hljs-built_in">int</span>)<br>    functions = &#123;<br>        <span class="hljs-string">&quot;tmdb_search&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;keyword&quot;</span>: <span class="hljs-string">&quot;string, tmdb search keyword, not include year&quot;</span>,<br>        &#125;,<br>        <span class="hljs-string">&quot;tv_season_info&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;tmdb_id&quot;</span>: <span class="hljs-string">&quot;int, tmdb tv id&quot;</span>,<br>        &#125;,<br>        <span class="hljs-string">&quot;done&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;string, media title&quot;</span>,<br>            <span class="hljs-string">&quot;genre&quot;</span>: <span class="hljs-string">&quot;string, media genre&quot;</span>,<br>            <span class="hljs-string">&quot;year&quot;</span>: <span class="hljs-string">&quot;int, media year&quot;</span>,<br>            <span class="hljs-string">&quot;tv_season_num&quot;</span>: <span class="hljs-string">&quot;int, tv season number&quot;</span>,<br>            <span class="hljs-string">&quot;tv_episode&quot;</span>: <span class="hljs-string">&quot;int, tv episode number&quot;</span>,<br>        &#125;,<br>    &#125;<br>    payload = &#123;<br>        <span class="hljs-string">&quot;model&quot;</span>: llm_model,<br>        <span class="hljs-string">&quot;messages&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&#x27;ä½ æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨å™¨ï¼Œæ“…é•¿åŸºäºä¸Šä¸‹æ–‡ï¼Œè¿”å›JSONæ ¼å¼çš„è°ƒç”¨ä¿¡æ¯ï¼š`&#123;&quot;function&quot;:&quot;xxx&quot;,&quot;arguments&quot;:&#123;&quot;key&quot;: &quot;value&quot;&#125;&#125;`ã€‚&#x27;</span><br>                + <span class="hljs-string">&quot;æˆ‘ä¼šæä¾›ä¸€ä¸ªæ–‡ä»¶åï¼Œä½ çš„ç›®æ ‡æ˜¯è·å–åª’ä½“æ–‡ä»¶çš„title, genre, year, tv_season_num, tv_episodeï¼Œå¹¶è°ƒç”¨doneå‡½æ•°ã€‚ä½ å¯ä»¥è°ƒç”¨tmdb_searchå’Œtv_season_infoå‡½æ•°æ¥è·å–tmdbä¿¡æ¯ã€‚&quot;</span>,<br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: json.dumps(functions, ensure_ascii=<span class="hljs-literal">False</span>),<br>            &#125;,<br>            &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: filename&#125;,<br>        ],<br>    &#125;<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        resp = session.post(llm_url, json=payload, timeout=<span class="hljs-number">30</span>)<br>        resp.raise_for_status()<br>        jr = resp.json()<br>        message = jr[<span class="hljs-string">&quot;choices&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;message&quot;</span>]<br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> jr[<span class="hljs-string">&quot;usage&quot;</span>].items():<br>            usage[k] += v<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;message&quot;</span>, message)<br>        jr = json.loads(get_clean_json(message[<span class="hljs-string">&quot;content&quot;</span>]))<br>        <span class="hljs-keyword">if</span> jr[<span class="hljs-string">&quot;function&quot;</span>] == <span class="hljs-string">&quot;tmdb_search&quot;</span>:<br>            res = tmdb_search(jr[<span class="hljs-string">&quot;arguments&quot;</span>][<span class="hljs-string">&quot;keyword&quot;</span>])<br>        <span class="hljs-keyword">elif</span> jr[<span class="hljs-string">&quot;function&quot;</span>] == <span class="hljs-string">&quot;tv_season_info&quot;</span>:<br>            res = tv_season_info(jr[<span class="hljs-string">&quot;arguments&quot;</span>][<span class="hljs-string">&quot;tmdb_id&quot;</span>])<br>        <span class="hljs-keyword">elif</span> jr[<span class="hljs-string">&quot;function&quot;</span>] == <span class="hljs-string">&quot;done&quot;</span>:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;unknown function: <span class="hljs-subst">&#123;jr[<span class="hljs-string">&#x27;function&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;function call&quot;</span>, jr[<span class="hljs-string">&quot;function&quot;</span>], res)<br>        res = <span class="hljs-string">f&quot;è°ƒç”¨<span class="hljs-subst">&#123;jr[<span class="hljs-string">&#x27;function&#x27;</span>]&#125;</span>çš„è¿”å›å€¼ï¼š\n<span class="hljs-subst">&#123;res&#125;</span>&quot;</span><br>        payload[<span class="hljs-string">&quot;messages&quot;</span>].append(&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: res&#125;)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;failed to get &quot;done&quot; function call&#x27;</span>)<br>        jr = &#123;&#125;<br><br>    <span class="hljs-keyword">if</span> jr:<br>        <span class="hljs-built_in">print</span>(jr[<span class="hljs-string">&quot;arguments&quot;</span>])<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;usage&quot;</span>, usage)<br></code></pre></td></tr></table></figure><h1 id="å››ã€æµ‹è¯•ç»“æœ"><a href="#å››ã€æµ‹è¯•ç»“æœ" class="headerlink" title="å››ã€æµ‹è¯•ç»“æœ"></a>å››ã€æµ‹è¯•ç»“æœ</h1><p>æµ‹è¯•ç›®æ ‡æ˜¯è®©å¤§æ¨¡å‹è¾“å‡ºæ ¼å¼åŒ–çš„åª’ä½“ä¿¡æ¯ï¼š</p><table><thead><tr><th>æ–‡ä»¶å</th><th>æ ¼å¼åŒ–ä¿¡æ¯</th></tr></thead><tbody><tr><td>Young.Woman.and.the.Sea.2024.2160p.DSNP.WEB-DL.H265.HDR.DDP5.1.Atmos-ADWeb.mkv</td><td><code>&#123;&#39;title&#39;: &#39;æ³³è€…ä¹‹å¿ƒ&#39;, &#39;genre&#39;: &#39;movie&#39;, &#39;year&#39;: 2024&#125;</code></td></tr><tr><td>ã€å‹•ç•«ç˜‹ã€‘ç‰©èªç³»åˆ— ç¬¬å¤–å­£ï¼†ç¬¬æ€ªå­£[9][1080P].mp4</td><td><code>&#123;&#39;title&#39;: &#39;ç‰©è¯­ç³»åˆ—&#39;, &#39;genre&#39;: &#39;tv(anime)&#39;, &#39;year&#39;: 2009, &#39;tv_season_num&#39;: 5, &#39;tv_episode&#39;: 9&#125;</code></td></tr></tbody></table><p>ç¬”è€…é€‰ç”¨äº†å››ä¸ªä½ä»·çš„å¤§æ¨¡å‹æ¥æµ‹è¯•ï¼Œæœ€è´µæ˜¯çš„gpt-4o-miniï¼Œè¾“å‡º$0.6&#x2F;1M tokensï¼š</p><ul><li>deepseek-chatçš„api (v2.5 09&#x2F;05æ›´æ–°)ï¼Œä½ä»·+å¼€æº</li><li>qwen-plus-latestçš„api (09&#x2F;19æ›´æ–°)ï¼Œä½ä»·+åŸºäºå¼€æºçš„qwen 2.5 72B</li><li>gpt-4o-miniçš„api (07&#x2F;18æ›´æ–°)ï¼Œä½ä»·+å›½é™…å¤§å‚</li><li>gemini-1.5-flash (04&#x2F;13æ›´æ–°)ï¼Œä½ä»·+å›½é™…å¤§å‚</li></ul><table><thead><tr><th>æ–‡ä»¶å</th><th>æ–¹æ¡ˆ</th><th>æ¨¡å‹</th><th>tokenæ¶ˆè€—</th><th>ç»“æœ</th></tr></thead><tbody><tr><td>Young.Woman.and.the.Sea.2024.2160p.DSNP.WEB-DL.H265.HDR.DDP5.1.Atmos-ADWeb.mkv</td><td>Toolsè°ƒç”¨</td><td>deepseek-chat</td><td>1141</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>qwen-plus-latest</td><td>1481</td><td>éƒ¨åˆ†æˆåŠŸï¼Œæ ‡é¢˜è§£ææˆäº†<code>æ³³è€…ä¹‹å¿ƒ (Young Woman and the Sea)</code></td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>gpt-4o-mini</td><td>747</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>gemini-1.5-flash</td><td>610</td><td>éƒ¨åˆ†æˆåŠŸï¼Œæ ‡é¢˜è§£ææˆäº†<code>Young.Woman.and.the.Sea</code></td></tr><tr><td>ã€å‹•ç•«ç˜‹ã€‘ç‰©èªç³»åˆ— ç¬¬å¤–å­£ï¼†ç¬¬æ€ªå­£[9][1080P].mp4</td><td>Toolsè°ƒç”¨</td><td>deepseek-chat</td><td>2821</td><td>æˆåŠŸï¼Œä½†ä¸ç¨³å®šï¼ˆè¶…æ—¶&#x2F;ç¬¬äºŒè½®æ—¶æ— æ³•è§¦å‘toolsè°ƒç”¨ç­‰ï¼‰</td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>qwen-plus-latest</td><td>1856</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>gpt-4o-mini</td><td>1667</td><td>éƒ¨åˆ†æˆåŠŸï¼Œæœªè§£æå‡ºç¬¬å‡ å­£&#x2F;ç¬¬å‡ é›†</td></tr><tr><td>åŒä¸Š</td><td>Toolsè°ƒç”¨</td><td>gemini-1.5-flash</td><td>1265</td><td>å¤±è´¥ï¼Œtmdb apiè°ƒç”¨æˆåŠŸä½†ç»“æœè§£æå¾ˆç³Ÿç³•</td></tr><tr><td>Young.Woman.and.the.Sea.2024.2160p.DSNP.WEB-DL.H265.HDR.DDP5.1.Atmos-ADWeb.mkv</td><td>JSONè°ƒç”¨</td><td>deepseek-chat</td><td>652</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>qwen-plus-latest</td><td>575</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>gpt-4o-mini</td><td>559</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>gemini-1.5-flash</td><td>587</td><td>æˆåŠŸ</td></tr><tr><td>ã€å‹•ç•«ç˜‹ã€‘ç‰©èªç³»åˆ— ç¬¬å¤–å­£ï¼†ç¬¬æ€ªå­£[9][1080P].mp4</td><td>JSONè°ƒç”¨</td><td>deepseek-chat</td><td>1158</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>qwen-plus-latest</td><td>942</td><td>æˆåŠŸ</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>gpt-4o-mini</td><td>540</td><td>éƒ¨åˆ†æˆåŠŸï¼Œæœªè§£æå‡ºç¬¬å‡ å­£&#x2F;ç¬¬å‡ é›†</td></tr><tr><td>åŒä¸Š</td><td>JSONè°ƒç”¨</td><td>gemini-1.5-flash</td><td>262</td><td>å¤±è´¥ï¼Œç›´æ¥æ²¡æœ‰è°ƒç”¨tmdb api</td></tr></tbody></table><h1 id="äº”ã€ç»“è®º"><a href="#äº”ã€ç»“è®º" class="headerlink" title="äº”ã€ç»“è®º"></a>äº”ã€ç»“è®º</h1><p>ä»å¤§æ¨¡å‹å¯¹æ¯”çš„è§’åº¦æ¥çœ‹ï¼š</p><ul><li><p><code>qwen-plus-latest</code>è¡¨ç°æœ€å¥½ã€‚ä»·æ ¼æ¯”<code>deepseek-chat</code>ç¨ä½ï¼Œä½†é€Ÿåº¦æ›´å¿«ã€æ•ˆæœæ›´å¥½ã€‚å……åˆ†ä½“ç°äº†æœ€æ–°å¼€æºçš„qwen 2.5å®¶æ—çš„å®åŠ›ã€‚</p></li><li><p><code>deepseek-chat</code>åœ¨Toolsè°ƒç”¨åœºæ™¯å‘æŒ¥ä¸ç¨³å®šï¼Œæ¯”å¦‚è§£æ<code>ã€å‹•ç•«ç˜‹ã€‘ç‰©èªç³»åˆ— ç¬¬å¤–å­£ï¼†ç¬¬æ€ªå­£[9][1080P].mp4</code>æ—¶ï¼Œè™½ç„¶çŸ¥é“è¦è°ƒç”¨å‡½æ•°è·å–å­£åº¦ä¿¡æ¯ï¼Œä½†å´æ²¡æœ‰æŒ‰Toolsæ ¼å¼è¾“å‡ºï¼Œå¯¼è‡´åç»­æ— æ³•è¡”æ¥ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;content&#x27;<span class="hljs-punctuation">:</span> &#x27;ä»æœç´¢ç»“æœæ¥çœ‹ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„æ¡ç›®ï¼šä¸€ä¸ªæ˜¯â€œç‰©èªç³»åˆ—â€ï¼ˆ<span class="hljs-number">2009</span>å¹´ï¼ŒTVåŠ¨ç”»ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯â€œæ˜¥é£ç‰©è¯­â€ï¼ˆ<span class="hljs-number">2023</span>å¹´ï¼Œ ç”µå½±ï¼‰ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯â€œç‰©èªç³»åˆ—â€çš„ä¿¡æ¯ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è·å–â€œç‰©èªç³»åˆ—â€çš„è¯¦ç»†ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯â€œç¬¬å¤–å­£â€å’Œâ€œç¬¬æ€ªå­£â€çš„ç›¸å…³ä¿¡æ¯ã€‚ç”±äºè¿™äº›å­£æ•°å¯èƒ½ä¸æ˜¯æ ‡å‡†çš„å­£æ•°ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥æŸ¥è¯¢ä»¥ç¡®è®¤ã€‚\n\nè¯·è°ƒç”¨ `tv_season_info` å‡½æ•°ï¼Œä¼ å…¥ `tmdb_id` ä¸º `<span class="hljs-number">46195</span>`ï¼Œ ä»¥è·å–â€œç‰©èªç³»åˆ—â€çš„å­£æ•°ä¿¡æ¯ã€‚&#x27;<span class="hljs-punctuation">,</span> &#x27;role&#x27;<span class="hljs-punctuation">:</span> &#x27;assistant&#x27;<span class="hljs-punctuation">,</span> &#x27;tool_calls&#x27;<span class="hljs-punctuation">:</span> None<span class="hljs-punctuation">,</span> &#x27;function_call&#x27;<span class="hljs-punctuation">:</span> None<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p><code>gpt-4o-mini</code>è¡¨ç°ä¸€èˆ¬ï¼Œä»·æ ¼æœ€è´µï¼Œä½†å®¹æ˜“å¿½ç•¥TVä½œå“çš„ç¬¬å‡ å­£&#x2F;ç¬¬å‡ é›†ã€‚</p></li><li><p><code>gemini-1.5-flash</code>ä»·æ ¼æœ€ä½ï¼Œè¡¨ç°ä¹Ÿæœ€å·®ã€‚</p></li></ul><p>ä»Toolsä½¿ç”¨çš„è§’åº¦æ¥çœ‹ï¼š</p><ul><li>Toolsè¯ç”Ÿçš„åœºæ™¯æ˜¯ï¼šåœ¨èŠå¤©æœºå™¨äººå¯¹è¯è¿‡ç¨‹ä¸­ï¼Œå…¼é¡¾ç”¨æˆ·ä½“éªŒå’Œå¤–éƒ¨å‡½æ•°è°ƒç”¨ã€‚ä½†åœ¨APIåœºæ™¯ä¸­ï¼Œâ€œå…¼é¡¾ç”¨æˆ·ä½“éªŒâ€çš„éƒ¨åˆ†æˆäº†ç´¯èµ˜ã€‚</li><li>ç¬”è€…è®¾è®¡çš„JSONè°ƒç”¨æ¨¡å¼ï¼Œå¯¹æœºå™¨é—´äº¤äº’è®¾è®¡ï¼Œåœ¨å¤–éƒ¨å‡½æ•°è°ƒç”¨æ–¹é¢æ¯”Toolsæ–¹å¼æ•ˆç‡æ›´é«˜ã€å‡†ç¡®åº¦æ›´é«˜ã€‚</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>å¤§æ¨¡å‹</tag>
      
      <tag>åª’ä½“åˆ®å‰Š</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è‡ªå»ºDocker Hubé•œåƒæœåŠ¡</title>
    <link href="/2024/06/08/self-host-docker-hub-mirror/"/>
    <url>/2024/06/08/self-host-docker-hub-mirror/</url>
    
    <content type="html"><![CDATA[<h1 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com//picgo/image-20240608093740935.png"></p><p>æœ€è¿‘åœ¨æŸäº›ç¥ç§˜åŠ›é‡çš„å½±å“ä¸‹ï¼ŒSJTUG&#x2F;USTCç­‰çŸ¥åDocker Hubé•œåƒç«™é™†ç»­åœæ­¢æœåŠ¡ã€‚</p><p>æ–‡æœ¬ä½¿ç”¨<a href="https://distribution.github.io/distribution">CNCF Distribution</a>çš„registryé¡¹ç›®ï¼Œåªéœ€è¦è¿è¡Œä¸€ä¸ªDockerå®¹å™¨ï¼Œå°±å¯ä»¥è‡ªå»ºDocker Hubé•œåƒæœåŠ¡ã€‚</p><h1 id="2-æ‰€éœ€æ¡ä»¶"><a href="#2-æ‰€éœ€æ¡ä»¶" class="headerlink" title="2. æ‰€éœ€æ¡ä»¶"></a>2. æ‰€éœ€æ¡ä»¶</h1><ul><li>å¯è¿è¡ŒDockerå®¹å™¨çš„æœåŠ¡å™¨</li><li>å¯ä»¥è®¿é—®docker.ioçš„HTTPä»£ç†ï¼ˆå¦‚æœæœåŠ¡å™¨æ— æ³•ç›´æ¥è®¿é—®çš„è¯ï¼‰</li></ul><h1 id="3-ç”ŸæˆSSLè¯ä¹¦"><a href="#3-ç”ŸæˆSSLè¯ä¹¦" class="headerlink" title="3. ç”ŸæˆSSLè¯ä¹¦"></a>3. ç”ŸæˆSSLè¯ä¹¦</h1><p>registryé»˜è®¤ä½¿ç”¨HTTPåè®®å¯¹å¤–æä¾›æœåŠ¡ï¼Œä½¿ç”¨HTTPSæ›´å®‰å…¨&amp;æ›´é€šç”¨ã€‚ç¬”è€…ç”Ÿæˆè‡ªç­¾åè¯ä¹¦çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 \<br>  -nodes -keyout example.com.key -out example.com.crt -subj &quot;/CN=example.com&quot; \<br>  -addext &quot;subjectAltName=DNS:example.com,DNS:*.example.com,IP:100.x.x.x,IP:192.168.1.30&quot;<br></code></pre></td></tr></table></figure><h1 id="4-å¯åŠ¨registryæœåŠ¡"><a href="#4-å¯åŠ¨registryæœåŠ¡" class="headerlink" title="4. å¯åŠ¨registryæœåŠ¡"></a>4. å¯åŠ¨registryæœåŠ¡</h1><p>å‡†å¤‡å¥½registryçš„å­˜å‚¨ç›®å½•ï¼Œæ”¾å…¥ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶ã€‚ç„¶åç¼–å†™å¦‚ä¸‹docker-composeæ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.1&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry:2</span><br>    <span class="hljs-attr">network_mode:</span> <span class="hljs-string">&quot;host&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">REGISTRY_HTTP_ADDR:</span> <span class="hljs-string">&quot;0.0.0.0:5000&quot;</span><br>      <span class="hljs-attr">REGISTRY_HTTP_TLS_KEY:</span> <span class="hljs-string">&quot;/var/lib/registry/example.com.key&quot;</span><br>      <span class="hljs-attr">REGISTRY_HTTP_TLS_CERTIFICATE:</span> <span class="hljs-string">&quot;/var/lib/registry/example.com.crt&quot;</span><br>      <span class="hljs-attr">REGISTRY_PROXY_REMOTEURL:</span> <span class="hljs-string">&quot;https://registry-1.docker.io&quot;</span> <span class="hljs-comment"># æŒ‡å®šä¸Šæ¸¸ä»“åº“åœ°å€</span><br>      <span class="hljs-attr">HTTPS_PROXY:</span> <span class="hljs-string">&quot;&#123;HTTPä»£ç†åœ°å€&#125;&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">registry</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/&#123;ä½ çš„è·¯å¾„&#125;/registry:/var/lib/registry&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/&#123;ä½ çš„è·¯å¾„&#125;/registry_config.yml:/etc/docker/registry/config.yml&quot;</span><br></code></pre></td></tr></table></figure><p>ç”¨docker-composeè¿è¡Œå®¹å™¨å³å¯å¯åŠ¨æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose -f registry.yml up -d<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶registryä¼šåœ¨ç¬”è€…çš„æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå°±æ˜¯<code>https://192.168.1.30:5000</code>æä¾›æœåŠ¡ã€‚</p><h1 id="5-å®¢æˆ·ç«¯ä½¿ç”¨"><a href="#5-å®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="5. å®¢æˆ·ç«¯ä½¿ç”¨"></a>5. å®¢æˆ·ç«¯ä½¿ç”¨</h1><h2 id="5-1-ä¿¡ä»»SSLè¯ä¹¦"><a href="#5-1-ä¿¡ä»»SSLè¯ä¹¦" class="headerlink" title="5.1 ä¿¡ä»»SSLè¯ä¹¦"></a>5.1 ä¿¡ä»»SSLè¯ä¹¦</h2><p>ç”±äºregistryä½¿ç”¨çš„æ˜¯è‡ªç­¾åSSLè¯ä¹¦ï¼Œå®¢æˆ·ç«¯è¦æƒ³æˆåŠŸæ‹‰å–é•œåƒéœ€è¦å…ˆä¿¡ä»»è¯¥è¯ä¹¦ã€‚æ–¹å¼æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯å°†è¯ä¹¦åŠ å…¥å®¢æˆ·ç«¯çš„çš„ç³»ç»Ÿä¿¡ä»»åˆ—è¡¨ï¼ˆæ¨èï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo cp /$&#123;ä½ çš„è·¯å¾„&#125;/example.com.crt /usr/share/ca-certificates<br>sudo dpkg-reconfigure ca-certificates<br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯Docker&#x2F;K3Sç­‰éœ€è¦æ‹‰å–é•œåƒçš„æœåŠ¡ï¼›ç¬¬äºŒç§æ˜¯è®©Dockeræ‹‰å–é•œåƒæ—¶è·³è¿‡è¯ä¹¦æ ¡éªŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo vim /etc/docker/daemon.json<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><br><span class="hljs-punctuation">&#123;</span><br>  ...<br>  <span class="hljs-attr">&quot;insecure-registries&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;192.168.1.30:5000&quot;</span><span class="hljs-punctuation">]</span><br>  ...<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯dockeræœåŠ¡ã€‚</p><p>ä¿¡ä»»å®Œè¯ä¹¦åï¼Œæ­¤æ—¶å°±å¯ä»¥æ‹‰å–Docker Hubä¸Šçš„é•œåƒçœ‹åˆ°æ•ˆæœäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull 192.168.1.30:5000/grafana/grafana:main<br></code></pre></td></tr></table></figure><h2 id="5-2-è®¾ç½®Dockeré•œåƒæº"><a href="#5-2-è®¾ç½®Dockeré•œåƒæº" class="headerlink" title="5.2 è®¾ç½®Dockeré•œåƒæº"></a>5.2 è®¾ç½®Dockeré•œåƒæº</h2><p>åŒæ ·æ˜¯ç¼–è¾‘<code>/etc/docker/daemon.json</code>ï¼Œå°†ä¸Šè¿°registryæœåŠ¡ä½œä¸ºDockeré•œåƒæºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  ...<br>  <span class="hljs-attr">&quot;registry-mirrors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;https://192.168.1.30:5000&quot;</span><br>  <span class="hljs-punctuation">]</span><br>  ...<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯DockeræœåŠ¡ï¼Œæ­¤æ—¶å°±å¯ä»¥å¿«é€Ÿæ‹‰å–é•œåƒäº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull grafana/grafana:main<br></code></pre></td></tr></table></figure><p>enjoy!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šæœºK3Sé›†ç¾¤æ­å»ºè¸©å‘è®°</title>
    <link href="/2024/06/07/multi-node-k3s-cluster/"/>
    <url>/2024/06/07/multi-node-k3s-cluster/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>ç”±äºç¬”è€…éœ€è¦éƒ¨ç½²ä¸€äº›è®¡ç®—æœåŠ¡å¹¶å®ç°æ‰©å±•çµæ´»ã€å¯ç”¨æ€§é«˜ï¼Œæ‰€ä»¥å†³å®šç”¨K8Sä½“ç³»æ¥ä»£æ›¿åŸæœ‰çš„Dockeréƒ¨ç½²ã€‚K8Så¯¹äºä¸ªäººæ¥è¯´ç»´æŠ¤æˆæœ¬å¤ªé«˜äº†ï¼Œæ‰€ä»¥ç¬”è€…é€‰ç”¨äº†æ›´è½»é‡çš„K3Sã€‚</p><p>æœ¬ç¯‡æ–‡ç« è®°å½•çš„æ˜¯ç¬”è€…æ­å»ºè¿™ä¸ªK3Sé›†ç¾¤çš„è¿‡ç¨‹ã€‚</p><h1 id="2-ç¦»çº¿å®‰è£…K3SæœåŠ¡"><a href="#2-ç¦»çº¿å®‰è£…K3SæœåŠ¡" class="headerlink" title="2. ç¦»çº¿å®‰è£…K3SæœåŠ¡"></a>2. ç¦»çº¿å®‰è£…K3SæœåŠ¡</h1><p>K3Sçš„<a href="https://docs.k3s.io/zh/quick-start">å¿«é€Ÿå…¥é—¨æŒ‡å—</a>ç»™å‡ºäº†ç®€æ´çš„å®‰è£…è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -sfL https://get.k3s.io | sh -<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å›½å†…åŠ é€Ÿè„šæœ¬ğŸ‘‡</span><br>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -<br></code></pre></td></tr></table></figure><p>ä½†ç”±äºå›½å†…æ„ˆåŠ æ¶åŠ£çš„ç½‘ç»œç¯å¢ƒï¼Œå³ä½¿è¿™ä¸ªè„šæœ¬æˆåŠŸå®‰è£…äº†K3SæœåŠ¡ï¼Œä¹Ÿæ— æ³•æˆåŠŸå¯åŠ¨ï¼šK3Sæ‰€éœ€çš„pauseé•œåƒæ— æ³•ä»docker.ioä¸Šæ‹‰å–ä¸‹æ¥ã€‚æ‰€ä»¥ç¬”è€…é€‰æ‹©ç¦»çº¿å®‰è£…K3Sã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://docs.k3s.io/zh/installation/airgap">Air-Gap Install | K3s</a></p><h2 id="2-1-ä¸‹è½½æ‰€éœ€æ–‡ä»¶"><a href="#2-1-ä¸‹è½½æ‰€éœ€æ–‡ä»¶" class="headerlink" title="2.1 ä¸‹è½½æ‰€éœ€æ–‡ä»¶"></a>2.1 ä¸‹è½½æ‰€éœ€æ–‡ä»¶</h2><p>åœ¨K3Sçš„<a href="https://github.com/k3s-io/k3s/releases">Releases</a>é¡µå¯ä»¥ä¸‹è½½åˆ°æˆ‘ä»¬æ‰€éœ€çš„æ–‡ä»¶ï¼šk3så’Œk3s-airgap-images-amd64.tar.gzã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com//picgo/image-20240607082747333.png" alt="image-20240607082747333"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget &lt;k3sé“¾æ¥&gt;<br>wget &lt;k3sé•œåƒé“¾æ¥&gt;<br>chmod +x k3s<br></code></pre></td></tr></table></figure><p>æœ¬æ¥è¿˜éœ€è¦ä¸‹è½½<code>k3s-install.sh</code>ï¼Œä½†ç”±äºç¬”è€…çš„å®‰è£…ç¯å¢ƒå¯ä»¥é¡ºç•…ä»rancher.cnè·å–è¯¥æ–‡ä»¶ï¼Œæ‰€ä»¥ç¬”è€…æ²¡æœ‰ä¸‹è½½ã€‚</p><h2 id="2-2-K3Sä¸»èŠ‚ç‚¹å®‰è£…æœåŠ¡"><a href="#2-2-K3Sä¸»èŠ‚ç‚¹å®‰è£…æœåŠ¡" class="headerlink" title="2.2 K3Sä¸»èŠ‚ç‚¹å®‰è£…æœåŠ¡"></a>2.2 K3Sä¸»èŠ‚ç‚¹å®‰è£…æœåŠ¡</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å‡†å¤‡æ–‡ä»¶</span><br>sudo mkdir -p /var/lib/rancher/k3s/agent/images<br>sudo cp ./k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images<br>sudo cp ./k3s /usr/local/bin/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¼€å§‹å®‰è£…</span><br>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_SKIP_DOWNLOAD=true sh -<br></code></pre></td></tr></table></figure><h2 id="2-3-K3Sä»èŠ‚ç‚¹å®‰è£…æœåŠ¡"><a href="#2-3-K3Sä»èŠ‚ç‚¹å®‰è£…æœåŠ¡" class="headerlink" title="2.3 K3Sä»èŠ‚ç‚¹å®‰è£…æœåŠ¡"></a>2.3 K3Sä»èŠ‚ç‚¹å®‰è£…æœåŠ¡</h2><p>æµç¨‹å’Œä¸»èŠ‚ç‚¹ç›¸åŒï¼Œåªæ˜¯éœ€è¦å…ˆä»ä¸»èŠ‚ç‚¹ä¸Šè·å–K3S TOKENï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo cat /var/lib/rancher/k3s/server/token<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ä»èŠ‚ç‚¹å®‰è£…æ˜¯åŠ å…¥ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å‡†å¤‡æ–‡ä»¶</span><br>sudo mkdir -p /var/lib/rancher/k3s/agent/images<br>sudo cp ./k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images<br>sudo cp ./k3s /usr/local/bin/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¼€å§‹å®‰è£…</span><br>export K3S_URL=&quot;https://&lt;ä¸»èŠ‚ç‚¹IP&gt;:6443&quot;<br>export K3S_TOKEN=&quot;&lt;ä¸Šä¸€æ­¥è·å–åˆ°çš„K3S TOKEN&gt;&quot;<br>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_SKIP_DOWNLOAD=true sh -<br></code></pre></td></tr></table></figure><h1 id="3-é…ç½®K3SæœåŠ¡"><a href="#3-é…ç½®K3SæœåŠ¡" class="headerlink" title="3. é…ç½®K3SæœåŠ¡"></a>3. é…ç½®K3SæœåŠ¡</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com//picgo/image-20240607085753410.png" alt="image-20240607085753410"></p><p>ä¸Šå›¾æ˜¯ç¬”è€…çš„ç½‘ç»œç¯å¢ƒï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸¤å¼ ç½‘å¡ï¼Œé€šè¿‡ç½‘æ®µä¸º<code>100.x.x.x</code>çš„ç½‘å¡äº’ç›¸è”é€šã€‚</p><p>åœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å®‰è£…å®ŒK3SæœåŠ¡åï¼Œç¬”è€…å‘ç°ä»èŠ‚ç‚¹æ— æ³•æˆåŠŸå¯åŠ¨K3SæœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo journalctl -u k3s-agent.service</span><br>...<br>Starting k3s agent v1.29.5+k3s1 (4e53a323)<br>Adding server to load balancer k3s-agent-load-balancer: 100.x.x.x:6443<br>Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -&gt; [100.x.x.x:6443] [default: 100.x.x.x:6443]<br>...<br>Getting list of apiserver endpoints from server<br>Updated load balancer k3s-agent-load-balancer default server address -&gt; 192.x.x.x:6443<br>Adding server to load balancer k3s-agent-load-balancer: 192.x.x.x:6443<br>Removing server from load balancer k3s-agent-load-balancer: 100.x.x.x:6443<br>...<br>error=&quot;dial tcp 192.x.x.x:6443: connect: connection timed out&quot;<br></code></pre></td></tr></table></figure><p>åŸæ¥ï¼Œå³ä½¿åœ¨ä»èŠ‚ç‚¹å®‰è£…K3Sæ—¶å·²ç»æŒ‡å®šäº†K3S_URLä¸º<code>100.x.x.x</code>ï¼Œä½†K3S Agentåœ¨è¿æ¥ä¸Šä¸»èŠ‚ç‚¹åä¾ç„¶é€‰æ‹©è¿æ¥<code>192.x.x.x</code>ï¼Œä½†ä»èŠ‚ç‚¹å®é™…ä¸Šæ— æ³•è¿æ¥è¿™ä¸ªIPã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶æŒ‡å®šèŠ‚ç‚¹IPã€‚</p><p>å‚è€ƒï¼š<a href="https://docs.k3s.io/zh/cli/server">server | K3s</a>ã€<a href="https://docs.k3s.io/zh/cli/agent">agent | K3s</a></p><h2 id="3-1-ä¿®æ”¹K3SæœåŠ¡æ–‡ä»¶"><a href="#3-1-ä¿®æ”¹K3SæœåŠ¡æ–‡ä»¶" class="headerlink" title="3.1 ä¿®æ”¹K3SæœåŠ¡æ–‡ä»¶"></a>3.1 ä¿®æ”¹K3SæœåŠ¡æ–‡ä»¶</h2><p>åœ¨ä¸»èŠ‚ç‚¹ä¸Šä¿®æ”¹é…ç½®<code>/etc/systemd/system/k3s.service</code>:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">...<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/k3s \<br>    server --node-ip &quot;100.x.x.x&quot; --node-external-ip &quot;100.x.x.x&quot; \<br></code></pre></td></tr></table></figure><p>åœ¨ä»èŠ‚ç‚¹ä¸Šä¿®æ”¹é…ç½®<code>/etc/systemd/system/k3s-agent.service</code>:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ExecStart</span>=/usr/local/bin/k3s \<br>    agent --node-ip &quot;100.x.x.x&quot; --node-external-ip &quot;100.x.x.x&quot; \<br></code></pre></td></tr></table></figure><p>ç„¶åå„è‡ªé‡å¯æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br>sudo systemctl restart k3s # ä¸»èŠ‚ç‚¹<br>sudo systemctl restart k3s-agent # ä»èŠ‚ç‚¹<br></code></pre></td></tr></table></figure><p>ç°åœ¨ä»èŠ‚ç‚¹æ­£å¸¸åŠ å…¥é›†ç¾¤äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo kubectl get nodes<br>NAME      STATUS   ROLES                  AGE   VERSION<br>xxxxxxx   Ready    &lt;none&gt;                 10m   v1.30.1+k3s1<br>xxxxx     Ready    control-plane,master   32m   v1.30.1+k3s1<br></code></pre></td></tr></table></figure><h2 id="3-2-æŸ¥çœ‹Nodeä¿¡æ¯"><a href="#3-2-æŸ¥çœ‹Nodeä¿¡æ¯" class="headerlink" title="3.2 æŸ¥çœ‹Nodeä¿¡æ¯"></a>3.2 æŸ¥çœ‹Nodeä¿¡æ¯</h2><p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼ˆ<code>sudo kubectl describe node xxx</code>ï¼‰ï¼Œä¼šå‘ç°æ³¨è§£<code>flannel.alpha.coreos.com/public-ip</code>ä¾ç„¶æ˜¯èŠ‚ç‚¹å¦ä¸€å¼ ç½‘å¡çš„IPã€‚ç›®å‰å½±å“æœªçŸ¥ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Annotations:        alpha<span class="hljs-selector-class">.kubernetes</span>.io/provided-node-ip: <span class="hljs-number">100</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><br>                    flannel<span class="hljs-selector-class">.alpha</span><span class="hljs-selector-class">.coreos</span>.com/backend-data: &#123;<span class="hljs-string">&quot;VNI&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;VtepMAC&quot;</span>:<span class="hljs-string">&quot;xx&quot;</span>&#125;<br>                    flannel<span class="hljs-selector-class">.alpha</span><span class="hljs-selector-class">.coreos</span>.com/backend-type: vxlan<br>                    flannel<span class="hljs-selector-class">.alpha</span><span class="hljs-selector-class">.coreos</span>.com/kube-subnet-manager: true<br>                    flannel<span class="hljs-selector-class">.alpha</span><span class="hljs-selector-class">.coreos</span>.com/public-ip: <span class="hljs-number">10</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><br>                    k3s.io/external-ip: <span class="hljs-number">100</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><br>                    k3s.io/hostname: xx<br>                    k3s.io/internal-ip: <span class="hljs-number">100</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span>.x<br></code></pre></td></tr></table></figure><h1 id="4-è®¾ç½®é™æ€CPUè°ƒåº¦ç­–ç•¥"><a href="#4-è®¾ç½®é™æ€CPUè°ƒåº¦ç­–ç•¥" class="headerlink" title="4. è®¾ç½®é™æ€CPUè°ƒåº¦ç­–ç•¥"></a>4. è®¾ç½®é™æ€CPUè°ƒåº¦ç­–ç•¥</h1><p>Docker&#x2F;K8Sä½“ç³»ä¸‹ï¼ŒCPUé»˜è®¤æ˜¯æŒ‰æ—¶é—´ç‰‡è°ƒåº¦çš„ã€‚å®¹å™¨è·å–åˆ°CPUæ—¶é—´ç‰‡åï¼Œå¯ä»¥åœ¨ä¸åŒçš„CPUæ ¸å¿ƒä¸­åˆ‡æ¢ã€‚è¿™åœ¨IOå¯†é›†å‹åœºæ™¯ä¸­å¯ä»¥æå‡èµ„æºåˆ©ç”¨ç‡ã€‚</p><p>ä½†ç¬”è€…çš„åœºæ™¯æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œåˆ‡æ¢CPUæ ¸å¿ƒä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥éœ€è¦å°†å®¹å™¨å’ŒCPUè¿›è¡Œç»‘å®šã€‚</p><h2 id="4-1-Dockerå®ç°"><a href="#4-1-Dockerå®ç°" class="headerlink" title="4.1 Dockerå®ç°"></a>4.1 Dockerå®ç°</h2><p>ç”¨dockerå‘½ä»¤è¿è¡Œå®¹å™¨æ—¶ï¼Œå¯ä»¥ç”¨<code>--cpuset-cpus</code>ç­‰å‚æ•°ç»‘å®šCPUæ ¸å¿ƒï¼ˆ<a href="https://docs.docker.com/config/containers/resource_constraints/#cpu">Runtime options with Memory, CPUs, and GPUs | Docker Docs</a>ï¼‰ï¼Œæˆ–è€…ç”¨docker-composeé…ç½®å®ç°ç±»ä¼¼æ•ˆæœï¼ˆ<a href="https://docs.docker.com/compose/compose-file/05-services/#cpuset">Services top-level elements | Docker Docs</a>ï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2.4&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">xxx:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">xxx</span><br><br>    <span class="hljs-comment"># ç»‘å®šcpuæ ¸å¿ƒ</span><br>    <span class="hljs-attr">cpuset:</span> <span class="hljs-string">&quot;0-3&quot;</span><br>    <span class="hljs-attr">cpu_count:</span> <span class="hljs-number">4</span><br>    <span class="hljs-comment"># é¢„ç•™å†…å­˜</span><br>    <span class="hljs-attr">mem_limit:</span> <span class="hljs-string">&#x27;4g&#x27;</span><br>    <span class="hljs-attr">memswap_limit:</span> <span class="hljs-string">&#x27;4g&#x27;</span><br>    <span class="hljs-attr">mem_reservation:</span> <span class="hljs-string">&#x27;2g&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="4-2-K3Så®ç°"><a href="#4-2-K3Så®ç°" class="headerlink" title="4.2 K3Så®ç°"></a>4.2 K3Så®ç°</h2><p>kubeletä¹Ÿå¯ä»¥è®¾ç½®ç±»ä¼¼çš„è°ƒåº¦ç­–ç•¥ï¼šstatic ç­–ç•¥ï¼ˆ<a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/cpu-management-policies/">æ§åˆ¶èŠ‚ç‚¹ä¸Šçš„ CPU ç®¡ç†ç­–ç•¥ | Kubernetes</a>ï¼‰ã€‚ä½†ç”±äºK3Så·²ç»å°†kubeleté›†æˆåˆ°äº†äºŒè¿›åˆ¶å†…å®¹é‡Œï¼Œæ‰€ä»¥æ— æ³•å•ç‹¬é…ç½®kubeletã€‚ç¼–è¾‘K3Sçš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo mkdir -p /etc/rancher/k3s/<br>sudo vim /etc/rancher/k3s/config.yaml<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kubelet-arg:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--cpu-manager-policy=static&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--system-reserved=cpu=1,memory=1Gi&quot;</span><br></code></pre></td></tr></table></figure><p>åˆ é™¤å·²æœ‰CPUè°ƒåº¦ç­–ç•¥å¹¶é‡å¯K3SæœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo rm /var/lib/kubelet/cpu_manager_state<br>sudo systemctl restart k3s # ä¸»èŠ‚ç‚¹<br>sudo systemctl restart k3s-agent # ä»èŠ‚ç‚¹<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥çœ‹åˆ°é…ç½®ç”Ÿæ•ˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl describe node xxx</span><br>...<br>Annotations:        alpha.kubernetes.io/provided-node-ip: 100.x.x.x<br>                    k3s.io/node-args:<br>                      [&quot;agent&quot;,&quot;--kubelet-arg&quot;,&quot;--cpu-manager-policy=static&quot;,&quot;--kubelet-arg&quot;,&quot;--system-reserved=cpu=1,memory=1Gi&quot;,&quot;--node-ip&quot;,&quot;10<br>...<br>Capacity:<br>  cpu:                16<br>  ...<br>Allocatable:<br>  cpu:                15<br>  ...<br></code></pre></td></tr></table></figure><p>å¤§åŠŸå‘Šæˆï¼Œæ„‰å¿«äº«å—K3Säº†~</p>]]></content>
    
    
    
    <tags>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023å¹´åº¦æ€»ç»“</title>
    <link href="/2024/01/01/2023%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/"/>
    <url>/2024/01/01/2023%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>2023å¹´å¯¹æˆ‘å½±å“æœ€å¤§çš„ä¸€æœ¬ä¹¦æ˜¯ã€Šçº³ç“¦å°”å®å…¸ã€‹ï¼Œä¹¦é‡Œå¯¹â€œæ™ºæ…§â€çš„å®šä¹‰æ˜¯â€œçŸ¥é“ä¸ªäººè¡Œä¸ºçš„é•¿æœŸåæœâ€ã€‚å¯¹äºæˆ‘è€Œè¨€ï¼Œè¿™ä¸ªå®šä¹‰æœ‰æ—¶å€™è¿˜è¦åŠ ä¸Šâ€œæˆ‘ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆåšâ€ã€‚äºæ˜¯ï¼Œè¿™æ¬¡çš„å¹´åº¦æ€»ç»“ï¼Œå°±è®©æˆ‘å¥½å¥½ç›˜ç‚¹ä¸‹2023å¹´åšè¿‡çš„é‡è¦å†³ç­–å§ã€‚</p><h1 id="èº«ä½“çŠ¶å†µ"><a href="#èº«ä½“çŠ¶å†µ" class="headerlink" title="èº«ä½“çŠ¶å†µ"></a>èº«ä½“çŠ¶å†µ</h1><ul><li>4æœˆåº•æ¬åˆ°ä¸Šæµ·åï¼Œæˆ‘é¢‘ç¹å»ä½å¤„é™„è¿‘çš„å¥èº«æˆ¿ä¸Šç§æ•™è¯¾ã€‚ä»·æ ¼ä¸ä¾¿å®œï¼Œä½†æˆæœæ˜¾è‘—ï¼šæ·±è¹²çªç ´100kgã€å‘åŠ›å§¿åŠ¿ä¼˜åŒ–äº†ä¸å°‘ï¼Œè€Œä¸”è¿˜å¼ºåŒ–äº†åšæŒé”»ç‚¼çš„ä¹ æƒ¯ï¼ˆæ„Ÿè°¢æ•™ç»ƒï¼‰ã€‚</li><li>10æœˆåˆæ¬åˆ°é•¿æ²™åï¼Œæˆ‘é¢‘ç¹ä¹…å+é¢å¯¹ç”µè„‘ï¼šç ”ç©¶3dæ‰“å°ï¼Œå¨±ä¹ï¼Œå†™ä»£ç ï¼Œç­‰ç­‰ã€‚æˆ·å¤–æ´»åŠ¨ä¹Ÿå°‘äº†å¾ˆå¤šï¼Œç»“æœæ˜¯è§†åŠ›æ˜æ˜¾ä¸‹é™ã€‚è¿˜å¥½å¥èº«æˆ¿æ²¡è½ä¸‹ï¼Œä¸ç„¶èº«ä½“ä¹Ÿå¾—å‡ºé—®é¢˜ã€‚åªèƒ½è¯´é•¿æ—¶é—´èœ—å±…ç¡®å®å¯¹å¥åº·æœ‰å®³ï¼Œæ‰€ä»¥ç»è¿‡ä¸€ç•ªåŠªåŠ›ï¼Œæˆ‘å¾ˆå¿«å°±è¦è„±ç¦»èœ—å±…çŠ¶æ€äº†ã€‚</li><li>å£è…”ã€ç”²çŠ¶è…ºç­‰æ–¹é¢å…³æ³¨åº¦ä¸é«˜ï¼Œä½†æ¯å¤©ä¼šå…³æ³¨ã€‚ç›®å‰æ•´ä½“æƒ…å†µè¿˜ç®—ç¨³å®šã€‚</li></ul><p>æ€»ä½“è€Œè¨€èº«ä½“çŠ¶å†µæ˜¯æœ€é‡è¦ä¹Ÿæ˜¯æœ€å€¼å¾—æŠ•å…¥çš„ï¼šæ­£é¢æ•ˆæœæ˜æ˜¾ï¼ŒæŠ•å…¥ä¸è¶³çš„è´Ÿé¢æ•ˆæœä¹Ÿå¾ˆæ˜æ˜¾ã€‚</p><h1 id="å¿ƒç†çŠ¶å†µä¸äººé™…å…³ç³»"><a href="#å¿ƒç†çŠ¶å†µä¸äººé™…å…³ç³»" class="headerlink" title="å¿ƒç†çŠ¶å†µä¸äººé™…å…³ç³»"></a>å¿ƒç†çŠ¶å†µä¸äººé™…å…³ç³»</h1><ul><li>ä¸‹åŠå¹´æˆ‘å‚åŠ äº†å¤šæ¬¡å¿ƒç†å’¨è¯¢ã€‚å¿ƒç†å’¨è¯¢å‡å°‘äº†æˆ‘çš„è¿·èŒ«å’Œç—›è‹¦ï¼Œæ•ˆæœå‡ºä¹æ„æ–™çš„å¥½ï¼ˆæ„Ÿè°¢å’¨è¯¢å¸ˆï¼‰ã€‚</li><li>æ¬åˆ°ä¸Šæµ·ç»™æˆ‘å¸¦æ¥çš„å¿ƒç†è´Ÿé¢å½±å“æ¯”æƒ³è±¡ä¸­çš„è¦å¤§ä¸€äº›ï¼Œä½†æ–¹å‘ä¸Šç•¥æœ‰ä¸åŒã€‚ä¸Šæµ·ä¸°å¯Œçš„æ–‡å¨±æ´»åŠ¨å¸¦æ¥äº†ä¸å°‘å®è´µå›å¿†ï¼Œä¹Ÿè¦†ç›–äº†äººé™…å…³ç³»é‡ç½®ç­‰æ–¹é¢çš„è´Ÿé¢å½±å“ã€‚ä½†å¯¹åŸå¸‚ç¼ºå°‘å½’å±æ„Ÿ+åŠ ç­ä¾ç„¶æ˜¯æŒ¥ä¹‹ä¸å»çš„é˜´å½±ï¼Œä¸ºäº†é«˜å·¥èµ„å’ŒèŒä¸šå‰æ™¯è€Œè¯´æœè‡ªå·±æš‚æ—¶åœç•™åœ¨ä¸Šæµ·çš„åº•æ°”ä¹Ÿè¶Šæ¥ä¸è¶³ã€‚ä»ç»“æœçœ‹ï¼Œæ¬åˆ°ä¸Šæµ·çŸ­æœŸå†…é™ä½äº†æˆ‘çš„å¹¸ç¦æ„Ÿï¼Œä½†ä¹ŸåŒæ—¶æ›´è®©æˆ‘è®¤æ¸…äº†è‡ªå·±ã€‚</li><li>å›é•¿æ²™åèœ—å±…äº†ä¸‰ä¸ªæœˆï¼Œå……åˆ†çš„è‡ªç”±å¸¦æ¥çš„å¹¸ç¦æ„Ÿå¾ˆæ˜æ˜¾ã€‚ä½†å­¤ç‹¬æ„Ÿï¼Œä»¥åŠå¯¹ç¤¾äº¤ã€ç¨³å®šæ”¶å…¥ã€ç¤¾ä¼šèº«ä»½çš„éœ€æ±‚éšç€æ—¶é—´çš„æ¨ç§»åœ¨é€æ¸å˜æ˜æ˜¾ã€‚</li></ul><p>ä»Šå¹´æˆ‘åœ¨è¿™æ–¹é¢ä»Šå¹´ç»ä¸èƒ½ç§°ä¹‹ä¸ºä¿å®ˆã€‚ç›¸æ¯”å»å¹´ï¼Œæˆ‘è§‰å¾—æˆ‘æ›´èƒ½è®¤æ¸…è‡ªå·±å’Œæ¥çº³è‡ªå·±äº†ï¼Œæˆ‘æƒ³è¿™æ˜¯å¥½äº‹ã€‚å½“ç„¶ï¼Œä»Šåå¯ä»¥é€‰æ‹©ä¸€äº›æ›´åˆé€‚çš„é€”å¾„ğŸ˜‚</p><h1 id="è´¢åŠ¡çŠ¶å†µ"><a href="#è´¢åŠ¡çŠ¶å†µ" class="headerlink" title="è´¢åŠ¡çŠ¶å†µ"></a>è´¢åŠ¡çŠ¶å†µ</h1><ul><li>ä»Šå¹´æˆ‘é€šè¿‡ä¸€äº›ä¸å¯æŒç»­çš„é€‰æ‹©ï¼Œè®©è´¢å¯Œæ€»é‡ç»§ç»­æœ‰ä»¤äººæ»¡æ„çš„å¢é•¿ã€‚æˆ–è®¸æˆ‘åœ¨æ½œæ„è¯†é‡ŒçŸ¥é“ï¼Œä¼ ç»Ÿè·¯å¾„ä¸‹æˆ‘å·²ç»è§¦è¾¾æé™äº†ï¼Ÿ</li><li>ä¸‹åŠå¹´è£¸è¾çš„å†³å®šç»™æˆ‘çš„è´¢åŠ¡çŠ¶å†µå¸¦æ¥äº†ä¸€äº›å‹åŠ›ã€‚è™½ç„¶åŸºäºå‰å‡ å¹´çš„ç§¯ç´¯ï¼Œæˆ‘åœ¨æœªæ¥æ•°å¹´å†…ä¸éœ€è¦æ‹…å¿ƒç”Ÿæ´»å¼€æ”¯ï¼Œä½†åŸºäºå¯¹ç¨³å®šæ”¶å…¥çš„æ¸´æ±‚ï¼Œæˆ‘è¿˜æ˜¯åœ¨è¾èŒä¸€ä¸ªåŠæœˆåå¼€å§‹æ‰¾å·¥ä½œã€‚</li><li>ä»Šå¹´æˆ‘åœ¨Aè‚¡åŸºé‡‘ä¸Šçš„æŠ•èµ„å‡ ä¹æ²¡æœ‰è°ƒæ•´ï¼Œç»“æœæ˜¯äºæŸæ•°ä¸‡ã€‚æŸå¤±å°šèƒ½æ¥å—ï¼Œä½†æŠ•èµ„é€»è¾‘éœ€è¦å‘ç”Ÿå˜æ›´ï¼šå•ä¸€èµ°å‘åˆ†æ•£ã€ç”¨åº•å±‚é€»è¾‘å–ä»£å†å²ä¸šç»©ä½œä¸ºåˆ¤æ–­ä¾æ®ã€‚</li></ul><p>å³ä½¿çŸ¥é“è‡ªå·±ï¼ˆæš‚æ—¶ï¼‰ä¸ç”¨ä¸ºé‡‘é’±çƒ¦æ¼ï¼Œä½†æˆ‘è¿˜æ˜¯åœ¨æ¸´æ±‚ç¨³å®šçš„æ”¶å…¥æ¥æºã€‚æˆ–è®¸åè€…æ‰æ›´å®¹æ˜“å–å¾—ç”Ÿæ´»çš„å¹³è¡¡ï¼Ÿ</p><h1 id="çƒ­æƒ…"><a href="#çƒ­æƒ…" class="headerlink" title="çƒ­æƒ…"></a>çƒ­æƒ…</h1><ul><li>æ¬åˆ°ä¸Šæµ·åæˆ‘å‚åŠ äº†å¾ˆå¤šäºŒæ¬¡å…ƒ&#x2F;å½±è§†ç›¸å…³çš„æ´»åŠ¨ï¼Œæ¬åˆ°é•¿æ²™åæˆ‘ä¹Ÿåœ¨ç»§ç»­å‚åŠ ã€‚å¾ˆé«˜å…´çœ‹åˆ°æˆ‘å¯¹çƒ­æƒ…æ²¡æœ‰æ¶ˆé€€ã€‚</li><li>â€œå›åˆ°é•¿æ²™ä¸“å¿ƒåšè‡ªå·±æœ‰çƒ­æƒ…çš„ä¸œè¥¿â€æ˜¯æˆ‘è£¸è¾çš„ä¸€å¤§åŸå› ã€‚ä½†åŸºäºå¯¹ç¨³å®šæ”¶å…¥çš„æ¸´æ±‚ï¼Œæˆ‘å¾€è¿™ä¸ªâ€çƒ­æƒ…â€œé‡Œæ³¨å…¥äº†ä¸å°‘å•†ä¸šåŒ–å› ç´ ã€‚è€Œå½“è¿™ä¸ªâ€çƒ­æƒ…â€œæ— æ³•å¿«é€Ÿå¸¦æ¥é¢„æœŸæ”¶ç›Šï¼Œæˆ‘ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å¼ºåŠ›çš„æ­£åé¦ˆé€”å¾„æ—¶ï¼Œè¿™ä¸ªâ€çƒ­æƒ…â€œä¹Ÿå°±æ…¢æ…¢æ¶ˆäº¡äº†ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘çš„çƒ­æƒ…ä¸æ­¢è¿™ä¸€ä¸ªï¼Œæ¥ä¸‹æ¥è¦åšçš„ï¼Œå¯èƒ½æ˜¯å‡å°‘å•†ä¸šåŒ–çš„å¹²æ‰°ï¼Œå†æ­é…ä¸€ä¸ªå°å°çš„æ­£åé¦ˆå¾ªç¯ã€‚</li></ul><p>å¥åº·çš„èº«ä½“ã€è‰¯å¥½çš„å¿ƒç†çŠ¶æ€å’Œäººé™…å…³ç³»ã€ä¸éœ€è¦ä¸ºè´¢åŠ¡çŠ¶å†µå‘æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿½æ±‚è‡ªå·±çš„çƒ­æƒ…å˜æˆä¸ºäº†ä¸€ä»¶äººç”Ÿä¸­æœ€é‡è¦çš„äº‹æƒ…ï¼ˆæ²¡æœ‰ä¹‹ä¸€ï¼‰ã€‚æˆ‘æƒ³ï¼Œè¿™æ˜¯2023å¹´æˆ‘ç»™è‡ªå·±çš„ä¸€ä¸ªæ³¨è§£ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>ç”Ÿæ´»</tag>
      
      <tag>æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å°†txtæ ¼å¼ç”µå­ä¹¦è½¬æ¢ä¸ºkindleæ ¼å¼</title>
    <link href="/2023/12/27/txt-to-kindle/"/>
    <url>/2023/12/27/txt-to-kindle/</url>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç¬”è€…æœ‰æ—¶å€™ä¼šé˜…è¯»ä¸€äº›txtæ ¼å¼çš„ç”µå­ä¹¦ï¼›åŒæ—¶ä¸ºäº†æŠ¤çœ¼ï¼Œç¬”è€…å€¾å‘äºåœ¨kindleä¸Šé˜…è¯»ç”µå­ä¹¦ã€‚ä½†ä½œä¸ºçº¯æ–‡æœ¬æ ¼å¼ï¼Œtxtåœ¨kindleä¸Šçš„é˜…è¯»ä½“éªŒæ¯”è¾ƒä¸€èˆ¬ï¼šå­—ä½“æ— æ³•éšæ„è°ƒèŠ‚ã€ç¼ºå°‘ç›®å½•ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…ç ”ç©¶äº†ä¸€å¥—è½¬æ¢æµç¨‹ï¼Œç”¨äºå°†txtæ ¼å¼çš„ç”µå­ä¹¦è½¬æ¢ä¸ºkindleçš„azw3æ ¼å¼ï¼ˆä¹Ÿé€‚ç”¨äºå…¶å®ƒç”µå­ä¹¦æ ¼å¼ï¼‰ï¼Œä»¥è·å¾—æ›´å¥½çš„é˜…è¯»ä½“éªŒã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227103239489.webp" alt="è½¬æ¢å‰"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227103414900.webp" alt="è½¬æ¢å"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227103329881.webp" alt="è½¬æ¢å"></th></tr></thead><tbody><tr><td>è½¬æ¢å‰</td><td>è½¬æ¢å</td><td>è½¬æ¢å</td></tr></tbody></table><h1 id="å¤„ç†txtæ–‡ä»¶"><a href="#å¤„ç†txtæ–‡ä»¶" class="headerlink" title="å¤„ç†txtæ–‡ä»¶"></a>å¤„ç†txtæ–‡ä»¶</h1><p>è¿™éƒ¨åˆ†å¤„ç†çš„æ ¸å¿ƒæ˜¯å°†txtæ–‡ä»¶è½¬æ¢ä¸ºå¸¦æ ¼å¼çš„htmlæ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä¸ªå¸¦æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢åŠŸèƒ½çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¦‚<a href="https://notepad-plus-plus.org/">Notepad++</a>ã€‚</p><h2 id="è½¬æ¢äºŒçº§æ ‡é¢˜"><a href="#è½¬æ¢äºŒçº§æ ‡é¢˜" class="headerlink" title="è½¬æ¢äºŒçº§æ ‡é¢˜"></a>è½¬æ¢äºŒçº§æ ‡é¢˜</h2><p>é¦–å…ˆå°†â€œç¬¬XXç« â€è½¬æ¢ä¸ºäºŒçº§æ ‡é¢˜ï¼Œä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼š</p><ul><li>æŸ¥æ‰¾ç›®æ ‡ï¼š<code>^(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ0-9]+ç« .*)</code></li><li>æ›¿æ¢ä¸ºï¼š<code>&lt;h2&gt;$1&lt;/h2&gt;</code></li></ul><p>ç‚¹å‡»â€œå…¨éƒ¨æ›¿æ¢â€æŒ‰é’®å³å¯çœ‹åˆ°æ•ˆæœã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102627720.webp" alt="image-20231227102627720"></p><h2 id="è½¬æ¢ä¸€çº§æ ‡é¢˜"><a href="#è½¬æ¢ä¸€çº§æ ‡é¢˜" class="headerlink" title="è½¬æ¢ä¸€çº§æ ‡é¢˜"></a>è½¬æ¢ä¸€çº§æ ‡é¢˜</h2><p>ç„¶åå°†â€œç¬¬XXå·â€è½¬æ¢ä¸ºä¸€çº§æ ‡é¢˜ï¼Œä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼š</p><ul><li>æŸ¥æ‰¾ç›®æ ‡ï¼š<code>^(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ0-9]+å·.*)</code></li><li>æ›¿æ¢ä¸ºï¼š<code>&lt;h1&gt;$1&lt;/h1&gt;</code></li></ul><p>ç‚¹å‡»â€œå…¨éƒ¨æ›¿æ¢â€æŒ‰é’®å³å¯çœ‹åˆ°æ•ˆæœã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102642685.webp" alt="image-20231227102642685"></p><h2 id="è½¬æ¢æ¢è¡Œ"><a href="#è½¬æ¢æ¢è¡Œ" class="headerlink" title="è½¬æ¢æ¢è¡Œ"></a>è½¬æ¢æ¢è¡Œ</h2><p>ç„¶åå°†â€œæ¢è¡Œâ€è½¬æ¢ä¸ºhtmlæ ‡ç­¾ï¼Œä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼š</p><ul><li>æŸ¥æ‰¾ç›®æ ‡ï¼š<code>\r?\n</code></li><li>æ›¿æ¢ä¸ºï¼š<code>&lt;/br&gt;\n</code></li></ul><p>ç‚¹å‡»â€œå…¨éƒ¨æ›¿æ¢â€æŒ‰é’®å³å¯çœ‹åˆ°æ•ˆæœã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102724977.webp" alt="image-20231227102724977"></p><h2 id="ä¿®æ”¹æ–‡ä»¶åç¼€ä¸º-html"><a href="#ä¿®æ”¹æ–‡ä»¶åç¼€ä¸º-html" class="headerlink" title="ä¿®æ”¹æ–‡ä»¶åç¼€ä¸º.html"></a>ä¿®æ”¹æ–‡ä»¶åç¼€ä¸º.html</h2><p>å°†æ–‡ä»¶çš„<code>.txt</code>åç¼€ä¿®æ”¹ä¸º<code>.html</code>ï¼Œä¹‹åå°†æ–‡ä»¶ç”¨æµè§ˆå™¨æ‰“å¼€å³å¯è§‚å¯Ÿåˆ°æ•ˆæœã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102734359.webp" alt="image-20231227102734359"></p><h1 id="è½¬æ¢ç”µå­ä¹¦"><a href="#è½¬æ¢ç”µå­ä¹¦" class="headerlink" title="è½¬æ¢ç”µå­ä¹¦"></a>è½¬æ¢ç”µå­ä¹¦</h1><p>è¿™éƒ¨åˆ†å¤„ç†çš„æ ¸å¿ƒæ˜¯å°†htmlæ ¼å¼çš„ç”µå­ä¹¦è½¬æ¢ä¸ºazw3ç­‰æ ¼å¼ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ç”µå­ä¹¦ç®¡ç†è½¯ä»¶ï¼Œæ¯”å¦‚<a href="https://calibre-ebook.com/">calibre - E-book management</a>ã€‚</p><h2 id="åŠ å…¥calibreä¹¦åº“"><a href="#åŠ å…¥calibreä¹¦åº“" class="headerlink" title="åŠ å…¥calibreä¹¦åº“"></a>åŠ å…¥calibreä¹¦åº“</h2><p>å°†htmlæ–‡ä»¶æ‹–å…¥calibreï¼Œå³å¯åŠ å…¥ä¹¦åº“</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227105124993.webp" alt="image-20231227105124993"></p><h2 id="å®Œå–„ä¹¦ç±å…ƒæ•°æ®"><a href="#å®Œå–„ä¹¦ç±å…ƒæ•°æ®" class="headerlink" title="å®Œå–„ä¹¦ç±å…ƒæ•°æ®"></a>å®Œå–„ä¹¦ç±å…ƒæ•°æ®</h2><p>ç¼–è¾‘ä¹¦ç±å…ƒæ•°æ®ï¼Œå¯å®Œå–„ä¹¦ç±çš„ä¹¦å&#x2F;ä½œè€…ç­‰ä¿¡æ¯ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102833783.webp" alt="image-20231227102833783"></p><h2 id="è½¬æ¢ä¹¦ç±æ ¼å¼"><a href="#è½¬æ¢ä¹¦ç±æ ¼å¼" class="headerlink" title="è½¬æ¢ä¹¦ç±æ ¼å¼"></a>è½¬æ¢ä¹¦ç±æ ¼å¼</h2><p>è½¬æ¢ä¹¦ç±ä¸ºazw3ï¼Œæ³¨æ„æŒ‡å®šè¾“å‡ºæ ¼å¼å’Œç›®å½•ç»“æ„ï¼š</p><ul><li>1çº§ç›®å½•ä¸º<code>//h:h1</code></li><li>2çº§ç›®å½•ä¸º<code>//h:h2</code></li></ul><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227103132931.webp" alt="image-20231227103132931"><br><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227102951708.webp" alt="image-20231227102951708"></p><h1 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h1><p>æœ€åå°†ä¹¦ç±å¯¼å…¥kindleå³å¯ï¼Œäº«å—é˜…è¯»å§~</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231227105812486.webp" alt="image-20231227105812486"></p>]]></content>
    
    
    
    <tags>
      
      <tag>ç”Ÿæ´»</tag>
      
      <tag>å¤šåª’ä½“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç®€æ˜“Dockeræ—¥å¿—æŒä¹…åŒ–&amp;ä¸­å¿ƒåŒ–æ–¹æ¡ˆ Loki</title>
    <link href="/2023/12/26/docker-log-center/"/>
    <url>/2023/12/26/docker-log-center/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç¬”è€…åœ¨å®¶åº­æœåŠ¡å™¨ä¸Šè¿è¡Œäº†ä¸€ç»„ä¸šåŠ¡Dockerå®¹å™¨ï¼Œæœ‰æŸ¥çœ‹å®¹å™¨æ—¥å¿—çš„éœ€æ±‚ã€‚<code>docker logs</code>åªèƒ½æŸ¥çœ‹å•ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼Œä¸”åœ¨å®¹å™¨è¢«åˆ é™¤ã€éœ€è¦æŒ‡å®šæ—¶é—´èŒƒå›´æŸ¥è¯¢ç­‰æƒ…å†µä¸‹è¡¨ç°ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥ç¬”è€…å¼€å§‹å¯»æ‰¾ä¸€ç§ç®€å•æ˜“ç”¨çš„æ—¥å¿—é›†ä¸­ç®¡ç†æ–¹æ¡ˆã€‚</p><p>Dockeræä¾›äº†<code>logging drivers</code>çš„é…ç½®é¡¹<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Configure logging drivers | Docker Docs](https://docs.docker.com/config/containers/logging/configure/)">[1]</span></a></sup>æ¥ç®¡ç†æ—¥å¿—ï¼Œå¯ä»¥å°†æ—¥å¿—å‘é€åˆ°<code>Logstash</code>æˆ–<code>fluentd</code>ã€‚ç»è¿‡ç¬”è€…çš„äº†è§£ï¼Œå‘ç°è¿™ç§æ–¹æ¡ˆæ˜¯æ¯”è¾ƒè€³ç†Ÿçš„ELK&#x2F;FEKæ–¹æ¡ˆï¼š</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231226154837554.webp" alt="elk"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231226154510340.webp" alt="fek"></th></tr></thead></table><p>è™½ç„¶è¿™å¥—æ–¹æ¡ˆæ¯”è¾ƒæˆç†Ÿï¼Œåº”ç”¨æ¡ˆä¾‹ä¹Ÿå¾ˆå¤šï¼Œä½†å¯¹äºç¬”è€…çš„ä¸ªäººç®€å•ä½¿ç”¨åœºæ™¯æ¥è¯´å¤ªéº»çƒ¦äº†ã€‚ç”±äºç¬”è€…å·²ç»éƒ¨ç½²äº†Grafanaçœ‹æ¿ï¼Œæ‰€æœ‰ç¬”è€…æœ€åé€‰æ‹©äº†Grafanaç”Ÿæ€ä¸‹çš„Lokiæ¥ç®¡ç†æ—¥å¿—ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231226155206048.webp" alt="Lokiæ¶æ„å›¾"></p><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¬”è€…å¯ä»¥åœ¨Grafanaçœ‹æ¿ä¸Šé€šè¿‡æ—¶é—´èŒƒå›´ã€å…³é”®å­—ã€å®¹å™¨åç§°ç­‰å‚æ•°æ¥æŸ¥çœ‹æ—¥å¿—ï¼Œç®€å•æ˜“ç”¨ä¸”ç¬¦åˆç¬”è€…éœ€æ±‚ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231226155545733.webp" alt="grafanaçœ‹æ¿"></p><h1 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h1><h2 id="promtail"><a href="#promtail" class="headerlink" title="promtail"></a>promtail</h2><p>promtailç”¨äºè½¬å‘å®¹å™¨äº§ç”Ÿçš„æ—¥å¿—ã€‚ä»<a href="https://github.com/grafana/loki/releases">Github releases</a>é¡µå¯ä»¥ä¸‹è½½åˆ°æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è™½ç„¶promtailä¹Ÿæä¾›å®˜æ–¹é•œåƒï¼Œä½†å¯¹äºpromtailè¿™ç§é™æ€ç¼–è¯‘çš„å•ä¸ªæ‰§è¡Œæ–‡ä»¶ï¼Œç¬”è€…æ›´å–œæ¬¢ç”¨<a href="http://supervisord.org/">Supervisor</a>ç®¡ç†ã€‚æ›´è¯¦ç»†çš„å®‰è£…æµç¨‹å‚è€ƒå®˜æ–¹æ–‡æ¡£<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Install Promtail | Grafana Loki documentation](https://grafana.com/docs/loki/latest/send-data/promtail/installation/)">[3]</span></a></sup>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ wget https://github.com/grafana/loki/releases/download/v2.9.3/promtail-linux-amd64.zip<br>$ unzip promtail-linux-amd64.zip &amp;&amp; <span class="hljs-built_in">rm</span> promtail-linux-amd64.zip<br>$ <span class="hljs-comment"># ä¸‹è½½é»˜è®¤é…ç½®æ–‡ä»¶</span><br>$ wget https://raw.githubusercontent.com/grafana/loki/main/clients/cmd/promtail/promtail-local-config.yaml<br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å¾ˆç®€å•ï¼šè¿ä¸ŠDocker daemonï¼Œå°†æ ‡ç­¾ä¸­å¸¦æœ‰<code>logging=promtail</code>çš„å®¹å™¨è¾“å‡ºå‘é€ç»™<code>localhost:3100</code>å¤„çš„lokiæœåŠ¡å™¨ã€‚å› ä¸ºè¦åŒºåˆ†å®¹å™¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜ç”¨å®¹å™¨åå’Œ<code>jobname</code>æ ‡ç­¾å€¼æ¥åŒºåˆ†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">http_listen_port:</span> <span class="hljs-number">9080</span><br>  <span class="hljs-attr">grpc_listen_port:</span> <span class="hljs-number">0</span><br><br><span class="hljs-attr">positions:</span><br>  <span class="hljs-attr">filename:</span> <span class="hljs-string">/tmp/positions.yaml</span><br><br><span class="hljs-attr">clients:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:3100/loki/api/v1/push</span><br><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">docker_containers</span><br>    <span class="hljs-attr">docker_sd_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">unix:///var/run/docker.sock</span><br>        <span class="hljs-attr">refresh_interval:</span> <span class="hljs-string">5s</span><br>        <span class="hljs-attr">filters:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">label</span><br>            <span class="hljs-attr">values:</span> [<span class="hljs-string">&quot;logging=promtail&quot;</span>]<br>    <span class="hljs-attr">relabel_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">&#x27;__meta_docker_container_name&#x27;</span>]<br>        <span class="hljs-attr">regex:</span> <span class="hljs-string">&#x27;/(.*)&#x27;</span><br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">&#x27;container&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">&#x27;__meta_docker_container_log_stream&#x27;</span>]<br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">&#x27;logstream&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">&#x27;__meta_docker_container_label_logging_jobname&#x27;</span>]<br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">&#x27;job&#x27;</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ä¹Ÿå¾ˆç®€å•ï¼Œè¿è¡Œï¼ˆæˆ–åœ¨ supervisoré…ç½®æ–‡ä»¶ä¸­è¾“å…¥ï¼‰å¦‚ä¸‹å‘½ä»¤å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./promtail-linux-amd64 -config.file promtail-local-config.yaml.yaml<br></code></pre></td></tr></table></figure><p>å¯åŠ¨åå°±å¯ä»¥ç”¨curlæˆ–æµè§ˆå™¨è®¿é—®9080ç«¯å£è¿›è¡ŒéªŒè¯äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ curl 127.0.0.1:9080<br>&lt;a href=<span class="hljs-string">&quot;/targets&quot;</span>&gt;See Other&lt;/a&gt;.<br></code></pre></td></tr></table></figure><h2 id="å®¹å™¨é…ç½®"><a href="#å®¹å™¨é…ç½®" class="headerlink" title="å®¹å™¨é…ç½®"></a>å®¹å™¨é…ç½®</h2><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¼šè®©promtailåªæŠ“å–ç‰¹å®šå®¹å™¨çš„æ—¥å¿—ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨ä¸šåŠ¡å®¹å™¨æ—¶å†™å…¥æ ‡ç­¾ã€‚ä»¥docker-composeæ–‡ä»¶ä¸ºä¾‹ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å†™å…¥ä¸¤ä¸ªæ ‡ç­¾å³å¯ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2.4&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">xxx-service:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">xxx-image:latest</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">logging:</span> <span class="hljs-string">&quot;promtail&quot;</span> <span class="hljs-comment"># è¡¨æ˜æ—¥å¿—éœ€è¦è¢«promtailæŠ“å–</span><br>      <span class="hljs-attr">logging_jobname:</span> <span class="hljs-string">&quot;xxx-service&quot;</span> <span class="hljs-comment"># å°†è¯¥å€¼åŠ å…¥æ—¥å¿—æ ‡ç­¾ï¼Œæ–¹ä¾¿åç»­æŸ¥çœ‹å’Œç­›é€‰æ—¥å¿—</span><br></code></pre></td></tr></table></figure><p>è¿™ä¹Ÿæ˜¯Lokiæ–¹æ¡ˆç›¸æ¯”ELK&#x2F;FEKæ–¹æ¡ˆçš„ä¸€ä¸ªä¼˜ç‚¹ï¼šåªéœ€è¦é‡å¯å®¹å™¨å°±å¯ä»¥æŠ“å–æ—¥å¿—ï¼Œä¸éœ€è¦é‡å¯DockeræœåŠ¡æœ¬èº«ã€‚</p><h2 id="Loki"><a href="#Loki" class="headerlink" title="Loki"></a>Loki</h2><p>Lokiç”¨äºæ¥æ”¶å®¹å™¨äº§ç”Ÿçš„æ—¥å¿—ã€‚ä»<a href="https://github.com/grafana/loki/releases">Github releases</a>é¡µå¯ä»¥ä¸‹è½½åˆ°æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ›´è¯¦ç»†çš„å®‰è£…æµç¨‹å‚è€ƒå®˜æ–¹æ–‡æ¡£<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Installation | Grafana Loki documentation](https://grafana.com/docs/loki/latest/setup/install/)">[4]</span></a></sup>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ wget https://github.com/grafana/loki/releases/download/v2.8.7/loki-linux-amd64.zip<br>$ unzip loki-linux-amd64.zip &amp;&amp; <span class="hljs-built_in">rm</span> loki-linux-amd64.zip<br>$ <span class="hljs-comment"># ä¸‹è½½é»˜è®¤é…ç½®æ–‡ä»¶</span><br>$ wget https://raw.githubusercontent.com/grafana/loki/main/cmd/loki/loki-local-config.yaml<br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å¾ˆç®€å•ï¼šç›‘å¬æœ¬æœº3100ç«¯å£ï¼Œå°†æ¥æ”¶åˆ°çš„æ—¥å¿—å­˜å‚¨åœ¨<code>/tmp/loki/chunks/</code>é‡Œã€‚ç¬”è€…ç”¨çš„å°±æ˜¯é»˜è®¤é…ç½®ï¼ˆæ›´è¯¦ç»†çš„é…ç½®è¯´æ˜å‚è€ƒå®˜æ–¹æ–‡æ¡£<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Grafana Loki configuration parameters | Grafana Loki documentation](https://grafana.com/docs/loki/latest/configure/)">[5]</span></a></sup>ï¼‰ï¼Œç›´æ¥å¯åŠ¨å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./loki-linux-amd64 -config.file loki-local-config.yaml<br></code></pre></td></tr></table></figure><p>å¯åŠ¨åå°±å¯ä»¥ç”¨curlæˆ–æµè§ˆå™¨è®¿é—®3100ç«¯å£è¿›è¡ŒéªŒè¯äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ curl 127.0.0.1:3100<br>404 page not found<br></code></pre></td></tr></table></figure><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><p>Grafanaçš„é…ç½®æ›´ç®€å•ã€‚è¾ƒæ–°ç‰ˆæœ¬çš„Grafanaå†…ç½®äº†å¯¹Lokiçš„æ”¯æŒï¼Œåœ¨ç½‘é¡µä¸­çš„Data sourcesé…ç½®é¡µé¢å¢åŠ ä¸€ä¸ªLokiæ•°æ®æºï¼Œè¾“å…¥Lokiçš„HTTPåœ°å€ï¼Œå°±å¯ä»¥åƒæ–‡ç« å¼€å¤´é‚£æ ·åœ¨Grafanaé¢æ¿çš„Exploreé¡µé¢é‡ŒæŸ¥è¯¢æ—¥å¿—äº†ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20231226162613619.webp" alt="data sourcesé…ç½®ç•Œé¢"></p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://docs.docker.com/config/containers/logging/configure/">Configure logging drivers | Docker Docs</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://www.atatus.com/blog/a-beginners-guide-for-grafana-loki/">A Beginnerâ€™s Guide for Grafana Loki (Open-source Log Aggregation by Prometheus)</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://grafana.com/docs/loki/latest/send-data/promtail/installation/">Install Promtail | Grafana Loki documentation</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://grafana.com/docs/loki/latest/setup/install/">Installation | Grafana Loki documentation</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://grafana.com/docs/loki/latest/configure/">Grafana Loki configuration parameters | Grafana Loki documentation</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>grafana</tag>
      
      <tag>æ—¥å¿—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŒ—äº¬åˆ°ä¸Šæµ·æ¬å®¶å°è®°</title>
    <link href="/2023/04/22/beijing-to-shanghai/"/>
    <url>/2023/04/22/beijing-to-shanghai/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>ç»è¿‡ä¸€ç•ªæ…é‡è€ƒè™‘ï¼Œç¬”è€…æœ€ç»ˆé€‰æ‹©ä¸Šæµ·ä½œä¸ºæœªæ¥ä¸€æ®µæ—¶é—´å·¥ä½œå’Œç”Ÿæ´»çš„åœ°æ–¹ã€‚</p><p>æ¥ä¸‹æ¥æœ€å¤§çš„æŒ‘æˆ˜æ¥è‡ªäºæ¬å®¶ï¼šä¸Šåƒå…¬é‡Œçš„è·ç¦»ã€ç¹å¤šçš„è¡Œæï¼ˆå‡é™æ¤…ã€å‡é™æ¡Œæ¡Œè…¿ã€å“‘é“ƒã€ITXä¸»æœºã€NASã€ç©ºæ°”å‡€åŒ–å™¨ã€åºŠä¸Šç”¨å“ã€è¡£ç‰©ã€ä¹¦ç±ç­‰ç­‰ï¼‰ã€‚</p><p>åŒæ—¶ï¼Œä¸ºäº†å‡å°‘æ¥å›å¥”æ³¢ï¼Œç¬”è€…æƒ³åœ¨ä¸Šæµ·ç§Ÿå¥½å…¬å¸é™„è¿‘çš„æˆ¿å­åç›´æ¥ä½ä¸‹ï¼Œ<strong>ä¸å†è¿”å›åŒ—äº¬</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªæ¬å®¶è¿‡ç¨‹éœ€è¦ä¸ºï¼š </p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">è¡Œæå‘å¾€ä¸Šæµ· -&gt; äººå‰å¾€ä¸Šæµ· -&gt; ç§Ÿå¥½æˆ¿å­ -&gt; æ¥æ”¶è¡Œæ<br></code></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« ï¼Œä¾¿æ˜¯åº”å¯¹è¿™ä¸ªè‰°å·¨ä»»åŠ¡çš„ç®€å•è®°å½•ã€‚</p><h1 id="2-æ–¹æ¡ˆé€‰æ‹©"><a href="#2-æ–¹æ¡ˆé€‰æ‹©" class="headerlink" title="2. æ–¹æ¡ˆé€‰æ‹©"></a>2. æ–¹æ¡ˆé€‰æ‹©</h1><blockquote><p><a href="https://v2ex.com/t/925040">è·¨çœæ¬å®¶æœ‰ä»€ä¹ˆé è°±çš„æ–¹æ¡ˆçš„å—ï¼Ÿ - V2EX</a></p><p><a href="https://v2ex.com/t/534112">æ±‚æ¨èæ¬å®¶å…¬å¸ï¼šä¸Šæµ·åˆ°æ­å· - V2EX</a></p><p><a href="https://www.v2ex.com/t/765610?p=1">ç»“æŸåŒ—æ¼‚ï¼Œæ¬å®¶ä¸œè¥¿å¤ªå¤šï¼Œé•¿é€”ç‰©æµå“ªå®¶å¼ºï¼Ÿ - V2EX</a></p><p><a href="https://www.v2ex.com/t/892974">è·¨åŸæ¬å®¶å¤§å®¶æœ‰æ“ä½œè¿‡ï¼Œæ±‚æ”¯æ‹› - V2EX</a></p></blockquote><p>æŒ‰ç¬”è€…çš„è°ƒæŸ¥ï¼Œè·¨åŸæ¬å®¶ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼šæ•´è½¦æ¬å®¶ã€å‘ç‰©æµã€‚</p><h2 id="2-1-æ•´è½¦æ¬å®¶"><a href="#2-1-æ•´è½¦æ¬å®¶" class="headerlink" title="2.1 æ•´è½¦æ¬å®¶"></a>2.1 æ•´è½¦æ¬å®¶</h2><p>è¯¥æ–¹æ¡ˆçš„æ„æ€æ˜¯åŒ…ä¸‹ä¸€è¾†ç®±å¼è´§è½¦ï¼Œå¾€å¾€ä¼šæ­é…ä¸Šæ¬å®¶å…¬å¸å‘¨åˆ°çš„è£…å¸æœåŠ¡ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ˜¯çœåŠ›çœå¿ƒã€æ—¶æ•ˆæ€§é«˜ï¼›ç¼ºç‚¹æ˜¯è´¹ç”¨è¾ƒé«˜ã€‚</p><p>æœ‰æœ‹å‹åœ¨ä»ç ä¸‰è§’æ¬åˆ°ä¸Šæµ·æ—¶é‡‡ç”¨äº†è¯¥æ–¹æ¡ˆï¼Œä»–çš„æƒ…å†µæ˜¯éœ€è¦å‘è¿ç”µè§†ã€å‡é™æ¤…ç­‰å¤§ä»¶ï¼Œä¸”æ²¡æœ‰åŸåŒ…è£…ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨è¿™ç§æ–¹æ¡ˆã€‚ä»–é€‰æ‹©çš„æ¬å®¶å…¬å¸æ˜¯è“çŠ€ç‰›ï¼Œæ€»èŠ±è´¹10000+ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230423084142995.webp"></p><p>ç”±äºè´¹ç”¨å¯¹äºç¬”è€…æ¥è¯´è¿‡äºé«˜æ˜‚ï¼Œè€Œä¸”é«˜æ—¶æ•ˆæ€§ä¹Ÿè®©ç¬”è€…å¾ˆéš¾åœ¨è¡Œæåˆ°è¾¾ä¸Šæµ·å‰ç§Ÿåˆ°åˆé€‚çš„æˆ¿å­ï¼Œæ‰€ä»¥ç¬”è€…ä¸è€ƒè™‘è¯¥æ–¹æ¡ˆã€‚</p><h2 id="2-2-å‘ç‰©æµ"><a href="#2-2-å‘ç‰©æµ" class="headerlink" title="2.2 å‘ç‰©æµ"></a>2.2 å‘ç‰©æµ</h2><p>è¯¥æ–¹æ¡ˆçš„æ„æ€æ˜¯è‡ªè¡Œæ‰“åŒ…è¡Œæï¼Œç„¶åäº¤ç»™ç‰©æµå…¬å¸ï¼ˆå¾·é‚¦ç‰©æµ&#x2F;é¡ºä¸°ç‰©æµç­‰ï¼‰æˆ–è€…ä¸ªä½“è´§è½¦ä¸»è¿›è¡Œè¿é€ï¼Œè¡Œæåˆ°è¾¾ç›®æ ‡åŸå¸‚åå†ç”±ç‰©æµæ–¹ä¸Šé—¨&#x2F;ä¸Šæ¥¼é€è´§ã€æˆ–è€…è‡ªæã€‚ä¼˜ç‚¹æ˜¯çœé’±ï¼Œç¼ºç‚¹æ˜¯åŠ³å¿ƒåŠ³åŠ›ã€æ—¶æ•ˆæ€§è¾ƒä½ã€‚</p><p>ç»è¿‡ç‰©æµå…¬å¸æä¾›çš„å·¥å…·é¢„ä¼°ï¼Œç¬”è€…çš„è¡Œææ€»è¿è´¹çº¦ä¸º1000å…ƒã€‚åŒæ—¶é€šè¿‡å’¨è¯¢å¿«é€’å‘˜ï¼Œç¬”è€…ç¡®å®šå¯ä»¥å…ˆåœ¨æ”¶ä»¶åœ°å€ä¸Šå†™ä¸ŠæŸä¸ªæ¨¡ç³Šåœ°å€ï¼ˆå¦‚åœ°é“ç«™é™„è¿‘ï¼‰ï¼Œå†åœ¨ç‰©æµæ´¾é€æ—¶å’Œå¿«é€’å‘˜åå•†å…·ä½“æ”¶ä»¶åœ°å€ã€‚</p><p>ç”±äºç¬”è€…çš„å¤§ä»¶ç‰©å“éƒ½å¸¦æœ‰åŸåŒ…è£…ï¼Œä¸”éœ€è¦åœ¨è¡Œæè¿è¾“è¿‡ç¨‹ä¸­åœ¨ä¸Šæµ·æ‰¾æˆ¿å­ï¼Œæ‰€ä»¥ç¬”è€…å†³å®šå‹æ¦¨ä¸‹è‡ªå·±çš„åŠ³åŠ¨åŠ›ï¼Œé‡‡ç”¨è¯¥æ–¹æ¡ˆæ¬å®¶ã€‚</p><h1 id="3-æ‰“åŒ…è¡Œæ"><a href="#3-æ‰“åŒ…è¡Œæ" class="headerlink" title="3. æ‰“åŒ…è¡Œæ"></a>3. æ‰“åŒ…è¡Œæ</h1><p>é™¤äº†å¤§ä»¶ç‰©å“è‡ªå¸¦çš„åŒ…è£…ç›’å¤–ï¼Œç¬”è€…è¿˜é¢å¤–è´­å…¥äº†5ä¸ªè§„æ ¼æ¯”è¾ƒå¸¸è§ï¼ˆ60cm*40cm*50cmï¼‰çš„æ¬å®¶æ‰“åŒ…ç›’ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230422165220093.webp"></p><p>ä¹‹åä¾¿æ˜¯è¾›è‹¦çš„æ‰“åŒ…è¿‡ç¨‹ã€‚æœ‰çš„å¤§ä»¶ç‰©å“æ¯”è¾ƒå®¹æ˜“æ”¾å…¥åŸåŒ…è£…ï¼Œä½†å‡é™æ¤…åˆ™éœ€è¦ç»è¿‡ç›¸å¯¹æš´åŠ›çš„æ‹†å¸è¿‡ç¨‹ï¼ˆå¦‚ä¸‹å›¾ä¸­è¢«é”¤å¾—å‘å‘æ´¼æ´¼çš„åº•åº§å’Œæ°”æŸ±ï¼Œå‚è€ƒè§†é¢‘<a href="https://www.bilibili.com/video/BV1mA411L7Hj/">ä¸€é”¤å­æ‹†æ‰è½¬æ¤…æ°”æ† æ€æ ·æ‹†å‡é™æ†&#x2F;æ¶²å‹æ† æ‹†ç”µè„‘æ¤…åº•ç›˜æ¤…è„š_å“”å“©å“”å“©_bilibili</a>ï¼‰</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230422155135469.webp"></p><p>è€ƒè™‘åˆ°è¡Œææœ‰å¯èƒ½ä¸¢å¤±ã€ä»¥åŠå¯èƒ½çš„ç´§æ€¥æƒ…å†µï¼Œç¬”è€…å°†é‡è¦æ–‡ä»¶æ”¾å…¥äº†éšæ—¶çš„è¡Œæç®±ä¸­ï¼›åŒæ—¶ä¸ºäº†è§„é¿å¯èƒ½çš„é£é™©ï¼Œç¬”è€…æ²¡æœ‰åœ¨æ‰“åŒ…çš„è¡Œæä¸­æ”¾å…¥å¹²ç”µæ± ã€åˆ€å…·ã€å‹ç¼©ç“¶ç½ã€‚æœ€åï¼Œç¬”è€…å…±æ‰“åŒ…å‡º14ä¸ªç®±å­ï¼ˆåŒ…æ‹¬æ·˜å®è´­ä¹°çš„5ä¸ªçº¸ç®±ï¼‰ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230422155648567.webp"></p><h1 id="4-ç‰©æµå‘å‡º"><a href="#4-ç‰©æµå‘å‡º" class="headerlink" title="4. ç‰©æµå‘å‡º"></a>4. ç‰©æµå‘å‡º</h1><p>ç¬”è€…å®‰æ’çš„æ—¶é—´è¡¨æ˜¯ä¸Šåˆå¯„å‡ºè¡Œæï¼Œæ¥ç€å¯¹åŒ—äº¬çš„ä½å¤„è¿›è¡Œé€€ç§Ÿï¼Œç„¶åä¸‹åˆ2ç‚¹æ­ä¹˜é«˜é“å‰å¾€ä¸Šæµ·ã€‚</p><p>ç¬”è€…åœ¨å‰ä¸€å¤©æ™šä¸Šé¢„çº¦äº†é¡ºä¸°ç‰©æµï¼Œæ”¶ä»¶åœ°å€ä¸º<strong>ä¸Šæµ·XXåœ°é“ç«™é™„è¿‘</strong>ï¼Œç¬¬äºŒå¤©9ç‚¹åˆ°10ç‚¹ä¸Šé—¨å–ä»¶ã€‚ä½†åˆ°äº†ç¬¬äºŒå¤©æ—©ä¸Šï¼Œåˆ†é…çš„å¿«é€’å‘˜è”ç³»æˆ‘è¯´å› ä¸ºè½¦ä¸Šæ²¡æœ‰è¶³å¤Ÿç©ºé—´å®¹çº³è¿™ä¹ˆç®±å­ï¼Œæ‰€ä»¥ä¸‹åˆæ‰èƒ½è¿‡æ¥å–ä»¶ã€‚ç¬”è€…è½¬è€Œé¢„çº¦äº†å¾·é‚¦ç‰©æµï¼Œå¾—åˆ°äº†ç›¸åŒçš„ç­”å¤ã€‚</p><p>æ‡µé€¼çš„ç¬”è€…åªå¥½å†æ¬¡é¢„çº¦äº†äº¬ä¸œå¿«é€’ï¼Œäº¬ä¸œå¿«é€’å°å“¥å¬é—»åç«‹å³ç«é€Ÿä¸Šé—¨è¿›è¡Œå–ä»¶ã€‚ç”±äºå°å“¥çš„ä¸‰è½®è½¦ä¹Ÿæ²¡æœ‰è¶³å¤Ÿç©ºé—´å®¹çº³æ‰€æœ‰ç®±å­ï¼Œæ‰€ä»¥å–ä»¶ä¸­é€”å°å“¥è¿˜å›äº†ä¸€è¶Ÿå¿«é€’ç½‘ç‚¹ï¼ˆè¿˜å¥½ç¬”è€…çš„ä½å¤„ç¦»ç½‘ç‚¹ä¸è¿œï¼‰ï¼Œç„¶åç»§ç»­å–ä»¶ï¼Œæœ€ç»ˆåœ¨11ç‚¹å‡ºå¤´å°†æ‰€æœ‰ç®±å­å–èµ°ï¼Œæ€»è€—æ—¶åŠä¸ªå¤šå°æ—¶ã€‚</p><p>å’Œä¸­ä»‹å•†é‡å¥½é€€ç§Ÿäº‹å®œåï¼Œç¬”è€…è¸ä¸Šäº†å‰å¾€ä¸Šæµ·çš„é«˜é“ã€‚éšåå¿«é€’å‘˜å‘æ¥çš„æ½æ”¶è´¦å•æ˜¾ç¤ºï¼Œè¡Œææ€»ä½“ç§¯1.57ç«‹æ–¹ç±³ï¼Œæ€»é‡é‡255åƒå…‹ï¼Œè¿è´¹1700+å…ƒã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230422170759849.webp"></p><h1 id="5-ç‰©æµæ¥æ”¶"><a href="#5-ç‰©æµæ¥æ”¶" class="headerlink" title="5. ç‰©æµæ¥æ”¶"></a>5. ç‰©æµæ¥æ”¶</h1><p>ç¬”è€…åœ¨å‘å‡ºè¡Œæå½“å¤©æŠµè¾¾ä¸Šæµ·åï¼Œç«‹å³å’Œä¸­ä»‹å¼€å§‹äº†çœ‹æˆ¿ä¹‹æ—…ã€‚åœ¨å®åœ°çœ‹äº†9å¥—æˆ¿åï¼Œç¬”è€…åœ¨ç¬¬äºŒå¤©ç­¾ä¸‹äº†ç§Ÿæˆ¿åˆåŒå¹¶å…¥ä½ï¼ˆä¸­ä»‹å¤§å§ç”šè‡³ç»™ç¬”è€…å€Ÿäº†æ¯›æ¯¯å’ŒåºŠå•åº”æ€¥ä½¿ç”¨ï¼‰ã€‚</p><p>ç¡®å®šäº†ä½å€åï¼Œç¬”è€…å°è¯•åœ¨äº¬ä¸œå°ç¨‹åºä¸Šä¿®æ”¹è¡ŒæåŒ…è£¹çš„æ”¶ä»¶åœ°å€ï¼šä»<strong>ä¸Šæµ·XXåœ°é“ç«™é™„è¿‘</strong>æ”¹ä¸º<strong>XXå°åŒºXXå·XXX</strong>ã€‚ä½†æ”¯ä»˜çš„5å…ƒæœåŠ¡è´¹è²Œä¼¼å¹¶æ²¡æœ‰èµ·åˆ°æ•ˆæœï¼Œå› ä¸ºæ•°å¤©åå¿«é€’å°å“¥ä¸Šé—¨é€è´§æ—¶å¹¶ä¸æ¸…æ¥šæˆ‘ä¿®æ”¹åçš„åœ°å€ï¼Œè€Œæ˜¯åœ¨æ²Ÿé€šç”µè¯é‡Œå£å¤´çº¦å®šäº†å…·ä½“åœ°å€ã€‚ç”±äºå¯„ä»¶ä¸‹å•æ—¶æ²¡çœ‹åˆ°â€œé€è´§ä¸Šæ¥¼â€çš„æœåŠ¡é€‰é¡¹ï¼ˆé¡ºä¸°å’Œå¾·é‚¦æœ‰ï¼‰ï¼Œæ‰€ä»¥ä¸Šé—¨æ—¶ä¸´æ—¶è®©å¿«é€’å°å“¥å¢åŠ äº†ä¸Šæ¥¼çš„æœåŠ¡ï¼Œå¹¶è½¬å¸äº†100å…ƒä½œä¸ºæŠ¥é…¬ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230423082456690.webp"></p><p>æ·˜å®ä¹°çš„5ä¸ªæ¬å®¶ç®±å­çŠ¶æ€æ¯”è¾ƒè‰¯å¥½ï¼Œä½†è¢«å­&#x2F;æ•å¤´&#x2F;æ˜¾ç¤ºå™¨çš„åŸåŒ…è£…ç›’å‡ºç°äº†ä¸åŒç¨‹åº¦çš„å˜å½¢ã€‚æ˜¾ç¤ºå™¨å‡ºç°äº†å¥½å‡ ä¸ªä¸å¯æ¢å¤çš„ç´«è‰²æ–‘ç‚¹ï¼Œè™½ç„¶åªæœ‰åœ¨é»‘è‰²èƒŒæ™¯ä¸‹æ‰æ¯”è¾ƒæ˜æ˜¾ï¼Œä½†ä¹Ÿè¯´æ˜åŸåŒ…è£…ç›’å¹¶ä¸æ˜¯100%å¯é ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230423082713935.webp"></p><h1 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h1><p>æ•´ä¸ªæ¬å®¶çš„æ—¶é—´çº¿ä¸ºï¼š</p><ul><li>å‘¨æ—¥ï¼šæ‰“åŒ…è¡Œæ</li><li>å‘¨ä¸€ï¼šå¯„å‡ºè¡Œæã€é€€ç§Ÿã€å‰å¾€ä¸Šæµ·ã€çœ‹æˆ¿</li><li>å‘¨äºŒï¼šçœ‹æˆ¿ã€ç­¾ç§Ÿæˆ¿åˆåŒ</li><li>å‘¨å››ï¼šæ”¶åˆ°è¡Œæ</li></ul><p>è™½ç„¶æ€»ä½“è€Œè¨€è¿˜ç®—é¡ºåˆ©ï¼Œä½†ä¾ç„¶å¾—åˆ°äº†ä¸å°‘ç»éªŒæ•™è®­ï¼š</p><ul><li>æ‰“åŒ…ç›’å­å¤šè¿‡ï¼Œå¹³å‡æ¯ä¸ªç›’å­è¿è´¹100+å…ƒï¼Œéƒ¨åˆ†ç›’å­æœ¬èº«ä»·å€¼æœ‰é™ã€‚</li><li>å‘¨ä¸€æ—¶é—´å®‰æ’è¿‡äºç´§å¼ ï¼Œå¯¹æ„å¤–æƒ…å†µå®¹å¿èƒ½åŠ›è¾ƒå·®ã€‚</li><li>è¿‡åº¦ä¾èµ–åŸåŒ…è£…ï¼Œå¢åŠ ç‰©å“æŸåé£é™©ã€‚</li></ul><p>æœ€åï¼ŒæœŸå¾…åœ¨ä¸Šæµ·çš„æ–°ç”Ÿæ´»ï¼</p>]]></content>
    
    
    
    <tags>
      
      <tag>ç”Ÿæ´»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å·å¤©æ¢æ—¥2.0ï¼šç¯¡æ”¹å…‰çŒ«çš„IPv6åœ°å€è‡ªåŠ¨åˆ†é…</title>
    <link href="/2023/02/17/modify-slaac/"/>
    <url>/2023/02/17/modify-slaac/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><blockquote><p>è¿™æ˜¯ä¸€ç¯‡ç¥å¥‡çš„æ–‡ç« ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œä½ å°†ä¼šçœ‹åˆ°ï¼š</p><ul><li>å¦‚ä½•å°†ä¸€å°åŒå£linuxè®¾å¤‡å˜æˆä¸€å°äº¤æ¢æœº</li><li>å¦‚ä½•ä¿®æ”¹ICMPv6æ•°æ®åŒ…ä¸­çš„DNSä¿¡æ¯å¹¶å‘é€IPv6æ•°æ®åŒ…</li><li>å¦‚ä½•ä¿®æ”¹IPv6æ•°æ®åŒ…ä¸­çš„æ¥æºIPåœ°å€å¹¶å‘é€ä»¥å¤ªç½‘å¸§</li></ul></blockquote><p>ä¸‹å›¾æ˜¯ç¬”è€…çš„ç½‘ç»œæ¶æ„ï¼ˆéƒ¨åˆ†ï¼‰ã€‚PCè‡ªåŠ¨ä»å…‰çŒ«å¤„è·å–IPv6åœ°å€ï¼Œå¹¶å°†å…¶ç½‘å…³&#x2F;DNSæŒ‡å‘å…‰çŒ«ï¼š</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20230217.slaac-default.svg" alt="ç¬”è€…å®¶åº­ç½‘ç»œæ¶æ„"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230217094605079.webp" style="zoom:33%;" /></th></tr></thead></table><p>ä½†å…‰çŒ«çš„DNSå­˜åœ¨DNSæ±¡æŸ“ã€æ— æ³•è‡ªå®šä¹‰è§£æè§„åˆ™ç­‰é—®é¢˜ï¼Œä¸”å®‰å“è®¾å¤‡æ— æ³•æ‰‹åŠ¨è®¾ç½®IPv6çš„DNSï¼Œæ‰€ä»¥ç¬”è€…åœ¨ä¹‹å‰çš„æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6](/2022/12/17/%E5%AE%89%E5%8D%93%E5%AF%B9%E6%8C%87%E5%AE%9AWiFi%E7%A6%81%E7%94%A8IPv6/)">[1]</span></a></sup><sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…](/2022/12/28/%E5%81%B7%E5%A4%A9%E6%8D%A2%E6%97%A5%EF%BC%9A%E5%B1%8F%E8%94%BD%E5%85%89%E7%8C%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8D/)">[2]</span></a></sup>é‡Œç›´æ¥ç¦ç”¨äº†å…‰çŒ«çš„IPv6åœ°å€è‡ªåŠ¨åˆ†é…ï¼Œå®¶åº­å±€åŸŸç½‘å†…åŸºæœ¬åªä½¿ç”¨IPv4ã€‚</p><p>ä½†ç¦ç”¨IPv6å§‹ç»ˆæ˜¯ä¸ªç¼ºæ†¾ã€‚æœ‰æ²¡æœ‰å¯èƒ½å®ç°ï¼Œ<strong>åœ¨ä¿ç•™å…‰çŒ«IPv6åœ°å€è‡ªåŠ¨åˆ†é…çš„åŸºç¡€ä¸Šï¼Œå®ç°è‡ªå®šä¹‰DNS</strong>å‘¢ï¼Ÿè¿™æ˜¯æœ¬æ–‡æƒ³è¦è®¨è®ºçš„é—®é¢˜ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20230217.slaac-expect.svg" alt="é¢„æœŸç½‘ç»œæ¶æ„"></p><h1 id="2-æ€è·¯"><a href="#2-æ€è·¯" class="headerlink" title="2. æ€è·¯"></a>2. æ€è·¯</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/ipv6-stateless-address-autoconfiguration.gif"></p><p>åŸºäºä¸Šé¢çš„åŠ¨å›¾å›é¡¾ä¸€ä¸‹IPv6 SLAACåœ°å€è‡ªåŠ¨åˆ†é…çš„åŸç†ï¼š</p><ul><li>PC1å‘å±€åŸŸç½‘å¹¿æ’­ICMPv6 <strong>Router Solicitation</strong>ï¼ˆRSï¼‰æ•°æ®åŒ…</li><li>è·¯ç”±å™¨æ”¶åˆ°RSåŒ…åå¹¿æ’­ICMPv6 <strong>Router Advertisement</strong> (RA)æ•°æ®åŒ…</li><li>PC1æ”¶åˆ°RAæ•°æ®åŒ…åå¾—çŸ¥IPv6ç½‘æ®µå‰ç¼€ï¼Œå¹¶ç”Ÿæˆè‡ªå·±çš„IPv6åœ°å€</li></ul><p>å…·ä½“åˆ°ç¬”è€…çš„ç¯å¢ƒï¼Œå…‰çŒ«å‘å‡ºçš„RAåŒ…é‡Œè¿˜æºå¸¦äº†é™„åŠ çš„DNSæœåŠ¡å™¨åœ°å€ä¿¡æ¯ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221228232047709.webp"></p><p>é‚£ä¹ˆå®ç°è‡ªå®šä¹‰DNSçš„æ€è·¯å°±æ¯”è¾ƒæ˜ç¡®äº†ï¼š</p><ul><li>PCæ­£å¸¸å‘å±€åŸŸç½‘å¹¿æ’­RSæ•°æ®åŒ…</li><li>å¢åŠ ä¸€å°è½¯äº¤æ¢æœºï¼Œè®©PCæ— æ³•ç›´æ¥æ”¶åˆ°å…‰çŒ«å¹¿æ’­çš„RAæ•°æ®åŒ…</li><li>è½¯äº¤æ¢æœºæ”¶åˆ°å…‰çŒ«å¹¿æ’­çš„RAæ•°æ®åŒ…åï¼Œä¿®æ”¹å…¶ä¸­çš„DNSä¿¡æ¯ï¼Œå¹¶é‡æ–°è¿›è¡Œå¹¿æ’­</li><li>PCæ”¶åˆ°ä¿®æ”¹åçš„RAæ•°æ®åŒ…ï¼Œç”Ÿæˆè‡ªå·±çš„IPv6åœ°å€</li></ul><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20230218.slaac-plan.svg" alt="æ”¹é€ æ€è·¯"></p><h1 id="3-è®¾ç½®è½¯äº¤æ¢æœº"><a href="#3-è®¾ç½®è½¯äº¤æ¢æœº" class="headerlink" title="3. è®¾ç½®è½¯äº¤æ¢æœº"></a>3. è®¾ç½®è½¯äº¤æ¢æœº</h1><p>ç¬”è€…ä½¿ç”¨å¹¿å—å¥½è¯„çš„å‹å–„NanoPi R2Sä½œä¸ºè¿™é‡Œçš„è½¯äº¤æ¢æœºï¼Œç³»ç»Ÿåˆ™ä½¿ç”¨çš„æ˜¯å‹å–„Ubuntu Core 20.04æ”¹ç‰ˆã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230218111856330.webp" alt="å‹å–„R2S"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20230218.network_arch.svg"></th></tr></thead></table><p>å°†å…‰çŒ«å’ŒPCåˆ†åˆ«è¿æ¥è‡³R2Sçš„ä¸¤ä¸ªç½‘å£åï¼Œåœ¨Ubuntuä¸Šé…ç½®ä¸€ä¸ªè¿æ¥ä¸¤ä¸ªç½‘å£çš„ç½‘æ¡¥ï¼Œå³å¯è®©R2SåŒ–èº«ä¸€å°è½¯äº¤æ¢æœºï¼ˆè¯¦ç»†è¯´æ˜è§Ubuntuç¤¾åŒºæ–‡æ¡£ï¼š<a href="https://help.ubuntu.com/community/NetworkConnectionBridge">NetworkConnectionBridge - Community Help Wiki</a>ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install bridge-utils<br>sudo vim /etc/network/interfaces.d/br0<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">auto</span> <span class="hljs-string">br0</span><br><span class="hljs-string">iface</span> <span class="hljs-string">br0</span> <span class="hljs-string">inet</span> <span class="hljs-string">static</span><br>   <span class="hljs-string">address</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.5</span><br>   <span class="hljs-string">netmask</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span><br>   <span class="hljs-string">gateway</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><br>   <span class="hljs-comment"># dns-nameservers 192.168.1.1</span><br>   <span class="hljs-string">bridge_ports</span> <span class="hljs-string">eth0</span> <span class="hljs-string">eth1</span><br>   <span class="hljs-string">bridge_stp</span> <span class="hljs-string">off</span><br>   <span class="hljs-string">bridge_fd</span> <span class="hljs-number">0</span><br>   <span class="hljs-string">bridge_maxwait</span> <span class="hljs-number">0</span><br><span class="hljs-string">iface</span> <span class="hljs-string">br0</span> <span class="hljs-string">inet6</span> <span class="hljs-string">auto</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo /etc/init.d/networking restart<br></code></pre></td></tr></table></figure><p>é…ç½®å¥½åå¯é€šè¿‡<code>brctl</code>å‘½ä»¤å¯ä»¥çœ‹åˆ°æ•ˆæœï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230218113942408.webp"></p><p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<code>ebtables</code>ç¦æ­¢æ¥è‡ªå…‰çŒ«çš„RAåŒ…å¹¿æ’­åˆ°ç½‘æ¡¥ä¸Šçš„å…¶å®ƒè®¾å¤‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo ebtables -A FORWARD -p IPv6 -s &#123;å…‰çŒ«MACåœ°å€&#125; --ip6-proto ipv6-icmp --ip6-icmp-type router-advertisement -j DROP<br></code></pre></td></tr></table></figure><h1 id="4-ä¿®æ”¹ICMPv6æ•°æ®åŒ…"><a href="#4-ä¿®æ”¹ICMPv6æ•°æ®åŒ…" class="headerlink" title="4. ä¿®æ”¹ICMPv6æ•°æ®åŒ…"></a>4. ä¿®æ”¹ICMPv6æ•°æ®åŒ…</h1><p>æ¥ç€æˆ‘ä»¬éœ€è¦åœ¨è¿™å°è½¯äº¤æ¢æœºä¸Šå¯¹ICMPv6 RAæ•°æ®åŒ…è¿›è¡ŒåŠ å·¥ã€‚æ•´ä½“é€»è¾‘å¹¶ä¸å¤æ‚ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">for &#123;<br>ç›‘å¬ICMPv6æ•°æ®åŒ…<br>è¿‡æ»¤RAæ•°æ®åŒ…<br>ä¿®æ”¹å…¶ä¸­çš„DNSä¿¡æ¯<br>å¹¿æ’­ä¿®æ”¹åçš„RAæ•°æ®åŒ…<br>&#125;<br></code></pre></td></tr></table></figure><p>Golangçš„å®˜æ–¹åŒ…<a href="https://pkg.go.dev/golang.org/x/net/icmp">golang.org&#x2F;x&#x2F;net&#x2F;icmp</a>èƒ½å¾ˆæ–¹ä¾¿åšåˆ°è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    mcastIP = net.ParseIP(<span class="hljs-string">&quot;ff02::1&quot;</span>) <span class="hljs-comment">// ç»„æ’­ip</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <br>    c, err := icmp.ListenPacket(<span class="hljs-string">&quot;ip6:ipv6-icmp&quot;</span>, <span class="hljs-string">&quot;::&quot;</span>) <span class="hljs-comment">// ç›‘å¬ICMPv6æ•°æ®åŒ…</span><br>    ...<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// ç›‘å¬ICMPv6æ•°æ®åŒ…</span><br>        rb := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">1500</span>)<br>n, peer, err := c.ReadFrom(rb)<br>        ...<br>        <span class="hljs-keyword">var</span> zone <span class="hljs-type">string</span><br><span class="hljs-keyword">if</span> parts := strings.SplitN(peer.String(), <span class="hljs-string">&quot;%&quot;</span>, <span class="hljs-number">2</span>); <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">2</span> &#123;<br>zone = parts[<span class="hljs-number">1</span>]<br>&#125;<br>        ...<br>        <span class="hljs-comment">// è¿‡æ»¤RAæ•°æ®åŒ…</span><br>        <span class="hljs-keyword">const</span> ProtocolIPv6ICMP = <span class="hljs-number">58</span><br>        rm, err := icmp.ParseMessage(ProtocolIPv6ICMP, rb[:n])<br>        ...<br>        <span class="hljs-keyword">if</span> rm.Type != ipv6.ICMPTypeRouterAdvertisement &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>        body, err = rm.Body.Marshal(<span class="hljs-type">int</span>(ipv6.ICMPTypeRouterAdvertisement))<br>        ...<br>        <span class="hljs-comment">// ä¿®æ”¹å…¶ä¸­çš„DNSä¿¡æ¯</span><br>        err = replaceDNS(body)<br>        ...<br>        rm.Body = &amp;icmp.RawBody&#123;Data: body&#125;<br>        <br>        <span class="hljs-comment">// å¹¿æ’­ä¿®æ”¹åçš„RAæ•°æ®åŒ…</span><br>        wb, err := rm.Marshal(<span class="hljs-literal">nil</span>)<br>...<br>_, err = c.WriteTo(wb, &amp;net.IPAddr&#123;IP: mcastIP, Zone: zone&#125;)<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜çš„å…³é”®åœ¨äºå¦‚ä½•ä¿®æ”¹RAæ•°æ®åŒ…ä¸­çš„DNSã€‚è™½ç„¶é€šè¿‡åˆ†æWiresharkæŠ“åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—DNSåœ¨RAæ•°æ®åŒ…ä¸­çš„å…·ä½“ä½ç½®ï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰ï¼Œä½†è¿™ç§ä¾èµ–Magic Numberçš„ä»£ç æ˜¾ç„¶ç¼ºå°‘é€šç”¨æ€§ã€‚</p><p>ç»´åŸºç™¾ç§‘<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ICMPv6 - Wikipedia](https://en.wikipedia.org/wiki/ICMPv6)">[4]</span></a></sup>å’ŒRFC6106<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[RFC 6106: IPv6 Router Advertisement Options for DNS Configuration](https://www.rfc-editor.org/rfc/rfc6106)">[5]</span></a></sup>ä»‹ç»äº†RAæ•°æ®åŒ…ã€DNS Optionçš„å…·ä½“æ ¼å¼ï¼š</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219103231373.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219102422222.webp"></th></tr></thead></table><p>äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒRAæ•°æ®åŒ…çš„16å­—èŠ‚åæ˜¯OptionsåŒºåŸŸï¼ˆ<code>icmp</code>åº“å·²å»é™¤äº†å‰4ä¸ªå­—èŠ‚ï¼‰ã€Optionçš„å‰ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«æ˜¯ç±»å‹å’ŒOptioné•¿åº¦ï¼ˆä»¥8å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åˆ—ä»£ç æŸ¥æ‰¾å¹¶æ›¿æ¢RAåŒ…ä¸­çš„DNSåœ°å€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    routerIP = net.ParseIP(<span class="hljs-string">&quot;fe80::1&quot;</span>) <span class="hljs-comment">// å…‰çŒ«ip</span><br>    dnsIP = net.ParseIP(<span class="hljs-string">&quot;fe80::xx&quot;</span>) <span class="hljs-comment">// è‡ªå®šä¹‰dnsæœåŠ¡å™¨ip</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">replaceDNS</span><span class="hljs-params">(body []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">for</span> idx := <span class="hljs-number">12</span>; idx &lt; <span class="hljs-built_in">len</span>(body)<span class="hljs-number">-1</span>; idx += <span class="hljs-type">int</span>(body[idx+<span class="hljs-number">1</span>]) * <span class="hljs-number">8</span> &#123; <span class="hljs-comment">// éå†æ‰€æœ‰option</span><br><span class="hljs-keyword">const</span> optTypeDNS = <span class="hljs-number">25</span><br><span class="hljs-keyword">if</span> optType := body[idx]; optType == optTypeDNS &#123; <span class="hljs-comment">// å®šä½dns option</span><br>ipL, ipR := idx+<span class="hljs-number">8</span>, idx+<span class="hljs-number">8</span>+<span class="hljs-number">16</span><br><span class="hljs-keyword">if</span> oldDNS := body[ipL:ipR]; !reflect.DeepEqual(oldDNS, []<span class="hljs-type">byte</span>(routerIP)) &#123; <span class="hljs-comment">// é˜²æ­¢é€’å½’æ›¿æ¢</span><br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;dns in RA (%s) not equal %s&quot;</span>, net.IP(oldDNS), routerIP)<br>&#125;<br>_ = <span class="hljs-built_in">append</span>(body[ipL:ipL], dnsIP...) <span class="hljs-comment">// åŸåœ°æ›¿æ¢dns ip</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;dns option not found&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="5-ä¿®æ”¹IPv6æ•°æ®åŒ…"><a href="#5-ä¿®æ”¹IPv6æ•°æ®åŒ…" class="headerlink" title="5. ä¿®æ”¹IPv6æ•°æ®åŒ…"></a>5. ä¿®æ”¹IPv6æ•°æ®åŒ…</h1><p>WiresharkæŠ“åŒ…çš„ç»“æœæ˜¾ç¤ºPCç¡®å®æ”¶åˆ°äº†ä¿®æ”¹åçš„RAæ•°æ®åŒ…ï¼Œä½†PCå´å¹¶æ²¡æœ‰åƒé¢„æƒ³çš„é‚£æ ·æ­£å¸¸è·å–åˆ°IPv6åœ°å€ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219201849810.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219202107580.webp"></th></tr></thead></table><p>ç”±äºPCæ”¶åˆ°çš„æ˜¯è½¯äº¤æ¢æœºé‡æ–°å¹¿æ’­çš„RAåŒ…ï¼Œæ‰€ä»¥å…¶IPv6æ•°æ®åŒ…é¦–éƒ¨çš„æ¥æºIPåœ°å€å˜æˆäº†è½¯äº¤æ¢æœºçš„IPv6åœ°å€ï¼ˆ<code>fe80::1c:xx</code>ï¼‰ï¼Œè€Œä¸æ˜¯åŸå§‹RAåŒ…ä¸­çš„å…‰çŒ«IPv6åœ°å€ï¼ˆ<code>fe80::1</code>ï¼‰ã€‚æ­¤æ—¶ç¬”è€…æœ‰äº†ä¸€ä¸ªå¤§èƒ†çš„çŒœæƒ³ï¼Œæ˜¯ä¸æ˜¯è¿™ä¸ªæ¥æºIPåœ°å€çš„é—®é¢˜å‘¢ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬åªè¦èƒ½å†ä¿®æ”¹è¿™ä¸ªå€¼ï¼Œå°±èƒ½è®©PCæ­£å¸¸è·å–åˆ°IPv6åœ°å€äº†ã€‚</p><p>è¦ä¿®æ”¹è¿™ä¸ªåœ°å€ï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li><p>é‡æ–°è®¡ç®—ICMPv6åŒ…çš„æ ¡éªŒå’Œã€‚ç»´åŸº<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ICMPv6 - Wikipedia](https://en.wikipedia.org/wiki/ICMPv6)">[4]</span></a></sup>ä¸Šä»‹ç»æ ¡éªŒå’Œéœ€è¦æ„é€ åŒ…å«æ¥æº&#x2F;ç›®æ ‡IPåœ°å€çš„<code>pseudo-header</code>ï¼Œè¿˜å¥½ä¸Šæ–‡æåˆ°çš„<code>icmp</code>åº“å·²ç»å°è£…äº†è¿™ä¸ªåŠŸèƒ½ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    routerIP = net.ParseIP(<span class="hljs-string">&quot;fe80::1&quot;</span>) <span class="hljs-comment">// å…‰çŒ«ip</span><br>    mcastIP = net.ParseIP(<span class="hljs-string">&quot;ff02::1&quot;</span>) <span class="hljs-comment">// ç»„æ’­ip</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    ...<br>    <span class="hljs-keyword">for</span> &#123;<br>       ...<br>        <span class="hljs-comment">// ä¿®æ”¹å…¶ä¸­çš„DNSä¿¡æ¯</span><br>        err = replaceDNS(body)<br>        ...<br>        rm.Body = &amp;icmp.RawBody&#123;Data: body&#125;<br>        <br>        <span class="hljs-comment">// è‡ªå®šä¹‰pseudo-headerï¼Œé‡è®¡ç®—æ ¡éªŒå’Œ</span><br>        head := icmp.IPv6PseudoHeader(routerIP, mcastIP)<br>        wb, err := rm.Marshal(head)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            ...<br>        &#125;<br>        <span class="hljs-comment">// å¹¿æ’­ä¿®æ”¹åçš„RAæ•°æ®åŒ…</span><br>        err = sendMsg(zone, wb)<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>é¿å…ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®æ¥æºIPåœ°å€ï¼Œæ¯”å¦‚ç›´æ¥å‘é€æ„é€ å¥½çš„ä»¥å¤ªç½‘æ•°æ®å¸§ã€‚ç»è¿‡ä¸€ç•ªæœå¯»ï¼Œç¬”è€…å‘ç°stackoverflowä¸Š<sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6 - Wikipedia](https://en.wikipedia.org/wiki/IPv6)">[7]</span></a></sup>å·²ç»æœ‰äººæä¾›äº†ç±»ä¼¼çš„demoï¼Œç¬”è€…åªéœ€è¦å‚è€ƒIPv6æ•°æ®åŒ…çš„æ ¼å¼<sup id="fnref:8" class="footnote-ref"><a href="#fn:8" rel="footnote"><span class="hint--top hint--rounded" aria-label="[go - Send custom ethernet packet using raw socket - Stack Overflow](https://stackoverflow.com/questions/70655602/send-custom-ethernet-packet-using-raw-socket)">[8]</span></a></sup>ç»„è£…IPv6æ•°æ®å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(zone <span class="hljs-type">string</span>, icmpBody []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// æŒ‡å®šæ¥æºmacåœ°å€&amp;ç›®æ ‡macåœ°å€</span><br>iface, err := net.InterfaceByName(zone)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;get link by name failed: %w&quot;</span>, err)<br>&#125;<br>srcMac := iface.HardwareAddr<br>dstMac := []<span class="hljs-type">byte</span>&#123;<span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>&#125; <span class="hljs-comment">// IPv6mcast_01</span><br><span class="hljs-comment">// ç»„è£…ä»¥å¤ªç½‘å¸§å¤´éƒ¨</span><br>data := []<span class="hljs-type">byte</span>&#123;<br>dstMac[<span class="hljs-number">0</span>], dstMac[<span class="hljs-number">1</span>], dstMac[<span class="hljs-number">2</span>], dstMac[<span class="hljs-number">3</span>], dstMac[<span class="hljs-number">4</span>], dstMac[<span class="hljs-number">5</span>],<br>srcMac[<span class="hljs-number">0</span>], srcMac[<span class="hljs-number">1</span>], srcMac[<span class="hljs-number">2</span>], srcMac[<span class="hljs-number">3</span>], srcMac[<span class="hljs-number">4</span>], srcMac[<span class="hljs-number">5</span>],<br><span class="hljs-number">0x86</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-comment">// Type: IPv6</span><br>&#125;<br><span class="hljs-comment">// ç»„è£…IPv6å¤´éƒ¨</span><br>length := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">2</span>)<br>binary.BigEndian.PutUint16(length, <span class="hljs-type">uint16</span>(<span class="hljs-built_in">len</span>(icmpBody)))<br>data = <span class="hljs-built_in">append</span>(data, []<span class="hljs-type">byte</span>&#123;<br><span class="hljs-number">0x60</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-comment">// ipv6.version</span><br>length[<span class="hljs-number">0</span>], length[<span class="hljs-number">1</span>], <span class="hljs-comment">// Payload Length</span><br><span class="hljs-number">0x3a</span>, <span class="hljs-comment">// Next Header: ICMPv6 (58)</span><br><span class="hljs-number">0xff</span>, <span class="hljs-comment">// Hop Limit: 255</span><br>&#125;...)<br>data = <span class="hljs-built_in">append</span>(data, routerIP...) <span class="hljs-comment">// æ¥æºipåœ°å€</span><br>data = <span class="hljs-built_in">append</span>(data, mcastIP...) <span class="hljs-comment">// ç›®æ ‡ipåœ°å€</span><br>    <span class="hljs-comment">// ç»„è£…ICMPv6æ•°æ®</span><br>data = <span class="hljs-built_in">append</span>(data, icmpBody...)<br><br><span class="hljs-comment">// å‘é€ä»¥å¤ªç½‘å¸§</span><br>fd, err := syscall.Socket(syscall.AF_PACKET, syscall.SOCK_RAW, <span class="hljs-type">int</span>(htons(syscall.ETH_P_ALL)))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;call socket failed: %w&quot;</span>, err)<br>&#125;<br>addr := syscall.SockaddrLinklayer&#123;<br>Ifindex: iface.Index,<br>Halen:   <span class="hljs-number">6</span>, <span class="hljs-comment">// Ethernet address length is 6 bytes</span><br>Addr:    [<span class="hljs-number">8</span>]<span class="hljs-type">byte</span>&#123;dstMac[<span class="hljs-number">0</span>], dstMac[<span class="hljs-number">1</span>], dstMac[<span class="hljs-number">2</span>], dstMac[<span class="hljs-number">3</span>], dstMac[<span class="hljs-number">4</span>], dstMac[<span class="hljs-number">5</span>]&#125;,<br>&#125;<br>err = syscall.Sendto(fd, data, <span class="hljs-number">0</span>, &amp;addr)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;call sendto failed: %w&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h1 id="6-æ•ˆæœ"><a href="#6-æ•ˆæœ" class="headerlink" title="6. æ•ˆæœ"></a>6. æ•ˆæœ</h1><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219210347954.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20230219210512956.webp"></th></tr></thead></table><p>æœ€åçš„æ•ˆæœè¯æ˜ç¬”è€…çš„çŒœæƒ³æ²¡é”™ã€‚åœ¨æ‰‹åŠ¨å°†IPv6æ•°æ®åŒ…çš„æ¥æºIPåœ°å€è®¾ç½®ä¸º<code>fe80::1</code>åï¼ŒPCæ­£å¸¸è·å–åˆ°äº†IPv6åœ°å€ï¼Œå¹¶è®¾ç½®äº†è‡ªå®šä¹‰DNSã€‚å”¯ä¸€ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒPCçš„é¦–é€‰DNSåœ°å€åœ°å€è¿˜æ˜¯å…‰çŒ«ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜å¯ä»¥åœ¨è½¯äº¤æ¢æœºä¸Šæ‰“ä¸ªè¡¥ä¸ï¼Œç¦æ­¢å‘å…‰çŒ«å‘é€DNSè¯·æ±‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo ebtables -A FORWARD -p IPv6 -d &#123;å…‰çŒ«MACåœ°å€&#125; --ip6-protocol udp --ip6-destination-port 53 -j DROP<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼ŒPCå°±åªèƒ½ä½¿ç”¨å¤‡ç”¨DNSï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„DNSäº†ã€‚</p><p>å°½ç®¡æœ€ç»ˆæ•ˆæœå¹¶ä¸å®Œç¾ï¼Œè¿™ç¯‡æ–‡ç« çš„è§£å†³æ–¹æ¡ˆä¹Ÿå¹¶ä¸å®ç”¨ï¼ˆè½¯è·¯ç”±+æ¡¥æ¥æ‰æ˜¯ç»ˆæè§£å†³æ–¹æ¡ˆï¼‰ï¼Œä½†ç›¸æ¯”äºç»“æœï¼Œç¬”è€…æ›´äº«å—çš„æ˜¯å‘ç°é—®é¢˜ã€è§£å†³é—®é¢˜çš„è¿‡ç¨‹ã€‚èƒ½å†™å‡ºè¿™ç¯‡æ–‡ç« çœŸæ˜¯å¤ªæ£’äº†ï¼</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="/2022/12/17/%E5%AE%89%E5%8D%93%E5%AF%B9%E6%8C%87%E5%AE%9AWiFi%E7%A6%81%E7%94%A8IPv6/">å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="/2022/12/28/%E5%81%B7%E5%A4%A9%E6%8D%A2%E6%97%A5%EF%BC%9A%E5%B1%8F%E8%94%BD%E5%85%89%E7%8C%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8D/">å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://help.ubuntu.com/community/NetworkConnectionBridge">NetworkConnectionBridge - Community Help Wiki</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/ICMPv6">ICMPv6 - Wikipedia</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://www.rfc-editor.org/rfc/rfc6106">RFC 6106: IPv6 Router Advertisement Options for DNS Configuration</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:7" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/IPv6">IPv6 - Wikipedia</a><a href="#fnref:7" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:8" class="footnote-text"><span><a href="https://stackoverflow.com/questions/70655602/send-custom-ethernet-packet-using-raw-socket">go - Send custom ethernet packet using raw socket - Stack Overflow</a><a href="#fnref:8" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç½‘ç»œ</tag>
      
      <tag>IPv6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>macOSå®‰è£…lxmlæŠ¥é”™&#39;Python.h&#39; file not found</title>
    <link href="/2023/01/16/install-lxml-on-mac/"/>
    <url>/2023/01/16/install-lxml-on-mac/</url>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><blockquote><p>macOSç¯å¢ƒï¼šVentura 13.0 (Apple Silicon)</p><p>Pythonç‰ˆæœ¬ï¼š3.9.6</p></blockquote><p>lxmlæ˜¯ç¬”è€…å¸¸ç”¨çš„htmlå†…å®¹è§£æåº“ã€‚ä½†ç¬”è€…åœ¨macOSä¸Šå®‰è£…lxmlæ—¶ç¢°åˆ°äº†å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip3 install lxml<br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs txt">...<br>src/lxml/etree.c:96:10: fatal error: &#x27;Python.h&#x27; file not found<br>      #include &quot;Python.h&quot;<br>               ^~~~~~~~~~<br>...<br></code></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« ç®€å•è®°å½•ä¸‹è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><ol><li><p>æ‰¾åˆ°<code>Python.h</code>æ–‡ä»¶æ‰€å¤„ä½ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo find / -iname &quot;Python.h&quot;<br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs txt">...<br>/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/Headers/Python.h<br>/Library/umad/Python.framework/Versions/3.8/include/python3.8/Python.h<br>/Library/Crypt/Python.framework/Versions/3.8/include/python3.8/Python.h<br>...<br></code></pre></td></tr></table></figure></li><li><p>ç¬”è€…ä½¿ç”¨çš„Pythonç‰ˆæœ¬ä¸º3.9ï¼Œå°†å¯¹åº”ç‰ˆæœ¬çš„æ–‡ä»¶å¤¹è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> C_INCLUDE_PATH=/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/Headers/<br></code></pre></td></tr></table></figure></li><li><p>é‡æ–°å®‰è£…ï¼Œæå®š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">...<br>Successfully built lxml<br>Installing collected packages: lxml<br>Successfully installed lxml-4.9.2<br></code></pre></td></tr></table></figure></li></ol><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><p><a href="https://stackoverflow.com/questions/35778495/fatal-error-python-h-file-not-found-while-installing-opencv">macos - fatal error: â€˜Python.hâ€™ file not found while installing opencv - Stack Overflow</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022å¹´åº¦æ€»ç»“</title>
    <link href="/2022/12/31/2022-annual-summary/"/>
    <url>/2022/12/31/2022-annual-summary/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸çŸ¥ä¸è§‰ä¸­åˆè¿‡äº†ä¸€å¹´ã€‚2022å¹´ï¼Œæˆ‘åœ¨é‚£äº›å¯¹è‡ªå·±æœ€é‡è¦çš„äº‹æƒ…ä¸Šæœ‰ä»€ä¹ˆè¿›å±•å‘¢ï¼Ÿæˆ‘æ˜¯å¦ä¾ç„¶åšå®šåœ°èµ°åœ¨æˆ‘è‡ªå·±çš„é‚£æ¡è·¯ä¸Šï¼Ÿ</p><p>æˆ–è®¸ï¼Œè¿™ç¯‡æ–‡ç« èƒ½è®©é—®é¢˜çš„ç­”æ¡ˆæ›´åŠ æ¸…æ™°ã€‚</p><h1 id="1-èº«ä½“å¥åº·"><a href="#1-èº«ä½“å¥åº·" class="headerlink" title="1. èº«ä½“å¥åº·"></a>1. èº«ä½“å¥åº·</h1><ul><li>ä»Šå¹´å»äº†çº¦100æ¬¡å¥èº«æˆ¿ï¼ˆå…¬å¸æ€»æ‰“å¡305æ¬¡ã€ç§æ•™30+æ¬¡ï¼‰ï¼Œæ·±è¹²åšç»„çªç ´1å€ä½“é‡ï¼›ç–«æƒ…å®…å®¶æœŸé—´ä½¿ç”¨è·³ç»³ã€å“‘é“ƒé”»ç‚¼ã€‚</li><li>4æœˆä»½é¦–æ¬¡å°è¯•å‚åŠ çˆ¬å±±æ´»åŠ¨ï¼Œä¹‹åé™†ç»­å»äº†ä¸‰æ¬¡ï¼Œç¬¬å››æ¬¡çˆ¬ä¸Šäº†åŒ—äº¬æœ€é«˜å³°ã€‚</li><li>è´­ç½®ç”µåŠ¨å‡é™æ¡Œã€å‡é™å°é¿å…ä¹…åï¼›æ‹”æ‰æ™ºé½¿åº”å¯¹é¾‹é½¿ï¼›ä½¿ç”¨è¯ç‰©å¯¹æŠ—è„±å‘ï¼›è¿›è¡Œæœé…¸æ²»ç–—æ”¹å–„çš®è‚¤çŠ¶å†µã€‚</li></ul><p>æ€»ä½“è€Œè¨€æˆ‘çš„å¥åº·çŠ¶å†µæ¯”è¾ƒç¨³å®šã€‚è¿‘è§†ã€ç”²äº¢æ²¡æœ‰æ¶åŒ–ï¼›å¹³æ—¶å¾ˆå°‘æ„Ÿå†’ï¼Œç–«æƒ…ç®¡æ§æ”¾å¼€åä¹Ÿæ²¡æœ‰æ„ŸæŸ“ã€‚èº«ææ²¡æœ‰å˜å¥½æœ‰ç‚¹å¯æƒœï¼Œå¸Œæœ›æ˜å¹´èƒ½ç»§ç»­å¥èº«ã€çˆ¬å±±ã€å…³æ³¨å„éƒ¨ä½æƒ…å†µã€‚</p><h1 id="2-å¿ƒç†å¥åº·"><a href="#2-å¿ƒç†å¥åº·" class="headerlink" title="2. å¿ƒç†å¥åº·"></a>2. å¿ƒç†å¥åº·</h1><ul><li>é˜…è¯»äº†5æœ¬å¿ƒç†å­¦ç›¸å…³çš„ä¹¦ç±ï¼Œåœ¨æ—¥è®°ä¸­æŒç»­ç»™è‡ªå·±ç§¯æçš„å¿ƒç†æš—ç¤ºï¼Œå‚åŠ äº†å…¬å¸çš„ç§¯æå¿ƒç†è®­ç»ƒè¥ã€‚</li><li>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­å¢åŠ äº†å’Œä»–äººçš„æ²Ÿé€šå’Œäº’åŠ¨ï¼Œæé«˜äº†å‚åŠ é›†ä½“æ´»åŠ¨ã€å¯»æ‰¾æ‹çˆ±æœºä¼šçš„é¢‘ç‡ã€‚</li><li>å¼€å§‹å°è¯•åœ¨å·¥ä½œä¹‹å¤–å¯»æ±‚æ›´å¤šæˆå°±æ„Ÿ&#x2F;è®¤åŒæ„Ÿ&#x2F;å½’å±æ„Ÿã€‚</li></ul><p>æ€»ä½“è€Œè¨€æˆ‘çš„å¿ƒç†å¥åº·ç¨‹åº¦ã€äººé™…å…³ç³»éƒ½æœ‰æ”¹å–„ã€‚ä½†å­¤ç‹¬æ„Ÿå§‹ç»ˆå›°æ‰°ç€æˆ‘ï¼Œå¸Œæœ›æ˜å¹´èƒ½è¿›ä¸€æ­¥å¢å¼ºè‡ªæˆ‘è®¤çŸ¥ã€ä¿æŒè½»æ¾æ„‰å¿«çš„å¿ƒæƒ…ã€‚</p><h1 id="3-è´¢åŠ¡çŠ¶å†µ"><a href="#3-è´¢åŠ¡çŠ¶å†µ" class="headerlink" title="3. è´¢åŠ¡çŠ¶å†µ"></a>3. è´¢åŠ¡çŠ¶å†µ</h1><ul><li>æ”¶å…¥ç›¸æ¯”è¶…å‡ºé¢„æœŸçš„å»å¹´æ¥è¯´ç•¥æœ‰ä¸‹é™ï¼›æ”¯å‡ºç•¥æœ‰ä¸Šå‡ï¼Œä¸»è¦é›†ä¸­äºä½æˆ¿&#x2F;é¥®é£Ÿ&#x2F;ä½“éªŒæ–¹é¢ã€‚</li><li>æŠ•èµ„ç­–ç•¥ä¿æŒè·Ÿéš+ä½è°ƒä»“é¢‘ç‡ï¼ŒåŸºé‡‘è´¦æˆ·äºæŸ8%+ï¼Œè¡¨ç°å¥½äºå¸‚åœºå‡å€¼ã€‚</li><li>å‡€èµ„äº§å¢å¹…ä»¤äººæ»¡æ„ï¼ŒæµåŠ¨èµ„äº§å……è£•ã€‚</li></ul><p>æ€»ä½“è€Œè¨€æˆ‘çš„è´¢åŠ¡çŠ¶å†µå¥åº·ç¨‹åº¦ã€æŠ—é£é™©èƒ½åŠ›ä¾ç„¶æ¯”è¾ƒå¼ºã€‚æ”¶å…¥ä¾èµ–å·¥èµ„ç›®å‰æ¥çœ‹ä¸æ˜¯é—®é¢˜ï¼Œä½†éšç€æˆ‘å¯¹å‡€èµ„äº§çš„å¢é•¿è¶Šæ¥è¶Šä¸æ•æ„Ÿï¼Œæˆ–è®¸æˆ‘éœ€è¦é‡æ–°è€ƒè™‘é‡‘é’±åœ¨æˆ‘äººç”Ÿä¸­çš„å®šä½ã€‚</p><h1 id="4-èŒä¸šå‘å±•"><a href="#4-èŒä¸šå‘å±•" class="headerlink" title="4. èŒä¸šå‘å±•"></a>4. èŒä¸šå‘å±•</h1><ul><li>è¾ƒé•¿çš„å±…å®¶åŠå…¬ç»å†è®©æˆ‘æ„è¯†åˆ°ï¼Œæ˜¯å¦åœ¨ç°åœºåŠå…¬å¹¶ä¸æ˜¯å½±å“æˆ‘å·¥ä½œæ•ˆç‡çš„å…³é”®å› ç´ ã€‚</li><li>å·¥ä½œä¸Šé‡åˆ°äº†ç“¶é¢ˆå’Œå±æœºï¼Œå–å¾—äº†å°‘é‡çªç ´ã€‚</li><li>çŸ­æœŸç›®æ ‡æ‘‡æ‘†ä¸å®šï¼Œç¼ºå°‘é•¿æœŸå‘å±•è§„åˆ’ã€‚</li></ul><p>æ€»ä½“è€Œè¨€æˆ‘çš„èŒä¸šå‘å±•åœ¨ä»Šå¹´é™·å…¥äº†ä½æ½®ã€‚å¸Œæœ›æ˜å¹´èƒ½æ›´å¤šåœ°æ€è€ƒè‡ªå·±çš„å®šä½ã€æ˜ç¡®æœªæ¥çš„å‘å±•è§„åˆ’ã€‚</p><h1 id="5-ä¸ªäººçˆ±å¥½"><a href="#5-ä¸ªäººçˆ±å¥½" class="headerlink" title="5. ä¸ªäººçˆ±å¥½"></a>5. ä¸ªäººçˆ±å¥½</h1><ul><li>é˜…è¯»äº†28æœ¬ä¹¦ç±ï¼Œè§‚çœ‹äº†24éƒ¨ç”µå½±ã€20éƒ¨å·¦å³åŠ¨æ¼«ã€‚å’Œä»¥å¾€ç›¸æ¯”ï¼Œå°†æ›´å¤šçš„ç²¾åŠ›æ”¾åœ¨äº†é˜…è¯»ã€æ€»ç»“å’Œæ€è€ƒä¸Šã€‚</li><li>ä¸‹åŠå¹´é‡æ–°å¼€å§‹å¯¹å¼€æºç¤¾åŒºä½œè´¡çŒ®ï¼Œå¹¶å°è¯•ç”¨åšå®¢åˆ†äº«è‡ªå·±çš„ç”Ÿæ´»ã€‚</li><li>æ‰©å±•äº†çˆ¬å±±æ´»åŠ¨ï¼Œä½“éªŒäº†å£°ä¹è®­ç»ƒã€æ”€å²©ã€çº¿ä¸‹äº¤å‹ç­‰ä¸€ç³»åˆ—æ´»åŠ¨ï¼Œåœ¨ç ”ç©¶æ”¹å–„å®¤å†…ç¯å¢ƒã€HomeLabç­‰æ–¹é¢æ”¶è·äº†å¾ˆå¤šä¹è¶£ã€‚</li></ul><p>æ€»ä½“è€Œè¨€ä»Šå¹´å‡­å…´è¶£åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œå‘¨æœ«è¿‡å¾—éƒ½æ¯”è¾ƒå¼€å¿ƒã€‚å¸Œæœ›èƒ½æ˜å¹´èƒ½ç»§ç»­å‘æ˜ç”Ÿæ´»ä¸­çš„ä¹è¶£ã€‚</p><table><thead><tr><th>åšæ–‡</th><th>Github</th></tr></thead><tbody><tr><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231191016046.webp"></td><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231191102003.webp"></td></tr></tbody></table><table><thead><tr><th>ä¹¦ç±</th><th>ç”µå½±</th><th>åŠ¨æ¼«</th></tr></thead><tbody><tr><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231162010125.webp"></td><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231162038502.webp"></td><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231185802364.webp"></td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>ç”Ÿæ´»</tag>
      
      <tag>æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>H2-2å…‰çŒ«é…ç½®IPv6é˜²ç«å¢™</title>
    <link href="/2022/12/31/h2-2-modem-ip6tables/"/>
    <url>/2022/12/31/h2-2-modem-ip6tables/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>IPv6ç›¸æ¯”IPv4çš„ä¸€å¤§ä¼˜åŠ¿æ˜¯IPåœ°å€ç©ºé—´å……è¶³ã€‚ä»¥ç¬”è€…çš„ä¸­å›½ç§»åŠ¨å®½å¸¦ä¸ºä¾‹ï¼Œå…‰çŒ«å¯ä»¥ä»è¿è¥å•†å¤„è·å¾—2409å¼€å¤´çš„<code>/64</code>å…¬ç½‘ç½‘æ®µï¼Œè¿æ¥è‡³å…‰çŒ«çš„è®¾å¤‡å¯è‡ªåŠ¨è·å¾—å…¬ç½‘IPv6åœ°å€ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221228.home_network.svg" alt="ç¬”è€…å®¶åº­ç½‘ç»œæ¶æ„"></p><p>ä½†å¤„äºå®‰å…¨è€ƒè™‘ï¼Œå…‰çŒ«çš„IPv6é˜²ç«å¢™ä¼šé»˜è®¤ç¦ç”¨æ‰€æœ‰å…¥ç«™è¿æ¥ï¼Œå¯¼è‡´å…¶å®ƒå…¬ç½‘è®¾å¤‡æ— æ³•ç›´è¿å…‰çŒ«é˜²ç«å¢™å†…éƒ¨çš„è®¾å¤‡ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221231.home_network.svg" alt="å…‰çŒ«å…¥ç«™é˜²ç«å¢™"></p><p>å¹¸è¿çš„æ˜¯ï¼Œç¬”è€…ä½¿ç”¨çš„ä¸­å›½ç§»åŠ¨H2-2å…‰çŒ«åœ¨ç½‘ä¸Šæœ‰å¤§é‡ä½¿ç”¨æ•™ç¨‹ï¼Œå¯ä»¥é€šè¿‡é…ç½®IPv6é˜²ç«å¢™çš„æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="2-å¼€å¯å…‰çŒ«telnetåŠŸèƒ½"><a href="#2-å¼€å¯å…‰çŒ«telnetåŠŸèƒ½" class="headerlink" title="2. å¼€å¯å…‰çŒ«telnetåŠŸèƒ½"></a>2. å¼€å¯å…‰çŒ«telnetåŠŸèƒ½</h1><ul><li><p>ç”¨æ™®é€šè´¦å·ç™»å½•å…‰çŒ«ç®¡ç†åå°ï¼ˆ<a href="http://192.168.1.1/">http://192.168.1.1/</a>ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°éå¸¸ç®€é™‹çš„é…ç½®ç•Œé¢ã€‚</p><p> <img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgoimage-20221231122943385.webp"></p></li><li><p>æ­¤æ—¶å¯ä»¥æ‰‹åŠ¨è·³è½¬è‡³telnetè®¾ç½®ç•Œé¢ï¼ˆ<a href="http://192.168.1.1/getpage.gch?pid=1002&nextpage=tele_sec_tserver_t.gch">http://192.168.1.1/getpage.gch?pid=1002&nextpage=tele_sec_tserver_t.gch</a>ï¼‰ï¼Œå¼€å¯å…‰çŒ«çš„telnetåŠŸèƒ½ã€‚</p><ul><li><p>å‹¾é€‰â€œå¯ç”¨Telnetâ€ï¼Œç‚¹å‡»ç¡®å®šä¿å­˜</p></li><li><p>ç„¶åå‹¾é€‰â€œå¯ç”¨LANä¾§Telnetâ€ï¼Œå†æ¬¡ç‚¹å‡»ç¡®å®šä¿å­˜</p></li></ul><p> <img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221229214607170.webp"></p></li><li><p>åœ¨Chromeæµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œ<code>document.getElementById(&quot;Frm_TSPassword&quot;).type = &quot;text&quot;</code>å‘½ä»¤å¯æ˜¾ç¤ºtelnetå¯†ç ã€‚</p><ul><li>ä¸è¿‡å¥½åƒæ‰€æœ‰çš„H2-2å…‰çŒ«telnetå¯†ç éƒ½æ˜¯<code>aDm8H%MdA</code>ï¼Œä¸”æ— æ³•é€šè¿‡è¿™ä¸ªé¡µé¢æ›´æ”¹</li></ul><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/picgo/image-20221231123702628.webp"></p></li><li><p>åœ¨æœ¬æœºå‘½ä»¤è¡Œä¸­è¿è¡Œtelnetå‘½ä»¤å³å¯ç™»å½•è‡³å…‰çŒ«ï¼Œå¹¶é€šè¿‡suå‘½ä»¤è·å–rootæƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">~ telnet 192.168.1.1<br>Trying 192.168.1.1...<br>Connected to 192.168.1.1.<br>Escape character is &#x27;^]&#x27;.<br><br>Login: CMCCAdmin<br>Password:<br>~ $ su<br>Password:<br>/ #<br></code></pre></td></tr></table></figure></li></ul><h1 id="3-è‡ªåŠ¨ç™»å½•telnetè„šæœ¬"><a href="#3-è‡ªåŠ¨ç™»å½•telnetè„šæœ¬" class="headerlink" title="3. è‡ªåŠ¨ç™»å½•telnetè„šæœ¬"></a>3. è‡ªåŠ¨ç™»å½•telnetè„šæœ¬</h1><p>è€ƒè™‘åˆ°telnetç™»å½•æ¯”è¾ƒç¹çï¼Œæ‰€ä»¥ç¬”è€…ç¼–å†™äº†ä¸€ä¸ª<code>expect</code><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="https://linux.die.net/man/1/expect">[1]</span></a></sup>è„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨ç™»å½•å…‰çŒ«ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"> ~ cat ~/scripts/telnet_modem<br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/usr/bin/env expect</span><br>set timeout 5<br>set host &quot;192.168.1.1&quot;<br>set user &quot;CMCCAdmin&quot;<br>set pwd &quot;aDm8H%MdA&quot;<br><br>spawn telnet $host<br>expect &quot;Login: &quot;<br>send &quot;$user\n&quot;<br>sleep 0.1<br>expect &quot;Password: &quot;<br>send &quot;$pwd\n&quot;<br>sleep 0.1<br>expect &quot;~ $ &quot;<br>send &quot;su\n&quot;<br>sleep 0.1<br>expect &quot;Password: &quot;<br>send &quot;$pwd\n&quot;<br>sleep 0.1<br>interact<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¯¥è„šæœ¬åå³å¯ç™»å½•å…‰çŒ«å¹¶è·å–rootæƒé™ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"> ~ ~/scripts/telnet_modem<br>spawn telnet 192.168.1.1<br>Trying 192.168.1.1...<br>Connected to 192.168.1.1.<br>Escape character is &#x27;^]&#x27;.<br><br>Login: CMCCAdmin<br>Password:<br>~ $ su<br>Password:<br>/ #<br></code></pre></td></tr></table></figure><h1 id="4-é…ç½®IPv6é˜²ç«å¢™"><a href="#4-é…ç½®IPv6é˜²ç«å¢™" class="headerlink" title="4. é…ç½®IPv6é˜²ç«å¢™"></a>4. é…ç½®IPv6é˜²ç«å¢™</h1><p>å…‰çŒ«çš„IPv6é˜²ç«å¢™å¯é€šè¿‡<code>ip6tables</code>å‘½ä»¤ç›´æ¥é…ç½®ã€‚ç™»å½•å…‰çŒ«åè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip6tables -I FORWARD -p tcp -m multiport --dports 10000:10009,12345 -j ACCEPT<br>ip6tables -I FORWARD -p udp -m multiport --dports 10000:10009,12345 -j ACCEPT<br></code></pre></td></tr></table></figure><p>å³å¯è®©å…‰çŒ«è½¬å‘ç›®æ ‡ç«¯å£ä¸º10000~10009ã€12345çš„tcp&#x2F;udpæµé‡ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221231.home_network_ip6tables.svg" alt="å…‰çŒ«å…¥ç«™é˜²ç«å¢™"></p><h1 id="5-æŒä¹…åŒ–IPv6é˜²ç«å¢™"><a href="#5-æŒä¹…åŒ–IPv6é˜²ç«å¢™" class="headerlink" title="5. æŒä¹…åŒ–IPv6é˜²ç«å¢™"></a>5. æŒä¹…åŒ–IPv6é˜²ç«å¢™</h1><p>å…‰çŒ«é‡å¯åä»¥ä¸Šè®¾ç½®çš„é˜²ç«å¢™è§„åˆ™ä¼šè¢«æ¸…é™¤ï¼Œå…¶å®ƒæ–‡ç« <sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ã€ç§»åŠ¨å…‰çŒ«H2-2çš„å®Œå…¨ç ´è§£å¿ƒè·¯å†ç¨‹åŠé…ç½®ã€‘\_zsuroyçš„åšå®¢-CSDNåšå®¢\_h2-2å…‰çŒ«](https://blog.csdn.net/zsuroy/article/details/127002555#t7)">[2]</span></a></sup>æåˆ°çš„æŒä¹…åŒ–æ–¹å¼ç¬”è€…æ²¡èƒ½å¤ç°ã€‚æ‰€ä»¥ç¬”è€…ç¼–å†™äº†ä¸€ä¸ªPythonè„šæœ¬ç”¨äºé…ç½®é˜²ç«å¢™ç«¯å£ï¼Œå¹¶é€šè¿‡crontabå®šæœŸæ‰§è¡Œæ¥å®ç°æŒä¹…åŒ–åœ°æ•ˆæœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">import</span> telnetlib<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br>need_forward = &#123;<span class="hljs-string">&#x27;10000:10009&#x27;</span>, <span class="hljs-string">&#x27;12345&#x27;</span>&#125;  <span class="hljs-comment"># éœ€å¼€æ”¾ç«¯å£</span><br>host, timeout = <span class="hljs-string">&#x27;192.168.1.1&#x27;</span>, <span class="hljs-number">3</span><br>user, pwd = <span class="hljs-string">&#x27;CMCCAdmin&#x27;</span>, <span class="hljs-string">&#x27;aDm8H%MdA&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(datetime.now())[:<span class="hljs-number">19</span>])<br><span class="hljs-comment"># ç™»å½•è·¯ç”±å™¨</span><br>tn = telnetlib.Telnet(host, timeout=timeout)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exec</span>(<span class="hljs-params">expect: <span class="hljs-built_in">str</span>, command: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    expectBytes = expect.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    content = tn.read_until(expectBytes, timeout=timeout)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> content.endswith(expectBytes):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;expect &#123;&#125;, got &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">repr</span>(expect), <span class="hljs-built_in">repr</span>(content.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))))<br>    tn.write(command.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    <span class="hljs-comment"># print(repr(content.decode(&#x27;utf-8&#x27;)))</span><br>    <span class="hljs-keyword">return</span> content.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;Login: &#x27;</span>, user)<br><span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;Password: &#x27;</span>, pwd)<br><span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;~ $ &#x27;</span>, <span class="hljs-string">&#x27;su&#x27;</span>)<br><span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;Password: &#x27;</span>, pwd)<br><br><span class="hljs-comment"># æŸ¥è¯¢å·²å¼€æ”¾ç«¯å£</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">forwarded_ports</span>() -&gt; <span class="hljs-built_in">set</span>:<br>    <span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;/ # &#x27;</span>, <span class="hljs-string">&#x27;ip6tables -L FORWARD&#x27;</span>)<br>    forwarded = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> <span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;/ # &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>        line = line.strip()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line.startswith(<span class="hljs-string">&#x27;ACCEPT&#x27;</span>):<br>            <span class="hljs-keyword">continue</span><br>        forwarded.update(line.split()[-<span class="hljs-number">1</span>].split(<span class="hljs-string">&#x27;,&#x27;</span>))<br>    <span class="hljs-keyword">return</span> forwarded<br>forwarded = forwarded_ports()<br><span class="hljs-comment"># print(&#x27;forwarded: &#x27;, forwarded)</span><br><br><span class="hljs-comment"># æ–°å¢æœªå¼€æ”¾ç«¯å£</span><br>new_ports = need_forward - forwarded<br><span class="hljs-keyword">if</span> new_ports:<br>    ports_str = <span class="hljs-string">&#x27;,&#x27;</span>.join(new_ports)<br>    <span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;/ # &#x27;</span>, <span class="hljs-string">&#x27;ip6tables -I FORWARD -p tcp -m multiport --dports &#123;&#125; -j ACCEPT&#x27;</span>.<span class="hljs-built_in">format</span>(ports_str))<br>    <span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;/ # &#x27;</span>, <span class="hljs-string">&#x27;ip6tables -I FORWARD -p udp -m multiport --dports &#123;&#125; -j ACCEPT&#x27;</span>.<span class="hljs-built_in">format</span>(ports_str))<br>    forwarded = forwarded_ports()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;forwarded: &#x27;</span>, forwarded)<br><br>tn.close()<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crontab">*/1 * * * * /home/worker/scripts/cron/router_ip6tables.py &gt;&gt; ~/ram/router_ip6tables.log 2&gt;&amp;1<br></code></pre></td></tr></table></figure><h1 id="6-åè®°"><a href="#6-åè®°" class="headerlink" title="6. åè®°"></a>6. åè®°</h1><p>ç½‘ä¸Šå…¶å®ƒæ–‡ç« <sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[å½»åº•ç©è½¬ç§»åŠ¨H2-2å…‰çŒ«â€”â€”ç§»åŠ¨å…‰çŒ«ä¸­çš„äº”äº”å¼€ï¼Œä¸è®ºè·¯ç”±è¿˜æ˜¯æ¡¥æ¥å®ƒéƒ½è¡Œ-å…‰çŒ«/adsl/cableæ— çº¿ä¸€ä½“æœº-æ©å±±æ— çº¿è®ºå›](https://www.right.com.cn/forum/thread-6054306-1-1.html)">[3]</span></a></sup><sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ã€æ±‚åŠ©ã€‘è§£å¯†ä¸­å›½ç§»åŠ¨H2-3Eé…ç½®æ–‡ä»¶-å…‰çŒ«/adsl/cableæ— çº¿ä¸€ä½“æœº-æ©å±±æ— çº¿è®ºå›](https://www.right.com.cn/FORUM/thread-5569630-1-1.html)">[4]</span></a></sup>è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è·å–å…‰çŒ«å®½å¸¦æ‹¨å·&#x2F;è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç ã€å¦‚ä½•æ¡¥æ¥è·¯ç”±å™¨ã€‚ä½†å¯¹äºå¯ä»¥å±è”½å…‰çŒ«IPåœ°å€è‡ªåŠ¨åˆ†é…<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…](/2022/12/28/å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…/)">[5]</span></a></sup>ã€é…ç½®å…‰çŒ«é˜²ç«å¢™çš„ç¬”è€…æ¥è¯´ï¼Œæ¡¥æ¥å·²ç»æ²¡æœ‰ä»€ä¹ˆå¸å¼•åŠ›äº†ã€‚å¦å¤–ç¬”è€…å‘ç°ï¼Œå³ä½¿é€šè¿‡è¶…çº§ç®¡ç†å‘˜ç™»å½•å…‰çŒ«åå°ï¼Œåœ¨ç½‘é¡µä¸Šé…ç½®DMZ&#x2F;è™šæ‹Ÿä¸»æœºé…ç½®ç­‰é˜²ç«å¢™è§„åˆ™ä¹Ÿä¸ä¼šå®é™…ç”Ÿæ•ˆï¼Œå®åœ¨ç¦»è°±ã€‚</p><p>ä¸å¯å¦è®¤çš„æ˜¯ï¼Œæ¡¥æ¥åœ¨ç»å¤§å¤šæ•°åœºæ™¯éƒ½æ˜¯ä¸€æ­¥åˆ°ä½çš„ä¾¿æ·é€‰æ‹©ã€‚ä½†å¯¹äºä¸æ–¹ä¾¿è¿›è¡Œæ¡¥æ¥çš„ç¬”è€…æ¥è¯´ï¼Œ<code>iptables</code>çœŸé¦™ã€‚</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><ul><li><a href="https://www.v2ex.com/t/844130">æ‰“é€šç§»åŠ¨å®½å¸¦ IPv6 çš„å…¬ç½‘è®¿é—® - V2EX</a></li></ul><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://linux.die.net/man/1/expect">https://linux.die.net/man/1/expect</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://blog.csdn.net/zsuroy/article/details/127002555#t7">ã€ç§»åŠ¨å…‰çŒ«H2-2çš„å®Œå…¨ç ´è§£å¿ƒè·¯å†ç¨‹åŠé…ç½®ã€‘_zsuroyçš„åšå®¢-CSDNåšå®¢_h2-2å…‰çŒ«</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.right.com.cn/forum/thread-6054306-1-1.html">å½»åº•ç©è½¬ç§»åŠ¨H2-2å…‰çŒ«â€”â€”ç§»åŠ¨å…‰çŒ«ä¸­çš„äº”äº”å¼€ï¼Œä¸è®ºè·¯ç”±è¿˜æ˜¯æ¡¥æ¥å®ƒéƒ½è¡Œ-å…‰çŒ«&#x2F;adsl&#x2F;cableæ— çº¿ä¸€ä½“æœº-æ©å±±æ— çº¿è®ºå›</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://www.right.com.cn/FORUM/thread-5569630-1-1.html">ã€æ±‚åŠ©ã€‘è§£å¯†ä¸­å›½ç§»åŠ¨H2-3Eé…ç½®æ–‡ä»¶-å…‰çŒ«&#x2F;adsl&#x2F;cableæ— çº¿ä¸€ä½“æœº-æ©å±±æ— çº¿è®ºå›</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="/2022/12/28/%E5%81%B7%E5%A4%A9%E6%8D%A2%E6%97%A5%EF%BC%9A%E5%B1%8F%E8%94%BD%E5%85%89%E7%8C%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8D/">å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç½‘ç»œ</tag>
      
      <tag>IPv6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å·å¤©æ¢æ—¥ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…</title>
    <link href="/2022/12/28/%E5%81%B7%E5%A4%A9%E6%8D%A2%E6%97%A5%EF%BC%9A%E5%B1%8F%E8%94%BD%E5%85%89%E7%8C%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8D/"/>
    <url>/2022/12/28/%E5%81%B7%E5%A4%A9%E6%8D%A2%E6%97%A5%EF%BC%9A%E5%B1%8F%E8%94%BD%E5%85%89%E7%8C%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221228.home_network.svg" alt="ç¬”è€…å®¶åº­ç½‘ç»œæ¶æ„"></p><p>åœ¨ä¹‹å‰çš„æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[2022-12-17-å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6](/2022/12/17/å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6/)">[1]</span></a></sup>ä¸­ï¼Œç¬”è€…è‹¦äºå®‰å“å¯¹IPv6çš„æ”¯æŒä¸ä½³ï¼Œæ‰€ä»¥åœ¨æ‰‹æœºå·²rootçš„æƒ…å†µä¸‹ä½¿ç”¨taskeråº”ç”¨+å‘½ä»¤è¡Œè®©å®‰å“è®¾å¤‡è¿æ¥æŒ‡å®šwifiåç¦ç”¨IPv6ã€‚ä½†è¿™ç§æ–¹æ¡ˆå¹¶ä¸å®Œç¾ï¼š</p><ul><li>é¦–å…ˆéœ€è¦ä¿è¯taskeråº”ç”¨å§‹ç»ˆåœ¨åå°è¿è¡Œï¼ˆç¬”è€…ä¼šå®šæ—¶è¿›å…¥æ¸…ç©ºåå°çš„æ·±åº¦çœç”µæ¨¡å¼ï¼‰</li><li>å…¶æ¬¡taskerå¹¶ä¸èƒ½ä¿è¯æ¯æ¬¡éƒ½ç¦ç”¨IPv6æˆåŠŸï¼ˆå¯èƒ½å’Œç¬”è€…é€‰æ‹©åªè¿è¡Œä¸€æ¡å‘½ä»¤æœ‰å…³ï¼‰</li></ul><p>æ‰€ä»¥ç¬”è€…çš„ç›®å…‰è¿˜æ˜¯è½¬å‘äº†æ›´ä¸ºå½»åº•çš„è§£å†³æ€è·¯ï¼šå±è”½å…‰çŒ«çš„IPåœ°å€è‡ªåŠ¨åˆ†é…åŠŸèƒ½ï¼Œä»è€Œè®©å®‰å“ä¸ä½¿ç”¨IPv6ç½‘ç»œã€‚è€ƒè™‘åˆ°ç¬”è€…å¹¶ä¸å¯¹å…‰çŒ«æœ‰å®Œå…¨çš„æ§åˆ¶æƒï¼Œæ‰€ä»¥ç¬”è€…ä¸»è¦ä»æ— çº¿APä¸Šå…¥æ‰‹ã€‚</p><h1 id="2-IPåœ°å€è‡ªåŠ¨åˆ†é…åŸç†"><a href="#2-IPåœ°å€è‡ªåŠ¨åˆ†é…åŸç†" class="headerlink" title="2. IPåœ°å€è‡ªåŠ¨åˆ†é…åŸç†"></a>2. IPåœ°å€è‡ªåŠ¨åˆ†é…åŸç†</h1><h2 id="2-1-IPv4"><a href="#2-1-IPv4" class="headerlink" title="2.1 IPv4"></a>2.1 IPv4</h2><p>å±€åŸŸç½‘å†…çš„IPv4åœ°å€æ™®éä½¿ç”¨DHCPåè®®æ¥è¿›è¡Œè‡ªåŠ¨åˆ†é…ã€‚æŒ‰ç…§ç»´åŸºç™¾ç§‘<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[åŠ¨æ€ä¸»æœºè®¾ç½®åè®® - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E4%B8%BB%E6%9C%BA%E8%AE%BE%E7%BD%AE%E5%8D%8F%E8%AE%AE)">[2]</span></a></sup>çš„æè¿°ï¼ŒDHCPæ˜¯ä¸€ä¸ªä½¿ç”¨UDPåè®®çš„åº”ç”¨å±‚åè®®ï¼Œå…¶ä½¿ç”¨ç«¯å£ä¸º67&#x2F;68çš„UDPåè®®ã€‚é€šè¿‡wiresharkæŠ“åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å‘ç°å®ƒçš„å­˜åœ¨ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221228225910186.webp" alt="DHCPæŠ“åŒ…"></p><h2 id="2-2-IPv6"><a href="#2-2-IPv6" class="headerlink" title="2.2 IPv6"></a>2.2 IPv6</h2><p>å±€åŸŸç½‘å†…çš„IPv6åœ°å€å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è‡ªåŠ¨åˆ†é…ï¼šæœ‰çŠ¶æ€çš„DHCPv6<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[DHCPv6 - Wikipedia](https://en.wikipedia.org/wiki/DHCPv6#cite_note-rfc4339-1)">[3]</span></a></sup>ã€æ— çŠ¶æ€çš„SLAAC<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6 - Wikipedia](https://en.wikipedia.org/wiki/IPv6#Stateless_address_autoconfiguration_(SLAAC))">[4]</span></a></sup><sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6 address - Wikipedia](https://en.wikipedia.org/wiki/IPv6_address#Stateless_address_autoconfiguration)">[5]</span></a></sup>ã€‚å‡ºäºé…ç½®çš„ä¾¿æ·æ€§è€ƒè™‘ï¼Œç›®å‰ä½¿ç”¨åè€…çš„è®¾å¤‡æ›´ä¸ºå¸¸è§ï¼ŒåŒ…æ‹¬ç¬”è€…çš„å…‰çŒ«ã€‚é™¤äº†ä¸Šä¸€ç¯‡æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[2022-12-17-å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6](/2022/12/17/å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6/)">[1]</span></a></sup>å¼•ç”¨çš„èµ„æ–™<sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6ç³»åˆ—åŸºç¡€ç¯‡ï¼ˆä¸‹ï¼‰â€”é‚»å±…å‘ç°åè®®NDP - é”æ·ç½‘ç»œ](https://www.ruijie.com.cn/jszl/83220/)">[6]</span></a></sup>ï¼Œå¦ä¸€ç¯‡æ–‡ç« ä¹Ÿ<sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6 Stateless Address Auto-configuration (SLAAC) | NetworkAcademy.io](https://www.networkacademy.io/ccna/ipv6/stateless-address-autoconfiguration-slaac)">[7]</span></a></sup>ç”¨åŠ¨å›¾å¾ˆå¥½åœ°æè¿°äº†SLAACåˆ†é…åœ°å€çš„è¿‡ç¨‹ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/ipv6-stateless-address-autoconfiguration.gif"></p><p>SLAACä½¿ç”¨çš„æ˜¯ç½‘ç»œå±‚çš„ICMPv6åè®®ï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Wiresharkæ¥å‘ç°å®ƒçš„å­˜åœ¨ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221228232047709.webp" alt="SLAACæŠ“åŒ…"></p><h1 id="3-æ–½å·¥"><a href="#3-æ–½å·¥" class="headerlink" title="3. æ–½å·¥"></a>3. æ–½å·¥</h1><h2 id="3-1-æ›¿æ¢IPv4-DHCP"><a href="#3-1-æ›¿æ¢IPv4-DHCP" class="headerlink" title="3.1 æ›¿æ¢IPv4 DHCP"></a>3.1 æ›¿æ¢IPv4 DHCP</h2><p>ç¬”è€…é€šè¿‡æœå¯»å¾—çŸ¥ï¼Œéƒ¨åˆ†å¯é…ç½®äº¤æ¢æœºä¸Šæœ‰ä¸€ä¸ªå«DHCP snooping<sup id="fnref:8" class="footnote-ref"><a href="#fn:8" rel="footnote"><span class="hint--top hint--rounded" aria-label="[DHCP snooping - ç¶­åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨æ›¸](https://zh.wikipedia.org/zh-tw/DHCP_snooping)">[8]</span></a></sup>çš„åŠŸèƒ½ï¼Œå¯ä»¥å±è”½æ¶æ„DHCPæœåŠ¡å™¨ã€‚ç»§ç»­æœå¯»å¾—çŸ¥ï¼ŒLinuxä¸Šå¯ä»¥ä½¿ç”¨<code>ebtables</code>å®ç°ç±»ä¼¼çš„æ•ˆæœ<sup id="fnref:9" class="footnote-ref"><a href="#fn:9" rel="footnote"><span class="hint--top hint--rounded" aria-label="[linux - iptables dhcp snooping - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/352231/iptables-dhcp-snooping)">[9]</span></a></sup>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ebtables -A FORWARD --protocol ipv4 --ip-proto udp --ip-dport 67:68 -j DROP<br></code></pre></td></tr></table></figure><p><code>ebtables</code><sup id="fnref:10" class="footnote-ref"><a href="#fn:10" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ebtables(8) - Linux man page](https://linux.die.net/man/8/ebtables)">[10]</span></a></sup>æ˜¯ä¸€ä¸ªèƒ½æ§åˆ¶ç½‘æ¡¥ä¸­ä»¥å¤ªç½‘å¸§æµé‡çš„å·¥å…·ã€‚åˆšå¥½ç¬”è€…çš„æ— çº¿APæ˜¯ä¸€ä¸ªè¿è¡Œç€Padavanï¼ˆåµŒå…¥å¼linuxç³»ç»Ÿï¼‰çš„è·¯ç”±å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥å·¥å…·ã€‚äºæ˜¯ç¬”è€…åœ¨æ— çº¿APä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯å±è”½æ¥è‡ªå…‰çŒ«çš„IPv4 DHCPæœåŠ¡å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ebtables -A FORWARD -p IPv4 -s $&#123;å…‰çŒ«çš„MACåœ°å€&#125; --ip-proto udp --ip-dport 67:68 -j DROP<br></code></pre></td></tr></table></figure><p>åœ¨æ— çº¿APä¸Šå¯ç”¨DHCPæœåŠ¡å™¨åï¼Œç½‘ç»œæ¶æ„å˜æˆäº†ä¸‹é¢çš„å½¢å¼ï¼Œè¿™æ ·ç¬”è€…å°±ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®é€æ˜ä»£ç†ç½‘å…³äº†ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221228234014958.webp" alt="æ— çº¿APè®¾ç½®"></p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221228.home_network_replace_dhcp.svg"></p><h2 id="3-2-å±è”½IPv6-SLAAC"><a href="#3-2-å±è”½IPv6-SLAAC" class="headerlink" title="3.2 å±è”½IPv6 SLAAC"></a>3.2 å±è”½IPv6 SLAAC</h2><p>å±è”½SLAACåè®®çš„æ ¸å¿ƒæ˜¯å±è”½ICMPv6åè®®ï¼Œè€Œ<code>ebtables</code>ä½œä¸ºèƒ½æ§åˆ¶ä»¥å¤ªç½‘å¸§çš„å·¥å…·åº”è¯¥ä¹Ÿèƒ½åšåˆ°ã€‚è™½ç„¶<code>ebtables</code>çš„man page<sup id="fnref:10" class="footnote-ref"><a href="#fn:10" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ebtables(8) - Linux man page](https://linux.die.net/man/8/ebtables)">[10]</span></a></sup>é¡µé¢æ²¡æœ‰è¯´æ˜å¦‚ä½•å±è”½è¯¥åè®®ï¼Œä½†ç¥å¥‡çš„æ˜¯ç¬”è€…åœ¨Azureçš„ä»£ç ä»“åº“å†…<sup id="fnref:11" class="footnote-ref"><a href="#fn:11" rel="footnote"><span class="hint--top hint--rounded" aria-label="[azure-container-networking/ebtables.go at v1.4.39 Â· Azure/azure-container-networking](https://github.com/Azure/azure-container-networking/blob/v1.4.39/ebtables/ebtables.go#L111)">[11]</span></a></sup>æ‰¾åˆ°äº†å¯¹åº”çš„ä½¿ç”¨ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Drop Icmpv6 discovery messages going out of interface</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DropICMPv6Solicitation</span><span class="hljs-params">(interfaceName <span class="hljs-type">string</span>, action <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>table := Filter<br>chain := Forward<br><br>rule := fmt.Sprintf(<span class="hljs-string">&quot;-p IPv6 --ip6-proto ipv6-icmp --ip6-icmp-type neighbour-solicitation -o %s -j DROP&quot;</span>,<br>interfaceName)<br><br><span class="hljs-keyword">return</span> runEbCmd(table, action, chain, rule)<br>&#125;<br></code></pre></td></tr></table></figure><p>äºæ˜¯ç¬”è€…åœ¨æ— çº¿APä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯å±è”½æ¥è‡ªå…‰çŒ«çš„ICMPv6æ•°æ®åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ebtables -A FORWARD -p IPv6 -s $&#123;å…‰çŒ«çš„MACåœ°å€&#125; --ip6-proto ipv6-icmp -j DROP<br></code></pre></td></tr></table></figure><p>ä¸è¿‡è™½ç„¶æ­¤æ—¶å®‰å“è®¾å¤‡æ— æ³•é€šè¿‡å…‰çŒ«è·å–åˆ°IPv6åœ°å€ï¼Œä½†æœ‰çº¿è¿æ¥æ— çº¿APçš„AIOä¸»æœºä¾ç„¶èƒ½æ­£å¸¸è·å–IPv6åœ°å€ï¼Œç¬”è€…æ¨æµ‹è¿™å’Œæ— çº¿APçš„ç‰¹æ®Šè½¯ç¡¬ä»¶è®¾ç½®æœ‰å…³ã€‚è‡³æ­¤ï¼Œç¬”è€…çš„æ”¹é€ å®Œç¾è¾¾åˆ°ç›®æ ‡ï¼Œå®¶åº­ç½‘ç»œæ¶æ„å˜æˆäº†è¿™ç§å½¢å¼ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/svg/20221229.home_network_block_icmp.svg"></p><p>æ— IPv6ã€è‡ªåŠ¨è®¾ç½®é€æ˜ä»£ç†ç½‘å…³ï¼Œç¬”è€…åˆèƒ½é¡ºç•…åœ°ä½¿ç”¨å®‰å“è®¾å¤‡äº†ã€‚</p><h1 id="4-åè®°"><a href="#4-åè®°" class="headerlink" title="4. åè®°"></a>4. åè®°</h1><p>å¦‚æœå¯¹å…‰çŒ«æ‹¥æœ‰å®Œå…¨çš„æ§åˆ¶æƒï¼Œåœ¨å…‰çŒ«ä¸Šå¼€å¯æ¡¥æ¥æ¨¡å¼ã€è®©ä¸ªäººçš„è·¯ç”±è®¾å¤‡è¿›è¡Œæ‹¨å·å¯èƒ½æ‰æ˜¯æœ€å®Œå–„çš„è§£å†³æ–¹æ¡ˆã€‚ç‰¹åˆ«æ˜¯å¦‚ä»Šå®¶ç”¨å®½å¸¦å·²ç»å¼€å§‹åˆ†é…å…¬ç½‘IPv6ç½‘æ®µï¼Œå¦‚æœèƒ½ç”¨åˆç†è®¾ç½®é˜²ç«å¢™ï¼Œç¬”è€…çš„AIOä¸»æœºå°±èƒ½ç›´æ¥åœ¨å…¬ç½‘æä¾›æœåŠ¡ã€‚å¸Œæœ›è¿™ä¸€å¤©èƒ½æ—©æ—¥åˆ°æ¥ã€‚</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="/2022/12/17/%E5%AE%89%E5%8D%93%E5%AF%B9%E6%8C%87%E5%AE%9AWiFi%E7%A6%81%E7%94%A8IPv6/">2022-12-17-å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E4%B8%BB%E6%9C%BA%E8%AE%BE%E7%BD%AE%E5%8D%8F%E8%AE%AE">åŠ¨æ€ä¸»æœºè®¾ç½®åè®® - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/DHCPv6#cite_note-rfc4339-1">DHCPv6 - Wikipedia</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/IPv6#Stateless_address_autoconfiguration_(SLAAC)">IPv6 - Wikipedia</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/IPv6_address#Stateless_address_autoconfiguration">IPv6 address - Wikipedia</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://www.ruijie.com.cn/jszl/83220/">IPv6ç³»åˆ—åŸºç¡€ç¯‡ï¼ˆä¸‹ï¼‰â€”é‚»å±…å‘ç°åè®®NDP - é”æ·ç½‘ç»œ</a><a href="#fnref:6" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:7" class="footnote-text"><span><a href="https://www.networkacademy.io/ccna/ipv6/stateless-address-autoconfiguration-slaac">IPv6 Stateless Address Auto-configuration (SLAAC) | NetworkAcademy.io</a><a href="#fnref:7" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:8" class="footnote-text"><span><a href="https://zh.wikipedia.org/zh-tw/DHCP_snooping">DHCP snooping - ç¶­åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨æ›¸</a><a href="#fnref:8" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:9" class="footnote-text"><span><a href="https://unix.stackexchange.com/questions/352231/iptables-dhcp-snooping">linux - iptables dhcp snooping - Unix &amp; Linux Stack Exchange</a><a href="#fnref:9" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:10" class="footnote-text"><span><a href="https://linux.die.net/man/8/ebtables">ebtables(8) - Linux man page</a><a href="#fnref:10" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:11" class="footnote-text"><span><a href="https://github.com/Azure/azure-container-networking/blob/v1.4.39/ebtables/ebtables.go#L111">azure-container-networking&#x2F;ebtables.go at v1.4.39 Â· Azure&#x2F;azure-container-networking</a><a href="#fnref:11" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç½‘ç»œ</tag>
      
      <tag>IPv6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨Prometheusç›‘æ§ç¡¬ç›˜SMARTä¿¡æ¯</title>
    <link href="/2022/12/23/%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7%E7%A1%AC%E7%9B%98SMART%E4%BF%A1%E6%81%AF/"/>
    <url>/2022/12/23/%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7%E7%A1%AC%E7%9B%98SMART%E4%BF%A1%E6%81%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>ç¬”è€…çš„NASï¼ˆæˆ–è€…è¯´ALL IN ONEä¸»æœºï¼‰å†…æœ‰ä¸¤å—3.5å¯¸çš„æœºæ¢°ç¡¬ç›˜ã€‚ç¾¤æ™–ã€TrueNASç­‰ç³»ç»Ÿå†…ç½®äº†æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯é€šè¿‡SMARTä¿¡æ¯ï¼ˆå‚æ•°ã€æ¸©åº¦ã€é€šç”µæ—¶é•¿ç­‰ï¼‰è§‚å¯Ÿç¡¬ç›˜å¥åº·çŠ¶å†µã€‚å¯æƒœç¬”è€…ä½¿ç”¨çš„æ˜¯Ubuntuç³»ç»Ÿï¼Œåªèƒ½å®šæœŸé€šè¿‡å‘½ä»¤è¡Œè¿›è¡Œæ£€æŸ¥ã€‚ä¸ºäº†æ›´æ–¹ä¾¿åœ°æŒæ¡ç¡¬ç›˜çš„å¥åº·çŠ¶å†µï¼Œç¬”è€…å†³å®šæ­å»ºä¸€å¥—å…³äºç¡¬ç›˜çš„ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="2-æ€è·¯"><a href="#2-æ€è·¯" class="headerlink" title="2. æ€è·¯"></a>2. æ€è·¯</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221223093351427.webp" alt="Prometheusæ¶æ„å›¾"></p><p>ç”±äºç¬”è€…å·²ç»æ­å»ºäº†ä¸€å¥—Prometheusç›‘æ§å¥—ä»¶ï¼Œæ‰€ä»¥è¯¥è§£å†³æ–¹æ¡ˆä¹Ÿä¼šåŸºäºPrometheusæ­å»ºã€‚æˆ‘ä»¬å¯ä»¥åƒä¹‹å‰çš„æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡](/2022/12/05/ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡/)">[1]</span></a></sup>ä¸€æ ·é€šè¿‡ä»£ç ä¸ŠæŠ¥SMARTä¿¡æ¯ï¼Œä½†ç›‘æ§ç¡¬ç›˜ä½œä¸ºæ¯”è¾ƒé€šç”¨çš„éœ€æ±‚ï¼Œåº”è¯¥å·²ç»æœ‰æˆç†Ÿæ–¹æ¡ˆäº†ã€‚æœä¸å…¶ç„¶ï¼Œ<a href="https://github.com/prometheus-community/node-exporter-textfile-collector-scripts">node-exporter-textfile-collector-scripts</a>ä»“åº“æä¾›äº†SMARTä¿¡æ¯æŠ“å–è„šæœ¬ï¼Œå¯é€šè¿‡node_exporterçš„<code>textfile-collector</code>æä¾›ç»™Promethuesã€‚æ•´ä½“çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=" mermaid">flowchart LR    A[æ•°æ®æŠ“å–è„šæœ¬]--sponge--&gt;B[.promæ–‡ä»¶]    C[node_exporter]--è¯»å–--&gt;B    D[Promethues]--pull--&gt;C    D--&gt;E[Alertmanager]    E--&gt;G[Telegramå‘Šè­¦]    F[Grafanaç›‘æ§]--&gt;D    style A stroke-dasharray:5    style B stroke-dasharray:5</code></pre><h1 id="3-æ–½å·¥"><a href="#3-æ–½å·¥" class="headerlink" title="3. æ–½å·¥"></a>3. æ–½å·¥</h1><ol><li><p>ä¸‹è½½æŠ“å–è„šæœ¬ã€‚å…‹éš†ä»“åº“åï¼Œä½¿ç”¨rootæƒé™å‘½ä»¤æ‰§è¡Œ<code>smartmon.sh</code>å³å¯çœ‹åˆ°SMARTè¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone git@github.com:prometheus-community/node-exporter-textfile-collector-scripts.git<br>cd node-exporter-textfile-collector-scripts<br>sudo ./smartmon.sh<br></code></pre></td></tr></table></figure><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221223095133005.webp"></p><p>åŒæ—¶æŒ‰ç…§ä»“åº“çš„æ¨èï¼Œå®‰è£…spongeç”¨äºè¾“å‡ºé‡å®šå‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install moreutils<br></code></pre></td></tr></table></figure></li><li><p>å®šæ—¶è¿è¡Œè„šæœ¬å¹¶ä¿å­˜ç»“æœã€‚ç”±äºè·å–SMARTä¿¡æ¯éœ€è¦rootæƒé™ï¼Œæ‰€ä»¥ç¬”è€…ä½¿ç”¨rootç”¨æˆ·çš„crontabï¼Œæ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡æŠ“å–è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo crontab -e<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crontab">* * * * * /home/worker/git/prometheus-community/node-exporter-textfile-collector-scripts/smartmon.sh | sponge /home/worker/log/smartmon.prom 2&gt;/home/worker/log/smartmon.stderr<br></code></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥ä½¿ç”¨spongeè€Œä¸æ˜¯ç®¡é“è¿›è¡Œè¾“å‡ºé‡å®šå‘ï¼Œæ˜¯å› ä¸ºshellåœ¨è¿›è¡Œè¾“å‡ºé‡å®šå‘æ—¶ä¼šå…ˆæ¸…ç©ºåŸæ–‡ä»¶ï¼Œå¯¼è‡´node_exporteråœ¨è¯»å–æ—¶æœ‰æœºç‡è¯»å–åˆ°ç©ºæ•°æ®ã€‚éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">head</span> ~/log/smartmon.prom</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">HELP smartmon_smartctl_version SMART metric smartctl_version</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">TYPE smartmon_smartctl_version gauge</span><br>smartmon_smartctl_version&#123;version=&quot;7.1&quot;&#125; 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br></code></pre></td></tr></table></figure></li><li><p>é…ç½®node_exporterã€‚åœ¨è¿è¡Œnode_exporteræ—¶æŒ‡å®š<code>textfile-collector</code>ç›®å½•ï¼Œç„¶åå¯é€šè¿‡curléªŒè¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shel">node_exporter --collector.textfile.directory=&#x27;/home/worker/log/&#x27;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl 127.0.0.1:9100/metrics</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">HELP smartmon_smartctl_version SMART metric smartctl_version</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">TYPE smartmon_smartctl_version gauge</span><br>smartmon_smartctl_version&#123;version=&quot;7.1&quot;&#125; 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br></code></pre></td></tr></table></figure></li><li><p>é…ç½®ç›‘æ§ã€‚æœ‰å›½å¤–ç½‘å‹é’ˆå¯¹ä¸Šè¿°è„šæœ¬é…ç½®äº†ç²¾ç¾çš„Grafanaé¢æ¿å¹¶åˆ†äº«åœ¨äº†GrafanaLabsä¸Š<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[S.M.A.R.T Dashboard | Grafana Labs](https://grafana.com/grafana/dashboards/13654-s-m-a-r-t-dashboard/)">[2]</span></a></sup>ï¼Œåœ¨Grafanaä¸Šè¾“å…¥å…¶ID<code>13654</code>å³å¯å¯¼å…¥ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221224091210859.webp"></p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221224091333135.webp"></p></li><li><p>ä¿®å¤é¢æ¿ã€‚å·¦ä¸Šè§’<code>Unhealthy Disks</code>çš„åŸæŸ¥è¯¢è¯­å¥ä¸ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-built_in">sum</span>(smartmon_device_smart_healthy&#123;instance<span class="hljs-operator">=</span><span class="hljs-operator">~</span>&quot;$instance&quot;&#125;)<span class="hljs-operator">-</span><span class="hljs-built_in">sum</span>(smartmon_device_smart_healthy&#123;instance<span class="hljs-operator">=</span><span class="hljs-operator">~</span>&quot;$instance&quot;&#125;)<br></code></pre></td></tr></table></figure><p>ç”±äºå‡å·ä¸¤è¾¹ç›¸ç­‰ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¿™ä¸ªæŸ¥è¯¢ç»“æœæ°¸è¿œä¸º0ã€‚ç¬”è€…å‘é‚®ä»¶è¯¢é—®äº†åŸä½œè€…ï¼Œä¸è¿‡è¿˜æ²¡æœ‰å¾—åˆ°å›å¤ã€‚æ”¹åŠ¨ä¸ºå¦‚ä¸‹æŸ¥è¯¢è¯­å¥åº”è¯¥åº”è¯¥èƒ½ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-built_in">count</span>(smartmon_device_smart_healthy&#123;instance<span class="hljs-operator">=</span><span class="hljs-operator">~</span>&quot;$instance&quot;&#125;)<span class="hljs-operator">-</span><span class="hljs-built_in">sum</span>(smartmon_device_smart_healthy&#123;instance<span class="hljs-operator">=</span><span class="hljs-operator">~</span>&quot;$instance&quot;&#125;)<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®å‘Šè­¦ã€‚åœ¨alerté…ç½®æ–‡ä»¶ï¼ˆç»†èŠ‚è§ä¹‹å‰çš„æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡](/2022/12/05/ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡/)">[1]</span></a></sup>ï¼‰ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œpromethuesä¼šåœ¨å‡ºç°ç¡¬ç›˜smartå¼‚å¸¸åå¯¹ç¬”è€…è¿›è¡Œå‘Šè­¦ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">smart</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">unhealthy_disks</span><br>    <span class="hljs-attr">expr:</span> <span class="hljs-string">count(smartmon_device_smart_healthy)-sum(smartmon_device_smart_healthy)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">for:</span> <span class="hljs-string">10m</span><br>    <span class="hljs-attr">annotations:</span><br>      <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;æœ‰ä¸å¥åº·çš„ç¡¬ç›˜&quot;</span><br></code></pre></td></tr></table></figure></li></ol><h1 id="4-æ•ˆæœ"><a href="#4-æ•ˆæœ" class="headerlink" title="4. æ•ˆæœ"></a>4. æ•ˆæœ</h1><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221224091333135.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221224093415453.webp"></th></tr></thead><tbody><tr><td>Grafanaçœ‹æ¿</td><td>Telegramé€šçŸ¥</td></tr></tbody></table><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="/2022/12/05/%E7%9B%91%E6%8E%A7%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F/">ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://grafana.com/grafana/dashboards/13654-s-m-a-r-t-dashboard/">S.M.A.R.T Dashboard | Grafana Labs</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç›‘æ§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“å¯¹æŒ‡å®šWiFiç¦ç”¨IPv6</title>
    <link href="/2022/12/17/%E5%AE%89%E5%8D%93%E5%AF%B9%E6%8C%87%E5%AE%9AWiFi%E7%A6%81%E7%94%A8IPv6/"/>
    <url>/2022/12/17/%E5%AE%89%E5%8D%93%E5%AF%B9%E6%8C%87%E5%AE%9AWiFi%E7%A6%81%E7%94%A8IPv6/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>è¿™æ˜¯ç¬”è€…ä¹‹å‰çš„å®¶åº­ç½‘ç»œæ¶æ„ï¼Œæ‰€æœ‰è®¾å¤‡é›†ä¸­åœ¨å®½å¸¦ç½‘å…³çš„äºŒçº§ NAT ä¸‹ï¼ŒåŒæ—¶æœ‰ä¸€å°æ—è·¯ç”±è®¾å¤‡ç”¨äºé€æ˜ä»£ç†ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/home_net_arch_old.drawio.svg"></p><p>åæ¥ç”±äºæŸäº›è®¾å¤‡æœ‰è¿æ¥å…¬ç½‘ IPv6 åœ°å€çš„éœ€æ±‚ï¼Œæ‰€ä»¥ç¬”è€…å°†äºŒçº§ NAT æ”¹æˆäº†æ— çº¿ AP ï¼Œæ‰€æœ‰è®¾å¤‡ç›´è¿å®½å¸¦ç½‘å…³ä»¥æ‹¿åˆ° IPv6 åœ°å€ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/home_net_arch_new.drawio.svg"></p><p>OP çš„å®‰å“è®¾å¤‡åœ¨ä¹‹å‰çš„ç½‘ç»œæ¶æ„ä¸­å°†æ—è·¯ç”±ä½œä¸ºç½‘å…³ã€‚ä½†åœ¨æ–°çš„ç½‘ç»œæ¶æ„ä¸­ï¼Œç”±äºå®‰å“è®¾å¤‡æ— æ³•è®¾ç½®é™æ€ IPv6 ï¼Œæ‰€ä»¥ IPv6 æµé‡æ— æ³•ç»è¿‡æ—è·¯ç”±ï¼›è€Œä¸”å³ä½¿ OP å°†å®‰å“è®¾å¤‡çš„ DNS å’Œ IPv4 ç½‘å…³è®¾ç½®ä¸ºæ—è·¯ç”±ï¼Œä½†å…¶ DNS è¯·æ±‚è¿˜æ˜¯<strong>æœ‰å¯èƒ½</strong>ç›´æ¥å‘é€åˆ°å®½å¸¦ç½‘å…³ä¸Šã€‚</p><p>ç”±äºç¬”è€…å¯¹åŸºäºæ—è·¯ç”±çš„é€æ˜ä»£ç†å’Œè‡ªå®šä¹‰DNSæœ‰è¾ƒå¼ºéœ€æ±‚ï¼Œæ‰€ä»¥ç¬”è€…å†³å®šè®©å®‰å“è®¾å¤‡åœ¨å®¶åº­ç½‘ç»œä¸­ä¸ä½¿ç”¨IPv6ï¼ˆä¸”ä¸å½±å“åœ¨å…¶å®ƒç½‘ç»œç¯å¢ƒä¸­ä½¿ç”¨IPv6ï¼‰ã€‚</p><h1 id="2-è¿œç¨‹ç«¯æ§åˆ¶ï¼ˆå¤±è´¥ï¼‰"><a href="#2-è¿œç¨‹ç«¯æ§åˆ¶ï¼ˆå¤±è´¥ï¼‰" class="headerlink" title="2. è¿œç¨‹ç«¯æ§åˆ¶ï¼ˆå¤±è´¥ï¼‰"></a>2. è¿œç¨‹ç«¯æ§åˆ¶ï¼ˆå¤±è´¥ï¼‰</h1><p>å®‰å“è®¾å¤‡é€šè¿‡æ— çº¿APæ¥å…¥ç½‘è·¯ï¼Œç¬”è€…é¦–å…ˆæƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æ— çº¿APå¤„è¿›è¡Œæ§åˆ¶ã€‚åªè¦é¿å…å®‰å“è®¾å¤‡è·å–åˆ°IPv6åœ°å€ï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚æŒ‰ç…§é”æ·çš„æ–‡ç« ä»‹ç»<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[IPv6ç³»åˆ—åŸºç¡€ç¯‡ï¼ˆä¸‹ï¼‰â€”é‚»å±…å‘ç°åè®®NDP - é”æ·ç½‘ç»œ](https://www.ruijie.com.cn/jszl/83220/)">[1]</span></a></sup>ï¼Œä¸»æœºæ— çŠ¶æ€é…ç½®IPv6æ˜¯é€šè¿‡ ICMPv6åè®®è¿›è¡Œçš„ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221217114114257.webp" alt="IPv6ä¸»æœºæ— çŠ¶æ€è‡ªåŠ¨é…ç½®çš„è¿‡ç¨‹"></p><p>ä½†ç¬”è€…åœ¨æ— çº¿APï¼ˆè¿è¡Œç€padavanç³»ç»Ÿçš„è·¯ç”±å™¨ï¼‰ä¸Šç”¨<code>tcpdump</code>æ¢æµ‹å®‰å“è®¾å¤‡ç›¸å…³çš„ç½‘ç»œæµé‡ï¼Œåªå‘ç°äº†é‚»å±…è¯·æ±‚ï¼ˆNSï¼‰çš„æµé‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcpdump -i br0 ether src $&#123;å®‰å“mac&#125; or ether dst  $&#123;å®‰å“mac&#125;<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">10:56:16.700518 IP6 :: &gt; ff02::1:ff48:xxx: ICMP6, neighbor solicitation, who has fe80::xxx, length 32<br>10:56:16.705741 IP6 :: &gt; ff02::16: HBH ICMP6, multicast listener report v2, 2 group record(s), length 48<br></code></pre></td></tr></table></figure><p>å†è€ƒè™‘åˆ°ICMPæ˜¯ç½‘ç»œå±‚åè®®ï¼Œæ— æ³•é€šè¿‡<code>iptables</code>ç­‰å·¥å…·è¿›è¡Œè¿‡æ»¤ï¼Œæ•…ç¬”è€…é€‰æ‹©æ”¾å¼ƒã€‚</p><h1 id="3-å®‰å“ç«¯æ§åˆ¶ï¼ˆæˆåŠŸï¼‰"><a href="#3-å®‰å“ç«¯æ§åˆ¶ï¼ˆæˆåŠŸï¼‰" class="headerlink" title="3. å®‰å“ç«¯æ§åˆ¶ï¼ˆæˆåŠŸï¼‰"></a>3. å®‰å“ç«¯æ§åˆ¶ï¼ˆæˆåŠŸï¼‰</h1><p>è™½ç„¶ä¸èƒ½é˜»æ­¢å®‰å“è®¾å¤‡è·å–IPv6åœ°å€ï¼Œä½†æˆ‘ä»¬ä¾ç„¶å¯ä»¥ç›´æ¥åœ¨å®‰å“ç«¯ç¦ç”¨IPv6åŠŸèƒ½ã€‚Reddit<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Disable IPv6 over wifi? : androiddev](https://www.reddit.com/r/androiddev/comments/k15y0a/disable_ipv6_over_wifi/)">[2]</span></a></sup>è®ºå›æœ‰äººæŒ‡å‡ºï¼Œå®‰å“åœ¨rootåå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç¦ç”¨WiFiçš„IPv6åŠŸèƒ½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo 0 | tee /proc/sys/net/ipv6/conf/wlan0/accept_ra<br>echo 1 | tee /proc/sys/net/ipv6/conf/all/disable_ipv6<br></code></pre></td></tr></table></figure><p>ç¬”è€…é€šè¿‡JuiceSSHéªŒè¯åç¡®è®¤æœ‰æ•ˆï¼Œä½†é‡è¿WiFiåIPv6åœ°å€ä¼šæ¢å¤ã€‚å†åŠ ä¸Šç¬”è€…åªæƒ³åœ¨å®¶åº­ç½‘ç»œç¦ç”¨å®‰å“çš„IPv6ï¼Œæ‰€ä»¥ç¬”è€…ä½¿ç”¨Taskerè½¯ä»¶è¿›è¡Œäº†é¢å¤–é…ç½®ï¼š</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221217123841698.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221217123710721.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221217123755563.webp"></th></tr></thead><tbody><tr><td>åœ¨Taskerå†…åˆ›å»ºä¸€ä¸ªé…ç½®</td><td>å½“WiFiè¿æ¥åˆ°æŒ‡å®šSSID</td><td>ä½¿ç”¨rootæ‰§è¡Œå¯¹åº”å‘½ä»¤</td></tr></tbody></table><p>é…ç½®å®Œæˆåï¼Œä¿æŒTaskerè¿è¡Œï¼Œå°±å¯ä»¥è®©ç¬”è€…çš„å®‰å“è®¾å¤‡åœ¨æ¥å…¥å®¶åº­ç½‘ç»œæ—¶ä¸ä½¿ç”¨IPv6äº†ã€‚</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.ruijie.com.cn/jszl/83220/">IPv6ç³»åˆ—åŸºç¡€ç¯‡ï¼ˆä¸‹ï¼‰â€”é‚»å±…å‘ç°åè®®NDP - é”æ·ç½‘ç»œ</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://www.reddit.com/r/androiddev/comments/k15y0a/disable_ipv6_over_wifi/">Disable IPv6 over wifi? : androiddev</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>æ•°ç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-åŠ æ¹¿ç¯‡</title>
    <link href="/2022/12/10/%E6%94%B9%E5%96%84%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F-%E5%8A%A0%E6%B9%BF%E7%AF%87/"/>
    <url>/2022/12/10/%E6%94%B9%E5%96%84%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F-%E5%8A%A0%E6%B9%BF%E7%AF%87/</url>
    
    <content type="html"><![CDATA[<h1 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h1><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡](/2022/12/09/æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡)">[1]</span></a></sup>ä¸­ï¼Œç¬”è€…é€šè¿‡æ–°é£å¤§å¹…ä¼˜åŒ–äº†å®¤å†…PM2.5å’ŒCO2æŒ‡æ ‡ã€‚å†¬å­£çš„åŒ—äº¬ç©ºæ°”ååˆ†å¹²ç‡¥ï¼Œå®¤å¤–ç©ºæ°”æ¹¿åº¦å¯èƒ½ä½è‡³20%ã€‚è€Œä½æ¹¿åº¦çš„ç©ºæ°”è¢«æ–°é£æºæºä¸æ–­é€å…¥å®¤å†…ï¼Œè®©å®¤å†…ç©ºæ°”æ¹¿åº¦å§‹ç»ˆç»´æŒåœ¨è¾ƒä½çš„æ°´å¹³ã€‚è€ƒè™‘åˆ°èˆ’é€‚çš„å®¤å†…æ¹¿åº¦ä¸º40%~60%<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æˆ¿é—´æ¹¿åº¦40%ï¼Œä¸çˆ±å¾—ç—…ï¼ˆå®¶å±…å¥åº·ï¼‰--ç§‘æŠ€--äººæ°‘ç½‘](http://scitech.people.com.cn/n/2013/0702/c1007-22041057.html)">[2]</span></a></sup>ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†è§£å†³ä½æ¹¿åº¦å¸¦æ¥çš„çš®è‚¤å®¹æ˜“å¹²ç‡¥ã€èµ·åºŠåå£é¼»ä¸èˆ’æœç­‰é—®é¢˜ï¼Œç¬”è€…å†³å®šé‡‡å–æ‰‹æ®µæå‡å®¤å†…æ¹¿åº¦ã€‚</p><h1 id="2-æ–¹æ¡ˆé€‰æ‹©"><a href="#2-æ–¹æ¡ˆé€‰æ‹©" class="headerlink" title="2. æ–¹æ¡ˆé€‰æ‹©"></a>2. æ–¹æ¡ˆé€‰æ‹©</h1><p>å®¤å†…åŠ æ¹¿å™¨æ˜¯æ¯”è¾ƒç›´æ¥çš„é€‰æ‹©ã€‚ç¬”è€…äº†è§£åå‘ç°å¸‚é¢ä¸Šä¸»è¦æœ‰ä¸¤ç±»åŠ æ¹¿å™¨ï¼šè¶…å£°æ³¢åŠ æ¹¿å™¨ã€è’¸å‘å‹åŠ æ¹¿å™¨ã€‚</p><table><thead><tr><th>å“ç±»</th><th>åŸç†</th><th>åŠ æ¹¿æ•ˆæœ</th><th>ä»·æ ¼</th><th>ä½¿ç”¨æ°´è´¨</th><th>æ¸…æ´—é¢‘ç‡</th><th>å®‰å…¨æ€§</th></tr></thead><tbody><tr><td>è¶…å£°æ³¢åŠ æ¹¿å™¨</td><td>å°†æ°´æ‰“ç¢æˆå°æ°´æ»´</td><td>å¼º</td><td>ä½</td><td>çº¯å‡€æ°´</td><td>é«˜</td><td>ä½<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[è¶…å£°æ³¢åŠ æ¹¿å™¨ï¼Œåˆ°åº•èƒ½ä¸èƒ½ç”¨ï¼Ÿ\_ç§‘æ™®ä¸­å›½ç½‘](https://www.kepuchina.cn/yc/202201/t20220107_3114895.shtml)">[3]</span></a></sup><sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[éŸ©å›½åŠ æ¹¿å™¨â€œæ€äººâ€äº‹ä»¶æœ€æ–°è°ƒæŸ¥ï¼šè‡³å°‘1.4ä¸‡äººæ­»äº¡ åŠ æ¹¿å™¨è¿˜èƒ½ç”¨å—ï¼Ÿ\_æ–°é—»\_å¤®è§†ç½‘(cctv.com)](http://m.news.cctv.com/2020/07/29/ARTITgCagrGFrX6jBuDWdLSn200729.shtml)">[4]</span></a></sup></td></tr><tr><td>è’¸å‘å‹åŠ æ¹¿å™¨</td><td>è®©æ°´è’¸å‘</td><td>å¼±</td><td>é«˜</td><td>æ— ç‰¹æ®Šè¦æ±‚</td><td>ä½</td><td>é«˜</td></tr></tbody></table><p>ç”±äºåŸç†é™åˆ¶ï¼Œè¶…å£°æ³¢åŠ æ¹¿å™¨ä¼šæ— å·®åˆ«åœ°å°†æ°´ä¸­æ‚è´¨ï¼ˆç»†èŒ&#x2F;åŒ–å­¦ç‰©è´¨ç­‰ï¼‰æ‰©æ•£åˆ°ç©ºæ°”ä¸­ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨è¶…å£°æ³¢åŠ æ¹¿å™¨ä¸­ï¼Œä¸ä»…è¦ä¿è¯æ°´è´¨å¹²å‡€ã€è¿˜è¦é¢‘ç¹æ¸…æ´åŠ æ¹¿å™¨ï¼Œå¦åˆ™å®¹æ˜“æœ‰å®‰å…¨é£é™©ã€‚ç¬”è€…å¹¶ä¸æƒ³åœ¨ä½¿ç”¨åŠ æ¹¿å™¨æ—¶èŠ±è´¹å¤ªå¤šç²¾åŠ›ï¼Œæ‰€ä»¥é€‰æ‹©äº†ä»·æ ¼æ›´è´µã€ä½†æ›´ä½¿ç”¨èµ·æ¥æ›´ä¾¿æ·çš„è’¸å‘å‹åŠ æ¹¿å™¨ã€‚å…·ä½“å‹å·çš„é€‰æ‹©å¯ä»¥å‚è€ƒå…ˆçœ‹è¯„æµ‹çš„è§†é¢‘<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[è®¤çœŸæµ‹äº†ä¸€ä¸ªæœˆï¼å‘Šè¯‰ä½  2022 å¹´å“ªæ¬¾åŠ æ¹¿å™¨å€¼å¾—ä¹°\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1KD4y1e7nA/)">[5]</span></a></sup>ã€‚</p><p>å½±å“è’¸å‘å‹åŠ æ¹¿å™¨åŠ æ¹¿æ•ˆæœçš„è¦ç´ ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š</p><ul><li><strong>æ¸©åº¦</strong>ã€‚æ°´çš„æ¸©åº¦è¶Šé«˜ï¼ŒåŠ æ¹¿æ•ˆæœè¶Šå¥½ã€‚</li><li><strong>è’¸å‘é¢ç§¯</strong>ã€‚è’¸å‘é¢ç§¯è¶Šå¤§ï¼ŒåŠ æ¹¿æ•ˆæœè¶Šå¥½ã€‚</li><li><strong>é£é‡</strong>ã€‚é£é‡è¶Šå¤§ï¼ŒåŠ æ¹¿æ•ˆæœè¶Šå¥½ã€‚</li></ul><h1 id="3-å®è·µ"><a href="#3-å®è·µ" class="headerlink" title="3. å®è·µ"></a>3. å®è·µ</h1><h2 id="3-1-æ”¹é€ ç©ºæ°”å‡€åŒ–å™¨"><a href="#3-1-æ”¹é€ ç©ºæ°”å‡€åŒ–å™¨" class="headerlink" title="3.1 æ”¹é€ ç©ºæ°”å‡€åŒ–å™¨"></a>3.1 æ”¹é€ ç©ºæ°”å‡€åŒ–å™¨</h2><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡](/2022/12/09/æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡)">[1]</span></a></sup>ä¸­ï¼Œç¬”è€…é€šè¿‡æ”¹é€ ç©ºæ°”å‡€åŒ–å™¨å®ç°äº†æ–°é£çš„æ•ˆæœã€‚åŒå•†å®¶è¿˜æœ‰å°†ç©ºæ°”å‡€åŒ–å™¨æ”¹é€ æˆåŠ æ¹¿å™¨çš„å¥—ä»¶ï¼Œå¤ç”¨ç»„ä»¶+ä»·æ ¼ä½å»‰ï¼ˆï¿¥200ï¼‰ä¸¤å¤§ä¼˜åŠ¿è®©ç¬”è€…ç«‹åˆ»ä¸‹äº†å•ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210182921083.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210183141611.webp"></th></tr></thead></table><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210184130772.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210183820899.webp"></th></tr></thead></table><p>ç„¶è€Œå®é™…ä½“éªŒåï¼Œç¬”è€…å‘ç°è¿™ä¸ªåŠ æ¹¿æ–¹æ¡ˆæ•ˆæœéå¸¸ä¸€èˆ¬ã€‚ä¸­åˆå¼€å§‹åŠ æ¹¿åï¼Œå®¤å†…æ¹¿åº¦ä»25%ç¼“æ…¢æå‡è‡³30%ï¼Œä¹‹åå°±åœæ»åœ¨30%å·¦å³ã€‚ä»è€—æ°´é€Ÿåº¦æ¨æµ‹ï¼Œè¿™ä¸ªåŠ æ¹¿æ–¹æ¡ˆçš„å®é™…åŠ æ¹¿èƒ½åŠ›çº¦ä¸º100ml&#x2F;hï¼Œè€Œå¸‚é¢ä¸Šå¸¸è§çš„è’¸å‘å‹åŠ æ¹¿å™¨åŠ æ¹¿èƒ½åŠ›æ™®éèƒ½è¾¾åˆ°600ml&#x2F;hã€‚</p><p>ç¬”è€…åˆ†æä¹‹åï¼Œå‘ç°è¿™ä¸ªåŠ æ¹¿æ–¹æ¡ˆåœ¨ä¸Šæ–‡æåˆ°çš„åŠ æ¹¿ä¸‰è¦ç´ ä¸Šéƒ½åšå¾—è¾ƒå·®ï¼š</p><ul><li><strong>æ¸©åº¦</strong>ã€‚ç”±äºç©ºæ°”å‡€åŒ–å™¨æ¥çš„æ˜¯å®¤å¤–ç©ºæ°”ï¼Œè€ŒåŒ—äº¬å†¬å­£å®¤å¤–æ¸©åº¦å¾€å¾€åœ¨é›¶ä¸‹ï¼Œæ‰€ä»¥ç©ºæ°”å‡€åŒ–å™¨å¹å‡ºçš„é£æ¸©åº¦ä¹Ÿå¾ˆä½ã€‚</li><li><strong>è’¸å‘é¢ç§¯</strong>ã€‚è¿™ä¸ªæ”¹è£…å¥—ä»¶ç”¨äº†å¸æ°´ç½‘æå‡è’¸å‘é¢ç§¯ã€‚æ°´ç®±é‡Œæ°´ä½è¾ƒé«˜æ—¶å¸æ°´ç½‘é€é£çš„éƒ¨åˆ†è¾ƒå°‘ã€æ°´ä½è¾ƒä½æ—¶é«˜å¤„çš„å¸æ°´ç½‘å¾ˆéš¾å¸åˆ°æ°´åˆ†ã€‚æ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆçš„è’¸å‘é¢ç§¯å§‹ç»ˆæ¯”è¾ƒä½ã€‚</li><li><strong>é£é‡</strong>ã€‚ç”±äºæ–°é£ä¸éœ€è¦å¤ªå¤§é£é‡ï¼Œæ‰€ä»¥ç¬”è€…ä¸€ç›´è®©ç©ºæ°”å‡€åŒ–å™¨ä¿æŒåœ¨æ¯”è¾ƒä½çš„é£é‡ã€‚</li></ul><h2 id="3-2-æ¢ç”¨åŠ æ¹¿å™¨"><a href="#3-2-æ¢ç”¨åŠ æ¹¿å™¨" class="headerlink" title="3.2 æ¢ç”¨åŠ æ¹¿å™¨"></a>3.2 æ¢ç”¨åŠ æ¹¿å™¨</h2><p>å‘ç°æ”¹é€ å‡€åŒ–å™¨çš„æ–¹æ¡ˆè¡Œä¸é€šåï¼Œç¬”è€…å¾ˆå¿«é€‰æ‹©äº†ä¸€æ¬¾â€œæ­£ç»â€çš„åŠ æ¹¿å™¨ï¼ˆï¿¥600ï¼‰ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210190138737.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210190514003.webp"></th></tr></thead></table><p>ç›¸æ¯”ä¸Šä¸€ä¸ªåŠ æ¹¿æ–¹æ¡ˆï¼Œè¿™æ¬¾åŠ æ¹¿å™¨åœ¨åŠ æ¹¿ä¸‰è¦ç´ ä¸Šéƒ½æœ‰æ”¹è¿›ï¼š</p><ul><li><strong>æ¸©åº¦</strong>ã€‚ç”±äºæ˜¯ç›´æ¥æ”¾åœ¨å®¤å†…ï¼Œç¯å¢ƒæ¸©åº¦æ›´é«˜ã€‚</li><li><strong>è’¸å‘é¢ç§¯</strong>ã€‚è¿™æ¬¾åŠ æ¹¿å™¨ä½¿ç”¨çš„æ»¤èŠ¯ï¼ˆä¸Šå›¾3å·ï¼‰ä½äºæ°´ç®±ï¼ˆä¸Šå›¾8å·ï¼‰ä¹‹ä¸Šï¼Œæ°´é€šè¿‡ä¸€ä¸ªå°ç®¡é“æå‡åˆ°æ»¤èŠ¯é¡¶éƒ¨ï¼Œå§‹ç»ˆä¿è¯è’¸å‘é¢ç§¯æœ€å¤§ã€‚</li><li><strong>é£é‡</strong>ã€‚ç”±äºä¸å’Œå®¤å¤–ç©ºæ°”äº¤æ¢ï¼Œæ‰€ä»¥è°ƒæ•´åŠ æ¹¿å™¨é£é‡æ—¶åªéœ€è€ƒè™‘å™ªéŸ³ã€‚</li></ul><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210191018549.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210191135433.webp"></th></tr></thead><tbody><tr><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210191233201.webp"></td><td><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210191440960.webp"></td></tr></tbody></table><p>ç¬”è€…æ”¾ç½®åŠ æ¹¿å™¨çš„æˆ¿é—´é¢ç§¯çº¦ä¸º17å¹³ç±³ï¼Œæ¸©åº¦çº¦ä¸º25Â°ã€‚æ”¶åˆ°åŠ æ¹¿å™¨åï¼Œç¬”è€…åœ¨14:30ç”¨æœ€å¤§é£é‡ï¼ˆæ¯”è¾ƒåµï¼‰å¼€å§‹åŠ æ¹¿ï¼Œæ­¤æ—¶æ¹¿åº¦ä¸åˆ°30%ï¼›å‚æ™šæ—¶å®¤å†…æ¹¿åº¦å‡é«˜è‡³50%ã€‚åˆ°äº†æ™šä¸Š23:30ï¼Œç¬”è€…å°†åŠ æ¹¿å™¨è°ƒæ•´ä¸ºç¡çœ æ¨¡å¼ï¼Œå®¤å†…æ¹¿åº¦é€æ¸ä»50%ä¸‹é™åˆ°43%ã€‚ä»è€—æ°´é€Ÿåº¦æ¥çœ‹ï¼Œè¿™æ¬¾åŠ æ¹¿å™¨çš„å®é™…èƒ½åŠ›æ˜¯æ¥è¿‘å…¶å®£ä¼ å€¼ï¼ˆæœ€å¤§600ml&#x2F;hã€ç¡çœ æ¨¡å¼260ml&#x2F;hï¼‰çš„ã€‚</p><p>è™½ç„¶åœ¨æ—¥å¸¸ä½¿ç”¨æ—¶ä¸èƒ½å§‹ç»ˆåªå¼€å¯ç¡çœ æ¨¡å¼ï¼Œä½†è€ƒè™‘åˆ°å…¶åŠ æ°´è¾ƒä¸ºæ–¹ä¾¿ï¼ˆå°†æ°´ç®±æ‹†é™¤åå¯ç›´æ¥ç”¨æ°´é¾™å¤´åŠ æ»¡5å‡æ°´ï¼‰ï¼Œæ‰€ä»¥æ€»ä½“è€Œè¨€ç¬”è€…å¯¹è¿™æ¬¾åŠ æ¹¿å™¨çš„è¡¨ç°ååˆ†æ»¡æ„ã€‚</p><h1 id="4-åè®°"><a href="#4-åè®°" class="headerlink" title="4. åè®°"></a>4. åè®°</h1><p>ç›¸æ¯”å…¶å®ƒæ•ˆæœæ›´å¥½ï¼ˆå½“ç„¶ä»·æ ¼ä¹Ÿæ›´è´µï¼‰çš„è’¸å‘å‹åŠ æ¹¿å™¨ï¼Œç¬”è€…é€‰æ‹©çš„è¿™æ¬¾åŠ æ¹¿å™¨åªé€‚ç”¨äºé¢ç§¯ä¸å¤§çš„æˆ¿é—´ã€‚æƒ³è¦åŠ æ¹¿æ›´å¤§çš„æˆ¿ä»·ã€ç”šè‡³æ˜¯å…¨å±‹åŠ æ¹¿ï¼Œè’¸å‘å‹åŠ æ¹¿å™¨å°±å¾—è€ƒè™‘ç”¨ç”µè¾…çƒ­æé«˜æ•ˆç‡äº†ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè®¸å¤šå·¥ä¸šçº§åŠ æ¹¿å™¨ä¼šé€‰æ‹©è¶…å£°æ³¢åŠ æ¹¿çš„æ–¹æ¡ˆã€‚åŠ æ¹¿å™¨çš„é€‰æ‹©ï¼Œæ›´å¤šä¹Ÿå¾—ç»“åˆå…·ä½“çš„éœ€æ±‚æ¥çœ‹å§ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210200802577.webp"><br /><sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="[352 H300åŠ æ¹¿å‡€åŒ–ä¸€ä½“æœºè¯„æµ‹\_ä½¿ç”¨æ•ˆæœæ€ä¹ˆæ ·\_æ™ºèƒ½å®¶](https://m.znj.com/news/120978.html)">[6]</span></a></sup></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221210200033630.webp"><br /><sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" aria-label="[è¶…å£°æ³¢åŠ æ¹¿å™¨é™¤æ¹¿äº§å“-åŠ æ¹¿äº§å“-é˜²çˆ†ç©ºè°ƒ-æ’æ¸©æ’æ¹¿æœº-ç²¾å¯†ç©ºè°ƒ-è½¬è½®é™¤æ¹¿æœº-æ¹¿ç¾ç”µæ°”](http://m.msshimei.com/product.html?type1=2&type2=14)">[7]</span></a></sup></th></tr></thead><tbody><tr><td>åŠ æ¹¿é‡2500ml&#x2F;h</td><td>åŠ æ¹¿é‡3000ml&#x2F;h</td></tr></tbody></table><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="/2022/12/09/%E6%94%B9%E5%96%84%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F-%E6%96%B0%E9%A3%8E%E7%AF%87">æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="http://scitech.people.com.cn/n/2013/0702/c1007-22041057.html">æˆ¿é—´æ¹¿åº¦40%ï¼Œä¸çˆ±å¾—ç—…ï¼ˆå®¶å±…å¥åº·ï¼‰â€“ç§‘æŠ€â€“äººæ°‘ç½‘</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.kepuchina.cn/yc/202201/t20220107_3114895.shtml">è¶…å£°æ³¢åŠ æ¹¿å™¨ï¼Œåˆ°åº•èƒ½ä¸èƒ½ç”¨ï¼Ÿ_ç§‘æ™®ä¸­å›½ç½‘</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="http://m.news.cctv.com/2020/07/29/ARTITgCagrGFrX6jBuDWdLSn200729.shtml">éŸ©å›½åŠ æ¹¿å™¨â€œæ€äººâ€äº‹ä»¶æœ€æ–°è°ƒæŸ¥ï¼šè‡³å°‘1.4ä¸‡äººæ­»äº¡ åŠ æ¹¿å™¨è¿˜èƒ½ç”¨å—ï¼Ÿ_æ–°é—»_å¤®è§†ç½‘(cctv.com)</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://www.bilibili.com/video/BV1KD4y1e7nA/">è®¤çœŸæµ‹äº†ä¸€ä¸ªæœˆï¼å‘Šè¯‰ä½  2022 å¹´å“ªæ¬¾åŠ æ¹¿å™¨å€¼å¾—ä¹°_å“”å“©å“”å“©_bilibili</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://m.znj.com/news/120978.html">352 H300åŠ æ¹¿å‡€åŒ–ä¸€ä½“æœºè¯„æµ‹_ä½¿ç”¨æ•ˆæœæ€ä¹ˆæ ·_æ™ºèƒ½å®¶</a><a href="#fnref:6" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:7" class="footnote-text"><span><a href="http://m.msshimei.com/product.html?type1=2&type2=14">è¶…å£°æ³¢åŠ æ¹¿å™¨é™¤æ¹¿äº§å“-åŠ æ¹¿äº§å“-é˜²çˆ†ç©ºè°ƒ-æ’æ¸©æ’æ¹¿æœº-ç²¾å¯†ç©ºè°ƒ-è½¬è½®é™¤æ¹¿æœº-æ¹¿ç¾ç”µæ°”</a><a href="#fnref:7" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç›‘æ§</tag>
      
      <tag>ç”Ÿæ´»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡-æ–°é£ç¯‡</title>
    <link href="/2022/12/09/%E6%94%B9%E5%96%84%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F-%E6%96%B0%E9%A3%8E%E7%AF%87/"/>
    <url>/2022/12/09/%E6%94%B9%E5%96%84%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F-%E6%96%B0%E9%A3%8E%E7%AF%87/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡](/2022/12/05/ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡/)">[1]</span></a></sup>ä¸­ï¼Œç¬”è€…æ­å»ºäº†ä¸€å¥—ç©ºæ°”è´¨é‡ç›‘æ§æ–¹æ¡ˆã€‚ä½†éšä¹‹è€Œæ¥çš„æ˜¯æŒç»­çš„å‘Šè­¦ä»¥åŠç³Ÿç³•çš„ç©ºæ°”ã€‚æœ€æç«¯çš„æ—¶å€™ï¼Œç¬”è€…èƒ½ä»ç›‘æ§ä¸Šè§‚å¯Ÿåˆ°è¶…è¿‡100çš„å®¤å†…PM2.5æµ“åº¦ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209201254014.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209203204756.webp" alt="image-20221209203204756"></th></tr></thead></table><p>åœ¨ä¸‹å†³å¿ƒæ”¹å–„å®¤å†…ç©ºæ°”è´¨é‡åï¼Œæ‘†åœ¨ç¬”è€…é¢å‰çš„æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š<code>ç©ºæ°”å‡€åŒ–å™¨</code>å’Œ<code>æ–°é£</code>ã€‚ä¸¤è€…éƒ½å¯ä»¥é™ä½å®¤å†…PM2.5ï¼Œä½†å‰è€…åªèƒ½è¢«åŠ¨å‡€åŒ–æµå…¥å®¤å†…çš„å®¤å¤–ç©ºæ°”ï¼ˆ<del>å…ˆæ±¡æŸ“åæ²»ç†</del>ï¼‰ï¼Œè€Œåè€…èƒ½ä¸»åŠ¨å‡€åŒ–å®¤å¤–ç©ºæ°”å¹¶é€å…¥å±‹å†…ï¼Œé™¤äº†èƒ½é™ä½å®¤å†…PM2.5ï¼Œè¿˜èƒ½ä¿è¯ä½CO2æµ“åº¦ã€é¿å…å®¤å†…ç§¯ç°ã€‚<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ–°é£ç³»ç»ŸVSç©ºæ°”å‡€åŒ–å™¨ï¼Œå®ƒå®Œç¾èƒœå‡ºï¼-è‹å·ç±³äºšæ™ºèƒ½ç§‘æŠ€æœ‰é™å…¬å¸MIAVENTILATION-æ–°é£ç³»ç»Ÿ-å®¶ç”¨æ–°é£ç³»ç»Ÿ-æ–°é£ç³»ç»ŸOEM-å…¨çƒ­äº¤æ¢å™¨-æ–°é£æ¢æ°”æœº-æ–°é£æœº](http://www.miachina.net/MIANews?id=684)">[2]</span></a></sup></p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/20190724150419_3180.webp"></p><p>è™½ç„¶æ–°é£ä¼šå¯¼è‡´å®¤å†…æ¸©æ¹¿åº¦å®¹æ˜“å—å®¤å¤–å½±å“ï¼Œä½†åœ¨ä¸€ä¼—è§†é¢‘çš„è¯±æƒ‘ä¸‹<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ–°é£æ¶ˆè´¹è€…æŠ¥å‘Š | çˆ±å¦å‡ºå“\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1A4411u7gg/?vd_source=834a38204871938e13afaddb910f3b67)">[3]</span></a></sup><sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[25å²è‡ªè£…ä¿®ï½œæ–°é£æœ€å¼ºã€Œé¿å‘æŒ‡å—ã€åè¡€æ•´ç†ï¼\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV18R4y1V7DV/?spm_id_from=333.337.search-card.all.click&vd_source=834a38204871938e13afaddb910f3b67)">[4]</span></a></sup>ï¼Œç¬”è€…æœ€ç»ˆè¿˜æ˜¯å°†ç›®å…‰é”å®šåœ¨äº†æ–°é£ä¸Šã€‚</p><h1 id="2-æ–°é£äº§å“é€‰æ‹©"><a href="#2-æ–°é£äº§å“é€‰æ‹©" class="headerlink" title="2. æ–°é£äº§å“é€‰æ‹©"></a>2. æ–°é£äº§å“é€‰æ‹©</h1><p>æ–°é£çš„å½¢æ€å¤šç§å¤šæ ·ï¼Œç¬”è€…äº†è§£åˆ°æœ‰å¦‚ä¸‹å‡ ç§ã€‚</p><h2 id="2-1-ä¸­å¤®æ–°é£"><a href="#2-1-ä¸­å¤®æ–°é£" class="headerlink" title="2.1 ä¸­å¤®æ–°é£"></a>2.1 ä¸­å¤®æ–°é£</h2><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209205604949.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209205820116.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209210021944.webp"></th></tr></thead></table><p>ä¸­å¤®æ–°é£ç³»ç»Ÿä½œä¸ºæ–°é£äº§å“çš„é¡¶çº§å½¢æ€ï¼Œè¢«å¹¿æ³›è¿ç”¨äºå•†åœºã€å†™å­—æ¥¼ç­‰åœºåˆã€‚è™½ç„¶ä¸­å¤®æ–°é£æ¢æ°”æ•ˆæœå¼ºå¤§ã€è¿˜å¯ä»¥ä½¿ç”¨çƒ­äº¤æ¢æ¥å‡å°‘å®¤å¤–æ¸©åº¦å¯¹å®¤å†…çš„å½±å“ï¼Œä½†ç”±äºä»·æ ¼æ˜‚è´µã€ä¸”éœ€è¦åœ¨è£…ä¿®æˆ¿å±‹ä¹‹å‰æå‰è§„åˆ’ï¼Œæ‰€ä»¥åœ¨å®¶åº­åœºåˆè¾ƒä¸ºå°‘è§ã€‚</p><h2 id="2-2-å£æŒ‚æ–°é£æœº"><a href="#2-2-å£æŒ‚æ–°é£æœº" class="headerlink" title="2.2  å£æŒ‚æ–°é£æœº"></a>2.2  å£æŒ‚æ–°é£æœº</h2><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/biguashi-xinfengqi.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209211336151.webp"></th></tr></thead></table><p>ç›¸æ¯”ä¸­å¤®æ–°é£ç³»ç»Ÿï¼Œå£æŒ‚å¼æ–°é£çš„å®‰è£…çµæ´»æ€§å°±è¦å¼ºä¸å°‘ï¼Œä¸€èˆ¬åªéœ€è¦åœ¨å¢™ä¸Šæ‰“å‡ºå¤§å°åˆé€‚çš„æ´ä½œä¸ºè¿›é£å£å³å¯ã€‚</p><h2 id="2-3-æ–°é£ç©ºè°ƒ"><a href="#2-3-æ–°é£ç©ºè°ƒ" class="headerlink" title="2.3 æ–°é£ç©ºè°ƒ"></a>2.3 æ–°é£ç©ºè°ƒ</h2><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209212241148.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209212709055.webp"></th></tr></thead></table><p>æ–°é£ç©ºè°ƒä½œä¸ºç»“åˆç©ºè°ƒå’Œæ–°é£çš„æ–°å“ç±»ï¼Œå…ˆçœ‹è¯„æµ‹å¯¹ç›¸å…³äº§å“è¿›è¡Œè¿‡è¯¦ç»†çš„è¯„æµ‹<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[ç©ºè°ƒæ–°ç‰©ç§ï¼Ÿç±³å®¶æ–°é£ç©ºè°ƒä½“éªŒ | å…ˆç¹ä¸ºå¿«\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1dy4y1t7E8/?vd_source=834a38204871938e13afaddb910f3b67)">[5]</span></a></sup>ã€‚æ–°é£ç©ºè°ƒç›¸æ¯”æ–°é£æœºæ¥è¯´å®‰è£…çµæ´»æ€§æ›´å¼ºï¼Œä½†éä¸“ç”¨çš„è¿›é£å£ä¹Ÿä¼šå½±å“æ–°é£ç©ºè°ƒçš„æ¢æ°”èƒ½åŠ›ã€‚</p><h2 id="2-4-ç±³çš®æ–°é£"><a href="#2-4-ç±³çš®æ–°é£" class="headerlink" title="2.4 ç±³çš®æ–°é£"></a>2.4 ç±³çš®æ–°é£</h2><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209214635749.webp" alt="image-20221209214635749"></p><p>è™½ç„¶æ–°é£ç©ºè°ƒçš„å®‰è£…çµæ´»æ€§å·²ç»è¶³å¤Ÿé«˜ï¼Œä½†å¯¹äºç§Ÿæˆ¿ä¸€æ—çš„ç¬”è€…æ¥è¯´ä¹°ä¸€ä¸ªæ–°é£ç©ºè°ƒè¿˜æ˜¯æœ‰ç‚¹è¿‡äºå¥¢ä¾ˆã€‚ä¸‡å¹¸çš„æ˜¯å¸‚é¢ä¸Šè¿˜æœ‰ç»ˆæå»‰ä»·è§£å†³æ–¹æ¡ˆï¼šç©ºæ°”å‡€åŒ–å™¨+å¯¼é£ç®¡ï¼Œæˆ–è€…ç®€ç§°ä¸ºç±³çš®æ–°é£ã€‚ç©ºæ°”å‡€åŒ–å™¨ä¸å†å‡€åŒ–å®¤å†…ç©ºæ°”ï¼Œè€Œæ˜¯ç»ç”±å¯çµæ´»å®‰è£…çš„å¯¼é£ç®¡å‡€åŒ–å®¤å¤–ç©ºæ°”ï¼Œå†å°†æ–°é²œç©ºæ°”è¾“å‡ºåˆ°å®¤å†…ï¼ˆ<del>å……åˆ†ä½“ç°äº†ç®¡é“å’Œåˆ†è€Œæ²»ä¹‹çš„æ€æƒ³</del>ï¼‰ã€‚ç¬”è€…åœ¨ç ”ç©¶äº†å®¤å†…çš„å¯¼é£æ¡ä»¶åï¼Œç«‹å³åœ¨æ·˜å®ä¸Šè´­å…¥äº†ç›¸å…³å¥—ä»¶ã€‚</p><h1 id="3-å®‰è£…"><a href="#3-å®‰è£…" class="headerlink" title="3. å®‰è£…"></a>3. å®‰è£…</h1><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209220045066.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209220229005.webp" alt="image-20221209220229005"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209215915645.webp"></th></tr></thead></table><p>å®‰è£…è¿‡ç¨‹æ¯”è¾ƒç®€å•ã€‚å°†ç©ºæ°”å‡€åŒ–å™¨çš„ä¸‹åŠéƒ¨åˆ†æ›¿æ¢ä¸ºå¯¼é£åº•åº§ï¼Œå¹¶åœ¨å…¶ä¸­æ”¾å…¥æ»¤èŠ¯ï¼›å°†å‡€åŒ–å™¨ä¸»ä½“ç”¨å¯¼é£ç®¡å’ŒæŒ¡é£æ¿ç›¸è¿åï¼Œå†ç”¨æ¨æ‹‰çª—ç´§ç´§å¤¹ä½æŒ¡é£æ¿å³å¯ã€‚</p><h1 id="4-æ•ˆæœ"><a href="#4-æ•ˆæœ" class="headerlink" title="4. æ•ˆæœ"></a>4. æ•ˆæœ</h1><p>ç¬”è€…åœ¨å®‰è£…å®Œè¿™å¥—æ–°é£å–å¾—äº†ç«‹ç«¿è§å½±çš„æ•ˆæœï¼šæ•°å°æ—¶å†…å®¤å†…PM2.5æµ“åº¦å°±ä»100+ä¸‹é™è‡³äº†0ã€‚å¯æƒœé»˜è®¤ä¿ç•™15å¤©æ•°æ®çš„Prometheuså·²ç»ä¸¢å¤±äº†å½“æ—¶çš„ç›‘æ§è®°å½•ï¼Œæ— æ³•ä»¥å›¾ç‰‡å½¢å¼å±•ç¤ºã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209221136039.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209221543799.webp"></th></tr></thead></table><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221209221252008.webp"></p><p>ç¬”è€…åœ¨å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼ŒåŒ—äº¬çš„PM2.5æµ“åº¦å·²ç»æ¥è¿‘100<sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="[åŒ—äº¬ç©ºæ°”è´¨é‡æŒ‡æ•°ï¼ˆAQIï¼‰å’Œä¸­å›½ ç©ºæ°”æ±¡æŸ“| IQAir](https://www.iqair.cn/cn/china/beijing)">[6]</span></a></sup>ï¼Œä½†å³ä½¿æ˜¯ä¸€ä¸ªç›¸å½“ä½çš„æ¢æ°”é€Ÿåº¦ï¼ˆç¬”è€…å§å®¤çº¦17å¹³ç±³ï¼‰ï¼Œè¿™å¥—æ–°é£ç³»ç»Ÿä¾ç„¶èƒ½å°†å®¤å†…PM2.5æµ“åº¦æ§åˆ¶åœ¨20ä»¥ä¸‹ï¼Œå®¤å†…äºŒæ°§åŒ–ç¢³æµ“åº¦åœ¨ç»è¿‡äº†è¿ç»­å‡ å¤©çš„åœ¨å®¶åŠå…¬åä¹Ÿä¾ç„¶è¶³å¤Ÿä½ã€‚ç¬”è€…å¯¹æ­¤è¡¨ç¤ºå¾ˆæ»¡æ„ï¼</p><p>PSï¼šä»ç©ºæ°”å‡€åŒ–å™¨çš„æ¹¿åº¦ä¼ æ„Ÿå™¨æ¥çœ‹ï¼Œç¬”è€…çš„å®¤å†…ç©ºæ°”å·²ç»è¿œä¸åƒåŒ—äº¬å†¬å¤©çš„å®¤å¤–ç©ºæ°”é‚£æ ·å¹²ç‡¥ã€‚è¿™æ˜¯å› ä¸ºç¬”è€…å·²ç»é‡‡å–æªæ–½æ”¹å–„äº†å®¤å†…æ¹¿åº¦ï¼Œé¢„è®¡ä¼šåœ¨ä¸‹ç¯‡æ–‡ç« åˆ†äº«ã€‚</p><h1 id="5-ä¼˜åŒ–é£é“"><a href="#5-ä¼˜åŒ–é£é“" class="headerlink" title="5. ä¼˜åŒ–é£é“"></a>5. ä¼˜åŒ–é£é“</h1><p>ä½¿ç”¨ä¸€æ®µæ—¶é—´åç¬”è€…é€šè¿‡ç›‘æ§å‘ç°ï¼Œè™½ç„¶å®¤å†…ç©ºæ°”è´¨é‡ç›¸æ¯”å®¤å¤–å¥½ä¸Šä¸å°‘ï¼Œä½†åœ¨å®¤å¤–ç©ºæ°”æ±¡æŸ“æ¯”è¾ƒä¸¥é‡ã€æˆ–è€…é£æ¯”è¾ƒå¤§æ—¶ï¼Œå®¤å†…PM2.5ç­‰æŒ‡æ ‡ä¾ç„¶ä¼šä¸Šå‡ã€‚åˆ†æå®¤å†…è¿›å‡ºé£å£åç¬”è€…å‘ç°ï¼Œç”±äºä½¿ç”¨ç±³çš®æ–°é£åæ¨æ‹‰çª—å¤„äºåŠå¼€çŠ¶æ€ï¼Œæ‰€ä»¥å®¤å¤–ç©ºæ°”å®¹æ˜“ä»ä¸¤å±‚æ¨æ‹‰çª—ä¸­é—´çš„ç¼éš™ä¸­è¿›å…¥å®¤å†…ã€‚</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221229125233049.webp"></p><p>åœ¨è´­ä¹°äº†åšåº¦åˆé€‚çš„æµ·ç»µæŒ¡é£æ¡ï¼Œå¹¶å°†å…¶å¡å…¥æ¨æ‹‰çª—ä¸­é—´çš„ç¼éš™åï¼Œå®¤å†…ç©ºæ°”è´¨é‡è¿›ä¸€æ­¥æ”¹å–„ï¼ŒPM2.5å€¼é•¿æœŸè¶‹è¿‘äº0ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221229125454887.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221229130138001.webp"></th></tr></thead></table><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="/2022/12/05/%E7%9B%91%E6%8E%A7%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F/">ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="http://www.miachina.net/MIANews?id=684">æ–°é£ç³»ç»ŸVSç©ºæ°”å‡€åŒ–å™¨ï¼Œå®ƒå®Œç¾èƒœå‡ºï¼-è‹å·ç±³äºšæ™ºèƒ½ç§‘æŠ€æœ‰é™å…¬å¸MIAVENTILATION-æ–°é£ç³»ç»Ÿ-å®¶ç”¨æ–°é£ç³»ç»Ÿ-æ–°é£ç³»ç»ŸOEM-å…¨çƒ­äº¤æ¢å™¨-æ–°é£æ¢æ°”æœº-æ–°é£æœº</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.bilibili.com/video/BV1A4411u7gg/?vd_source=834a38204871938e13afaddb910f3b67">æ–°é£æ¶ˆè´¹è€…æŠ¥å‘Š | çˆ±å¦å‡ºå“_å“”å“©å“”å“©_bilibili</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://www.bilibili.com/video/BV18R4y1V7DV/?spm_id_from=333.337.search-card.all.click&vd_source=834a38204871938e13afaddb910f3b67">25å²è‡ªè£…ä¿®ï½œæ–°é£æœ€å¼ºã€Œé¿å‘æŒ‡å—ã€åè¡€æ•´ç†ï¼_å“”å“©å“”å“©_bilibili</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://www.bilibili.com/video/BV1dy4y1t7E8/?vd_source=834a38204871938e13afaddb910f3b67">ç©ºè°ƒæ–°ç‰©ç§ï¼Ÿç±³å®¶æ–°é£ç©ºè°ƒä½“éªŒ | å…ˆç¹ä¸ºå¿«_å“”å“©å“”å“©_bilibili</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://www.iqair.cn/cn/china/beijing">åŒ—äº¬ç©ºæ°”è´¨é‡æŒ‡æ•°ï¼ˆAQIï¼‰å’Œä¸­å›½ ç©ºæ°”æ±¡æŸ“| IQAir</a><a href="#fnref:6" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç›‘æ§</tag>
      
      <tag>ç”Ÿæ´»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡</title>
    <link href="/2022/12/05/%E7%9B%91%E6%8E%A7%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F/"/>
    <url>/2022/12/05/%E7%9B%91%E6%8E%A7%E5%AE%A4%E5%86%85%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h1><p>çˆ±å¦å‡ºå“çš„æ–°é£æ¶ˆè´¹æŠ¥å‘Š<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ–°é£æ¶ˆè´¹è€…æŠ¥å‘Š | çˆ±å¦å‡ºå“\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1A4411u7gg/)">[1]</span></a></sup>é‡Œæåˆ°äº†ä¸€ä¸ªæ¦‚å¿µï¼šå®¤å†…ç©ºæ°”çš„å››ä¸ªç»ˆæç›®æ ‡æ˜¯æ’æ¸©ã€æ’æ¹¿ã€æ’å‡€ã€æ’æ°§ã€‚ç¬”è€…å¯¹æ­¤æ·±æ„Ÿè®¤åŒï¼Œå¯æƒœç¬”è€…ç”Ÿæ´»çš„åŒ—äº¬å¹¶æ²¡æœ‰è¶³å¤Ÿå®œäººçš„æ°”å€™<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[æ¨¡æ¿:åŒ—äº¬å¸‚æ°”å€™æ•°æ® - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/Template:%E5%8C%97%E4%BA%AC%E5%B8%82%E6%B0%94%E5%80%99%E6%95%B0%E6%8D%AE)">[2]</span></a></sup>ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221205220501060.webp"></p><p>ç©ºæ°”è´¨é‡æŒ‡æ•°<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[åŒ—äº¬ç©ºæ°”è´¨é‡æŒ‡æ•°AQI\_PM2.5æœˆç»Ÿè®¡å†å²æ•°æ®\_ä¸­å›½ç©ºæ°”è´¨é‡åœ¨çº¿ç›‘æµ‹åˆ†æå¹³å°å†å²æ•°æ®](https://www.aqistudy.cn/historydata/monthdata.php?city=%E5%8C%97%E4%BA%AC)">[3]</span></a></sup>ä¹Ÿå ªå¿§ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221205215834953.webp"></p><p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œä¸ºäº†ä¿è¯å®¤å†…ç©ºæ°”å«æ°§é‡ï¼Œç¬”è€…çš„çª—æˆ·å¸¸å¹´æ˜¯åŠå¼€çš„ã€‚è¿™å°±å¯¼è‡´å®¤å†…ç©ºæ°”å¾ˆå®¹æ˜“å—å®¤å¤–å½±å“ï¼Œä¸ä»…å®¹æ˜“ç§¯ç°ï¼Œè€Œä¸”å¾€å¾€è¦ç­‰ç©ºæ°”è´¨é‡æ˜¾è‘—ç³Ÿç³•æ—¶ç¬”è€…æ‰ä¼šæƒ³åˆ°è¦å…³çª—ã€‚</p><p>ä¸ºäº†èƒ½æ›´å¥½åœ°è¯„ä¼°å®¤å†…ç©ºæ°”è´¨é‡ï¼Œå¹¶æŒ‡å¯¼æ”¹è¿›çš„æ–¹å‘ï¼Œç¬”è€…å†³å®šæ­å»ºä¸€å¥—ç›‘æ§å®¤å†…ç©ºæ°”è´¨é‡çš„è§£å†³æ–¹æ¡ˆã€‚éœ€è¦ç›‘æ§çš„æŒ‡æ ‡åŒ…æ‹¬ï¼šæ¸©åº¦&#x2F;æ¹¿åº¦&#x2F;äºŒæ°§åŒ–ç¢³&#x2F;PM2.5ã€‚</p><h1 id="2-ç¡¬ä»¶éƒ¨åˆ†"><a href="#2-ç¡¬ä»¶éƒ¨åˆ†" class="headerlink" title="2. ç¡¬ä»¶éƒ¨åˆ†"></a>2. ç¡¬ä»¶éƒ¨åˆ†</h1><p>é¦–å…ˆæ˜¯ç‰©ç¾ä»·å»‰çš„ç±³å®¶è“ç‰™æ¸©æ¹¿åº¦è®¡2ï¼Œåªè¦29å³å¯å®ç°æ¸©æ¹¿åº¦æµ‹é‡ï¼Œå¹¶å¯åœ¨APPç«¯æŸ¥çœ‹å†å²æ•°æ®ã€‚ç„¶è€Œå®é™…ä½“éªŒå¹¶ä¸å¥½ï¼Œæ‰“å¼€APPåå¾ˆéš¾ç›´æ¥åŠ è½½æˆåŠŸæ•°æ®ï¼ˆç¬”è€…ç”šè‡³è¦é‡å¯è“ç‰™æ‰è¡Œï¼‰ï¼ŒæŸ¥çœ‹å†å²æ•°æ®åŠŸèƒ½ä¹Ÿä¸èƒ½è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ã€‚ä¸æ¸…æ¥šä½¿ç”¨è“ç‰™ç½‘å…³åä½“éªŒèƒ½å¦å¾—åˆ°æå‡ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/c44018f98ca3bc62.webp"></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206092203598.webp" alt="image-20221206092203598" style="zoom:50%;" /></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206092129994.webp" alt="image-20221206092129994" style="zoom:50%;" /></th></tr></thead></table><p>ç„¶åæ˜¯åŠŸèƒ½ç›¸å¯¹å®Œå–„çš„é’èç©ºæ°”æ£€æµ‹ä»ªLiteã€æ·˜å®æŸå“ç‰Œç©ºæ°”æ£€æµ‹ä»ªï¼Œåœ¨500å…ƒçš„ä»·ä½ä¸Šéƒ½èƒ½åšåˆ°æ¸©åº¦&#x2F;æ¹¿åº¦&#x2F;äºŒæ°§åŒ–ç¢³&#x2F;PM2.5çš„æ£€æµ‹ã€‚</p><table><thead><tr><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/O1CN017VZrO42DFEU0obiX7_!!2201232258579.webp" alt="img" style="zoom:50%;" /></th><th><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206093206207.webp" alt="image-20221206093206207" style="zoom:50%;" /></th></tr></thead></table><p>é’èè¿™æ¬¾æ¥å…¥äº†ç±³å®¶ç”Ÿæ€ï¼Œèƒ½å¾ˆå¥½å’Œå…¶ä½™è®¾å¤‡è”åŠ¨ï¼Œå¤–å½¢ä¹Ÿæ›´ä¸ºç®€çº¦ã€‚æŸå“ç‰Œè¿™æ¬¾ä¼˜ç‚¹æ˜¯è‡ªå®šä¹‰ç¨‹åº¦é«˜ï¼Œå’Œåº—å®¶å’¨è¯¢åå¾—çŸ¥å…¶èƒ½é€šè¿‡USBå°†ç›‘æ§æ•°æ®å‘é€ä¸»æœºï¼Œå¹¶æä¾›äº†ä¸€ä»½æºç <sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="[JoeyZheng/Lewei365B35ï¼šä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä»365 B35è·å–æ•°æ®ï¼Œç„¶åå‘é€åˆ°Lewei50å¹³å°ï¼Œç”¨äºç½‘é¡µå’Œå¾®ä¿¡çš„æ•°æ®ç›‘æ§å’Œè·Ÿè¸ªã€‚](https://github.com/JoeyZheng/Lewei365B35)">[4]</span></a></sup>ä½œä¸ºå‚è€ƒã€‚ç¬”è€…è€ƒè™‘åˆ°ä½¿ç”¨ç±³å®¶APPçš„ä½“éªŒä¸ä½³ï¼Œä¸”æœ‰è¾ƒå¤šè‡ªå®šä¹‰éœ€æ±‚ï¼Œæ‰€ä»¥è´­å…¥äº†åè€…ã€‚</p><p>åè€…åˆ°æ‰‹åç¬”è€…å‘ç°äº†ä¸€äº›å°é—®é¢˜ï¼š</p><ul><li>ç”±äºéœ€è¦é€šè¿‡USBå‘é€æ£€æµ‹æ•°æ®ï¼Œæ‰€ä»¥æ£€æµ‹ä»ªä¸èƒ½ç¦»ä¸»æœºå¤ªè¿œï¼Œè€Œæ‘†æ”¾çš„ä½ç½®å¯èƒ½ä¼šå½±å“æ£€æµ‹å‡†ç¡®æ€§</li><li>ç”±äºéœ€è¦å§‹ç»ˆè¿æ¥USBï¼Œå„éƒ¨ä»¶çš„å‘çƒ­ï¼ˆåŒ…æ‹¬å†…ç½®ç”µæ± ï¼‰ä¼šå½±å“æ¸©åº¦æ£€æµ‹å‡†ç¡®æ€§</li><li>USBå‘é€çš„æ£€æµ‹æ•°æ®ä¸­ä¸åŒ…æ‹¬PM10ï¼Œå•†å®¶è§£é‡Šè¿™æ˜¯å› ä¸ºå›½å†…çš„PM10ä¼ æ„Ÿå™¨æ™®éä¸å‡†ç¡®</li></ul><p>å¥½åœ¨è¿™äº›é—®é¢˜ç¬”è€…éƒ½èƒ½æ¥å—ã€‚æœ‰äº†æ•°æ®æºåï¼Œä¸‹é¢å°±å¼€å§‹æ­£å¼æ–½å·¥ã€‚</p><h1 id="3-è½¯ä»¶éƒ¨åˆ†"><a href="#3-è½¯ä»¶éƒ¨åˆ†" class="headerlink" title="3. è½¯ä»¶éƒ¨åˆ†"></a>3. è½¯ä»¶éƒ¨åˆ†</h1><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/architecture.webp" alt="prometheusæ¶æ„å›¾"></p><p>å‚è€ƒPrometheusçš„æ¶æ„å›¾ï¼Œç¬”è€…åˆ—å‡ºäº†è‡ªå·±è¿™å¥—ç›‘æ§æ–¹æ¡ˆçš„æ¶æ„å›¾ï¼šå®šæœŸæŠ“å–ç©ºæ°”æ£€æµ‹æ•°æ®å¹¶ä¸ŠæŠ¥ã€Grafanaåšå±•ç¤ºã€å‘Šè­¦åˆ™ç”¨Telegramè§¦è¾¾ã€‚</p><pre><code class=" mermaid">flowchart LR    A[ç©ºæ°”æ£€æµ‹ä»ª]--USB--&gt;B[PC]    B-.push.-&gt;C[Pushgateway]    D[Promethues]-.pull.-&gt;C    D--&gt;E[Alertmanager]    E--&gt;G[Telegram]    F[Grafana]--&gt;D    style C stroke-dasharray:5    style E stroke-dasharray:5</code></pre><h2 id="3-1-ä¸ŠæŠ¥æ£€æµ‹æ•°æ®"><a href="#3-1-ä¸ŠæŠ¥æ£€æµ‹æ•°æ®" class="headerlink" title="3.1 ä¸ŠæŠ¥æ£€æµ‹æ•°æ®"></a>3.1 ä¸ŠæŠ¥æ£€æµ‹æ•°æ®</h2><p>åœ¨<a href="https://github.com/prometheus/pushgateway/releases">releasesé¡µ</a>ä¸‹è½½æœ€æ–°Pushgatewayåç”¨<a href="http://supervisord.org/index.html">Supervisor</a>ç­‰å·¥å…·è¿è¡Œï¼Œå³å¯åœ¨9091ç«¯å£ä¸Šæä¾›APIæœåŠ¡ã€‚</p><p>å°†æ£€æµ‹ä»ªè¿æ¥åˆ°PCåï¼ŒPCä¼šè‡ªåŠ¨è¯†åˆ«åˆ°è¯¥è®¾å¤‡ï¼ˆwin10&#x2F;ubuntu20.04éƒ½æ— éœ€é¢å¤–å®‰è£…é©±åŠ¨ï¼Œå¥½è¯„ï¼‰ã€‚ç”¨æ³¢ç‰¹ç‡57600è¿æ¥åï¼Œç¬”è€…å‘ç°æ£€æµ‹ä»ªå°†PM2.5&#x2F;CO2&#x2F;æ¸©åº¦&#x2F;æ¹¿åº¦ç­‰æ•°æ®ä»¥CSVæ ¼å¼å‘¨æœŸæ€§å‘é€è‡³PCã€‚</p><p>äºæ˜¯å¯ä»¥ç¼–å†™å¦‚ä¸‹è„šæœ¬ï¼Œç”¨äºè§£ææ£€æµ‹ä»ªæä¾›çš„æ•°æ®å¹¶å°†å…¶å‘é€è‡³Pushgatewayï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> serial<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> requests<br><br>PORT = <span class="hljs-string">&#x27;/dev/ttyUSB0&#x27;</span><br>BRATE = <span class="hljs-number">57600</span><br>HOST = socket.gethostname()<br>alias = &#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;0.3um&#x27;</span>, <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;pm2.5&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;hcho&#x27;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&#x27;co2&#x27;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-number">5</span>: <span class="hljs-string">&#x27;humidity&#x27;</span>&#125;<br><br>session = requests.Session()<br>device = serial.Serial(port=PORT, baudrate=BRATE, timeout=<span class="hljs-number">2</span>)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    time.sleep(<span class="hljs-number">0.1</span>)<br>    <span class="hljs-keyword">if</span> device.in_waiting &gt; <span class="hljs-number">0</span>:<br>        text = device.readline().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).strip()  <span class="hljs-comment"># type: <span class="hljs-built_in">str</span></span><br>        lines = [<span class="hljs-string">&#x27;# TYPE b36_air_monitor gauge&#x27;</span>]<br>        <span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(text.split(<span class="hljs-string">&#x27;,&#x27;</span>)):<br>            name = alias.get(i)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:<br>                <span class="hljs-keyword">continue</span><br>            lines.append(<br>                <span class="hljs-string">f&#x27;b36_air_monitor&#123;&#123;instance=&quot;<span class="hljs-subst">&#123;PORT&#125;</span>&quot;,alias=&quot;<span class="hljs-subst">&#123;name&#125;</span>&quot;,index=&quot;<span class="hljs-subst">&#123;i&#125;</span>&quot;&#125;&#125; <span class="hljs-subst">&#123;val&#125;</span>&#x27;</span>)<br>        lines.append(<span class="hljs-string">&#x27;&#x27;</span>)<br>        url = <span class="hljs-string">f&#x27;http://127.0.0.1:9091/metrics/job/<span class="hljs-subst">&#123;HOST&#125;</span>&#x27;</span>  <span class="hljs-comment"># Pushgatewayåœ°å€</span><br>        <span class="hljs-keyword">try</span>:<br>            session.post(url, data=<span class="hljs-string">&#x27;\n&#x27;</span>.join(lines))<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-built_in">print</span>(datetime.now())<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(ex))<br></code></pre></td></tr></table></figure><p>è¿è¡Œåå¯è¯»å–Pushgatewayçš„è¾“å‡ºè¿›è¡ŒéªŒè¯ï¼ˆç”±äºç¬”è€…è´­ä¹°çš„æ£€æµ‹ä»ªæ²¡æœ‰æ­é…ç”²é†›æ¨¡å—ï¼Œæ‰€ä»¥hchoçš„å€¼å§‹ç»ˆä¸º0ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl 127.0.0.1:9091/metrics</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">TYPE b36_air_monitor gauge</span><br>b36_air_monitor&#123;alias=&quot;0.3um&quot;,index=&quot;0&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 250<br>b36_air_monitor&#123;alias=&quot;co2&quot;,index=&quot;3&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 687<br>b36_air_monitor&#123;alias=&quot;hcho&quot;,index=&quot;2&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 0<br>b36_air_monitor&#123;alias=&quot;humidity&quot;,index=&quot;5&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 28<br>b36_air_monitor&#123;alias=&quot;pm2.5&quot;,index=&quot;1&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 1<br>b36_air_monitor&#123;alias=&quot;temp&quot;,index=&quot;4&quot;,instance=&quot;/dev/ttyUSB0&quot;,job=&quot;nas&quot;&#125; 26<br></code></pre></td></tr></table></figure><h2 id="3-2-æ¥å…¥Prometheus"><a href="#3-2-æ¥å…¥Prometheus" class="headerlink" title="3.2 æ¥å…¥Prometheus"></a>3.2 æ¥å…¥Prometheus</h2><p>æ•°æ®ä¸ŠæŠ¥åˆ°Pushgatewayåï¼Œä¸‹ä¸€æ­¥æ˜¯ç”±Prometheusè¿›è¡ŒæŠ“å–ã€‚åœ¨<code>scrape_configs</code>ä¸‹å¢åŠ é…ç½®å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&quot;pushgateway&quot;</span><br>    <span class="hljs-attr">honor_labels:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&quot;localhost:9091&quot;</span>]<br></code></pre></td></tr></table></figure><p>é‡å¯Prometheusåå¯åœ¨Webé¡µé¢éªŒè¯ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206184333163.webp"></p><h2 id="3-3-é…ç½®å‘Šè­¦"><a href="#3-3-é…ç½®å‘Šè­¦" class="headerlink" title="3.3 é…ç½®å‘Šè­¦"></a>3.3 é…ç½®å‘Šè­¦</h2><p>ä»ç¬”è€…æŸ¥é˜…çš„èµ„æ–™æ¥çœ‹ï¼ŒPM2.5æµ“åº¦å°äº35Î¼g&#x2F;m3ã€CO2æµ“åº¦å°äº1000ppmæ˜¯æ¯”è¾ƒèˆ’é€‚çš„å®¤å†…ç©ºæ°”æ ‡å‡†<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="[å®¤å…§ç©ºæ°£å“è³ªæ¨™æº– â€“ æµ¦ç¾…ç‰¹å®˜æ–¹è¨è«–å€](https://purotechbogger.wordpress.com/air/)">[5]</span></a></sup>ï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206190207027.webp"></p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/e59c96e789873737381.webp"></p><p>äºæ˜¯ç¬”è€…åŸºäºè¿™ä¸¤ä¸ªæ•°å€¼ä¸ºæŠ“å–åˆ°çš„æ•°æ®é…ç½®äº†å‘Šè­¦ã€‚é¦–å…ˆæ˜¯åœ¨<a href="https://github.com/prometheus/alertmanager/releases">releasesé¡µ</a>ä¸‹è½½æœ€æ–°Alertmanagerå¹¶ç”¨<a href="http://supervisord.org/index.html">Supervisor</a>å·¥å…·è¿è¡Œï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">route:</span><br>  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;tg&#x27;</span><br><span class="hljs-attr">receivers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;tg&#x27;</span><br>    <span class="hljs-attr">telegram_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">api_url:</span> <span class="hljs-string">&quot;https://api.telegram.org&quot;</span><br>      <span class="hljs-attr">bot_token:</span> <span class="hljs-string">&quot;xx:xx&quot;</span><br>      <span class="hljs-attr">chat_id:</span> <span class="hljs-string">xxx</span><br>      <span class="hljs-attr">parse_mode:</span> <span class="hljs-string">&quot;HTML&quot;</span><br>      <span class="hljs-attr">http_config:</span><br>        <span class="hljs-attr">proxy_url:</span> <span class="hljs-string">&quot;xxx&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯åœ¨Promethuesçš„é…ç½®ä¸­åŠ å…¥å‘Šè­¦è§„åˆ™ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># prometheus.yml</span><br><span class="hljs-attr">rule_files:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;prometheus_alert.yml&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># prometheus_alert.yml</span><br><span class="hljs-attr">groups:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">air_monitor</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighCO2</span><br>    <span class="hljs-attr">expr:</span> <span class="hljs-string">avg(b36_air_monitor&#123;job=&quot;nas&quot;,instance=&quot;/dev/ttyUSB0&quot;,alias=&quot;co2&quot;&#125;)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">1000</span><br>    <span class="hljs-attr">for:</span> <span class="hljs-string">10m</span><br>    <span class="hljs-attr">annotations:</span><br>      <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;å®¤å†…CO2æµ“åº¦è¶…è¿‡1000&quot;</span><br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighPM2.5</span><br>    <span class="hljs-attr">expr:</span> <span class="hljs-string">avg(b36_air_monitor&#123;job=&quot;nas&quot;,instance=&quot;/dev/ttyUSB0&quot;,alias=&quot;pm2.5&quot;&#125;)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">35</span><br>    <span class="hljs-attr">for:</span> <span class="hljs-string">10m</span><br>    <span class="hljs-attr">annotations:</span><br>      <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;å®¤å†…PM2.5æµ“åº¦è¶…è¿‡35&quot;</span><br></code></pre></td></tr></table></figure><p>å½“è¿‡å»10åˆ†é’ŸPM2.5æµ“åº¦&#x2F;CO2æµ“åº¦è¶…è¿‡è®¾å®šå€¼æ—¶ï¼ŒPromethuesä¼šé€šè¿‡Alertmanagerå‘ç¬”è€…çš„Telegramå‘é€å‘Šè­¦ã€‚</p><h1 id="4-æ•ˆæœå±•ç¤º"><a href="#4-æ•ˆæœå±•ç¤º" class="headerlink" title="4. æ•ˆæœå±•ç¤º"></a>4. æ•ˆæœå±•ç¤º</h1><p>æœ€åæ¥çœ‹çœ‹æ•ˆæœï¼š</p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206191154479.webp" alt="Grafanaç›‘æ§çœ‹æ¿"></p><p><img src="https://picutres-1251933829.cos.ap-beijing.myqcloud.com/image-20221206191249249.webp" alt="Telegramå‘Šè­¦"></p><p>ç¬”è€…è¡¨ç¤ºå¾ˆæ»¡æ„ï¼</p><p>PSï¼šå…¶å®ä»ä¸Šå›¾çš„ç›‘æ§å¯ä»¥çœ‹å‡ºï¼Œç¬”è€…çš„å®¤å†…PM2.5&#x2F;CO2æµ“åº¦éƒ½æ¯”è¾ƒä½ï¼Œè¿™æ˜¯å› ä¸ºç¬”è€…åœ¨å†™ä¸‹è¿™ç¯‡æ–‡ç« æ—¶å·²ç»é€šè¿‡ä¸€äº›æ‰‹æ®µå¤§å¹…æ”¹å–„ç©ºæ°”çŠ¶å†µäº†ï¼Œç¬”è€…ä¼šåœ¨åç»­çš„æ–‡ç« è¿›è¡Œåˆ†äº«~</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.bilibili.com/video/BV1A4411u7gg/">æ–°é£æ¶ˆè´¹è€…æŠ¥å‘Š | çˆ±å¦å‡ºå“_å“”å“©å“”å“©_bilibili</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://zh.wikipedia.org/wiki/Template:%E5%8C%97%E4%BA%AC%E5%B8%82%E6%B0%94%E5%80%99%E6%95%B0%E6%8D%AE">æ¨¡æ¿:åŒ—äº¬å¸‚æ°”å€™æ•°æ® - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.aqistudy.cn/historydata/monthdata.php?city=%E5%8C%97%E4%BA%AC">åŒ—äº¬ç©ºæ°”è´¨é‡æŒ‡æ•°AQI_PM2.5æœˆç»Ÿè®¡å†å²æ•°æ®_ä¸­å›½ç©ºæ°”è´¨é‡åœ¨çº¿ç›‘æµ‹åˆ†æå¹³å°å†å²æ•°æ®</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://github.com/JoeyZheng/Lewei365B35">JoeyZheng&#x2F;Lewei365B35ï¼šä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä»365 B35è·å–æ•°æ®ï¼Œç„¶åå‘é€åˆ°Lewei50å¹³å°ï¼Œç”¨äºç½‘é¡µå’Œå¾®ä¿¡çš„æ•°æ®ç›‘æ§å’Œè·Ÿè¸ªã€‚</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://purotechbogger.wordpress.com/air/">å®¤å…§ç©ºæ°£å“è³ªæ¨™æº– â€“ æµ¦ç¾…ç‰¹å®˜æ–¹è¨è«–å€</a><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>ç›‘æ§</tag>
      
      <tag>ç”Ÿæ´»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨Afterburnerå’ŒGrafanaç›‘æ§PCæ€§èƒ½</title>
    <link href="/2022/08/20/%E7%94%A8Afterburner%E5%92%8CGrafana%E7%9B%91%E6%8E%A7PC%E6%80%A7%E8%83%BD/"/>
    <url>/2022/08/20/%E7%94%A8Afterburner%E5%92%8CGrafana%E7%9B%91%E6%8E%A7PC%E6%80%A7%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç›‘æ§LinuxæœåŠ¡å™¨æ€§èƒ½å·²ç»æœ‰æ¯”è¾ƒæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆäº†ï¼šç¬”è€…ç”¨çš„æ˜¯<code>node_exporter</code>+<code>Prometheus</code>+<code>Grafana</code>çš„ç»å…¸ä¸‰ä»¶å¥—ï¼Œæ•´ä½“æ•ˆæœä»¤äººæ»¡æ„ï¼š</p><table><thead><tr><th>æ•´ä½“æ¶æ„</th><th>Grafanaé¢æ¿</th></tr></thead><tbody><tr><td><img src="/images/2022/8/20/43f3ee1d6e7cc42258812b94b31292d3.jpg"></td><td><img src="/images/2022/8/20/5315d9b41fb01e5f42efbcdb90c33b38.jpg"></td></tr></tbody></table><p>åŒæ—¶ç¬”è€…åœ¨ä½¿ç”¨PCæ—¶å¶å°”è¿˜ä¼šä½¿ç”¨<a href="https://www.msi.com/Landing/afterburner/graphics-cards">MSI Afterburner</a>ï¼ˆä»¥ä¸‹ç®€ç§°Afterburnerï¼‰æ¥è§‚å¯ŸPCæ€§èƒ½ï¼š</p><p><img src="/images/2022/8/20/be56457ed0e1952818d51b2009053c09.jpg"></p><p>ä½†Afterburnerçš„ç›‘æ§åŠŸèƒ½å¹¶ä¸æ˜“ç”¨ï¼ˆç‰¹åˆ«æ˜¯åœ¨é«˜åˆ†è¾¨ç‡ä¸‹ï¼‰ï¼Œå¦‚æœèƒ½å°†ç›‘æ§æ•°æ®åœ¨Grafanaä¸Šå‘ˆç°é‚£å°±å¤ªæ£’äº†ã€‚<a href="https://github.com/RafhaanShah/grAfterburner">RafhaanShah&#x2F;grAfterburner</a>è¿™ä¸ªå¼€æºé¡¹ç›®åšåˆ°äº†è¿™ç‚¹ï¼Œå…¶ä½¿ç”¨çš„æ˜¯æ–¹æ¡ˆæ˜¯<a href="https://collectd.org/">collectd</a>+<a href="https://graphiteapp.org/">Graphite</a>+<a href="https://grafana.com/">Grafana</a>ï¼Œæ•´ä½“ç”¨<code>docker-compose</code>å¯åŠ¨ã€‚ä¸è¿‡ç”±äºç¬”è€…å·²ç»æœ‰äº†å¦ä¸€å¥—åŸºäº<code>Prometheus</code>çš„ç›‘æ§æ–¹æ¡ˆï¼Œæ‰€ä»¥ç¬”è€…å†³å®šæ–°é€ ä¸ªè½®å­æ¥å¤ç”¨ç°æœ‰çš„ç›‘æ§ç»„ä»¶ã€‚</p><h1 id="è·å–æ•°æ®"><a href="#è·å–æ•°æ®" class="headerlink" title="è·å–æ•°æ®"></a>è·å–æ•°æ®</h1><p>Afterburneræœ¬ä½“åœ¨<a href="https://www.msi.com/Landing/afterburner/graphics-cards">å®˜ç½‘</a>ä¸‹è½½å¹¶å®‰è£…å³å¯ï¼Œä½†Afterburnerä¸ç›´æ¥å¯¹å¤–æä¾›ç›‘æ§æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«<code>MSI Afterburner Remote Server</code>çš„å°å·¥å…·æ¥åšåˆ°ã€‚è¿™ä¸ªå·¥å…·æ˜¯ä¸ºäº†åœ¨æ‰‹æœºä¸Šç›‘æ§PCæ€§èƒ½è€Œå¼€å‘çš„ï¼Œä½†å› ä¸ºç§ç§åŸå› å®˜ç½‘å·²ç»ä¸å†æä¾›å…¶ä¸‹è½½å…¥å£ï¼Œæœ€æ–°ç‰ˆæœ¬ä¹Ÿåœç•™åœ¨2011å¹´å¼€å‘çš„V1.2ã€‚ä¸‡å¹¸çš„æ˜¯æˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸‰æ–¹ç½‘ç«™ä¸‹è½½åˆ°è¿™ä¸ªå·¥å…·ï¼ˆ<a href="https://drive.google.com/file/d/1zRZQ8_aEQcKwld3uavyT0aFi3b4sux-R/view">google driver</a>ã€<a href="https://github.com/wolf-joe/data-backup/tree/main/software/msi-afterburner">github</a>ï¼‰ã€‚</p><p>è¿è¡ŒAfterburneråï¼Œç‚¹å‡»<code>MSI Afterburner Remote Server</code>çš„ä¸»ç¨‹åºï¼Œè¯¥å·¥å…·ä¼šåœ¨åå°è¿è¡Œï¼Œå¹¶åœ¨æ‰˜ç›˜åŒºåŸŸå†…å±•ç¤ºå¯†ç ã€ç«¯å£ï¼ˆé»˜è®¤82ï¼‰ç­‰ä¿¡æ¯ï¼š</p><p><img src="/images/2022/8/20/c9934a2d9cba41ce121e27231caa7980.jpg" alt="image-20220820162024028"></p><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<code>127.0.0.1:82/mahm</code>ï¼Œè¾“å…¥ç”¨æˆ·å<code>MSIAfterburner</code>å’Œä¸Šé¢çš„å¯†ç å³å¯çœ‹åˆ°å¯¹åº”çš„ç›‘æ§æ•°æ®ï¼š</p><p><img src="/images/2022/8/20/b93b658e283490dbfd7b6b26845e07cc.jpg" alt="image-20220820162505895"></p><h1 id="è½¬æ¢æ•°æ®æ ¼å¼"><a href="#è½¬æ¢æ•°æ®æ ¼å¼" class="headerlink" title="è½¬æ¢æ•°æ®æ ¼å¼"></a>è½¬æ¢æ•°æ®æ ¼å¼</h1><p><code>MSI Afterburner Remote Server</code>æä¾›çš„ç›‘æ§æ•°æ®æ˜¯xmlæ ¼å¼çš„ï¼Œè¦æƒ³é€‚é…<code>Prometheus</code>ï¼Œå¾—åšä¸€å±‚è½¬æ¢æ‰è¡Œã€‚ç¬”è€…é€‰ç”¨Golangå®ç°ä¸€ä¸ªHTTPæ­£å‘ä»£ç†å°å·¥å…·æ¥å®Œæˆè¿™å±‚è½¬æ¢ï¼Œé€»è¾‘å¾ˆç®€å•ï¼šæ¥æ”¶<code>Prometheus</code>å‘å‡ºçš„æ•°æ®é‡‡é›†è¯·æ±‚ã€ä»<code>MSI Afterburner Remote Server</code>å¤„è·å–ç›‘æ§æ•°æ®ã€å°†ç›‘æ§æ•°æ®ä»¥metricsæ ¼å¼è¿›è¡Œè¿”å›ã€‚</p><!---@startumlparticipant Afterburner as dataparticipant proxyparticipant Prometheus as pmpm -> proxy: GET /metricsproxy -> data: GET /mahmdata --\> proxy: xmlproxy -> proxy: convertproxy --\> pm@enduml--><p><img src="/images/2022/8/20/d3ce4a5f1aeea651a6ab8534e7965d3d.jpg" alt="PlantUML diagram"></p><p>è¯¥å·¥å…·å·²åœ¨<a href="https://github.com/wolf-joe/tools/tree/main/cmd/afterburner_exporter">GitHub</a>ä¸Šå¼€æºï¼Œå®‰è£…è¿è¡Œåå¯ç›´æ¥é€šè¿‡æµè§ˆå™¨çœ‹åˆ°å·¥å…·è¾“å‡ºçš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">go install github.com/wolf-joe/tools/cmd/afterburner_exporter@latest</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">afterburner_exporter -listen <span class="hljs-string">&quot;0.0.0.0:8090&quot;</span> -target <span class="hljs-string">&quot;127.0.0.1:82&quot;</span> -password <span class="hljs-string">&quot;17cc95b4017d496f82&quot;</span></span><br>2022/08/20 18:13:08 listen on :8090<br></code></pre></td></tr></table></figure><p><img src="/images/2022/8/20/0701aeb276daaf249d1ac1ea26062661.jpg" alt="image-20220820185928484"></p><h1 id="æ¥å…¥Prometheus"><a href="#æ¥å…¥Prometheus" class="headerlink" title="æ¥å…¥Prometheus"></a>æ¥å…¥Prometheus</h1><p>ä¿®æ”¹Prometheusçš„é…ç½®æ–‡ä»¶ï¼Œè®©å…¶å®šæ—¶æŠ“å–ä¸Šä¸€ç« çš„metricsæ•°æ®ï¼Œé‡å¯åå¯çœ‹åˆ°æœåŠ¡æ­£å¸¸æ¥å…¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&quot;desktop&quot;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&quot;localhost:9102&quot;</span>] <span class="hljs-comment"># è¿™é‡Œå°†PCä¸Šçš„127.0.0.1:8090è½¬å‘åˆ°äº†PrometheusæœåŠ¡å™¨çš„:9102</span><br></code></pre></td></tr></table></figure><p><img src="/images/2022/8/20/815351595b418e04648bacc311c011b7.jpg" alt="image-20220820190351844"></p><h1 id="é…ç½®Grafana"><a href="#é…ç½®Grafana" class="headerlink" title="é…ç½®Grafana"></a>é…ç½®Grafana</h1><p>PrometheusæŠ“å–åˆ°æ•°æ®ä¹‹åï¼Œåœ¨Grafanaä¸Šæ·»åŠ å¯¹åº”é¢æ¿ï¼š</p><p><img src="/images/2022/8/20/4e0513124777c920c5a47b0f70b7a005.jpg" alt="image-20220821051812112"></p><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/images/2022/8/20/c6d98f87fc49e13258216134d189871a.jpg" alt="image-20220821051331042"></p><p>å¤§åŠŸå‘Šæˆï¼</p>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>ç›‘æ§</tag>
      
      <tag>ç”Ÿæ´»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè¯­è¨€errorå››é—®</title>
    <link href="/2021/07/17/Go%E8%AF%AD%E8%A8%80error%E5%9B%9B%E9%97%AE/"/>
    <url>/2021/07/17/Go%E8%AF%AD%E8%A8%80error%E5%9B%9B%E9%97%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯error"><a href="#ä»€ä¹ˆæ˜¯error" class="headerlink" title="ä»€ä¹ˆæ˜¯error"></a>ä»€ä¹ˆæ˜¯error</h1><p>Goè¯­è¨€æ²¡æœ‰åƒJava&#x2F;Pythonä¸€æ ·æä¾›<code>try</code>&amp;<code>catch</code>è¿™ç§é”™è¯¯æ•è·æ–¹å¼ï¼Œè€Œæ˜¯è¦æ±‚ç¼–ç è€…æ˜¾ç¤ºåœ°å¤„ç†ä¸‹æ¸¸çš„ä¼ é€’çš„é”™è¯¯ã€æ˜¾ç¤ºåœ°å‘ä¸Šæ¸¸æŠ›å‡ºé”™è¯¯ï¼Œä¹Ÿéš¾æ€ªæ€»æ˜¯æœ‰äººåæ§½Goåœ¨è¿™æ–¹é¢çš„å•°å—¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> file *os.File<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>file, err = os.Open(<span class="hljs-string">&quot;something.txt&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-comment">// å¤„ç†æ‰“å¼€æ–‡ä»¶æ—¶çš„é”™è¯¯ï¼Œæ¯”å¦‚panic</span><br>    <span class="hljs-built_in">panic</span>(file)<br>&#125;<br><span class="hljs-comment">// å¤„ç†æ–‡ä»¶</span><br>fmt.Println(file.Stat())<br><span class="hljs-comment">// å¤„ç†å…³é—­æ–‡ä»¶æ—¶çš„é”™è¯¯ï¼Œæ¯”å¦‚ç›´æ¥å¿½ç•¥</span><br>_ = file.Close()<br></code></pre></td></tr></table></figure><p><img src="/images/2021/07/17/most_used_words.png" alt="words.png"></p><p>Goåœ¨æ ‡å‡†åº“é‡Œæä¾›äº†ä¸€ç§é”™è¯¯è¡¨ç°å½¢å¼ï¼š<code>error</code>æ¥å£ï¼Œå®šä¹‰å¾ˆç®€å•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> builtin<br><br><span class="hljs-comment">// The error built-in interface type is the conventional interface for</span><br><span class="hljs-comment">// representing an error condition, with the nil value representing no error.</span><br><span class="hljs-keyword">type</span> <span class="hljs-type">error</span> <span class="hljs-keyword">interface</span> &#123;<br>    Error() <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è€ŒGoæå€¡çš„ç»„åˆæœºåˆ¶è®©ä»»ä½•å®ç°äº†<code>Error() string</code>æ–¹æ³•çš„ç±»å‹éƒ½å¯ä»¥è§†ä½œ<code>error</code>ï¼Œè¿™å°±å¸¦æ¥äº†æå¤§çš„çµæ´»æ€§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Error1 <span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e Error1)</span></span> Error() <span class="hljs-type">string</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(e) &#125;<br><br><span class="hljs-keyword">type</span> Error2 <span class="hljs-keyword">struct</span>&#123; msg <span class="hljs-type">string</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Error2)</span></span> SetMsg(msg <span class="hljs-type">string</span>) &#123; e.msg = msg &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Error2)</span></span> Error() <span class="hljs-type">string</span>     &#123; <span class="hljs-keyword">return</span> e.msg &#125;<br><br><span class="hljs-keyword">var</span> err1 <span class="hljs-type">error</span> = Error1(<span class="hljs-string">&quot;hello&quot;</span>) <span class="hljs-comment">// Error1å¯ä»¥è¢«è§†ä¸ºError</span><br><span class="hljs-keyword">var</span> err2 <span class="hljs-type">error</span> = &amp;Error2&#123;msg: <span class="hljs-string">&quot;world&quot;</span>&#125; <span class="hljs-comment">// Error2ä¹Ÿå¯ä»¥è¢«è§†ä¸ºError</span><br></code></pre></td></tr></table></figure><h1 id="å¦‚ä½•åˆ›å»ºerror"><a href="#å¦‚ä½•åˆ›å»ºerror" class="headerlink" title="å¦‚ä½•åˆ›å»ºerror"></a>å¦‚ä½•åˆ›å»ºerror</h1><p>GoåŸç”Ÿæä¾›äº†ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºä¸€ä¸ª<code>error</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> err1 <span class="hljs-type">error</span> = errors.New(<span class="hljs-string">&quot;error msg&quot;</span>)<br><span class="hljs-keyword">var</span> err2 <span class="hljs-type">error</span> = fmt.Errorf(<span class="hljs-string">&quot;error msg: %s&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>)<br></code></pre></td></tr></table></figure><p>å‰è€…æ¯”è¾ƒç®€å•ï¼Œå•çº¯åœ°åˆ›å»ºäº†ä¸€ä¸ª<code>string</code>çš„å°è£…ç±»å‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> errors<br><br><span class="hljs-comment">// New returns an error that formats as the given text.</span><br><span class="hljs-comment">// Each call to New returns a distinct error value even if the text is identical.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(text <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> &amp;errorString&#123;text&#125; &#125;<br><br><span class="hljs-comment">// errorString is a trivial implementation of error.</span><br><span class="hljs-keyword">type</span> errorString <span class="hljs-keyword">struct</span>&#123; s <span class="hljs-type">string</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *errorString)</span></span> Error() <span class="hljs-type">string</span> &#123; <span class="hljs-keyword">return</span> e.s &#125;<br></code></pre></td></tr></table></figure><p>åè€…åœ¨ç¤ºä¾‹ä»£ç ä¸­ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥çœ‹æˆ<code>fmt.Sprintf</code>+<code>errors.New</code>ã€‚å½“ç„¶Go1.13åšäº†ç‚¹å°æ”¹è¿›ï¼Œä¸‹æ–‡ä¼šæåˆ°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Go1.12æºç </span><br><span class="hljs-keyword">package</span> fmt<br><br><span class="hljs-comment">// Errorf formats according to a format specifier and returns the string</span><br><span class="hljs-comment">// as a value that satisfies error.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Errorf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">return</span> errors.New(Sprintf(format, a...))<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†è¿™ä¸¤ç§æ–¹å¼è¿˜æ˜¯å¤ªç®€é™‹äº†ï¼Œæ¯•ç«Ÿæºå¸¦çš„åªæ˜¯å­—ç¬¦ä¸²ä¿¡æ¯ã€‚æ‰€ä»¥åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œæ›´å¸¸è§çš„åšæ³•æ˜¯è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> BizError <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯</span><br>    Code <span class="hljs-type">int32</span> <span class="hljs-comment">// é”™è¯¯ç </span><br>    Msg  <span class="hljs-type">string</span> <span class="hljs-comment">// é”™è¯¯æç¤º</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *BizError)</span></span> Error() <span class="hljs-type">string</span> &#123; <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;BizError&lt;%d&gt;: %s&quot;</span>, e.Code, e.Msg) &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBizErr</span><span class="hljs-params">(code <span class="hljs-type">int32</span>, msg <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> &amp;BizError&#123;Code: code, Msg: msg&#125; &#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä¸ºæŸäº›ç‰¹å®šåœºæ™¯è®¾è®¡çš„å…¬ç”¨é”™è¯¯ï¼ˆå¦‚æ ‡å‡†åº“é‡Œçš„<code>io.EOF</code>ï¼‰ä¹Ÿä¼šä½¿ç”¨<code>errors.New</code>ï¼Œè¿™äº›é”™è¯¯çš„æ„æ€ä¹Ÿè¶³ä»¥ç”¨ç®€çŸ­çš„å­—ç¬¦ä¸²æè¿°ã€‚</p><h1 id="å¦‚ä½•å‘ä¸Šæ¸¸ä¼ é€’error"><a href="#å¦‚ä½•å‘ä¸Šæ¸¸ä¼ é€’error" class="headerlink" title="å¦‚ä½•å‘ä¸Šæ¸¸ä¼ é€’error"></a>å¦‚ä½•å‘ä¸Šæ¸¸ä¼ é€’error</h1><p>ç”±äºGoä¸­çš„é”™è¯¯ä¸€èˆ¬æ˜¯é€šè¿‡<code>error</code>æ¥å£ä»¥è¿”å›å€¼çš„å½¢å¼ä¼ é€’ç»™ä¸Šæ¸¸çš„ï¼Œä¸”ä¸€èˆ¬ä¸ä¼šåŒ…å«å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ç»™ä¸Šæ¸¸ä¼ é€’<code>error</code>æ—¶å°±éœ€è¦è€ƒè™‘é™„åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ä»¥ä¾¿æ’æŸ¥é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å°†ä¸‹æ¸¸çš„<code>error</code>ä¼ é€’ç»™ä¸Šæ¸¸æ—¶ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dial80</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>    addr, timeout := <span class="hljs-string">&quot;127.0.0.1:80&quot;</span>, time.Second<br>        <span class="hljs-comment">// do something</span><br>    <span class="hljs-keyword">if</span> ... &#123;<br>        timeout = time.Second * <span class="hljs-number">3</span><br>    &#125;<br>    conn, err := net.DialTimeout(<span class="hljs-string">&quot;tcp&quot;</span>, addr, timeout)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    _ = conn.Close()<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ªç®€å•çš„å‡½æ•°ï¼Œå¦‚æœä¸Šæ¸¸<strong>æœ‰å¿…è¦</strong>æ„ŸçŸ¥å‡ºç°é”™è¯¯æ—¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ¯”å¦‚è¶…æ—¶é…ç½®ï¼‰ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯å°†é”™è¯¯ä¿¡æ¯é‡æ–°æ‹¼è£…ä¸€ä¸‹ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dial80</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// å¯¹erroræ¥è¯´ï¼Œ%sä¼šè°ƒç”¨.Error()æ–¹æ³•</span><br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;dial80 timeout %s: %s&quot;</span>, timeout, err)<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹æ³•æ˜¯å°†<code>error</code>å†åŒ…è£…ä¸€å±‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> dial80Err <span class="hljs-keyword">struct</span> &#123;<br>    timeout time.Duration<br>    err     <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *dial80Err)</span></span> Error() <span class="hljs-type">string</span> &#123; <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;dial80 timeout %s: %s&quot;</span>, e.timeout, e.err) &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dial80</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> &amp;dial80Err&#123;timeout: timeout, err: err&#125;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†ä¸¤ç§æ–¹æ³•éƒ½å¹¶ä¸å®Œç¾ã€‚å‰è€…ä¼šä¸¢å¤±<code>error</code>ä¸­é™¤<code>.Error()</code>è¿”å›å€¼å¤–çš„å…¶å®ƒä¿¡æ¯ï¼Œåè€…ç”¨èµ·æ¥å¾ˆç¹çï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰çš„ã€‚Go1.13å¼•å…¥äº†<em>Error wrapping</em>çš„æ¦‚å¿µï¼Œé€šè¿‡æ‰©å±•<code>fmt.Errorf</code>æ¥åŒ…è£…<code>error</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dial80</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;dial80 timeout %s: %w&quot;</span>, timeout, err)<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„å…¶ä¸­<code>%w</code>å ä½ç¬¦ï¼Œ<code>fmt.Errorf</code>ä¼šç‰¹æ®Šå¤„ç†è¿™ä¸ªå ä½ç¬¦ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªå ä½ç¬¦ï¼Œ<code>fmt.Errorf</code>ä¼šå°†å…¶å¯¹åº”çš„<code>error</code>ä¸é”™è¯¯ä¿¡æ¯ä¸€èµ·æ”¾å…¥ä¸€ä¸ªæ–°çš„ç»“æ„ä½“é‡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Go1.13æºç </span><br><span class="hljs-keyword">package</span> fmt<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Errorf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> p.wrappedErr == <span class="hljs-literal">nil</span> &#123;<br>        err = errors.New(s)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        err = &amp;wrapError&#123;s, p.wrappedErr&#125;<br>    &#125;<br>    ...<br>&#125;<br><br><span class="hljs-keyword">type</span> wrapError <span class="hljs-keyword">struct</span> &#123;<br>    msg <span class="hljs-type">string</span><br>    err <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *wrapError)</span></span> Error() <span class="hljs-type">string</span> &#123; <span class="hljs-keyword">return</span> e.msg &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *wrapError)</span></span> Unwrap() <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> e.err &#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•ç»¼åˆäº†å‰ä¸¤ç§çš„ä¼˜ç‚¹ï¼Œå³ä½¿ç”¨ä¾¿æ·åˆä¸ä¼šä¸¢å¤±ä¿¡æ¯ã€‚æ‰€ä»¥åœ¨Go1.13ä¹‹åï¼Œéå¸¸æ¨èä½¿ç”¨<code>%w</code>å ä½ç¬¦æ¥ä¸ºé”™è¯¯é™„åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯å¹¶ä¼ é€’ç»™ä¸Šæ¸¸ã€‚</p><h1 id="å¦‚ä½•åˆ†æä¸‹æ¸¸ä¼ é€’çš„error"><a href="#å¦‚ä½•åˆ†æä¸‹æ¸¸ä¼ é€’çš„error" class="headerlink" title="å¦‚ä½•åˆ†æä¸‹æ¸¸ä¼ é€’çš„error"></a>å¦‚ä½•åˆ†æä¸‹æ¸¸ä¼ é€’çš„error</h1><p>å½“æˆ‘ä»¬å¾—åˆ°ä¸‹æ¸¸ä¼ é€’çš„<code>error</code>ä¸”éœ€è¦æ ¹æ®å…¶ç±»å‹ã€å±æ€§åšè¿›ä¸€æ­¥æ“ä½œæ—¶ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼ˆå½“ç„¶ï¼Œå‰ææ˜¯ä¸‹æ¸¸ä¸èƒ½ä½¿ç”¨<code>errors.New</code>æˆ–<code>fmt.Errorf</code>+<code>%s</code>æ¥ä¼ é€’é”™è¯¯ï¼Œç¬‘ï¼‰</p><p>ç”±äºä¸‹æ¸¸å¯èƒ½ä¼ é€’<code>wrapError</code>ç»™ä¸Šæ¸¸ï¼Œæ‰€ä»¥ä¸Šæ¸¸å¹¶ä¸èƒ½ç›´æ¥å¯¹<code>error</code>è¿›è¡Œæ¯”è¾ƒè¿ç®—ï¼ˆ<code>==</code>ï¼‰ã€ç±»å‹æ–­è¨€ï¼Œè€Œæ˜¯è¦ç”¨<code>errors</code>åŒ…æä¾›çš„APIè¿›è¡Œåˆ†æã€‚</p><p>æ¯”å¦‚ï¼Œç”¨<code>errors.Is</code>æ›¿ä»£<code>==</code>è¿ç®—ç¬¦æ¥åˆ¤æ–­ä¸¤ä¸ª<code>error</code>æ˜¯å¦ç›¸ç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">myRead := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> ... &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;myRead: %w&quot;</span>, io.EOF)<br>    &#125;<br>    ...<br>&#125;<br>buf, err := myRead()<br><span class="hljs-keyword">if</span> errors.Is(err, io.EOF) &#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åˆæ¯”å¦‚ï¼Œç”¨<code>errors.As</code>æ›¿ä»£<code>.(type)</code>æ¥åšç±»å‹æ–­è¨€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">err := dial80()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">var</span> opErr *net.OpError<br>    <span class="hljs-comment">// åˆ¤æ–­erræ˜¯å¦ä¸ºè¶…æ—¶é”™è¯¯</span><br>    <span class="hljs-keyword">if</span> ok := errors.As(err, &amp;opErr); ok &amp;&amp; opErr.Timeout() &#123;<br>        <span class="hljs-comment">// do something</span><br>    &#125;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="github-com-x2F-pkg-x2F-errors"><a href="#github-com-x2F-pkg-x2F-errors" class="headerlink" title="github.com&#x2F;pkg&#x2F;errors"></a>github.com&#x2F;pkg&#x2F;errors</h1><p>æ ‡å‡†åº“ä¸­<code>errors.Is</code>å’Œ<code>errors.As</code>ä¸¤ä¸ªå‡½æ•°éœ€è¦é¢‘ç¹ä½¿ç”¨æ€§èƒ½è¾ƒå·®çš„åå°„ï¼Œ<code>errors.As</code>ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç¹çï¼Œæ‰€ä»¥å¦‚æœæœ‰æ¡ä»¶çš„è¯å¯ä»¥ä½¿ç”¨åŠŸèƒ½æ›´ä¸°å¯Œçš„<a href="https://github.com/pkg/errors/">github.com&#x2F;pkg&#x2F;errors</a>åŒ…ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// import github.com/pkg/errors</span><br>myRead := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> ... &#123;<br>        <span class="hljs-comment">// æ•ˆæœç±»ä¼¼ fmt.Errorf(&quot;myRead: %w&quot;, io.EOF)</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.WithMessage(io.EOF, <span class="hljs-string">&quot;myRead&quot;</span>)<br>    &#125;<br>    ...<br>&#125;<br>buf, err := myRead()<br><span class="hljs-keyword">if</span> errors.Is(err, io.EOF) &#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><span class="hljs-comment">// è°¨æ…ä½¿ç”¨</span><br><span class="hljs-keyword">if</span> errors.Cause(err) == io.EOF &#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶åœ¨ä¸‹æ¸¸é€šè¿‡<code>errors.WithMessage</code>&#x2F;<code>errors.WithMessagef</code>åŒ…è£…é”™è¯¯ï¼Œåœ¨ä¸Šæ¸¸é€šè¿‡<code>errors.Cause</code>è·å–è¢«åŒ…è£…çš„åŸå§‹é”™è¯¯ã€‚ä¸è¿‡<code>errors.Cause</code>ä¸èƒ½ç©¿é€è¢«<code>fmt.Errorf</code>+<code>%w</code>åŒ…è£…çš„<code>wrapError</code>ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶ä¸€å®šè¦è°¨æ…ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol><li>Goä¸­çš„<code>error</code>æ˜¯ä¸€ä¸ªåªéœ€å®ç°<code>Error() string</code>æ–¹æ³•çš„æ¥å£ã€‚</li><li>é™¤éæ˜¯å…¬ç”¨é”™è¯¯ï¼Œå¦åˆ™å°½é‡ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹æ¥ç”Ÿæˆé”™è¯¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨<code>errors.New</code>å’Œ<code>fmt.Errorf</code>ã€‚</li><li>ä½¿ç”¨<code>fmt.Errorf</code>ä¸<code>%w</code>æ¥ä¸ºé”™è¯¯é™„åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li>ä½¿ç”¨<code>errors.Is</code>ã€<code>errors.As</code>æ¥åˆ†æé”™è¯¯ã€‚</li><li>å¦‚æœ‰æ¡ä»¶ï¼Œå¯ä½¿ç”¨æ›´ä¼˜ç§€çš„<a href="https://github.com/pkg/errors/">github.com&#x2F;pkg&#x2F;errors</a>åŒ…æ›¿ä»£æ ‡å‡†åº“çš„<code>errors</code>åŒ…å’Œ<code>fmt.Errorf</code>ã€‚</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¯»ã€Šæµç•…çš„Pythonã€‹ï¼šä¸€ç­‰å‡½æ•°</title>
    <link href="/2020/07/05/fluent-python-chap-5/"/>
    <url>/2020/07/05/fluent-python-chap-5/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸€ç­‰å¯¹è±¡ï¼ˆ<code>first-class objects</code>ï¼‰æ˜¯æŒ‡æ‹¥æœ‰å¦‚ä¸‹ç‰¹æ€§çš„ç¨‹åºå®ä½“ï¼š</p><ul><li>åœ¨è¿è¡Œæ—¶åˆ›å»º</li><li>èƒ½èµ‹å€¼ç»™å˜é‡æˆ–æ•°æ®ç»“æ„ä¸­çš„å…ƒç´ </li><li>èƒ½ä½œä¸ºå‚æ•°ä¼ ç»™å‡½æ•°</li><li>èƒ½ä½œä¸ºå‡½æ•°çš„è¿”å›ç»“æœ</li></ul><p>Pythonä¸­çš„å‡½æ•°æ‹¥æœ‰è¿™å‡ ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥è¢«ç§°ä½œ<strong>ä¸€ç­‰å‡½æ•°</strong>ï¼ˆ<code>functions as first-class objects</code>ï¼Œç®€ç§°<code>first-class functions</code>ï¼‰ã€‚</p><h1 id="æŠŠå‡½æ•°è§†ä½œå¯¹è±¡"><a href="#æŠŠå‡½æ•°è§†ä½œå¯¹è±¡" class="headerlink" title="æŠŠå‡½æ•°è§†ä½œå¯¹è±¡"></a>æŠŠå‡½æ•°è§†ä½œå¯¹è±¡</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x</span>):  <span class="hljs-comment"># åœ¨è¿è¡Œæ—¶åˆ›å»º</span><br><span class="hljs-meta">... </span>    <span class="hljs-string">&quot;&quot;&quot;return x * x&quot;&quot;&quot;</span><br><span class="hljs-meta">... </span>    <span class="hljs-keyword">return</span> x * x<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bar = foo  <span class="hljs-comment"># èµ‹å€¼ç»™å˜é‡</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bar.__doc__<br><span class="hljs-string">&#x27;return x * x&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">print</span>(bar)  <span class="hljs-comment"># ä½œä¸ºå‚æ•°ä¼ ç»™å‡½æ•°</span><br>&lt;function foo at ...&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">fooo</span>(): <span class="hljs-keyword">return</span> foo<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fooo()(<span class="hljs-number">10</span>)  <span class="hljs-comment"># ä½œä¸ºå‡½æ•°çš„è¿”å›ç»“æœ</span><br><span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><h1 id="é«˜é˜¶å‡½æ•°"><a href="#é«˜é˜¶å‡½æ•°" class="headerlink" title="é«˜é˜¶å‡½æ•°"></a>é«˜é˜¶å‡½æ•°</h1><p>æ¥å—å‡½æ•°ä¸ºå‚æ•°ï¼Œæˆ–æŠŠå‡½æ•°ä½œä¸ºç»“æœè¿”å›çš„å‡½æ•°æ˜¯<strong>é«˜é˜¶å‡½æ•°</strong>ï¼Œæ¯”å¦‚ä¸Šæ–‡æåˆ°çš„<code>print()</code>å’Œ<code>fooo()</code>ã€‚å†æ¯”å¦‚æ¥æ”¶å‡½æ•°ä½œä¸º<code>key</code>å‚æ•°çš„<code>sorted()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">sorted</span>([-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>], key=<span class="hljs-built_in">abs</span>)<br>[<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure><p>å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸€èˆ¬ä¼šæä¾›<code>map</code>ã€<code>filter</code>ã€<code>reduce</code>ä¸‰ä¸ªé«˜é˜¶å‡½æ•°ã€‚Pythonä¹Ÿæä¾›è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œä½†åˆ—è¡¨æ¨å¯¼ï¼ˆ<code>list comprehensions</code>ï¼‰å’Œç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼ˆ<code>generator expressions</code>ï¼‰åœ¨å®Œæˆå’Œ<code>map</code>ã€<code>filter</code>ç›¸åŒçš„åŠŸèƒ½æ—¶ä»£ç å¯è¯»æ€§æ›´å¥½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(foo, <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>)))<br>[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">9</span>, <span class="hljs-number">16</span>, <span class="hljs-number">25</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>[foo(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>)]<br>[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">9</span>, <span class="hljs-number">16</span>, <span class="hljs-number">25</span>]<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(foo, <span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x &gt; <span class="hljs-number">2</span>, <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>))))  <span class="hljs-comment"># ç”¨lambdaå…³é”®å­—åˆ›é€ äº†ä¸€ä¸ªåŒ¿åå‡½æ•°</span><br>[<span class="hljs-number">9</span>, <span class="hljs-number">16</span>, <span class="hljs-number">25</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>[foo(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2</span>]<br>[<span class="hljs-number">9</span>, <span class="hljs-number">16</span>, <span class="hljs-number">25</span>]<br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æ‰§è¡Œæ±‚å’Œæ“ä½œï¼Œä¹Ÿå¯ä»¥ç”¨å†…ç½®çš„<code>sum</code>å‡½æ•°æ›¿ä»£<code>reduce</code>ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ›´å¥½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce  <span class="hljs-comment"># Python3èµ·ï¼Œreduceä¸å†æ˜¯å†…ç½®å‡½æ•°</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> add  <span class="hljs-comment"># add ç›¸å½“äº lambda a, b: a + b</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>reduce(add, <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>))<br><span class="hljs-number">4950</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">sum</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>))<br><span class="hljs-number">4950</span><br></code></pre></td></tr></table></figure><p>å’Œ<code>sum</code>å’Œ<code>reduce</code>çš„æ€è·¯ç±»ä¼¼ï¼Œ<code>all</code>å’Œ<code>any</code>ä¹Ÿæ˜¯ä¸¤ä¸ªå†…ç½®çš„å½’çº¦å‡½æ•°ï¼š</p><ul><li><code>all(iterable)</code>ï¼šå¦‚æœæ¯ä¸ªå…ƒç´ éƒ½ä¸ºçœŸï¼Œè¿”å›<code>True</code>ã€‚<code>all([])</code>è¿”å›<code>True</code>ã€‚</li><li><code>any(iterable)</code>ï¼šå¦‚ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸ºçœŸï¼Œè¿”å›<code>True</code>ã€‚<code>any([])</code>è¿”å›<code>False</code>ã€‚</li></ul><h1 id="åŒ¿åå‡½æ•°"><a href="#åŒ¿åå‡½æ•°" class="headerlink" title="åŒ¿åå‡½æ•°"></a>åŒ¿åå‡½æ•°</h1><p>ç”¨<code>lambda</code>å…³é”®å­—åˆ›é€ çš„å‡½æ•°å«åš<strong>åŒ¿åå‡½æ•°</strong>ã€‚åŒ¿åå‡½æ•°åªèƒ½ä½¿ç”¨çº¯è¡¨è¾¾å¼ï¼Œå‡½æ•°å†…ä¸èƒ½èµ‹å€¼ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨<code>while</code>ã€<code>try</code>ç­‰è¯­å¥ã€‚åŒ¿åå‡½æ•°ä¸€èˆ¬åªä½œä¸ºå‚æ•°ä¼ é€’ç»™é«˜é˜¶å‡½æ•°ï¼Œå°±åƒä¸Šä¸€èŠ‚çš„ç¤ºä¾‹é‚£æ ·ã€‚</p><p>ä»<code>Pythonic</code>çš„è§’åº¦æ¥è¯´ï¼ŒåŒ¿åå‡½æ•°æœ€å¥½ä¸è¦è¶…è¿‡ä¸€è¡Œï¼Œä¹Ÿä¸æ¨èå°†åŒ¿åå‡½æ•°èµ‹å€¼ç»™å…¶å®ƒå˜é‡ã€‚</p><h1 id="å¯è°ƒç”¨å¯¹è±¡"><a href="#å¯è°ƒç”¨å¯¹è±¡" class="headerlink" title="å¯è°ƒç”¨å¯¹è±¡"></a>å¯è°ƒç”¨å¯¹è±¡</h1><p>èƒ½è¢«è°ƒç”¨è¿ç®—ç¬¦ï¼ˆå³<code>()</code>ï¼‰åº”ç”¨çš„å¯¹è±¡è¢«ç§°ä¸º<strong>å¯è°ƒç”¨å¯¹è±¡</strong>ï¼Œè¿™ç‚¹å¯ä»¥é€šè¿‡å†…ç½®çš„<code>callable</code>å‡½æ•°æ¥åˆ¤æ–­ã€‚<a href="https://docs.python.org/3/reference/datamodel.html">Pythonæ•°æ®æ¨¡å‹</a>æ–‡æ¡£åˆ—å‡ºäº†7ç§å¯è°ƒç”¨å¯¹è±¡ï¼š</p><ul><li>ç”¨æˆ·å®šä¹‰çš„å‡½æ•°ï¼ˆ<code>User-defined functions</code>ï¼‰ï¼Œä½¿ç”¨<code>def</code>è¯­å¥å’Œ<code>lambda</code>è¡¨è¾¾å¼åˆ›å»ºçš„å‡½æ•°ã€‚</li><li>æ–¹æ³•ï¼ˆ<code>Instance methods</code>ï¼‰ï¼Œåœ¨ç±»çš„å®šä¹‰ä½“ä¸­å®šä¹‰çš„å‡½æ•°ã€‚</li><li>ç”Ÿæˆå™¨å‡½æ•°ï¼ˆ<code>Generator functions</code>ï¼‰ï¼Œä½¿ç”¨<code>yield</code>å…³é”®å­—çš„å‡½æ•°æˆ–æ–¹æ³•ã€‚è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°ä¼šè¿”å›ç”Ÿæˆå™¨å¯¹è±¡ã€‚</li><li>å†…ç½®å‡½æ•°ï¼ˆ<code>Built-in functions</code>ï¼‰ã€å†…ç½®æ–¹æ³•ï¼ˆ<code>Built-in methods</code>ï¼‰ï¼Œç”¨Cè¯­è¨€å®ç°çš„å‡½æ•°&#x2F;æ–¹æ³•ï¼Œå¦‚<code>len()</code>ã€<code>alist.append()</code>ã€‚</li><li>ç±»ï¼ˆ<code>Classes</code>ï¼‰ï¼Œè°ƒç”¨ç±»æ—¶ä¼šè¿è¡Œç±»çš„<code>__new__</code>æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œç„¶åè¿è¡Œ<code>__init__</code>æ–¹æ³•åˆå§‹åŒ–å®ä¾‹ã€‚</li><li>ç±»çš„å®ä¾‹ï¼ˆ<code>Class Instances</code>ï¼‰ï¼Œå®šä¹‰äº†<code>__call__</code>æ–¹æ³•çš„ç±»çš„å®ä¾‹ã€‚</li></ul><p>å½“ç„¶ï¼Œã€Šæµç•…çš„Pythonã€‹åŸºäºPython3.4ï¼Œåç»­çš„Pythonç‰ˆæœ¬è¿˜å¼•å…¥äº†å…¶å®ƒç§ç±»çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œå¦‚åç¨‹å‡½æ•°ï¼ˆ<code>Coroutine functions</code>ï¼‰å’Œå¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°ï¼ˆ<code>Asynchronous generator functions</code>ï¼‰ï¼Œè¯¦è§å‰æ–‡çš„æ–‡æ¡£é“¾æ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">abs</span>, <span class="hljs-built_in">str</span>, <span class="hljs-number">13</span><br>(&lt;built-<span class="hljs-keyword">in</span> function <span class="hljs-built_in">abs</span>&gt;, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt;, <span class="hljs-number">13</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[<span class="hljs-built_in">callable</span>(obj) <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> (<span class="hljs-built_in">abs</span>, <span class="hljs-built_in">str</span>, <span class="hljs-number">13</span>)]<br>[<span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>]<br></code></pre></td></tr></table></figure><h1 id="å‡½æ•°å†…çœ"><a href="#å‡½æ•°å†…çœ" class="headerlink" title="å‡½æ•°å†…çœ"></a>å‡½æ•°å†…çœ</h1><p><strong>å†…çœ</strong>æŒ‡ç¨‹åºåœ¨è¿è¡Œæ—¶æ£€æŸ¥å¯¹è±¡ç±»å‹çš„ä¸€ç§èƒ½åŠ›ï¼Œåœ¨Pythonä¸­ï¼Œå‡½æ•°æä¾›è®¸å¤šå±æ€§æ¥å®ç°å†…çœã€‚å‡½æ•°ç‰¹æœ‰çš„å±æ€§ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><table><thead><tr><th>åç§°</th><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>__annotations__</code></td><td>dict</td><td>å‚æ•°å’Œè¿”å›å€¼çš„æ³¨è§£</td></tr><tr><td><code>__call__</code></td><td>method-wrapper</td><td>å®ç°<code>()</code>è¿ç®—ç¬¦</td></tr><tr><td><code>__closure__</code></td><td>tuple</td><td>å‡½æ•°é—­åŒ…ï¼Œå³è‡ªç”±å˜é‡çš„ç»‘å®š</td></tr><tr><td><code>__code__</code></td><td>code</td><td>ç¼–è¯‘æˆå­—èŠ‚ç çš„å‡½æ•°å…ƒæ•°æ®å’Œå‡½æ•°å®šä¹‰ä½“</td></tr><tr><td><code>__defaults__</code></td><td>tuple</td><td>å½¢å‚çš„é»˜è®¤å€¼</td></tr><tr><td><code>__get__</code></td><td>method-wraper</td><td>å®ç°<a href="https://docs.python.org/3/howto/descriptor.html">åªè¯»æè¿°ç¬¦åè®®</a></td></tr><tr><td><code>__globals__</code></td><td>dict</td><td>å‡½æ•°æ‰€åœ¨æ¨¡å—çš„å…¨å±€å˜é‡</td></tr><tr><td><code>__kwdefaults__</code></td><td>dict</td><td>ä»…é™å…³é”®å­—å½¢å‚çš„é»˜è®¤å€¼</td></tr><tr><td><code>__name__</code></td><td>str</td><td>å‡½æ•°åç§°</td></tr><tr><td><code>__qualname__</code></td><td>str</td><td>å‡½æ•°çš„<a href="https://www.python.org/dev/peps/pep-3155/">é™å®šåç§°</a>ï¼Œå¦‚<code>Random.choice</code></td></tr></tbody></table><h1 id="å‡½æ•°å‚æ•°ã€è·å–å…³äºå‚æ•°çš„ä¿¡æ¯"><a href="#å‡½æ•°å‚æ•°ã€è·å–å…³äºå‚æ•°çš„ä¿¡æ¯" class="headerlink" title="å‡½æ•°å‚æ•°ã€è·å–å…³äºå‚æ•°çš„ä¿¡æ¯"></a>å‡½æ•°å‚æ•°ã€è·å–å…³äºå‚æ•°çš„ä¿¡æ¯</h1><p>è¯¦è§<a href="/2020/07/04/python-parameters-and-arguments/">ä¸Šä¸€ç¯‡æ–‡ç« </a></p><h1 id="å‡½æ•°æ³¨è§£"><a href="#å‡½æ•°æ³¨è§£" class="headerlink" title="å‡½æ•°æ³¨è§£"></a>å‡½æ•°æ³¨è§£</h1><p>Python3æä¾›çš„æ–°è¯­æ³•<code>å‡½æ•°æ³¨è§£</code>å¯ä»¥ä¸ºå‡½æ•°å£°æ˜çš„å‚æ•°å’Œè¿”å›å€¼é™„åŠ å…ƒæ•°æ®ï¼Œå¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">num_a: <span class="hljs-string">&#x27;int &gt; 0&#x27;</span>, num_b: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;123&#x27;</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>    <span class="hljs-keyword">return</span> (num_a + <span class="hljs-built_in">int</span>(num_b)) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>å‡½æ•°ä¸­çš„å‚æ•°å¯ä»¥åœ¨<code>:</code>ä¹‹åå¢åŠ æ³¨è§£è¡¨è¾¾å¼ã€‚å¦‚å‚æ•°æœ‰é»˜è®¤å€¼ï¼Œåˆ™è¡¨è¾¾å¼æ”¾åœ¨å‚æ•°å’Œ<code>=</code>å·ä¹‹é—´ã€‚å‡½æ•°æœ«å°¾çš„<code>)</code>å’Œ<code>:</code>ä¹‹é—´ä¹Ÿå¯ä»¥æ”¾å…¥è¡¨è¾¾å¼ï¼Œç”¨äºæ³¨è§£è¿”å›å€¼ã€‚æ³¨è§£ä¸ä¼šåšä»»ä½•å¤„ç†ï¼Œåªæ˜¯å‚¨å­˜åœ¨å‡½æ•°çš„<code>__annotations__</code>å±æ€§é‡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__annotations__<br>&#123;<span class="hljs-string">&#x27;num_a&#x27;</span>: <span class="hljs-string">&#x27;int &gt; 0&#x27;</span>, <span class="hljs-string">&#x27;num_b&#x27;</span>: &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt;, <span class="hljs-string">&#x27;return&#x27;</span>: &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;float&#x27;</span>&gt;&#125;<br></code></pre></td></tr></table></figure><p>æ³¨è§£åªæ˜¯å…ƒæ•°æ®ï¼Œå¯ä»¥ä¾›IDEã€æ¡†æ¶ã€è£…é¥°å™¨ã€é™æ€ä»£ç åˆ†æå·¥å…·ç­‰ä½¿ç”¨ã€‚æ ‡å‡†åº“ä¸­åªæœ‰ä¸Šä¸€èŠ‚æåˆ°çš„<code>inspect.signature</code>ä¼šç”¨åˆ°æ³¨è§£ï¼Œå¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> inspect <span class="hljs-keyword">import</span> signature<br><span class="hljs-meta">&gt;&gt;&gt; </span>sig = signature(foo)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sig.return_annotation<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;float&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> sig.parameters.values():<br><span class="hljs-meta">... </span>    anno = <span class="hljs-built_in">str</span>(param.annotation)<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;anno:&lt;<span class="hljs-number">13</span>&#125;</span> : <span class="hljs-subst">&#123;param.name&#125;</span> = <span class="hljs-subst">&#123;param.default&#125;</span>&#x27;</span>)<br><span class="hljs-meta">... </span><br><span class="hljs-built_in">int</span> &gt; <span class="hljs-number">0</span>       : num_a = &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;inspect._empty&#x27;</span>&gt;<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt; : num_b = <span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><h2 id="ç”¨æ³¨è§£å®ç°å‚æ•°æ ¡éªŒ"><a href="#ç”¨æ³¨è§£å®ç°å‚æ•°æ ¡éªŒ" class="headerlink" title="ç”¨æ³¨è§£å®ç°å‚æ•°æ ¡éªŒ"></a>ç”¨æ³¨è§£å®ç°å‚æ•°æ ¡éªŒ</h2><p>Pythonå¤§ç‰›<code>Raymond Hettinger</code>åœ¨ä¸€ä¸ª<a href="https://stackoverflow.com/questions/3038033/what-are-good-uses-for-python3s-function-annotations">StackOverflowé—®ç­”</a>é‡Œå±•ç¤ºäº†ä¸€ç§æ–¹ä¾¿çš„ã€åŸºäºæ³¨è§£çš„å‚æ•°æ ¡éªŒæœºåˆ¶ï¼Œæ‘˜å½•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">func, <span class="hljs-built_in">locals</span></span>):<br>    <span class="hljs-keyword">for</span> var, test <span class="hljs-keyword">in</span> func.__annotations__.items():<br>        value = <span class="hljs-built_in">locals</span>[var]<br>        msg = <span class="hljs-string">&#x27;Var: &#123;0&#125;\tValue: &#123;1&#125;\tTest: &#123;2.__name__&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(var, value, test)<br>        <span class="hljs-keyword">assert</span> test(value), msg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_int</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">int</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">between</span>(<span class="hljs-params">lo, hi</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_between</span>(<span class="hljs-params">x</span>):<br>        <span class="hljs-keyword">return</span> lo &lt;= x &lt;= hi<br>    <span class="hljs-keyword">return</span> _between<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x: between(<span class="hljs-params"><span class="hljs-number">3</span>, <span class="hljs-number">10</span></span>), y: is_int</span>):<br>    validate(f, <span class="hljs-built_in">locals</span>())<br>    <span class="hljs-built_in">print</span>(x, y)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>f(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>)<br><span class="hljs-number">3</span> <span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f(<span class="hljs-number">0</span>, <span class="hljs-number">31.1</span>)<br>Traceback (most recent call last):<br>  ...<br>AssertionError: Var: xValue: <span class="hljs-number">0</span>Test: _between<br></code></pre></td></tr></table></figure><p>å…¶åŸºæœ¬æ€æƒ³æ˜¯ç”¨<code>Callable</code>å¯¹è±¡å……å½“å‡½æ•°å‚æ•°çš„æ³¨è§£ï¼Œç„¶ååœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶è°ƒç”¨<code>Callable</code>å¯¹è±¡æ¥æ ¡éªŒå‚æ•°ã€‚æ¢å¥è¯è¯´ï¼Œä¸Šé¢çš„å‡½æ•°<code>f</code>å¯ä»¥æ”¹å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-number">3</span> &lt;= x &lt;= <span class="hljs-number">10</span>, <span class="hljs-string">f&#x27;Var: xValue: <span class="hljs-subst">&#123;x&#125;</span>Test: _between&#x27;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">int</span>), <span class="hljs-string">f&#x27;Var: yValue: <span class="hljs-subst">&#123;y&#125;</span>Test: is_int&#x27;</span><br>    <span class="hljs-built_in">print</span>(x, y)<br></code></pre></td></tr></table></figure><p>ç”±æ­¤å¯è§å‰æ–‡å‚æ•°æ ¡éªŒæœºåˆ¶çš„ç²¾å¦™ã€‚</p><h1 id="æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å—"><a href="#æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å—" class="headerlink" title="æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å—"></a>æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å—</h1><p>åœ¨<code>operator</code>å’Œ<code>functools</code>ç­‰æ¨¡å—çš„æ”¯æŒä¸‹ï¼ŒPythonä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ã€‚</p><h2 id="operatoræ¨¡å—"><a href="#operatoræ¨¡å—" class="headerlink" title="operatoræ¨¡å—"></a>operatoræ¨¡å—</h2><p><code>operator</code>æ¨¡å—ä¸ºè®¸å¤šç®—æ•°è¿ç®—ç¬¦æä¾›äº†å¯¹åº”çš„å‡½æ•°ï¼Œå¦‚<code>add</code>ï¼ˆå¯¹åº”<code>a + b</code>ï¼‰ã€<code>mul</code>ï¼ˆå¯¹åº”<code>a * b</code>ï¼‰ç­‰ç­‰ã€‚æ¯”å¦‚è®¡ç®—<code>1~n</code>çš„å’Œä¸<code>n</code>çš„é˜¶ä¹˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> add, mul<br><span class="hljs-meta">&gt;&gt;&gt; </span>n = <span class="hljs-number">10</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>reduce(add, <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, n+<span class="hljs-number">1</span>))  <span class="hljs-comment"># 1 + 2 + ... + 10</span><br><span class="hljs-number">55</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>reduce(mul, <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, n+<span class="hljs-number">1</span>))  <span class="hljs-comment"># 1 * 2 * ... * 10</span><br><span class="hljs-number">3628800</span><br></code></pre></td></tr></table></figure><p><code>operator</code>æ¨¡å—è¿˜æä¾›äº†<code>itemgetter</code>å’Œ<code>attrgetter</code>ä¸¤ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä»åºåˆ—ä¸­æå–å…ƒç´ æˆ–è¯»å–å¯¹è±¡çš„å±æ€§ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>records = [(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>)]<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter, attrgetter<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">sorted</span>(records, key=itemgetter(<span class="hljs-number">1</span>))  <span class="hljs-comment"># itemgetter(1) ç­‰æ•ˆäº lambda x: x[1]</span><br>[(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>), (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>)]<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>attrgetter(<span class="hljs-string">&#x27;append&#x27;</span>)(records)<br>&lt;built-<span class="hljs-keyword">in</span> method append of <span class="hljs-built_in">list</span> <span class="hljs-built_in">object</span> at ...&gt;<br></code></pre></td></tr></table></figure><p>æœ€åä»‹ç»<code>methodcaller</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åˆ›å»ºçš„å‡½æ•°ä¼šè°ƒç”¨å¯¹è±¡ä¸Šçš„æŒ‡å®šæ–¹æ³•ï¼Œå¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> methodcaller<br><span class="hljs-meta">&gt;&gt;&gt; </span>records<br>[(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>)]<br><span class="hljs-meta">&gt;&gt;&gt; </span>append_lemon = methodcaller(<span class="hljs-string">&#x27;append&#x27;</span>, (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;lemon&#x27;</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span>append_lemon(records)  <span class="hljs-comment"># ç­‰æ•ˆäº records.append((4, &#x27;lemon&#x27;))</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>records<br>[(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>), (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;lemon&#x27;</span>)]<br></code></pre></td></tr></table></figure><h2 id="ç”¨functools-partialå†»ç»“å‚æ•°"><a href="#ç”¨functools-partialå†»ç»“å‚æ•°" class="headerlink" title="ç”¨functools.partialå†»ç»“å‚æ•°"></a>ç”¨functools.partialå†»ç»“å‚æ•°</h2><p>é™¤äº†å‰æ–‡å·²ç»å¤šæ¬¡æåˆ°çš„<code>reduce</code>ï¼Œ<code>functools</code>æ¨¡å—è¿˜æä¾›äº†è®¸å¤šæœ‰ç”¨çš„å‡½æ•°ï¼Œæ¯”å¦‚å¯ä»¥å†»ç»“å‡½æ•°å‚æ•°çš„<code>partial</code>ã€‚ä¸Šä¸€èŠ‚æåˆ°çš„<code>append_lemon</code>å…¶å®å°±èµ·åˆ°äº†ç±»ä¼¼<code>partial</code>çš„ä½œç”¨ï¼Œä½†<code>partial</code>çš„åŠŸèƒ½æ›´å¼ºå¤§ã€‚æ¯”å¦‚å‰æ–‡æåˆ°çš„è‡ªå®šä¹‰æ’åºï¼Œå¯ä»¥ç”¨æ›´é€šç”¨çš„å½¢å¼é‡å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>records = [(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>)]<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter, attrgetter<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">sorted</span>(records, key=itemgetter(<span class="hljs-number">1</span>))  <span class="hljs-comment"># itemgetter(1) ç­‰æ•ˆäº lambda x: x[1]</span><br>[(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>), (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>)]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<br><span class="hljs-meta">&gt;&gt;&gt; </span>sort_by_second = partial(<span class="hljs-built_in">sorted</span>, key=itemgetter(<span class="hljs-number">1</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span>sort_by_second(records)<br>[(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;apple&#x27;</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;juice&#x27;</span>), (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;orange&#x27;</span>)]<br></code></pre></td></tr></table></figure><p>åœ¨éœ€è¦ç”¨ç›¸åŒï¼ˆæˆ–ç±»ä¼¼ï¼‰çš„å‚æ•°åå¤è°ƒç”¨æŸä¸ªå‡½æ•°æ—¶ï¼Œä½¿ç”¨<code>functools.partial</code>å†»ç»“å‚æ•°å¯ä»¥æœ‰æ•ˆé™ä½å·¥ä½œé‡å’Œbugå‡ºç°çš„å‡ ç‡ã€‚<code>functools</code>è¿˜æä¾›äº†<code>wraps</code>ã€<code>lru_cache</code>ç­‰æ¯”è¾ƒå®ç”¨çš„è£…é¥°å™¨ï¼Œè¿™æ–¹é¢çš„å†…å®¹å¯ä»¥å‚è€ƒç¬”è€…<a href="/2020/06/20/python-decorators-source-code/">å…ˆå‰çš„æ–‡ç« </a>ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æµç•…çš„Python</tag>
      
      <tag>è¯»ä¹¦ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pythonä¸­çš„å‡½æ•°å‚æ•°ä¸å‚æ•°ä¼ é€’</title>
    <link href="/2020/07/04/python-parameters-and-arguments/"/>
    <url>/2020/07/04/python-parameters-and-arguments/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« ä½¿ç”¨CPython3.6</p></blockquote><h1 id="å®šä½å‚æ•°ã€å…³é”®å­—å‚æ•°"><a href="#å®šä½å‚æ•°ã€å…³é”®å­—å‚æ•°" class="headerlink" title="å®šä½å‚æ•°ã€å…³é”®å­—å‚æ•°"></a>å®šä½å‚æ•°ã€å…³é”®å­—å‚æ•°</h1><p>åœ¨Pythonä¸­ï¼Œå½“å®šä¹‰ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå‡½æ•°æ¥æ”¶çš„å‚æ•°å«åšä¸ºå½¢å¼å‚æ•°ï¼ˆ<code>parameters</code>ï¼‰ï¼Œä»¥ä¸‹ç®€ç§°<strong>å½¢å‚</strong>ï¼›å½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œè°ƒç”¨è€…ä¼ é€’ç»™è¯¥å‡½æ•°çš„å€¼å«åšå®é™…å‚æ•°ï¼ˆ<code>arguments</code>ï¼‰ï¼Œä»¥ä¸‹ç®€ç§°<strong>å®å‚</strong>ã€‚</p><p>æ ¹æ®<a href="https://docs.python.org/3/library/inspect.html">inspectæ¨¡å—</a>çš„æè¿°ï¼ŒPythonçš„å½¢å‚å¯ä»¥åˆ†æˆå¦‚ä¸‹äº”ç±»ï¼š</p><ul><li><em>POSITIONAL_OR_KEYWORD</em>ï¼Œé»˜è®¤ç±»å‹ï¼Œå¯é€šè¿‡å®šä½&#x2F;å…³é”®å­—å®å‚ä¼ é€’ï¼›</li><li><em>VAR_POSITIONAL</em>ï¼Œå®šä½å½¢å‚å…ƒç¥–ï¼Œå¦‚<code>*args</code>ï¼Œæ•è·å‰©ä¸‹çš„å®šä½å®å‚ï¼›</li><li><em>KEYWORD_ONLY</em>ï¼Œåœ¨<code>*</code>æˆ–<code>*args</code>ä¹‹åçš„å½¢å‚ï¼Œåªèƒ½é€šè¿‡å…³é”®å­—å®å‚ä¼ é€’ï¼›</li><li><em>VAR_KEYWORD</em>ï¼Œå…³é”®å­—å½¢å‚å­—å…¸ï¼Œå¦‚<code>**kwargs</code>ï¼Œæ•è·å‰©ä¸‹çš„å…³é”®å­—å®å‚ï¼›</li><li><em>POSITIONAL_ONLY</em>ï¼Œåªèƒ½é€šè¿‡å®šä½å®å‚ä¼ é€’ï¼ŒPythonè¯­æ³•æš‚ä¸æ”¯æŒï¼Œåªæœ‰ä¸€äº›Cå‡½æ•°ï¼ˆå¦‚<code>divmod</code>ï¼‰ä½¿ç”¨ã€‚</li></ul><p>æ¯”å¦‚å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a, *args</span>):<br>    <span class="hljs-built_in">print</span>(a, args)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å½¢å‚<code>a</code>å±äº<em>POSITIONAL_OR_KEYWORD</em>ï¼Œå¯é€šè¿‡å®šä½&#x2F;å…³é”®å­—å®å‚ä¼ é€’ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>)<br><span class="hljs-number">1</span> ()<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo(a=<span class="hljs-number">1</span>)<br><span class="hljs-number">1</span> ()<br></code></pre></td></tr></table></figure><p>æ»¡è¶³å½¢å‚<code>a</code>ä¹‹åï¼Œå‰©ä½™çš„å®šä½å®å‚å°†è¢«<code>*args</code>ä»¥å…ƒç»„çš„å½¢å¼æ•è·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><span class="hljs-number">1</span> (<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure><p>å†æ¯”å¦‚å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a, *args, b, **kwargs</span>):<br>    <span class="hljs-built_in">print</span>(a, args, b, kwargs)<br></code></pre></td></tr></table></figure><p>å½¢å‚<code>b</code>å±äº<em>KEYWORD_ONLY</em>ï¼Œå› ä¸ºå®ƒåœ¨<code>*args</code>ä¹‹åå®šä¹‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>, b=<span class="hljs-number">2</span>)<br><span class="hljs-number">1</span> () <span class="hljs-number">2</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>æ»¡è¶³å½¢å‚<code>b</code>ä¹‹åï¼Œå‰©ä½™çš„å…³é”®å­—å®å‚å°†è¢«<code>**kwargs</code>ä»¥å­—å…¸çš„å½¢å¼æ•è·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>, b=<span class="hljs-number">2</span>, c=<span class="hljs-number">3</span>)<br><span class="hljs-number">1</span> () <span class="hljs-number">2</span> &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">3</span>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³å®šä¹‰<em>KEYWORD_ONLY</em>å½¢å‚ï¼Œä½†ä¸æƒ³ä½¿ç”¨<em>VAR_POSITIONAL</em>å½¢å‚ï¼ˆå³<code>*args</code>ï¼‰ï¼Œåˆ™å¯ä»¥åœ¨å®šä¹‰å‡½æ•°æ—¶å•ç‹¬çš„<code>*</code>å·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a, *, b</span>):<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(a, b)<br>...<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>, b=<span class="hljs-number">2</span>)<br><span class="hljs-number">1</span> <span class="hljs-number">2</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>foo(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>TypeError: foo() takes <span class="hljs-number">1</span> positional argument but <span class="hljs-number">2</span> were given<br></code></pre></td></tr></table></figure><h1 id="å‚æ•°é»˜è®¤å€¼"><a href="#å‚æ•°é»˜è®¤å€¼" class="headerlink" title="å‚æ•°é»˜è®¤å€¼"></a>å‚æ•°é»˜è®¤å€¼</h1><p>åœ¨å®šä¹‰å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å½¢å‚æŒ‡å®šé»˜è®¤å€¼ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a=<span class="hljs-number">1</span>, *args, b=<span class="hljs-number">2</span>, **kwargs</span>):<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(a, args, b, kwargs)<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>foo()<br><span class="hljs-number">1</span> () <span class="hljs-number">2</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½¢å‚çš„é»˜è®¤å€¼å­˜å‚¨åœ¨å‡½æ•°å¯¹è±¡çš„<code>__defaults__</code>å’Œ<code>__kwdefaults__</code>å±æ€§é‡Œï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶åŠ¨æ€ç”Ÿæˆï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦ç”¨å¯å˜å¯¹è±¡å……å½“å½¢å‚çš„é»˜è®¤å€¼ã€‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯åé¢æ•™æï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">param=[]</span>):<br><span class="hljs-meta">... </span>    param.append(<span class="hljs-number">1</span>)<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">id</span>(param), param)<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">print</span>(<span class="hljs-built_in">id</span>(foo.__defaults__[<span class="hljs-number">0</span>]), foo.__defaults__[<span class="hljs-number">0</span>])<br><span class="hljs-number">140009169940232</span> []<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo()<br><span class="hljs-number">140009169940232</span> [<span class="hljs-number">1</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo()<br><span class="hljs-number">140009169940232</span> [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br></code></pre></td></tr></table></figure><h1 id="è·å–å…³äºå‚æ•°çš„ä¿¡æ¯"><a href="#è·å–å…³äºå‚æ•°çš„ä¿¡æ¯" class="headerlink" title="è·å–å…³äºå‚æ•°çš„ä¿¡æ¯"></a>è·å–å…³äºå‚æ•°çš„ä¿¡æ¯</h1><p><strong>å†…çœ</strong>æŒ‡ç¨‹åºåœ¨è¿è¡Œæ—¶æ£€æŸ¥å¯¹è±¡ç±»å‹çš„ä¸€ç§èƒ½åŠ›ï¼Œæœ¬èŠ‚ä»‹ç»çš„å†…å®¹å°±å±äºå‡½æ•°å†…çœçš„èŒƒå›´ã€‚å‡è®¾æœ‰å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a=<span class="hljs-number">1</span>, *args, b=<span class="hljs-number">2</span>, **kwargs</span>):<br>    c = a<br>    <span class="hljs-built_in">print</span>(c, args, b, kwargs)<br></code></pre></td></tr></table></figure><p>å°±åƒä¸Šä¸€èŠ‚ä¸­æåˆ°çš„ï¼Œ<code>foo</code>å‡½æ•°æœ‰<code>__defaults__</code>ã€<code>__kwdefaults__</code>å±æ€§ï¼Œç”¨äºè®°å½•å®šä½å‚æ•°å’Œå…³é”®å­—å‚æ•°çš„é»˜è®¤å€¼ï¼›æœ‰<code>__code__</code>å±æ€§ï¼Œå­˜å‚¨å‡½æ•°ç¼–è¯‘åçš„å­—èŠ‚ç ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å‚æ•°çš„åç§°ã€‚é€šè¿‡è¿™äº›å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å…³äºå‡½æ•°å‚æ•°çš„ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__defaults__<br>(<span class="hljs-number">1</span>,)<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__kwdefaults__<br>&#123;<span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">2</span>&#125;<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__code__.co_varnames  <span class="hljs-comment"># å‚æ•°&amp;å±€éƒ¨å˜é‡åç§°</span><br>(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;args&#x27;</span>, <span class="hljs-string">&#x27;kwargs&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__code__.co_argcount  <span class="hljs-comment"># å®šä½å‚æ•°æ•°é‡</span><br><span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>foo.__code__.co_kwonlyargcount  <span class="hljs-comment"># ä»…é™å…³é”®å­—å‚æ•°æ•°é‡</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä½†è¿™æ ·è¿˜æ˜¯å¤ªåŸå§‹ã€å¤ªä¸æ–¹ä¾¿äº†ã€‚å¹¸å¥½ï¼Œæˆ‘ä»¬æœ‰æ›´å¥½çš„é€‰æ‹©ï¼šPythonå†…ç½®çš„<code>inspect</code>æ¨¡å—ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æå–äº†<code>foo</code>å‡½æ•°çš„ç­¾åï¼Œç„¶åè·å–å‡½æ•°çš„å‚æ•°ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> inspect <span class="hljs-keyword">import</span> signature<br><span class="hljs-meta">&gt;&gt;&gt; </span>sig = signature(foo)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sig<br>&lt;Signature (a=<span class="hljs-number">1</span>, *args, b=<span class="hljs-number">2</span>, **kwargs)&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> sig.parameters.items():<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(param.kind):&lt;<span class="hljs-number">21</span>&#125;</span> : <span class="hljs-subst">&#123;param.name:&lt;<span class="hljs-number">6</span>&#125;</span> = <span class="hljs-subst">&#123;param.default&#125;</span>&#x27;</span>)<br><span class="hljs-meta">... </span><br>POSITIONAL_OR_KEYWORD : a      = <span class="hljs-number">1</span><br>VAR_POSITIONAL        : args   = &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;inspect._empty&#x27;</span>&gt;<br>KEYWORD_ONLY          : b      = <span class="hljs-number">2</span><br>VAR_KEYWORD           : kwargs = &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;inspect._empty&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œ<code>inspect.Signature</code>å¯¹è±¡è¿˜æœ‰ä¸€ä¸ª<code>bind</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å°†ä¸€äº›å¯¹è±¡ç»‘å®šåˆ°å‡½æ•°çš„å½¢å‚ä¸Šï¼Œå°±åƒPythonè§£é‡Šå™¨åœ¨è°ƒç”¨å‡½æ•°æ—¶åšçš„é‚£æ ·ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæ¡†æ¶å¯ä»¥åœ¨çœŸæ­£æ‰§è¡Œå‡½æ•°å‰éªŒè¯å‚æ•°ï¼Œå°±åƒä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bound = sig.bind(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, c=<span class="hljs-number">3</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> bound.arguments.items():<br><span class="hljs-meta">... </span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;name:&lt;<span class="hljs-number">6</span>&#125;</span> = <span class="hljs-subst">&#123;value&#125;</span>&#x27;</span>)<br><span class="hljs-meta">... </span><br>a      = <span class="hljs-number">1</span><br>args   = (<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>kwargs = &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">3</span>&#125;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bound = sig.bind(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, a=<span class="hljs-number">4</span>)<br>Traceback (most recent call last):<br>  File ...<br>TypeError: multiple values <span class="hljs-keyword">for</span> argument <span class="hljs-string">&#x27;a&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="å‡½æ•°å‚æ•°ä¼ é€’"><a href="#å‡½æ•°å‚æ•°ä¼ é€’" class="headerlink" title="å‡½æ•°å‚æ•°ä¼ é€’"></a>å‡½æ•°å‚æ•°ä¼ é€’</h1><p>è¯´èµ·å‡½æ•°å‚æ•°ä¼ é€’ï¼Œå¯èƒ½å°±æœ‰äººæƒ³èµ·äº†<code>å¼•ç”¨ä¼ é€’</code>ã€<code>å€¼ä¼ é€’</code>â€¦â€¦å¿˜æ‰è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œæ¥çœ‹çœ‹ä¸‹é¢ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo1</span>(<span class="hljs-params">param: <span class="hljs-built_in">list</span></span>):<br>    param += [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<br><br>arg1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>foo1(arg1)<br><span class="hljs-built_in">print</span>(arg1)  <span class="hljs-comment"># è¾“å‡º[1, 2, 3, 4, 5]</span><br></code></pre></td></tr></table></figure><p>å†…å­˜ä¸­æœ‰ä¸€ä¸ª<code>list</code>å¯¹è±¡ï¼ˆ<code>[1, 2, 3]</code>ï¼‰ï¼Œè¯¥å¯¹è±¡æœ‰ä¸¤ä¸ªåˆ«åï¼š<code>arg1</code>å’Œ<code>param</code>ã€‚ç”±äº<code>list</code>å¯¹è±¡æ˜¯å¯å˜çš„ï¼ˆ<code>mutable</code>ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>param</code>è¿™ä¸ªåˆ«åä¿®æ”¹è¿™ä¸ª<code>list</code>å¯¹è±¡çš„å†…å®¹ã€‚</p><p><img src="/images/2020/07/04/list.webp" alt="tuple.webp"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo2</span>(<span class="hljs-params">param: <span class="hljs-built_in">tuple</span></span>):<br>    param += (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br><br>arg2 = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>foo2(arg2)<br><span class="hljs-built_in">print</span>(arg2)  <span class="hljs-comment"># è¾“å‡º(1, 2, 3)</span><br></code></pre></td></tr></table></figure><p>å†…å­˜ä¸­æœ‰ä¸€ä¸ª<code>tuple</code>å¯¹è±¡ï¼ˆ<code>(1, 2, 3)</code>ï¼‰ï¼Œè¯¥å¯¹è±¡ä¹Ÿæœ‰ä¸¤ä¸ªåˆ«åï¼š<code>arg2</code>å’Œ<code>param</code>ã€‚ä½†ç”±äº<code>tuple</code>å¯¹è±¡æ˜¯ä¸å¯å˜çš„<code>(immutable)</code>ï¼Œå½“æ‰§è¡Œ<code>param += (4, 5)</code>æ—¶ï¼Œè§£é‡Šå™¨åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„<code>tuple</code>å¯¹è±¡ï¼ˆ<code>(1, 2, 3, 4, 5)</code>ï¼‰ï¼Œå¹¶è®©<code>param</code>æŒ‡å‘è¿™ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€ŒåŸæ¥çš„å¯¹è±¡æ²¡æœ‰è¢«æ”¹å˜ã€‚</p><p><img src="/images/2020/07/04/tuple.webp" alt="tuple.webp"></p><p>åœ¨Pythonä¸­ï¼Œå‚æ•°ä¼ é€’æœ¬è´¨ä¸Šæ˜¯ä¸ºå·²æœ‰çš„å¯¹è±¡å–äº†ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸçº§åˆ«çš„åˆ«åã€‚å¦‚æœè¯¥å¯¹è±¡æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨å‡½æ•°å†…ä¿®æ”¹è¯¥å¯¹è±¡ï¼Œè¿™ç§ä¿®æ”¹ä¹Ÿå¯ä»¥è¢«å…¶å®ƒçš„åˆ«åæ‰€æ„ŸçŸ¥ã€‚å¼„æ¸…æ¥šå¯¹è±¡ã€åˆ«åçš„å…³ç³»ï¼Œå°±ä¸ä¼šå¯¹<code>å€¼ä¼ é€’</code>ã€<code>å¼•ç”¨ä¼ é€’</code>è¿™ç§è¯´æ³•æ„Ÿåˆ°å›°æƒ‘äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pythonéƒ¨åˆ†å†…ç½®å‡½æ•°è£…é¥°å™¨æºç æµ…æ</title>
    <link href="/2020/06/20/python-decorators-source-code/"/>
    <url>/2020/06/20/python-decorators-source-code/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ˜¯è¿™ä¸ªåšå®¢é‡Œç¬¬ä¸€ç¯‡å¸¦æœ‰<code>æºç </code>Tagçš„æ–‡ç« ã€‚åœ¨è¿‡å»çš„ä¸€ä¸ªæœˆï¼Œç¬”è€…æ·±åˆ»åœ°è®¤è¯†åˆ°è‡ªå·±åœ¨æŠ€æœ¯æ·±åº¦æ–¹é¢æœ‰å¾ˆå¤§çš„ä¸è¶³ï¼Œæ‰€ä»¥åœ¨æœªæ¥çš„å­¦ä¹ é“è·¯ä¸Šï¼Œç¬”è€…ä¼šå°½é‡å¤šåœ°é˜…è¯»å¼€æºè½¯ä»¶çš„æºä»£ç ï¼Œå¹¶å°†è‡ªå·±çš„ç†è§£ä»¥æ–‡ç« çš„å½¢å¼è¡¨è¾¾å‡ºæ¥ã€‚å¦‚æœ‰é”™æ¼ï¼Œè¯·å„ä½è¯»è€…ä¸åæŒ‡æ•™ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« æ‰€ç”¨ç¯å¢ƒä¸ºCPython3.6</p></blockquote><h1 id="functools-wraps"><a href="#functools-wraps" class="headerlink" title="functools.wraps"></a>functools.wraps</h1><p><code>wraps</code>è¿™ä¸ªå†…ç½®å‡½æ•°è£…é¥°å™¨åœ¨ç¬”è€…çš„<a href="/2020/06/19/%E8%AF%BB%E3%80%8A%E6%B5%81%E7%95%85%E7%9A%84Python%E3%80%8B%EF%BC%9A%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%8E%E9%97%AD%E5%8C%85/#functool-wraps">ä¸Šä¸€ç¯‡æ–‡ç« </a>é‡Œæœ‰è¿‡ä»‹ç»ï¼ŒåŠŸèƒ½å¾ˆå•çº¯ï¼ˆæ‹·è´<code>__name__</code>ã€<code>__doc__</code>ç­‰å±æ€§ï¼‰ï¼Œæºç ä¹Ÿå¾ˆçŸ­ï¼ˆä¸åˆ°50è¡Œï¼‰ã€‚</p><h2 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">deco</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;inner(<span class="hljs-subst">&#123;args&#125;</span>, <span class="hljs-subst">&#123;kwargs&#125;</span>)&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> inner<br><br><span class="hljs-meta">@deco</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;target doc&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;target(name=<span class="hljs-subst">&#123;name&#125;</span>)&#x27;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨ä¸ç”¨<code>wraps</code>è£…é¥°å™¨çš„æƒ…å†µä¸‹ï¼Œ<code>target</code>çš„<code>__name__</code>å’Œ<code>__doc__</code>å±æ€§éƒ½æ¥è‡ª<code>deco()</code>é‡Œçš„<code>inner</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;__doc__  :&#x27;</span>, target.__doc__)   <span class="hljs-comment"># __doc__  : inner doc</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;__name__ :&#x27;</span>, target.__name__)  <span class="hljs-comment"># __name__ : inner</span><br>target(name=<span class="hljs-string">&#x27;bob&#x27;</span>)                    <span class="hljs-comment"># inner((), &#123;&#x27;name&#x27;: &#x27;bob&#x27;&#125;)</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸€ç‚¹ä¹Ÿä¸å¥‡æ€ªï¼Œå› ä¸ºæ­¤æ—¶<code>target</code>æ˜¯<code>deco()</code>çš„è¿”å›å€¼ï¼Œå…¶<code>__name__</code>ç­‰å±æ€§è‡ªç„¶ä¹Ÿä¸ä¼šæ˜¯æ¥è‡ªè¢«è£…é¥°çš„åŸå§‹<code>target</code>ã€‚ä½†ä»è°ƒç”¨è€…çš„è§’åº¦æ¥è¯´ï¼Œè¿™æ˜¯å¾ˆè®©äººè´¹è§£çš„ã€‚æ‰€ä»¥Pythonå†…ç½®äº†<code>wraps</code>è£…é¥°å™¨ï¼Œå¯ä»¥æ‹·è´è¢«è£…é¥°å‡½æ•°çš„éƒ¨åˆ†å±æ€§ï¼Œè®©è£…é¥°åçš„å‡½æ•°<code>çœ‹èµ·æ¥</code>å’Œè£…é¥°å‰ä¸€æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">deco</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br><span class="hljs-meta">    @functools.wraps(<span class="hljs-params">func</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;inner(<span class="hljs-subst">&#123;args&#125;</span>, <span class="hljs-subst">&#123;kwargs&#125;</span>)&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> inner<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;__doc__  :&#x27;</span>, target.__doc__)   <span class="hljs-comment"># __doc__  : target doc</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;__name__ :&#x27;</span>, target.__name__)  <span class="hljs-comment"># __name__ : target</span><br>target(name=<span class="hljs-string">&#x27;bob&#x27;</span>)                    <span class="hljs-comment"># inner((), &#123;&#x27;name&#x27;: &#x27;bob&#x27;&#125;)</span><br></code></pre></td></tr></table></figure><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p><code>wraps</code>è£…é¥°å™¨çš„å…¥å£å‡½æ•°åœ¨<code>functools.py</code>çš„ç¬¬<a href="https://github.com/python/cpython/blob/3.6/Lib/functools.py#L74">74è¡Œ</a>ï¼Œå‡½æ•°å¾ˆçŸ­å°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">wraps</span>(<span class="hljs-params">wrapped,</span><br><span class="hljs-params">          assigned = WRAPPER_ASSIGNMENTS,</span><br><span class="hljs-params">          updated = WRAPPER_UPDATES</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; ... çœç•¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> partial(update_wrapper, wrapped=wrapped,<br>                   assigned=assigned, updated=updated)<br></code></pre></td></tr></table></figure><p><a href="/2020/06/19/%E8%AF%BB%E3%80%8A%E6%B5%81%E7%95%85%E7%9A%84Python%E3%80%8B%EF%BC%9A%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%8E%E9%97%AD%E5%8C%85/#%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8">ä¸Šä¸€ç¯‡æ–‡ç« </a>æˆ‘ä»‹ç»è¿‡ï¼Œå¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨ä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨è¿”å›çš„å‡½æ•°æ¥å¯¹ç›®æ ‡å‡½æ•°è¿›è¡Œè£…é¥°ã€‚äºæ˜¯ï¼Œä¸Šé¢æåˆ°çš„<code>deco()</code>å‡½æ•°å°±å¯ä»¥è½¬æ¢ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, update_wrapper, WRAPPER_ASSIGNMENTS, WRAPPER_UPDATES<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deco</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>    <span class="hljs-comment"># @functools.wraps(func)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;inner(<span class="hljs-subst">&#123;args&#125;</span>, <span class="hljs-subst">&#123;kwargs&#125;</span>)&#x27;</span>)<br><br>    <span class="hljs-comment"># å…³é”®çš„ä¸¤è¡Œ</span><br>    tmp = partial(update_wrapper, wrapped=func,<br>                  assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)<br>    inner = tmp(inner)<br><br>    <span class="hljs-keyword">return</span> inner<br></code></pre></td></tr></table></figure><p>ç”±äº<code>functools.partial</code>çš„åŠŸèƒ½åªæ˜¯å›ºå®šå‚æ•°ï¼Œæ‰€ä»¥ä»¥ä¸Šæåˆ°çš„å…³é”®çš„ä¸¤è¡Œå¯ä»¥è½¬æ¢ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">inner = update_wrapper(inner, wrapped=func, assigned=WRAPPER_ASSIGNMENTS,<br>                       updated=WRAPPER_UPDATES)<br></code></pre></td></tr></table></figure><p>å†è®©æˆ‘ä»¬æŠŠç›®å…‰èšé›†åœ¨<code>update_wrapper()</code>å‡½æ•°çš„æºç ä¸Šï¼ˆ<code>functools.py</code><a href="https://github.com/python/cpython/blob/3.6/Lib/functools.py#L44">ç¬¬44è¡Œ</a>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">WRAPPER_ASSIGNMENTS = (<span class="hljs-string">&#x27;__module__&#x27;</span>, <span class="hljs-string">&#x27;__name__&#x27;</span>, <span class="hljs-string">&#x27;__qualname__&#x27;</span>, <span class="hljs-string">&#x27;__doc__&#x27;</span>,<br>                       <span class="hljs-string">&#x27;__annotations__&#x27;</span>)<br>WRAPPER_UPDATES = (<span class="hljs-string">&#x27;__dict__&#x27;</span>,)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_wrapper</span>(<span class="hljs-params">wrapper,</span><br><span class="hljs-params">                   wrapped,</span><br><span class="hljs-params">                   assigned = WRAPPER_ASSIGNMENTS,</span><br><span class="hljs-params">                   updated = WRAPPER_UPDATES</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; ... çœç•¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> assigned:<br>        <span class="hljs-keyword">try</span>:<br>            value = <span class="hljs-built_in">getattr</span>(wrapped, attr)<br>        <span class="hljs-keyword">except</span> AttributeError:<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">setattr</span>(wrapper, attr, value)<br>    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> updated:<br>        <span class="hljs-built_in">getattr</span>(wrapper, attr).update(<span class="hljs-built_in">getattr</span>(wrapped, attr, &#123;&#125;))<br>    <span class="hljs-comment"># Issue #17482: set __wrapped__ last so we don&#x27;t inadvertently copy it</span><br>    <span class="hljs-comment"># from the wrapped function when updating __dict__</span><br>    wrapper.__wrapped__ = wrapped<br>    <span class="hljs-comment"># Return the wrapper so this can be used as a decorator via partial()</span><br>    <span class="hljs-keyword">return</span> wrapper<br></code></pre></td></tr></table></figure><p>ç»“åˆå‰ä¸¤æ®µä»£ç ï¼Œ<code>functools.wraps</code>æ‰€åšçš„äº‹æƒ…å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼šé€šè¿‡<code>getattr()</code>ä»è¢«è£…é¥°çš„å‡½æ•°ä¸­æå–<code>__module__</code>ã€<code>__name__</code>ç­‰å±æ€§ï¼Œå†é€šè¿‡<code>setattr()</code>å°†æå–åˆ°çš„å±æ€§èµ‹å€¼ç»™è£…é¥°åçš„å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>deco()</code>è£…é¥°å™¨æœ€åå¯ä»¥è½¬æ¢ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">deco</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>    <span class="hljs-comment"># @functools.wraps(func)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;inner(<span class="hljs-subst">&#123;args&#125;</span>, <span class="hljs-subst">&#123;kwargs&#125;</span>)&#x27;</span>)<br><br><span class="hljs-comment"># èŠ‚çœç©ºé—´ï¼Œä¸è€ƒè™‘AttributeError</span><br>    <span class="hljs-built_in">setattr</span>(inner, <span class="hljs-string">&#x27;__module__&#x27;</span>, <span class="hljs-built_in">getattr</span>(func, <span class="hljs-string">&#x27;__module__&#x27;</span>)) <br>    <span class="hljs-comment"># ... çœç•¥</span><br>    <span class="hljs-built_in">getattr</span>(inner, <span class="hljs-string">&#x27;__dict__&#x27;</span>).update(<span class="hljs-built_in">getattr</span>(func, <span class="hljs-string">&#x27;__dict__&#x27;</span>, &#123;&#125;))<br>    inner.__wrapped__ = func<br><br>    <span class="hljs-keyword">return</span> inner<br></code></pre></td></tr></table></figure><p>ä¸è€ƒè™‘æ³¨é‡Šï¼Œ<code>functools.wraps</code>çš„ä»£ç æ€»å…±åªæœ‰23è¡Œï¼Œå¯ä»¥è¯´æ˜¯ç›¸å½“çŸ­å°äº†ğŸ¤£</p><h1 id="functools-lru-cache"><a href="#functools-lru-cache" class="headerlink" title="functools.lru_cache"></a>functools.lru_cache</h1><p><code>lru_cache</code>æ˜¯ä¸ªéå¸¸å®ç”¨çš„è£…é¥°å™¨ï¼Œè¿™ä¸ªè£…é¥°å™¨å¯ä»¥å°†å‡½æ•°çš„ç»“æœç¼“å­˜èµ·æ¥ï¼Œé¿å…ä¼ å…¥ç›¸åŒçš„å‚æ•°æ—¶é‡å¤è®¡ç®—ã€‚<code>lru</code>ä»£è¡¨è¿™ä¸ªè£…é¥°å™¨åœ¨ç¼“å­˜ç»“æœæ—¶é‡‡ç”¨<code>æœ€è¿‘æœ€å°‘ä½¿ç”¨</code>ç®—æ³•ï¼Œåœ¨ç¼“å­˜çš„ç»“æœåˆ°è¾¾ä¸€å®šæ•°é‡æ—¶æŠ›å¼ƒé‚£äº›å¾ˆä¹…æ²¡å‘½ä¸­è¿‡çš„ç¼“å­˜ã€‚</p><p><code>lru_cache</code>æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š<code>maxsize</code>å’Œ<code>typed</code>ã€‚å‰è€…ç”¨äºæŒ‡å®šç¼“å­˜ç»“æœæ•°é‡ä¸Šé™ï¼Œè€Œåè€…ç”¨äºåˆ¤æ–­ç¼“å­˜æ˜¯æ˜¯å¦è€ƒè™‘å‚æ•°ç±»å‹ã€‚æ¯”å¦‚<code>func(1)</code>å’Œ<code>func(1.0)</code>åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šå…±ç”¨ç¼“å­˜ï¼Œä½†å½“<code>typed</code>ä¸º<code>True</code>æ—¶ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±ä¼šåˆ†å¼€ç¼“å­˜ã€‚</p><h2 id="ä½¿ç”¨ç¤ºä¾‹-1"><a href="#ä½¿ç”¨ç¤ºä¾‹-1" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><p>é€’å½’è®¡ç®—<code>fibonacci</code>æ•°åˆ—è¿™ç§éœ€è¦å¤šæ¬¡é‡å¤è®¡ç®—çš„åœºæ™¯ç‰¹åˆ«é€‚åˆä½¿ç”¨<code>lru_cache</code>è£…é¥°å™¨ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªå®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">k: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    <span class="hljs-keyword">return</span> k <span class="hljs-keyword">if</span> k &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> fibonacci(k - <span class="hljs-number">1</span>) + fibonacci(k - <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>å½“è®¡ç®—<code>fibonacci(6)</code>æ—¶ï¼Œæ€»å…±éœ€è¦è°ƒç”¨25æ¬¡<code>fibonacci()</code>å‡½æ•°ï¼Œå…¶ä¸­8æ¬¡æ˜¯<code>fibonacci(1)</code>ã€‚ä½†ä½¿ç”¨<code>lru_cache</code>è£…é¥°å™¨åï¼Œåªéœ€è¦è°ƒç”¨7æ¬¡<code>fibonacci()</code>å‡½æ•°å³å¯å¾—å‡ºè®¡ç®—ç»“æœï¼Œè€Œä¸”åªéœ€è¦åœ¨åŸå‡½æ•°ä¸ŠåŠ ä¸Šä¸€è¡Œä»£ç å³å¯å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@functools.lru_cache()</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">k: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    <span class="hljs-keyword">return</span> k <span class="hljs-keyword">if</span> k &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> fibonacci(k - <span class="hljs-number">1</span>) + fibonacci(k - <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œä½¿ç”¨äº†<code>lru_cache</code>è£…é¥°å™¨çš„å‡½æ•°è¿˜ä¼šè¢«â€é™„èµ â€ä¸¤ä¸ªæ–¹æ³•ï¼š<code>cache_info</code>å’Œ<code>cache_clear</code>ï¼Œåˆ†åˆ«ç”¨äºå±•ç¤ºç¼“å­˜æƒ…å†µå’Œæ¸…ç©ºç¼“å­˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>fibonacci(<span class="hljs-number">6</span>)<br><span class="hljs-number">8</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fibonacci.cache_info()<br>CacheInfo(hits=<span class="hljs-number">4</span>, misses=<span class="hljs-number">7</span>, maxsize=<span class="hljs-number">128</span>, currsize=<span class="hljs-number">7</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>fibonacci.cache_clear()<br><span class="hljs-meta">&gt;&gt;&gt; </span>fibonacci.cache_info()<br>CacheInfo(hits=<span class="hljs-number">0</span>, misses=<span class="hljs-number">0</span>, maxsize=<span class="hljs-number">128</span>, currsize=<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h2 id="æºç -1"><a href="#æºç -1" class="headerlink" title="æºç "></a>æºç </h2><p><code>functool.lru_cache</code>åœ¨CPythoné‡Œæœ‰ä¸¤ç§å®ç°ï¼Œä¸€ç§åŸºäºCè¯­è¨€ï¼ˆ<code>_functool._lru_cache_wrapper</code>ï¼‰ï¼Œå¦ä¸€ç§åŸºäºPythonï¼ˆ<code>functool._lru_cache_wraper</code>ï¼‰ã€‚åè€…åªæœ‰åœ¨å‰è€…æ— æ³•å¯¼å…¥æ—¶æ‰ä¼šå¯ç”¨ï¼Œä½†æœ¬ç¯‡æ–‡ç« è¿˜æ˜¯èšç„¦äºåè€…çš„æºç ã€‚</p><p><code>lru_cache</code>è£…é¥°å™¨çš„å…¥å£å‡½æ•°åœ¨<code>functools.py</code>ç¬¬<a href="https://github.com/python/cpython/blob/3.6/Lib/functools.py#L448">448è¡Œ</a>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">_CacheInfo = namedtuple(<span class="hljs-string">&quot;CacheInfo&quot;</span>, [<span class="hljs-string">&quot;hits&quot;</span>, <span class="hljs-string">&quot;misses&quot;</span>, <span class="hljs-string">&quot;maxsize&quot;</span>, <span class="hljs-string">&quot;currsize&quot;</span>])<br><span class="hljs-comment"># ... ç•¥</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lru_cache</span>(<span class="hljs-params">maxsize=<span class="hljs-number">128</span>, typed=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot; ... ç•¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> maxsize <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(maxsize, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&#x27;Expected maxsize to be an integer or None&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorating_function</span>(<span class="hljs-params">user_function</span>):<br>        wrapper = _lru_cache_wrapper(user_function, maxsize, typed, _CacheInfo)<br>        <span class="hljs-keyword">return</span> update_wrapper(wrapper, user_function)<br><br>    <span class="hljs-keyword">return</span> decorating_function<br></code></pre></td></tr></table></figure><p>å’Œ<code>wraps</code>ä¸€æ ·ï¼Œ<code>lru_cache</code>ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨ã€‚åŒæ—¶ï¼Œ<code>lru_cache</code>è¿˜ç”¨åˆ°äº†ä¸Šä¸€èŠ‚æåˆ°çš„<code>update_wrapper()</code>å‡½æ•°ï¼Œè‡ªåŠ¨å°†è¢«è£…é¥°å‡½æ•°çš„å±æ€§æ‹·è´åˆ°æ–°å‡½æ•°ä¸­ã€‚è¿™æ®µä»£ç çš„å…³é”®æ˜¯<code>wrapper = _lru_cache_wrapper(...)</code>ï¼Œé‚£å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹<code>_lru_cache_wrapper</code>å‡½æ•°çš„æºç ç»“æ„ï¼ˆ<code>functools.py</code>ç¬¬<a href="https://github.com/python/cpython/blob/3.6/Lib/functools.py#L485">485è¡Œ</a>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lru_cache_wrapper</span>(<span class="hljs-params">user_function, maxsize, typed, _CacheInfo</span>):<br>    <span class="hljs-comment"># åˆå§‹åŒ–å˜é‡ï¼Œçœç•¥</span><br><br>    <span class="hljs-keyword">if</span> maxsize == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-comment"># No caching -- just a statistics update after a successful call</span><br>            <span class="hljs-comment"># ... çœç•¥</span><br>    <span class="hljs-keyword">elif</span> maxsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-comment"># Simple caching without ordering or size limit</span><br>            <span class="hljs-comment"># ... çœç•¥</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-comment"># Size limited caching that tracks accesses by recency</span><br>            <span class="hljs-comment"># ... çœç•¥</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cache_info</span>():<br>        <span class="hljs-string">&quot;&quot;&quot;Report cache statistics&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># ... çœç•¥</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cache_clear</span>():<br>        <span class="hljs-string">&quot;&quot;&quot;Clear the cache and cache statistics&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># ... çœç•¥</span><br><br>    wrapper.cache_info = cache_info<br>    wrapper.cache_clear = cache_clear<br>    <span class="hljs-keyword">return</span> wrapper<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå½“æŸä¸ªå‡½æ•°ä½¿ç”¨äº†<code>lru_cache</code>è£…é¥°å™¨åï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶è¢«æ‰§è¡Œçš„å®é™…ä¸Šæ˜¯æºç é‡Œå®šä¹‰çš„å„ä¸ª<code>wrapper</code>ï¼Œ<code>cache_info()</code>å’Œ<code>cache_clear()</code>è¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯åœ¨æºç é‡Œä¸º<code>wrapper</code>åŠ ä¸Šçš„ã€‚æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬å…·ä½“åˆ†ææºç é‡Œå®šä¹‰çš„å„ä¸ªæ¨¡å—ã€‚</p><h3 id="maxsizeä¸º0"><a href="#maxsizeä¸º0" class="headerlink" title="maxsizeä¸º0"></a>maxsizeä¸º0</h3><p>å½“<code>maxsize</code>ä¸º0æ—¶ï¼Œ<code>lru_cache</code>ä¸ä¼šç¼“å­˜ä»»ä½•ç»“æœï¼Œé™¤äº†è°ƒç”¨åŸå§‹å‡½æ•°å¹¶è¿”å›ç»“æœå¤–ï¼Œåªå¢åŠ <code>misses</code>ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰è®¡æ•°å™¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lru_cache_wrapper</span>(<span class="hljs-params">user_function, maxsize, typed, _CacheInfo</span>):<br>    <span class="hljs-comment"># ...</span><br>    hits = misses = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-keyword">if</span> maxsize == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-comment"># No caching -- just a statistics update after a successful call</span><br>            <span class="hljs-keyword">nonlocal</span> misses<br>            result = user_function(*args, **kwds)<br>            misses += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> result<br>    <span class="hljs-comment"># ...</span><br></code></pre></td></tr></table></figure><h3 id="maxsizeä¸ºNone"><a href="#maxsizeä¸ºNone" class="headerlink" title="maxsizeä¸ºNone"></a>maxsizeä¸ºNone</h3><p>å½“<code>maxsize</code>ä¸º<code>None</code>æ—¶ï¼Œ<code>lru_cache</code>ä¼šæ— é™åˆ¶åœ°ç¼“å­˜ç»“æœï¼Œ<code>lru</code>ç®—æ³•å¹¶ä¸ä¼šç”Ÿæ•ˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lru_cache_wrapper</span>(<span class="hljs-params">user_function, maxsize, typed, _CacheInfo</span>):<br>    <span class="hljs-comment"># Constants shared by all lru cache instances:</span><br>    sentinel = <span class="hljs-built_in">object</span>()          <span class="hljs-comment"># unique object used to signal cache misses</span><br>    make_key = _make_key         <span class="hljs-comment"># build a key from the function arguments</span><br>    cache = &#123;&#125;<br>    hits = misses = <span class="hljs-number">0</span><br>    cache_get = cache.get    <span class="hljs-comment"># bound method to lookup a key or return None</span><br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-keyword">elif</span> maxsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-comment"># Simple caching without ordering or size limit</span><br>            <span class="hljs-keyword">nonlocal</span> hits, misses<br>            key = make_key(args, kwds, typed)<br>            result = cache_get(key, sentinel)<br>            <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> sentinel:<br>                hits += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">return</span> result<br>            result = user_function(*args, **kwds)<br>            cache[key] = result<br>            misses += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> result<br>    <span class="hljs-comment"># ...</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>lru_cache</code>é¦–å…ˆä¼šé€šè¿‡å‡½æ•°çš„å‚æ•°ç”Ÿæˆ<code>key</code>å€¼ï¼ˆ<code>make_key</code>ï¼‰ï¼Œå†ç”¨<code>key</code>å€¼å»ç¼“å­˜æ± ï¼ˆ<code>dict</code>ï¼‰é‡ŒæŸ¥æ‰¾ç»“æœã€‚å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™è¿”å›ç¼“å­˜å¹¶å¢åŠ <code>hits</code>è®¡æ•°å™¨ï¼›å¦åˆ™è°ƒç”¨å‡½æ•°è¿”å›ç»“æœï¼Œå°†ç»“æœåŠ å…¥ç¼“å­˜æ± å¹¶å¢åŠ <code>misses</code>ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰è®¡æ•°å™¨ã€‚</p><h3 id="make-key"><a href="#make-key" class="headerlink" title="_make_key"></a>_make_key</h3><p>å†è®©æˆ‘ä»¬å°†ç›®å…‰è½¬åˆ°<code>_make_key</code>ä¸Šæ¥ã€‚è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡å‡½æ•°çš„å‚æ•°ã€<code>typed</code>çš„å€¼æ¥ä¸ºå‡½æ•°è°ƒç”¨ç”Ÿæˆ<code>key</code>å€¼ï¼Œç”¨äºåœ¨ç¼“å­˜æ± é‡ŒæŸ¥æ‰¾æˆ–ç¼“å­˜ç»“æœã€‚å…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">_HashedSeq</span>(<span class="hljs-title class_ inherited__">list</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; ... çœç•¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    __slots__ = <span class="hljs-string">&#x27;hashvalue&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, tup, <span class="hljs-built_in">hash</span>=<span class="hljs-built_in">hash</span></span>):<br>        self[:] = tup<br>        self.hashvalue = <span class="hljs-built_in">hash</span>(tup)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.hashvalue<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_key</span>(<span class="hljs-params">args, kwds, typed,</span><br><span class="hljs-params">             kwd_mark = (<span class="hljs-params"><span class="hljs-built_in">object</span>(<span class="hljs-params"></span>),</span>),</span><br><span class="hljs-params">             fasttypes = &#123;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>, <span class="hljs-built_in">frozenset</span>, <span class="hljs-built_in">type</span>(<span class="hljs-params"><span class="hljs-literal">None</span></span>)&#125;,</span><br><span class="hljs-params">             <span class="hljs-built_in">tuple</span>=<span class="hljs-built_in">tuple</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">type</span>, <span class="hljs-built_in">len</span>=<span class="hljs-built_in">len</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot; ... çœç•¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    key = args<br>    <span class="hljs-keyword">if</span> kwds:<br>        key += kwd_mark<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> kwds.items():<br>            key += item<br>    <span class="hljs-keyword">if</span> typed:<br>        key += <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">type</span>(v) <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> args)<br>        <span class="hljs-keyword">if</span> kwds:<br>            key += <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">type</span>(v) <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> kwds.values())<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(key) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(key[<span class="hljs-number">0</span>]) <span class="hljs-keyword">in</span> fasttypes:<br>        <span class="hljs-keyword">return</span> key[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">return</span> _HashedSeq(key)<br></code></pre></td></tr></table></figure><p>ä»è¿™æ®µæºç å¯ä»¥çœ‹å‡ºï¼Œå½“å‡½æ•°çš„å‚æ•°åªæœ‰ä¸€ä¸ªã€<code>typed</code>ä¸º<code>False</code>ã€ä¸”ç±»å‹ä¸º<code>int</code>ã€<code>str</code>ç­‰æ—¶ï¼Œ<code>_make_key</code>ä¼šç›´æ¥å°†è¯¥å‚æ•°ä½œä¸º<code>key</code>å€¼è¿”å›ã€‚å¦åˆ™ï¼Œ<code>_make_key</code>ä¼šç”Ÿæˆä¸€ä¸ª<code>_HashedSeq</code>æ¥å­˜å‚¨å‡½æ•°çš„å‚æ•°ï¼Œå½“<code>typed</code>ä¸º<code>True</code>æ—¶è¿˜ä¼šå­˜å‚¨å‚æ•°çš„ç±»å‹ï¼Œä¸”<code>*args</code>å’Œ<code>**kwargs</code>è¿™ä¸¤ç§å‚æ•°ä¹‹é—´ä¼šæ’å…¥ä¸€ä¸ª<code>object</code>ç”¨ä½œåˆ†éš”ã€‚ä¸‹é¢è¿™å‡ ä¸ªä¾‹å­èƒ½å¸®åŠ©ç†è§£è¿™æ®µæºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> _make_key<br><span class="hljs-meta">&gt;&gt;&gt; </span>_make_key((<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;123&#x27;</span>), &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;bob&#x27;</span>&#125;, <span class="hljs-literal">False</span>)<br>[<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;123&#x27;</span>, &lt;<span class="hljs-built_in">object</span> <span class="hljs-built_in">object</span> at ...&gt;, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;bob&#x27;</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>_make_key((<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;123&#x27;</span>), &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;bob&#x27;</span>&#125;, <span class="hljs-literal">True</span>)<br>[<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;123&#x27;</span>, &lt;<span class="hljs-built_in">object</span> <span class="hljs-built_in">object</span> at ...&gt;, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;bob&#x27;</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;int&#x27;</span>&gt;, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt;, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt;]<br><span class="hljs-meta">&gt;&gt;&gt; </span>_make_key((<span class="hljs-number">1</span>,), &#123;&#125;, <span class="hljs-literal">False</span>)<br><span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>_make_key((<span class="hljs-number">1</span>,), &#123;&#125;, <span class="hljs-literal">True</span>)<br>[<span class="hljs-number">1</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;int&#x27;</span>&gt;]<br></code></pre></td></tr></table></figure><h4 id="è°é”™äº†ï¼Ÿ"><a href="#è°é”™äº†ï¼Ÿ" class="headerlink" title="è°é”™äº†ï¼Ÿ"></a>è°é”™äº†ï¼Ÿ</h4><p>ç†è§£äº†è¿™æ®µæºç ä¹‹åï¼Œåˆä¼šå‡ºç°æ–°çš„é—®é¢˜ï¼šä¸ç®¡<code>typed</code>ä¸º<code>True</code>è¿˜æ˜¯<code>False</code>ï¼Œå¯¹äºå•å‚æ•°<code>1</code>å’Œ<code>1.0</code>ï¼Œ<code>_make_key()</code>å¾—åˆ°çš„ç»“æœçš„å“ˆå¸Œå€¼éƒ½ä¸ä¸€è‡´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> _make_key<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hash</span>(_make_key((<span class="hljs-number">1</span>,), &#123;&#125;, <span class="hljs-literal">False</span>))    <span class="hljs-comment"># 1</span><br><span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hash</span>(_make_key((<span class="hljs-number">1.0</span>,), &#123;&#125;, <span class="hljs-literal">False</span>))  <span class="hljs-comment"># [1.0]</span><br><span class="hljs-number">3430019387558</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hash</span>(_make_key((<span class="hljs-number">1</span>,), &#123;&#125;, <span class="hljs-literal">True</span>))     <span class="hljs-comment"># [1, &lt;class &#x27;int&#x27;&gt;]</span><br><span class="hljs-number">3713082220284583106</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hash</span>(_make_key((<span class="hljs-number">1.0</span>,), &#123;&#125;, <span class="hljs-literal">True</span>))   <span class="hljs-comment"># [1.0, &lt;class &#x27;float&#x27;&gt;]</span><br><span class="hljs-number">3713082219329796056</span><br></code></pre></td></tr></table></figure><p>ä½†æ­¤æ—¶å¦‚æœä½¿ç”¨<code>lru_cache</code>ï¼Œå°±ä¼šå‘ç°<code>lru_cache</code>æ˜¯å°†å•å‚æ•°<code>1</code>å’Œ<code>1.0</code>ä¸€èµ·ç¼“å­˜çš„ï¼Œå’Œæœ¬æ–‡ä¸€å¼€å§‹å¯¹<code>lru_cache</code>çš„æè¿°ä¸€è‡´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@functools.lru_cache()</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">val</span>):<br>    <span class="hljs-built_in">print</span>(val)<br><br>test(<span class="hljs-number">1</span>)    <span class="hljs-comment"># è¾“å‡º1</span><br>test(<span class="hljs-number">1.0</span>)  <span class="hljs-comment"># å·²ç¼“å­˜ï¼Œä¸è¾“å‡º</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™åˆ°åº•æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Ÿç­”æ¡ˆå°±æ˜¯å‰æ–‡æåˆ°çš„Cè¯­è¨€å®ç°å’ŒPythonå®ç°çš„åŒºåˆ«ã€‚Cè¯­è¨€å®ç°çš„<code>_lru_cache_wrapper()</code>å¹¶ä¸ä½¿ç”¨Pythonå®ç°çš„<code>_make_key()</code>ï¼Œè€ŒCPythoné»˜è®¤ä½¿ç”¨çš„æ˜¯å‰è€…ï¼Œæ‰€ä»¥ä¼šé€ æˆè¿™é‡Œæåˆ°çš„é—®é¢˜ã€‚</p><p>æ­¤æ—¶å¦‚æœå°†ä¿®æ”¹CPythonå†…ç½®çš„<code>functools.py</code>ï¼Œåªä½¿ç”¨Pythonå®ç°çš„<code>_lru_cache_wrapper()</code>ï¼Œå°±ä¼šå‘ç°ç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚<code>1</code>å’Œ<code>1.0</code>é€šè¿‡<code>_make_key()</code>å¾—åˆ°çš„å“ˆå¸Œå€¼ä¸åŒï¼Œè‡ªç„¶ä¹Ÿå°±ä¼šåˆ†å¼€ç¼“å­˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># ä¸ä½¿ç”¨Cè¯­è¨€å®ç°çš„ç‰ˆæœ¬</span><br>    <span class="hljs-comment"># from _functools import _lru_cache_wrapper</span><br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">except</span> ImportError:<br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@functools.lru_cache()</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">val</span>):<br>    <span class="hljs-built_in">print</span>(val)<br><br>test(<span class="hljs-number">1</span>)    <span class="hljs-comment"># è¾“å‡º1</span><br>test(<span class="hljs-number">1.0</span>)  <span class="hljs-comment"># è¾“å‡º1.0</span><br></code></pre></td></tr></table></figure><h3 id="maxsizeä¸ºæ­£æ•´æ•°"><a href="#maxsizeä¸ºæ­£æ•´æ•°" class="headerlink" title="maxsizeä¸ºæ­£æ•´æ•°"></a>maxsizeä¸ºæ­£æ•´æ•°</h3><p>å½“<code>maxsize</code>ä¸ºæ­£æ•´æ•°æ—¶ï¼Œ<code>lru_cache</code>ä¸èƒ½æ— é™åˆ¶åœ°ç¼“å­˜å‡½æ•°ç»“æœï¼Œå¿…é¡»ç”¨<code>lru</code>ç®—æ³•æ¸…é™¤ç¼“å­˜ã€‚é—æ†¾çš„æ˜¯ï¼Œç”±äºå—é™äºç¯‡å¹…ï¼Œä¸”ç¬”è€…å¹¶æ²¡æœ‰å¼„æ‡‚è¿™éƒ¨åˆ†çš„ä»£ç ï¼ˆè¿™æ‰æ˜¯é‡ç‚¹å§â€¦â€¦ï¼‰ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†æºç å°±å…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚</p><h3 id="cache-infoå’Œcache-clear"><a href="#cache-infoå’Œcache-clear" class="headerlink" title="cache_infoå’Œcache_clear"></a>cache_infoå’Œcache_clear</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lru_cache_wrapper</span>(<span class="hljs-params">user_function, maxsize, typed, _CacheInfo</span>):<br>    <span class="hljs-comment"># ...</span><br>    hits = misses = <span class="hljs-number">0</span><br>    full = <span class="hljs-literal">False</span><br>    cache_len = cache.__len__  <span class="hljs-comment"># get cache size without calling len()</span><br>    lock = RLock()           <span class="hljs-comment"># because linkedlist updates aren&#x27;t threadsafe</span><br>    root = []                <span class="hljs-comment"># root of the circular doubly linked list</span><br>    root[:] = [root, root, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]     <span class="hljs-comment"># initialize by pointing to self</span><br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cache_info</span>():<br>        <span class="hljs-string">&quot;&quot;&quot;Report cache statistics&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> lock:<br>            <span class="hljs-keyword">return</span> _CacheInfo(hits, misses, maxsize, cache_len())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cache_clear</span>():<br>        <span class="hljs-string">&quot;&quot;&quot;Clear the cache and cache statistics&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">nonlocal</span> hits, misses, full<br>        <span class="hljs-keyword">with</span> lock:<br>            cache.clear()<br>            root[:] = [root, root, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]<br>            hits = misses = <span class="hljs-number">0</span><br>            full = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨æ¯”è¾ƒå•çº¯ï¼Œåˆ†åˆ«æ˜¯è¿”å›å½“å‰ç¼“å­˜çŠ¶æ€å’Œæ¸…ç©ºç¼“å­˜ã€‚æºç ä¹Ÿç®€å•æ˜“æ‡‚ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»ã€‚å…¶ä¸­<code>root</code>ã€<code>lock</code>ã€<code>full</code>ç­‰å˜é‡æ˜¯åªæœ‰åœ¨<code>maxsize</code>ä¸ºæ­£æ•´æ•°ï¼Œæˆ–è€…è¯´å¯ç”¨<code>lru</code>ç®—æ³•æ—¶æ‰éœ€è¦çš„ï¼Œæœ¬æ–‡ä»‹ç»çš„ã€é’ˆå¯¹å…¶å®ƒæƒ…å†µçš„æºç ä¸éœ€è¦è¿™å‡ ä¸ªå˜é‡ã€‚</p><h1 id="å°¾å£°"><a href="#å°¾å£°" class="headerlink" title="å°¾å£°"></a>å°¾å£°</h1><p>æœ¬æ¥ç¬”è€…è¿˜æƒ³åˆ†æ<code>singledispatch</code>è£…é¥°å™¨çš„æºç çš„ï¼Œä½†ä¸€ä¸ª<code>lru_cache</code>å°±æŠŠç¬”è€…æŠ˜è…¾å¾—å¤Ÿå‘›ï¼Œè¿™è¿˜æ˜¯è·³è¿‡äº†æœ€å¤æ‚çš„<code>lru</code>ç®—æ³•çš„æƒ…å†µä¸‹â€¦â€¦è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®å•Šã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¯»ã€Šæµç•…çš„Pythonã€‹ï¼šå‡½æ•°è£…é¥°å™¨ä¸é—­åŒ…</title>
    <link href="/2020/06/19/fluent-python-chap-7/"/>
    <url>/2020/06/19/fluent-python-chap-7/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2020/06/19/fluent_python.webp"></p><p>è¯»ä¹¦ç¬”è®°è¿™ç§å†…å®¹ï¼Œæ”¾åœ¨<code>Evernote</code>ç­‰ç¬”è®°è½¯ä»¶é‡Œä¼¼ä¹è¦æ¯”æ”¾åœ¨åšå®¢é‡Œæ›´åˆé€‚ã€‚ä½†å…¶ä¸€æ˜¯ç¬”è€…è¿˜æ²¡æœ‰æ‰¾åˆ°é€‚åˆæˆ‘çš„ç¬”è®°åŒæ­¥æ–¹æ¡ˆï¼Œå…¶äºŒæ˜¯åšå®¢ç›¸æ¯”ç¬”è®°è½¯ä»¶æ›´èƒ½é”»ç‚¼è‡ªèº«çš„è¡¨è¾¾èƒ½åŠ›ï¼ˆæˆ–è®¸å§ï¼‰ï¼Œå…¶ä¸‰æ˜¯å°†è¯»ä¹¦ç¬”è®°æ”¾åœ¨åšå®¢é‡Œå¯ä»¥é¿å…åœ¨æ±‚èŒçš„æ—¶å€™è¢«é¢è¯•å®˜åæ§½åšå®¢å†…å®¹å¤ªå°‘ï¼ˆç¬‘ï¼‰ï¼Œæ‰€ä»¥è¿˜æ˜¯å†³å®šå°†è¿™ç¯‡æ–‡ç« æ”¾åœ¨åšå®¢é‡Œã€‚</p><p>ä½†ä¸ç®¡æ€æ ·ï¼Œè¯»ä¹¦ç¬”è®°ç»ˆå½’æ˜¯è¯»ä¹¦ç¬”è®°ï¼Œå¯¹å…¶ä»–äººçš„ä½œç”¨è¿˜æ˜¯æœ‰é™ï¼Œå¦‚æœ‰è¯»è€…è§‰å¾—ç¢çœ¼çƒ¦è¯·æ— è§†ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« ä½¿ç”¨CPython3.6</p></blockquote><h1 id="å‡½æ•°è£…é¥°å™¨"><a href="#å‡½æ•°è£…é¥°å™¨" class="headerlink" title="å‡½æ•°è£…é¥°å™¨"></a>å‡½æ•°è£…é¥°å™¨</h1><p>å‡½æ•°è£…é¥°å™¨æ˜¯å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œå…¶å‚æ•°æ˜¯å¦ä¸€ä¸ªå‡½æ•°ï¼ˆè¢«è£…é¥°çš„å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è£…é¥°å™¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">deco</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running inner()&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> inner<br></code></pre></td></tr></table></figure><p>ç”¨æ³•ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œä¸‹é¢ä¸¤æ®µä»£ç æ•ˆæœä¸€æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@deco</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br><br>target = deco(target)<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¾‹å­å°±å¯ä»¥çœ‹å‡ºï¼Œè£…é¥°å™¨åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ã€‚å³ä½¿æ²¡æœ‰è¿™ä¸ªè¯­æ³•ç³–ï¼Œä¹Ÿåªæ˜¯åœ¨è¿›è¡Œç±»ä¼¼çš„æ“ä½œæ—¶éœ€è¦æ›´ç¹ççš„ä»£ç ï¼Œä½†ä¸ä¼šé€ æˆåŠŸèƒ½ä¸Šçš„ç¼ºå¤±ã€‚</p><p>æ—¢ç„¶ä¸Šé¢ä¸¤æ®µä»£ç æ•ˆæœä¸€æ ·ï¼Œé‚£è£…é¥°å™¨ä½•æ—¶è¿è¡Œå°±å¾ˆæ˜æ˜¾äº†ï¼š<strong>åœ¨è¢«è£…é¥°çš„å‡½æ•°å®šä¹‰ä¹‹åï¼ˆé€šå¸¸æ˜¯å‡½æ•°è¢«å¯¼å…¥æ—¶ï¼‰ç«‹å³è¿è¡Œ</strong>ã€‚æ¯•ç«Ÿï¼ŒçœŸæ­£è¢«å¯¼å…¥çš„ä¸æ˜¯<code>target()</code>ï¼Œè€Œæ˜¯<code>deco()</code>çš„è¿”å›å€¼ã€‚è€Œè¦è·å¾—<code>deco()</code>çš„è¿”å›å€¼ï¼Œå°±å¿…é¡»è®©<code>deco()</code>å…ˆè¿è¡Œã€‚</p><h1 id="å˜é‡ä½œç”¨åŸŸ"><a href="#å˜é‡ä½œç”¨åŸŸ" class="headerlink" title="å˜é‡ä½œç”¨åŸŸ"></a>å˜é‡ä½œç”¨åŸŸ</h1><p>ä¸‹é¢ä¸¤æ®µä»£ç æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-number">9</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f1</span>():<br>    <span class="hljs-built_in">print</span>(b)<br><br>f1()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-number">9</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f2</span>():<br>    <span class="hljs-built_in">print</span>(b)  <span class="hljs-comment"># UnboundLocalError: local variable &#x27;b&#x27; referenced before assignment</span><br>    b = <span class="hljs-number">3</span><br><br>f2()<br></code></pre></td></tr></table></figure><p>ç­”æ¡ˆæ˜¯åä¸€æ®µä»£ç åœ¨æ‰§è¡Œ<code>print(b)</code>æ—¶ä¼šæŠ›å‡º<code>UnboundLocalError</code>ã€‚å› ä¸ºåœ¨<code>f2()</code>ä¸­å˜é‡<code>b</code>è¢«èµ‹å€¼äº†ï¼ˆ<code>b = 3</code>ï¼‰ï¼Œäºæ˜¯Pythonåœ¨ç¼–è¯‘<code>f2()</code>çš„å®šä¹‰ä½“æ—¶å°†<code>b</code>è§†ä¸ºå±€éƒ¨å˜é‡ï¼Œè€Œä¸æ˜¯åƒ<code>f1()</code>é‚£æ ·åœ¨å…¨å±€å˜é‡é‡ŒæŸ¥æ‰¾<code>b</code>ã€‚å¦‚æœæƒ³è®©<code>f2()</code>ä¹Ÿå°†<code>b</code>è§†ä¸ºå…¨å±€å˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨<code>global</code>å…³é”®å­—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-number">9</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f1</span>():<br>    <span class="hljs-keyword">global</span> b<br>    <span class="hljs-built_in">print</span>(b)<br>    b = <span class="hljs-number">3</span><br><br>f1()  <span class="hljs-comment"># æ­£å¸¸è¿è¡Œ</span><br></code></pre></td></tr></table></figure><h1 id="é—­åŒ…"><a href="#é—­åŒ…" class="headerlink" title="é—­åŒ…"></a>é—­åŒ…</h1><p>ä¸ºä»€ä¹ˆä¼šçªç„¶æåˆ°å˜é‡ä½œç”¨åŸŸè¿™ä¸ªæ¦‚å¿µå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼ŒPythonä¸­çš„å±€éƒ¨å˜é‡åœ¨ç¦»å¼€ä½œç”¨åŸŸä¼šåè¢«GCï¼ˆåƒåœ¾å›æ”¶ï¼‰æœºåˆ¶é”€æ¯ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> weakref<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>():<br><span class="hljs-meta">... </span>    s = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))<br><span class="hljs-meta">... </span>    weakref.finalize(s, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;s has gone&#x27;</span>))<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>foo()<br>s has gone<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œ<code>foo()</code>è¿è¡Œå®Œæˆåï¼Œè¿è¡ŒæœŸé—´åˆ›å»ºçš„å˜é‡<code>s</code>è¢«é”€æ¯äº†ã€‚ä½†å¦‚æœæˆ‘ä»¬æƒ³åœ¨<code>foo()</code>å†…éƒ¨å†å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è®©è¿™ä¸ªå‡½æ•°èƒ½è®¿é—®å˜é‡<code>s</code>ï¼Œé‚£<code>s</code>å°±ä¸ä¼šè¢«é”€æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> weakref<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>():<br><span class="hljs-meta">... </span>    s = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))<br><span class="hljs-meta">... </span>    weakref.finalize(s, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;s has gone&#x27;</span>))<br>...<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bar</span>():<br><span class="hljs-meta">... </span>        <span class="hljs-built_in">print</span>(s)<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">return</span> bar<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bar = foo()<br><span class="hljs-meta">&gt;&gt;&gt; </span>bar()<br>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br></code></pre></td></tr></table></figure><p>åƒ<code>bar()</code>è¿™ç§<strong>å»¶ä¼¸äº†ä½œç”¨åŸŸçš„å‡½æ•°</strong>å«åš<strong>é—­åŒ…</strong>ï¼Œå®ƒèƒ½è®¿é—®ä¸åœ¨å®šä¹‰ä½“å†…å®šä¹‰çš„éå…¨å±€å˜é‡ã€‚ä»è¿™ç‚¹å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰åµŒå¥—å‡½æ•°æ‰æœ‰é—­åŒ…è¿™ä¸ªæ¦‚å¿µã€‚</p><p>å˜é‡<code>s</code>åœ¨<code>foo()</code>è¿è¡Œå‡½æ•°åå·²ç»æ˜¯å­¤é­‚é‡é¬¼ï¼Œè¢«ç§°ä½œè‡ªç”±å˜é‡ï¼ˆ<code>free variable</code>ï¼‰ã€‚ä½†<code>bar()</code>è¦èƒ½å¤Ÿè®¿é—®å˜é‡<code>s</code>ï¼Œå°±éœ€è¦æŒæœ‰å˜é‡<code>s</code>çš„å¼•ç”¨ï¼Œè¿™ç‚¹å¯ä»¥ä»<code>__code__</code>å±æ€§ï¼ˆç¼–è¯‘åçš„å‡½æ•°å®šä¹‰ä½“ï¼‰å’Œ<code>__closure__</code>å±æ€§ä¸­å¯ä»¥çœ‹å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bar.__code__.co_varnames  <span class="hljs-comment"># å±€éƒ¨å˜é‡</span><br>()<br><span class="hljs-meta">&gt;&gt;&gt; </span>bar.__code__.co_freevars  <span class="hljs-comment"># è‡ªç”±å˜é‡</span><br>(<span class="hljs-string">&#x27;s&#x27;</span>,)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bar.__closure__<br>(&lt;cell at ...: <span class="hljs-built_in">set</span> <span class="hljs-built_in">object</span> at ...&gt;,)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bar.__closure__[<span class="hljs-number">0</span>].cell_contents<br>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br></code></pre></td></tr></table></figure><h2 id="å±é™©åœ°å¸¦ï¼šè¢«åˆ é™¤çš„è‡ªç”±å˜é‡"><a href="#å±é™©åœ°å¸¦ï¼šè¢«åˆ é™¤çš„è‡ªç”±å˜é‡" class="headerlink" title="å±é™©åœ°å¸¦ï¼šè¢«åˆ é™¤çš„è‡ªç”±å˜é‡"></a>å±é™©åœ°å¸¦ï¼šè¢«åˆ é™¤çš„è‡ªç”±å˜é‡</h2><p>Pythonåœ¨ç¼–è¯‘<code>foo()</code>æ—¶å‘ç°<code>bar()</code>éœ€è¦è®¿é—®å˜é‡<code>s</code>ï¼Œäºæ˜¯å°†<code>s</code>è§†ä¸ºè‡ªç”±å˜é‡ï¼Œå³ä½¿ç¦»å¼€ä½œç”¨åŸŸä¹Ÿä¸ä¼šé”€æ¯ã€‚ä½†Pythonä¸æ˜¯é™æ€è¯­è¨€ï¼Œå¯¹è±¡çš„å®é™…çŠ¶æ€éœ€è¦ç­‰åˆ°è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>():<br>    s = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))<br>    weakref.finalize(s, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;s has gone&#x27;</span>))<br>    <span class="hljs-keyword">del</span> s         <span class="hljs-comment"># 1. è¾“å‡ºs has gone</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bar</span>():<br>        <span class="hljs-built_in">print</span>(s)  <span class="hljs-comment"># 4. NameError: free variable &#x27;s&#x27; referenced before assignment in enclosing scope</span><br><br>    <span class="hljs-keyword">return</span> bar<br><br><br>bar = foo()<br><span class="hljs-built_in">print</span>(bar.__code__.co_freevars)  <span class="hljs-comment"># 2. è¾“å‡º(&#x27;s&#x27;,)</span><br><span class="hljs-built_in">print</span>(bar.__closure__[<span class="hljs-number">0</span>])        <span class="hljs-comment"># 3. è¾“å‡º&lt;cell at ...: empty&gt;</span><br>bar()<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„æ‰§è¡Œé¡ºåºå’Œè¾“å‡ºç»“æœå·²ç»ä»¥æ³¨é‡Šçš„å½¢å¼é™„åŠ ã€‚Pythonåœ¨ç¼–è¯‘å®Œ<code>bar()</code>ä¹‹åçŸ¥é“åº”è¯¥å°†<code>s</code>è§†ä¸ºè‡ªç”±å˜é‡ï¼Œä½†å®é™…ä¸Š<code>bar()</code>åœ¨è¿è¡Œæ—¶å˜é‡<code>s</code>å·²ç»è¢«åˆ é™¤äº†â€¦â€¦è¿™ä¸ªä¾‹å­å‘Šè¯‰æˆ‘ä»¬ï¼ŒPythonçš„åŠ¨æ€ç‰¹æ€§æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œæ›´ç›´ç™½ç‚¹å°±æ˜¯ï¼šä¸è¦ä½œæ­».</p><h2 id="nonlocalå…³é”®å­—"><a href="#nonlocalå…³é”®å­—" class="headerlink" title="nonlocalå…³é”®å­—"></a>nonlocalå…³é”®å­—</h2><p>å†æ¥çœ‹çœ‹è¿™æ ·ä¸€ä¸ªè¿”å›å€¼ä¸º<code>ç»Ÿè®¡å¹³å‡å€¼çš„å‡½æ•°</code>çš„å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_averager</span>():<br>    nums = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">averager</span>(<span class="hljs-params">num: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        nums.append(num)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(nums) / <span class="hljs-built_in">len</span>(nums)<br><br>    <span class="hljs-keyword">return</span> averager<br><br>averager = make_averager()<br><span class="hljs-built_in">print</span>(averager(<span class="hljs-number">10</span>))  <span class="hljs-comment"># 10.0</span><br><span class="hljs-built_in">print</span>(averager(<span class="hljs-number">5</span>))  <span class="hljs-comment"># 7.5</span><br></code></pre></td></tr></table></figure><p>å—¯ï¼Œè¿è¡Œå¾ˆå®Œç¾ã€‚ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œè®©å®ƒä¸éœ€è¦å°†æ‰€æœ‰çš„æ•°å­—éƒ½ä¿å­˜èµ·æ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_averager</span>():<br>    total, count = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">averager</span>(<span class="hljs-params">num: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        total += num  <span class="hljs-comment"># UnboundLocalError</span><br>        count += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> total / count<br><br>    <span class="hljs-keyword">return</span> averager<br></code></pre></td></tr></table></figure><p>å’Œä¸Šä¸€èŠ‚çš„ç¬¬äºŒä¸ªä¾‹å­ç±»ä¼¼ï¼Œ<code>averager()</code>åœ¨è¿è¡Œæ—¶ä¼šæŠ›å‡º<code>UnboundLocalError</code>å¼‚å¸¸ã€‚ä½†è¿™æ¬¡ä¸èƒ½ç”¨<code>global</code>å…³é”®å­—æ¥è§£å†³è¿™ä¸ªå¼‚å¸¸äº†ï¼šå› ä¸º<code>total</code>å’Œ<code>num</code>å‹æ ¹å°±ä¸æ˜¯å…¨å±€å˜é‡ï¼Œè€Œæ˜¯ä½œç”¨åŸŸä»…é™<code>make_averager()</code>çš„å±€éƒ¨å˜é‡ã€‚é‚£æ€æ ·è®©<code>averager()</code>èƒ½ä¿®æ”¹<code>total</code>å’Œ<code>num</code>å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<code>nonlocal</code>å…³é”®å­—ã€‚å’Œ<code>global</code>å…³é”®å­—ç±»ä¼¼ï¼Œ<code>nonlocal</code>ä¼šå‘ŠçŸ¥Pythonï¼š<strong>è¿™ä¸ªå˜é‡åœ¨æ›´å¤–å±‚çš„ä½œç”¨åŸŸ</strong>ã€‚å¦‚ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_averager</span>():<br>    total, count = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">averager</span>(<span class="hljs-params">num: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">nonlocal</span> total, count<br>        total += num<br>        count += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> total / count  <span class="hljs-comment"># æ­£å¸¸è¿è¡Œ</span><br><br>    <span class="hljs-keyword">return</span> averager<br></code></pre></td></tr></table></figure><p>ä½†<code>nonlocal</code>å…³é”®å­—å¹¶ä¸èƒ½å–ä»£<code>global</code>å…³é”®å­—ï¼Œå› ä¸ºå±€éƒ¨å˜é‡ï¼ˆ<code>locals()</code>ï¼‰å’Œå…¨å±€å˜é‡ï¼ˆ<code>globals()</code>ï¼‰æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„ä»£ç ä¼šæŠ›å‡º<code>SyntaxError</code>ï¼Œå³ä½¿<code>f2()</code>å¹¶æ²¡æœ‰è¢«å®é™…æ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-number">9</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">f2</span>():<br>    <span class="hljs-keyword">nonlocal</span> b<br>    <span class="hljs-built_in">print</span>(b)<br>    b = <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶<code>nonlocal</code>å…³é”®å­—çš„å£°æ˜æ˜¯ä¸é™æ·±åº¦çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Pythonä¼šä¸€ç›´å‘æ›´å¤–å±‚çš„ä½œç”¨åŸŸå¯»æ‰¾è¿™ä¸ªå˜é‡ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚å¦‚ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_averager</span>():<br>    total, count = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">averager</span>(<span class="hljs-params">num: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">deeper</span>():<br>            <span class="hljs-keyword">nonlocal</span> total, count<br>            total += num<br>            count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> total / count  <span class="hljs-comment"># æ­£å¸¸è¿è¡Œ</span><br><br>        <span class="hljs-keyword">return</span> deeper()<br><br>    <span class="hljs-keyword">return</span> averager<br></code></pre></td></tr></table></figure><h1 id="è®¡æ—¶å‡½æ•°è£…é¥°å™¨"><a href="#è®¡æ—¶å‡½æ•°è£…é¥°å™¨" class="headerlink" title="è®¡æ—¶å‡½æ•°è£…é¥°å™¨"></a>è®¡æ—¶å‡½æ•°è£…é¥°å™¨</h1><p>äº†è§£äº†å‡½æ•°è£…é¥°å™¨ã€é—­åŒ…ç­‰æ¦‚å¿µåï¼Œå°±å¯ä»¥ç¼–å†™ä¸€ä¸ªç¨å¾®å…·æœ‰ä¸€ç‚¹å®ç”¨æ€§çš„å‡½æ•°è£…é¥°å™¨äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">clock</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        t0 = time.perf_counter()<br>        result = func(*args, **kwargs)<br>        elapsed = time.perf_counter() - t0<br>        fmt = <span class="hljs-string">&#x27;[&#123;elapsed:.4f&#125;s] &#123;func.__name__&#125;(&#123;args&#125;, &#123;kwargs&#125;): &#123;result&#125;&#x27;</span><br>        <span class="hljs-built_in">print</span>(fmt.<span class="hljs-built_in">format</span>(**<span class="hljs-built_in">locals</span>()))<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> inner<br></code></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œ<code>inner</code>å‡½æ•°å±äºé—­åŒ…å‡½æ•°ï¼Œ<code>func</code>å±äºè‡ªç”±å˜é‡ã€‚ä½¿ç”¨æ–¹æ³•å’Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@clock</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">snooze</span>(<span class="hljs-params">second: <span class="hljs-built_in">float</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;snooze doc&quot;&quot;&quot;</span><br>    time.sleep(second)<br><br>snooze(<span class="hljs-number">0.1</span>)  <span class="hljs-comment"># è¾“å‡ºï¼š[0.1001s] snooze((0.1,), &#123;&#125;): None</span><br></code></pre></td></tr></table></figure><h2 id="functool-wraps"><a href="#functool-wraps" class="headerlink" title="functool.wraps"></a>functool.wraps</h2><p>ä¸Šé¢è¿™ä¸ªè£…é¥°å™¨çš„ç¼ºç‚¹æ˜¯æ— æ³•ç»§æ‰¿è¢«è£…é¥°å‡½æ•°çš„å±æ€§ï¼ˆå¦‚<code>__name__</code>ã€<code>__doc__</code>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(snooze.__name__)  <span class="hljs-comment"># inner</span><br><span class="hljs-built_in">print</span>(snooze.__doc__)  <span class="hljs-comment"># inner doc</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦è¯·å‡ºPythonå†…ç½®çš„è£…é¥°å™¨<code>functool.wraps</code>äº†ï¼Œè¿™ä¸ªè£…é¥°å™¨ä¼šè‡ªåŠ¨å¤åˆ¶è¢«è£…é¥°å‡½æ•°çš„å±æ€§åˆ°è¿”å›å€¼å‡½æ•°é‡Œï¼ˆæ¢å¥è¯è¯´å°±æ˜¯è®©<code>inner()</code>æŒ‰ç›®æ ‡å‡½æ•°<code>snnoze()</code>çš„æ ·å­æ•´ä¸ªå®¹ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">clock</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br><span class="hljs-meta">    @functools.wraps(<span class="hljs-params">func</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># ... ç•¥</span><br>    <span class="hljs-keyword">return</span> inner<br><br><span class="hljs-meta">@clock</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">snooze</span>(<span class="hljs-params">second: <span class="hljs-built_in">float</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;snooze doc&quot;&quot;&quot;</span><br>    time.sleep(second<br><br><span class="hljs-built_in">print</span>(snooze.__name__)  <span class="hljs-comment"># snooze</span><br><span class="hljs-built_in">print</span>(snooze.__doc__)  <span class="hljs-comment"># snooze doc</span><br></code></pre></td></tr></table></figure><h1 id="å¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨"><a href="#å¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨" class="headerlink" title="å¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨"></a>å¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨</h1><p>ä¸ŠèŠ‚æåˆ°çš„<code>functool.wraps</code>è£…é¥°å™¨æ¯”è¾ƒç‰¹åˆ«ï¼Œè¿™ä¸ªè£…é¥°å™¨å¯ä»¥ä¼ å…¥å‚æ•°ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºä¸å¸¦å‚æ•°çš„è£…é¥°å™¨ï¼Œä¸‹é¢ä¸¤æ®µä»£ç æ˜¯ç›¸ç­‰çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@deco</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br><br>target = deco(target)<br></code></pre></td></tr></table></figure><p>è€Œå¯¹äºå¸¦å‚æ•°çš„è£…é¥°å™¨ï¼Œä¸‹é¢ä¸¤æ®µä»£ç ä¹Ÿæ˜¯ç›¸ç­‰çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@deco(<span class="hljs-params"><span class="hljs-number">123</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;running target()&#x27;</span>)<br><br>target = deco(<span class="hljs-number">123</span>)(target)<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œè£…é¥°å™¨å¸¦ä¸å¸¦å‚æ•°ï¼Œå†³å®šäº†æ˜¯ç”¨è¿™ä¸ªå‡½æ•°æœ¬èº«æ¥å½“è£…é¥°å™¨ï¼Œè¿˜æ˜¯ç”¨å‡½æ•°çš„è¿”å›å€¼æ¥å½“è£…é¥°å™¨ï¼ˆå¯èƒ½æœ‰ç‚¹ç»•ï¼‰ã€‚ç”¨è¿™ä¸ªæ€è·¯æ”¹è¿›ä¸€ä¸‹å‰é¢æåˆ°çš„å‡½æ•°è®¡æ—¶è£…é¥°å™¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">DEFAULT_FMT = <span class="hljs-string">&#x27;[&#123;elapsed:.4f&#125;s] &#123;func.__name__&#125;(&#123;args&#125;, &#123;kwargs&#125;): &#123;result&#125;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clock_plus</span>(<span class="hljs-params">fmt=DEFAULT_FMT</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clock</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">*args, **kwargs</span>):<br>            <span class="hljs-string">&quot;&quot;&quot;inner doc&quot;&quot;&quot;</span><br>            t0 = time.perf_counter()<br>            result = func(*args, **kwargs)<br>            elapsed = time.perf_counter() - t0<br>            <span class="hljs-built_in">print</span>(fmt.<span class="hljs-built_in">format</span>(**<span class="hljs-built_in">locals</span>()))<br>            <span class="hljs-keyword">return</span> result<br><br>        <span class="hljs-keyword">return</span> inner<br>    <span class="hljs-keyword">return</span> clock<br></code></pre></td></tr></table></figure><p>ç”¨æ³•å’Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@clock_plus(<span class="hljs-params">fmt=<span class="hljs-string">&#x27;&#123;elapsed:.4f&#125;&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">snooze</span>(<span class="hljs-params">second: <span class="hljs-built_in">float</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;snooze doc&quot;&quot;&quot;</span><br>    time.sleep(second)<br><br>snooze(<span class="hljs-number">0.1</span>)  <span class="hljs-comment"># è¾“å‡ºï¼š0.1001</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¸¦å‚æ•°çš„å‡½æ•°è£…é¥°å™¨åªæ˜¯åœ¨ä¸å¸¦å‡½æ•°çš„è£…é¥°å™¨å¤–é¢è£¹äº†ä¸€å±‚ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šé­”æœ¯æ“ä½œã€‚</p><h1 id="å°¾å£°"><a href="#å°¾å£°" class="headerlink" title="å°¾å£°"></a>å°¾å£°</h1><p>ã€Šæµç•…çš„Pythonã€‹ç¬¬ä¸ƒç« ï¼ˆå‡½æ•°è£…é¥°å™¨å’Œé—­åŒ…ï¼‰çš„æ¦‚å¿µä¸ç®—å°‘ï¼ŒåŒæ—¶ç¬”è€…ä¹Ÿæ²¡èƒ½åœ¨æå–å…³é”®ä¿¡æ¯çš„åŸºç¡€ä¸Šæ§åˆ¶å¥½ç¯‡å¹…ï¼Œå†åŠ ä¸Šæ–‡ç« é‡Œè¿˜æœ‰ç¬”è€…çš„ä¸€äº›ä¸ªäººç†è§£ï¼Œæ‰€ä»¥æ–‡ç« æœ€ååªèƒ½è‰è‰æ”¶å°¾ï¼Œæ²¡æœ‰ä»‹ç»å æ”¾è£…é¥°å™¨ã€<code>functools.lru_cache</code>ç­‰å†…å®¹ã€‚</p><p>ä¹Ÿè®¸åœ¨è¯»å®Œè¿™ç±»ä¹¦ç±åï¼Œç”»ä¸€ä¸ªæ€ç»´å¯¼å›¾ï¼Œæˆ–å•çº¯å†™ä¸€ç¯‡ç»™è‡ªå·±çœ‹çš„ç¬”è®°æ‰æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œè‡³å°‘ä¸ä¼šåœ¨åšå®¢é‡Œä¸¢äººï¼ˆé€ƒ</p>]]></content>
    
    
    
    <tags>
      
      <tag>æµç•…çš„Python</tag>
      
      <tag>è¯»ä¹¦ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•åœ¨Pythonä¸­å¼•èµ·å†…å­˜æ³„éœ²</title>
    <link href="/2020/06/14/%E5%A6%82%E4%BD%95%E5%9C%A8Python%E4%B8%AD%E5%BC%95%E8%B5%B7%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/"/>
    <url>/2020/06/14/%E5%A6%82%E4%BD%95%E5%9C%A8Python%E4%B8%AD%E5%BC%95%E8%B5%B7%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2020/06/14/gc.jpg"></p><p>å—¯ï¼Œæ€ä¹ˆçœ‹æ€ä¹ˆåƒæ ‡é¢˜å…šå†™çš„æ ‡é¢˜â€¦â€¦å…¶å®è¿™ç¯‡æ–‡ç« åªæ˜¯ç¬”è€…å¯¹Pythonä¸­å¼•ç”¨è®¡æ•°ã€å¼±å¼•ç”¨çš„ä¸€äº›è®°å½•å’Œæ€è€ƒï¼Œä¸æ¶‰åŠå¼•ç”¨å¾ªç¯ã€åˆ†ä»£å›æ”¶ç­‰æ¦‚å¿µï¼Œå…ˆæ‰“ä¸ªé¢„é˜²é’ˆã€‚</p><blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« åŸºäºCPython 3.6ï¼Œå¯èƒ½ä¸é€‚ç”¨äºå…¶å®ƒCPythonç‰ˆæœ¬æˆ–å…¶å®ƒç±»å‹çš„Pythonå®ç°ã€‚</p></blockquote><h1 id="å¼•ç”¨è®¡æ•°"><a href="#å¼•ç”¨è®¡æ•°" class="headerlink" title="å¼•ç”¨è®¡æ•°"></a>å¼•ç”¨è®¡æ•°</h1><p><strong>å¼•ç”¨è®¡æ•°</strong>ï¼ˆReference countingï¼‰å¯ä»¥è¯´æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œç‚’å†·é¥­ä¹Ÿæ²¡å•¥æ„æ€ã€‚å¼•ç”¨ä¸€ä¸‹ã€Šæµç•…çš„Pythonã€‹é‡Œçš„æè¿°ï¼š<em>â€œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šç»Ÿè®¡æœ‰å¤šå°‘å¼•ç”¨æŒ‡å‘è‡ªå·±ã€‚å½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ï¼Œå¯¹è±¡ç«‹å³å°±è¢«é”€æ¯â€</em>ã€‚å¼•ç”¨è®¡æ•°åœ¨ä¸å­˜åœ¨<strong>å¼•ç”¨å¾ªç¯</strong>ï¼ˆReference cycleï¼‰æ—¶èƒ½å¤ŸåŠæ—¶æ¸…ç†å†…å­˜ï¼Œè¿™ä¹Ÿæ˜¯CPythonæœ€ä¸»è¦çš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> sys<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> weakref<br><span class="hljs-meta">&gt;&gt;&gt; </span>s1 = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span>sys.getrefcount(s1)<br><span class="hljs-number">2</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>s2 = s1<br><span class="hljs-meta">&gt;&gt;&gt; </span>s2 <span class="hljs-keyword">is</span> s1<br><span class="hljs-literal">True</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>sys.getrefcount(s1)<br><span class="hljs-number">3</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>weakref.finalize(s1, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;obj has gone&quot;</span>))<br>&lt;finalize <span class="hljs-built_in">object</span> at ...; <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;set&#x27;</span> at ...&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">del</span> s2<br><span class="hljs-meta">&gt;&gt;&gt; </span>sys.getrefcount(s1)<br><span class="hljs-number">2</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">del</span> s1<br>obj has gone<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œ<code>set(range(3))</code>è¿™ä¸ªå¯¹è±¡æ€»å…±æœ‰ä¸¤ä¸ªå¼•ç”¨ï¼š<code>s1</code>å’Œ<code>s2</code>ï¼Œåªæœ‰å½“è¿™ä¸¤ä¸ªå¼•ç”¨éƒ½æ— æ•ˆï¼ˆ<code>del s2</code>ã€<code>del s1</code>ï¼‰ä¹‹åï¼Œè¿™ä¸ªå¯¹è±¡æ‰ä¼šè¢«é”€æ¯ï¼ˆæˆ–è€…è¯´å ç”¨çš„å†…å­˜ç©ºé—´è¢«å›æ”¶ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>sys.getrefcount()</code>è¿”å›çš„å€¼ä¼šæ¯”çœŸå®å¼•ç”¨è®¡æ•°å€¼é«˜å‡º1ï¼Œå› ä¸ºå‚æ•°ä¼ é€’ä¼šï¼ˆä¸´æ—¶ï¼‰å¢åŠ ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¦è§<a href="https://docs.python.org/3.6/library/sys.html#sys.getrefcount">å®˜æ–¹æ–‡æ¡£</a>ã€‚åŒæ—¶ï¼Œç¬”è€…ç”¨åˆ°äº†<code>weakref.finalize()</code>æ–¹æ³•æ¥ç¡®è®¤å¯¹è±¡æ˜¯å¦è¢«é”€æ¯ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘çš„å¯¹è±¡è¢«é”€æ¯æ—¶è°ƒç”¨ç¬¬äºŒä¸ªå‚æ•°ï¼ˆä¸€ä¸ª<code>Callable</code>å¯¹è±¡ï¼‰ã€‚</p><h1 id="å¦‚ä½•å¼•èµ·å†…å­˜æ³„éœ²"><a href="#å¦‚ä½•å¼•èµ·å†…å­˜æ³„éœ²" class="headerlink" title="å¦‚ä½•å¼•èµ·å†…å­˜æ³„éœ²"></a>å¦‚ä½•å¼•èµ·å†…å­˜æ³„éœ²</h1><p>å‰é¢æåˆ°ï¼Œå¼•ç”¨è®¡æ•°åœ¨ä¸å­˜åœ¨å¼•ç”¨å¾ªç¯æ—¶èƒ½åŠæ—¶æ¸…ç†å†…å­˜ï¼Œä½†è¿™å¹¶ä¸èƒ½ä»£è¡¨ç¨‹åºå‘˜å°±èƒ½é«˜æ•æ— å¿§äº†ã€‚æ¯•ç«Ÿï¼Œè¢«é—å¿˜çš„å¼•ç”¨ä¹Ÿæ˜¯å¼•ç”¨ã€‚è€ƒè™‘ä¸‹é¢è¿™ä¸ªå¯ä»¥è¿½è¸ªå½“å‰å®ä¾‹çš„ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOBJ</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    __instances = <span class="hljs-built_in">set</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span></span>):<br>        self.name = name<br>        self.__instances.add(self)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;MyOBJ(&#x27;<span class="hljs-subst">&#123;self.name&#125;</span>&#x27;)&quot;</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">instances</span>(<span class="hljs-params">cls</span>):<br>        <span class="hljs-keyword">return</span> cls.__instances<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>obj1 = MyOBJ(<span class="hljs-string">&quot;obj1&quot;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>weakref.finalize(obj1, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;obj1 has gone&quot;</span>))<br>&lt;finalize <span class="hljs-built_in">object</span> at ...; <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;MyOBJ&#x27;</span> at ...&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">del</span> obj1<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">len</span>(MyOBJ.instances())<br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿é€šè¿‡<code>del obj1</code>å°†å¯¹è±¡çš„å¼•ç”¨åˆ é™¤ï¼Œä½†ç”±äº<code>MyOBJ</code>è¿™ä¸ªç±»çš„<code>__instances</code>å±æ€§é‡Œå§‹ç»ˆæŒæœ‰<code>obj1</code>å¯¹åº”å¯¹è±¡çš„å¦ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªå¯¹è±¡å§‹ç»ˆæ— æ³•è¢«é”€æ¯ã€‚å¦‚æœä¸èƒ½å°†<code>__instances</code>é‡Œçš„å¼•ç”¨ä¹Ÿåˆ é™¤ï¼Œå°±ä¼šå¼•èµ·å†…å­˜æ³„éœ²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>MyOBJ.instances().pop()<br>MyOBJ(<span class="hljs-string">&#x27;obj1&#x27;</span>)<br>obj1 has gone<br></code></pre></td></tr></table></figure><h1 id="å¼±å¼•ç”¨ï¼ˆweakrefï¼‰"><a href="#å¼±å¼•ç”¨ï¼ˆweakrefï¼‰" class="headerlink" title="å¼±å¼•ç”¨ï¼ˆweakrefï¼‰"></a>å¼±å¼•ç”¨ï¼ˆweakrefï¼‰</h1><p>å¯èƒ½ä»ç¬¬ä¸€ä¸ªä¾‹å­é‡Œå°±æœ‰è¯»è€…å¥‡æ€ªï¼š<code>weakref.finalize()</code>ä¼šåœ¨å¯¹è±¡è¢«é”€æ¯æ—¶æ‰§è¡ŒåŠ¨ä½œï¼ŒæŒ‰ç†è¯´ä¹Ÿåº”è¯¥æŒæœ‰è¯¥å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨æ‰å¯¹ï¼Œè¿™ä¸å°±äº§ç”ŸçŸ›ç›¾äº†å—ï¼Ÿå®é™…ä¸Š<code>weakref</code>è¿™ä¸ªæ¨¡å—åå°±ç»™å‡ºäº†è¯´æ˜ï¼š<strong>å¼±å¼•ç”¨</strong>ï¼ˆweakrefï¼‰æŒ‡ä¸å¢åŠ å¯¹è±¡å¼•ç”¨è®¡æ•°çš„å¼•ç”¨ã€‚äºæ˜¯ï¼Œ<code>weakref.finalize()</code>è‡ªç„¶ä¹Ÿå°±ä¸ä¼šå¦¨ç¢å¯¹è±¡è¢«é”€æ¯äº†ã€‚</p><p>åŒæ ·çš„ï¼Œä¸Šä¸€èŠ‚æåˆ°çš„å†…å­˜æ³„éœ²é—®é¢˜ä¹Ÿå¯ä»¥é€šè¿‡<code>weakref</code>æ¨¡å—æä¾›çš„åŠŸèƒ½è§£å†³ã€‚åªéœ€è¦å°†<code>MyOBJ</code>é‡Œ<code>__instances</code>çš„ç±»å‹æ”¹ä¸º<code>WeakSet</code>å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOBJ</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    __instances = weakref.WeakSet()<br>    <br>    <span class="hljs-comment"># ... çœç•¥</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>obj1 = MyOBJ(<span class="hljs-string">&quot;obj1&quot;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>weakref.finalize(obj1, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;obj1 has gone&quot;</span>))<br>&lt;finalize <span class="hljs-built_in">object</span> at ...; <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;MyOBJ&#x27;</span> at ...&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">len</span>(MyOBJ.instances())<br><span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">del</span> obj1<br>obj1 has gone<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">len</span>(MyOBJ.instances())<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>åœ¨å¼•å…¥äº†<code>WeakSet</code>åï¼Œ<code>__instances</code>å±æ€§æŒæœ‰çš„å¼•ç”¨éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œå½“å®é™…çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶æœºåˆ¶é”€æ¯æ—¶ï¼Œ<code>__instances</code>å±æ€§é‡Œçš„å¼•ç”¨ä¹Ÿä¼šè·Ÿç€è¢«åˆ é™¤ã€‚ç±»ä¼¼çš„æ•°æ®ç»“æ„è¿˜æœ‰<code>WeakKeyDictionary</code>ã€<code>WeakValueDictionary</code>ï¼Œå®ƒä»¬ä¼šå°†å¯¹è±¡çš„å¼•ç”¨åˆ†åˆ«å½“æˆå­—å…¸çš„é”®å’Œå€¼ï¼Œæ›´å…·ä½“çš„è¯´æ˜å¯ä»¥å‚è€ƒ<a href="https://docs.python.org/3.6/library/weakref.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h1 id="å»¶ä¼¸"><a href="#å»¶ä¼¸" class="headerlink" title="å»¶ä¼¸"></a>å»¶ä¼¸</h1><p>å®é™…ä¸Šæœ¬æ–‡åªæ¶‰åŠPythonå†…å­˜ç®¡ç†ä¸­æœ€åŸºæœ¬çš„ä¸€äº›æ¦‚å¿µã€‚å…³äºå¼•ç”¨å¾ªç¯ã€åˆ†ä»£å›æ”¶ç­‰æ¦‚å¿µï¼Œæ¨èé˜…è¯»ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><a href="https://github.com/python/cpython/blob/3.6/Modules/gcmodule.c#L899">cpython&#x2F;gcmodule.c at 3.6 Â· python&#x2F;cpython</a></li><li><a href="https://pythoninternal.wordpress.com/2014/08/04/the-garbage-collector/">The Garbage Collector | Yet Another Python Internals Blog</a></li><li><a href="https://www.quora.com/How-does-garbage-collection-in-Python-work-What-are-the-pros-and-cons">How does garbage collection in Python work? What are the pros and cons? - Quora</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>GC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•é«˜æ•ˆåœ°å¯¹100ä¸‡ä¸ªUUIDè¿›è¡Œå‰ç¼€åŒ¹é…æŸ¥è¯¢</title>
    <link href="/2020/06/13/%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E5%9C%B0%E5%AF%B9100%E4%B8%87%E4%B8%AAUUID%E8%BF%9B%E8%A1%8C%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2/"/>
    <url>/2020/06/13/%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E5%9C%B0%E5%AF%B9100%E4%B8%87%E4%B8%AAUUID%E8%BF%9B%E8%A1%8C%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2020/06/13/redis-logo.png"></p><p>åœ¨ã€ŠRediså®æˆ˜ã€‹è¿™æœ¬ä¹¦çš„ç¬¬å…­ç« ä¸­ï¼Œä½œè€…ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Redisçš„ZSETæ¥å®ç°é€šè®¯å½•è‡ªåŠ¨è¡¥å…¨ï¼ˆå³å‰ç¼€åŒ¹é…æŸ¥è¯¢ï¼‰ã€‚è¿™éƒ¨åˆ†å†…å®¹æ¿€å‘äº†æˆ‘çš„å…´è¶£ï¼Œäºæ˜¯æˆ‘å€ŸåŠ©è¿™ä¸ªæœºä¼šæŠ›å‡ºé—®é¢˜ï¼šå¦‚ä½•é«˜æ•ˆåœ°å¯¹100ä¸‡ä¸ªUUIDè¿›è¡Œå‰ç¼€åŒ¹é…ï¼Œå¹¶å°è¯•ç”¨è¿™ç¯‡æ–‡ç« æ¥è§£ç­”ã€‚</p><h1 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h1><p>é¦–å…ˆæ˜¯æ•°æ®å‡†å¤‡å·¥ä½œï¼šç”Ÿæˆ100ä¸‡ä¸ªUUIDã€å°†å…¶å†™å…¥è‡³Rediså’ŒMariaDBï¼ˆåè€…å¯ä½œä¸ºå¯¹æ¯”ï¼‰ã€‚é¡ºä¾¿ä¸€æï¼ŒRediså’ŒMariaDBå‡åœ¨ç¬”è€…ç”µè„‘ä¸Šé€šè¿‡Dockeréƒ¨ç½²ï¼Œç‰ˆæœ¬åˆ†åˆ«ä¸ºRedis 6.0å’ŒMariaDB 10.4ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-comment"># ç”Ÿæˆ100ä¸‡ä¸ªUUID</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;0..999999&#125;; <span class="hljs-keyword">do</span> uuidgen; <span class="hljs-keyword">done</span> &gt; uuids_1m.txt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">du</span> uuids_1m.txt -h</span><br>36Muuids_1m.txt<br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">head</span> -n2 uuid_1m.txt</span><br>25e2cc59-b117-4961-9bc6-a63c5b1770db<br>e9f833b9-630d-47cb-b2ae-69c6d1bc2bde<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">redis&gt; </span><span class="language-bash">zcount uuids -inf +inf</span><br>(integer) 1000000<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"># MariaDBè¡¨ç»“æ„ï¼Œåœ¨uuidå­—æ®µåŠ äº†ç´¢å¼•<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> uuids (<br>    id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key auto_increment,<br>    uuid <span class="hljs-type">char</span>(<span class="hljs-number">36</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    key idx_uuid (uuid)<br>);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> uuids;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">1000000</span>  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br>mariadb<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> table_name, data_length, index_length <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;uuids&#x27;</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------+-------------+--------------+</span><br><span class="hljs-operator">|</span> table_name <span class="hljs-operator">|</span> data_length <span class="hljs-operator">|</span> index_length <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------+-------------+--------------+</span><br><span class="hljs-operator">|</span> uuids      <span class="hljs-operator">|</span> <span class="hljs-number">64569344</span>    <span class="hljs-operator">|</span> <span class="hljs-number">78397440</span>     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------+-------------+--------------+</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ’å…¥100ä¸‡æ¡UUIDæ•°æ®åï¼ŒMariaDBæ•°æ®è¡¨çš„å¤§å°è¶…è¿‡äº†60MBï¼Œç´¢å¼•çš„å¤§å°è¶…è¿‡äº†70MBã€‚åŒæ—¶ï¼Œæ•°æ®å‡†å¤‡å®Œæˆåï¼ŒRediså’ŒMariaDBçš„å†…å­˜å ç”¨ä»åˆšéƒ¨ç½²æ—¶çš„5Må’Œ80Mä¸Šå‡è‡³äº†120Må’Œ270Mã€‚</p><h1 id="Pythonéå†æŸ¥è¯¢"><a href="#Pythonéå†æŸ¥è¯¢" class="headerlink" title="Pythonéå†æŸ¥è¯¢"></a>Pythonéå†æŸ¥è¯¢</h1><p>æ•°æ®å‡†å¤‡å®Œæˆåï¼Œä¸‹é¢è¦åšçš„å°±æ˜¯è¿›è¡Œå‰ç¼€åŒ¹é…æŸ¥è¯¢ã€‚æœ€ç›´æ¥çš„æ–¹å¼åº”è¯¥æ˜¯éå†æŸ¥è¯¢äº†ï¼Œå®ç°èµ·æ¥ä¹Ÿç®€å•ï¼Œä½†<code>O(n)</code>çš„æ—¶é—´å¤æ‚å®åœ¨æ˜¯è®©äººä¸æ•¢æ­ç»´ï¼Œä»£ç è´´å‡ºæ¥æƒå½“æ¶ˆé£ã€‚</p><p>ä¸ºäº†æ›´ç¬¦åˆå‰ç¼€åŒ¹é…æŸ¥è¯¢çš„å®šä¹‰ï¼Œæˆ‘åœ¨è¯»å–å®ŒUUIDåè¿˜ä¼šå¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡æ’åºæ“ä½œï¼Œè€Œè¿™ä¸ªæ’åºçš„æ—¶é—´æ¶ˆè€—æ˜¯ä¸ä¼šè¢«ç»Ÿè®¡åˆ°åç»­çš„æ€§èƒ½å¯¹æ¯”ä¸­çš„ï¼Œè¿™å¯¹ä¸‹ä¸€èŠ‚çš„äºŒåˆ†æŸ¥è¯¢åŒæ ·é€‚ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">uuids = []<br><span class="hljs-comment"># .. è¯»å–uuid</span><br>uuids.sort()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">traverse</span>(<span class="hljs-params">prefix: <span class="hljs-built_in">str</span>, limit=<span class="hljs-number">10</span></span>):<br>    start = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> start &lt; <span class="hljs-built_in">len</span>(uuids) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> uuids[start].startswith(prefix):<br>        start += <span class="hljs-number">1</span><br>    ans = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, <span class="hljs-built_in">min</span>(start + limit, <span class="hljs-built_in">len</span>(uuids))):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> uuids[i].startswith(prefix):<br>            <span class="hljs-keyword">break</span><br>        ans.append(uuids[i])<br>    <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><h1 id="PythonäºŒåˆ†æŸ¥è¯¢"><a href="#PythonäºŒåˆ†æŸ¥è¯¢" class="headerlink" title="PythonäºŒåˆ†æŸ¥è¯¢"></a>PythonäºŒåˆ†æŸ¥è¯¢</h1><p>éå†æŸ¥è¯¢æœ€å¤§çš„é—®é¢˜åœ¨äºå…¶<code>O(n)</code>çš„æ—¶é—´å¤æ‚åº¦ã€‚ä½†åªè¦ç›®æ ‡æ•°æ®æ˜¯æœ‰åºçš„ï¼Œé‚£å°±åˆ°æ—¶é—´å¤æ‚åº¦åªæœ‰<code>O(log n)</code>çš„äºŒåˆ†æŸ¥è¯¢ä¸Šåœºçš„æ—¶å€™äº†ã€‚å¯¹äºå‰ç¼€åŒ¹é…æŸ¥è¯¢æ¥è¯´ï¼ŒæŸ¥è¯¢ä»¥<code>abcd</code>å¼€å¤´çš„å­—ç¬¦ä¸²ï¼Œæœ¬è´¨ä¸Šæ˜¯æŸ¥è¯¢æ¯”<code>abcczzzz...</code>å¤§çš„å­—ç¬¦ä¸²ã€‚è€Œåœ¨ä»£ç ä¸­ï¼Œæˆ‘ç”¨<code>0xffff</code>è¿™ä¸ªè¾¹ç•Œç¬¦å·æ¥ä»£æ›¿å‰æ–‡æåˆ°çš„é‚£ä¸€ä¸²<code>zzzz....</code>ï¼Œè¿™å¯¹UUIDè¿™ç§ä¸è¶…è¿‡ASCIIç èŒƒå›´çš„å­—ç¬¦ä¸²æ¥è¯´å·²ç»è¶³å¤Ÿäº†ã€‚</p><p>åŒæ—¶ï¼Œä»£ç é‡ŒäºŒåˆ†æŸ¥æ‰¾çš„ç»“æœï¼ˆ<code>start</code>ï¼‰æ˜¯ç¬¬ä¸€ä¸ªå¤§äºè¦æ‰¾çš„å­—ç¬¦ä¸²çš„å…ƒç´ çš„ä¸‹æ ‡ï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">bin_search</span>(<span class="hljs-params">prefix: <span class="hljs-built_in">str</span>, limit=<span class="hljs-number">10</span></span>):<br>    target = prefix[:-<span class="hljs-number">1</span>] + <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(prefix[-<span class="hljs-number">1</span>]) - <span class="hljs-number">1</span>) + <span class="hljs-built_in">chr</span>(<span class="hljs-number">0xffff</span>)<br>    left, right = <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(uuids) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> left &lt;= right:<br>        mid = (left + right) // <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> uuids[mid] == target:<br>            start = left + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">elif</span> uuids[mid] &lt; target:<br>            left = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            right = mid - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        start = left<br>    ans = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, <span class="hljs-built_in">min</span>(start + limit, <span class="hljs-built_in">len</span>(uuids))):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> uuids[i].startswith(prefix):<br>            <span class="hljs-keyword">break</span><br>        ans.append(uuids[i])<br>    <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><h1 id="Redis-ZSETæŸ¥è¯¢"><a href="#Redis-ZSETæŸ¥è¯¢" class="headerlink" title="Redis+ZSETæŸ¥è¯¢"></a>Redis+ZSETæŸ¥è¯¢</h1><p>Redis+ZSETæŸ¥è¯¢çš„åŸç†å’ŒäºŒåˆ†æŸ¥è¯¢åŸç†çš„ç±»ä¼¼ã€‚Redisä¸­çš„ZSETé»˜è®¤ä¼šæŒ‰ç…§å…ƒç´ çš„åˆ†å€¼è¿›è¡Œæ’åºï¼Œä½†å¦‚æœä¸¤ä¸ªå…ƒç´ çš„åˆ†å€¼ä¸€è‡´ï¼Œé‚£å°±æŒ‰å…ƒç´ æœ¬èº«æ’åºã€‚æ¢è¨€ä¹‹ï¼Œåœ¨ZSETé‡Œå­˜æ”¾å¤šä¸ªåˆ†å€¼ä¸€è‡´çš„UUIDï¼Œä»ä¸­ä»»æ„å–å‡ºä¸€æ®µUUIDï¼Œè¿™äº›UUIDå¿…ç„¶æ˜¯æœ‰åºçš„ã€‚</p><p>è€Œä¸ºäº†è¿›è¡Œå‰ç¼€åŒ¹é…æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ZSETé‡Œæ’å…¥ä¸¤ä¸ªè¾¹ç•Œå…ƒç´ ï¼Œç”¨æ¥æ ‡ç¤ºå¼€å§‹å’Œç»“æŸã€‚å¯¹äºå‰ç¼€<code>abcd</code>æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªè¾¹ç•Œå…ƒç´ å°±æ˜¯<code>abcc0xffff</code>å’Œ<code>abcd0xffff</code>ï¼ŒZSETé‡Œè¿™ä¸¤ä¸ªè¾¹ç•Œå…ƒç´ ä¹‹é—´çš„æ•°æ®å°±æ˜¯æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢çš„ç»“æœã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_zset</span>(<span class="hljs-params">prefix: <span class="hljs-built_in">str</span>, limit=<span class="hljs-number">10</span></span>):<br>    identifier = <span class="hljs-built_in">str</span>(uuid4())<br>    start = prefix[:-<span class="hljs-number">1</span>] + <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(prefix[-<span class="hljs-number">1</span>]) - <span class="hljs-number">1</span>)<br>    start += <span class="hljs-built_in">chr</span>(<span class="hljs-number">0xffff</span>) + identifier<br>    end = prefix + <span class="hljs-built_in">chr</span>(<span class="hljs-number">0xffff</span>) + identifier<br>    conn.zadd(<span class="hljs-string">&quot;uuids&quot;</span>, &#123;start: <span class="hljs-number">0</span>, end: <span class="hljs-number">0</span>&#125;)  <span class="hljs-comment"># æ‰€æœ‰UUIDçš„åˆ†å€¼éƒ½æ˜¯0</span><br>    si = conn.zrank(<span class="hljs-string">&quot;uuids&quot;</span>, start) + <span class="hljs-number">1</span><br>    ei = conn.zrank(<span class="hljs-string">&quot;uuids&quot;</span>, end) - <span class="hljs-number">1</span><br>    ei = <span class="hljs-built_in">min</span>(si + limit - <span class="hljs-number">1</span>, ei)<br>    pipe = conn.pipeline()<br>    pipe.zrange(<span class="hljs-string">&quot;uuids&quot;</span>, si, ei)<br>    pipe.zrem(<span class="hljs-string">&quot;uuids&quot;</span>, start, end)<br>    zr = pipe.execute()[<span class="hljs-number">0</span>]  <span class="hljs-comment"># type: <span class="hljs-type">List</span>[<span class="hljs-built_in">bytes</span>]</span><br>    ans = [uuid.decode(<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">for</span> uuid <span class="hljs-keyword">in</span> zr]<br>    <span class="hljs-keyword">return</span> [uuid <span class="hljs-keyword">for</span> uuid <span class="hljs-keyword">in</span> ans <span class="hljs-keyword">if</span> <span class="hljs-built_in">chr</span>(<span class="hljs-number">0xffff</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> uuid]<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥è¯¢è¿‡ç¨‹è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼šè¦å…ˆæ’å…¥è¾¹ç•Œå…ƒç´ ï¼Œå†æ‰¾å‡ºä¸¤ä¸ªè¾¹ç•Œå…ƒç´ çš„ä½ç½®ï¼Œå†ç”¨è¾¹ç•Œå…ƒç´ çš„ä½ç½®è·å–æŸ¥è¯¢ç»“æœã€‚è€Œä¸”ç”±äºè¿‡ç¨‹å¤æ‚ï¼Œè¿™ç§æ–¹æ³•å®é™…çš„æ€§èƒ½è¡¨ç°å¹¶ä¸èƒ½è®©äººæ»¡æ„ï¼Œè¿™ä¸ªä¹‹åå†åˆ†æã€‚</p><blockquote><p>è¿™æ®µä»£ç æœ‰å¾ˆå¤§çš„éšæ‚£ï¼šæ²¡æœ‰è€ƒè™‘å¤šä¸ªæŸ¥è¯¢åŒæ—¶æ‰§è¡Œçš„æƒ…å†µã€‚æ›´å®Œå–„çš„å®ç°è¯·å‚è€ƒã€ŠRediså®æˆ˜ã€‹ç¬¬å…­ç« ï¼šä½¿ç”¨Redisæ„å»ºåº”ç”¨ç¨‹åºç»„ä»¶</p></blockquote><h1 id="MariaDB-LikeæŸ¥è¯¢"><a href="#MariaDB-LikeæŸ¥è¯¢" class="headerlink" title="MariaDB+LikeæŸ¥è¯¢"></a>MariaDB+LikeæŸ¥è¯¢</h1><p>æœ€åä»‹ç»ä¸€ç§ç®€å•ç²—æš´çš„æŸ¥è¯¢æ–¹æ³•ï¼šMariaDB+LikeæŸ¥è¯¢ï¼Œä¸€æ¡SQLè§£å†³ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">mysql_like</span>(<span class="hljs-params">prefix: <span class="hljs-built_in">str</span>, limit=<span class="hljs-number">10</span></span>):<br>    sql = <span class="hljs-string">&quot;select uuid from uuids where uuid like %s order by uuid limit %s&quot;</span><br>    cursor.execute(sql, (prefix + <span class="hljs-string">&#x27;%&#x27;</span>, limit))<br>    <span class="hljs-keyword">return</span> [uuid <span class="hljs-keyword">for</span> uuid, <span class="hljs-keyword">in</span> cursor.fetchall()]<br></code></pre></td></tr></table></figure><h1 id="éªŒè¯-amp-æ€§èƒ½æµ‹è¯•"><a href="#éªŒè¯-amp-æ€§èƒ½æµ‹è¯•" class="headerlink" title="éªŒè¯&amp;æ€§èƒ½æµ‹è¯•"></a>éªŒè¯&amp;æ€§èƒ½æµ‹è¯•</h1><p>ç”¨<code>5678e</code>è¿™ä¸ªå‰ç¼€æ¥éªŒè¯å››ç§æŸ¥è¯¢æ–¹æ³•çš„æ­£ç¡®æ€§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">[<span class="hljs-string">&#x27;5678e37b-6e7c-4760-89aa-1dc4c2b547c5&#x27;</span>, <span class="hljs-string">&#x27;5678e967-4d5d-4e26-8ed1-bd8819b5b62c&#x27;</span>]<br>traverse(<span class="hljs-string">&#x27;5678e&#x27;</span>): <span class="hljs-number">0.108424</span>s<br>[<span class="hljs-string">&#x27;5678e37b-6e7c-4760-89aa-1dc4c2b547c5&#x27;</span>, <span class="hljs-string">&#x27;5678e967-4d5d-4e26-8ed1-bd8819b5b62c&#x27;</span>]<br>bin_search(<span class="hljs-string">&#x27;5678e&#x27;</span>): <span class="hljs-number">0.000020</span>s<br>[<span class="hljs-string">&#x27;5678e37b-6e7c-4760-89aa-1dc4c2b547c5&#x27;</span>, <span class="hljs-string">&#x27;5678e967-4d5d-4e26-8ed1-bd8819b5b62c&#x27;</span>]<br>redis_zset(<span class="hljs-string">&#x27;5678e&#x27;</span>): <span class="hljs-number">0.002244</span>s<br>[<span class="hljs-string">&#x27;5678e37b-6e7c-4760-89aa-1dc4c2b547c5&#x27;</span>, <span class="hljs-string">&#x27;5678e967-4d5d-4e26-8ed1-bd8819b5b62c&#x27;</span>]<br>mysql_like(<span class="hljs-string">&#x27;5678e&#x27;</span>): <span class="hljs-number">0.000773</span>s<br></code></pre></td></tr></table></figure><p>ä»è€—æ—¶æ¥çœ‹ï¼Œ<code>O(n)</code>çš„éå†æŸ¥è¯¢å¦¥å¦¥å«åº•ï¼Œ<code>O(log n)</code>çš„äºŒåˆ†æŸ¥è¯¢ç§’æ€å…¨åœºï¼ŒMariaDBçš„æŸ¥è¯¢é€Ÿåº¦åˆ™è¿œè¿œç”©å¼€äº†Redisã€‚å½“ç„¶ï¼Œå•æ¬¡ç‰¹å®šæ¡ä»¶æŸ¥è¯¢ä¸èƒ½è¯´æ˜ä»€ä¹ˆé—®é¢˜ï¼Œä¸‹é¢æ¥çœ‹çœ‹10000æ¬¡éšæœºå‰ç¼€ï¼ˆé•¿åº¦ä¸º1~8çš„éšæœºå­—ç¬¦ä¸²ï¼‰åŒ¹é…æŸ¥è¯¢æ‰€éœ€è¦çš„æ—¶é—´ï¼š</p><p><img src="/images/2020/06/13/compare.png"></p><ul><li><p>ä¸å‡ºæ‰€æ–™ï¼ŒäºŒåˆ†æŸ¥è¯¢çš„é€Ÿåº¦æ˜¯æœ€å¿«çš„ï¼Œæ¯•ç«Ÿæ˜¯åœ¨å†…å­˜ä¸­ä»¥<code>O(log n)</code>çš„æ—¶é—´å¤æ‚åº¦æ¥æŸ¥æ‰¾æ•°æ®ã€‚</p></li><li><p>MariaDBæŸ¥æ‰¾çš„é€Ÿåº¦æ¯”äºŒåˆ†æŸ¥æ‰¾çš„é€Ÿåº¦æ…¢ä¸Šåå€ï¼Œä½†æ€§èƒ½ä¾ç„¶å‡ºä¹æˆ‘çš„æ„æ–™ã€‚InnoDBçš„B+æ ‘ç´¢å¼•æ— ç–‘æ˜¯æœ€å¤§åŠŸè‡£ï¼Œå®šä½åˆ°ç‰¹å®šå‰ç¼€çš„é¦–ä¸ªUUIDåªéœ€è¦<code>O(log n)</code>çš„æ—¶é—´å¤æ‚åº¦ï¼Œä¹‹åå°±åªéœ€è¦é¡ºåºè¯»å–æ•°æ®ã€‚åŒæ—¶ï¼Œ100ä¸‡ä¸ªUUIDçš„ç´¢å¼•å°åˆ°å¯ä»¥å…¨éƒ¨æ”¾å…¥å†…å­˜ï¼Œè¿™è¿›ä¸€æ­¥æé«˜äº†æ€§èƒ½ã€‚</p></li><li><p>Redisè¿™ä¸ªä»¥å¿«è‘—ç§°çš„KVæ•°æ®åº“åè€Œæœ€æ…¢ï¼Œä½†ä»”ç»†æƒ³æƒ³ä¹Ÿæ— å¯åšéã€‚ä¸ºäº†è¿›è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š<code>ZADD</code>æ·»åŠ è¾¹ç•Œå…ƒç´ ã€<code>ZRANK</code>ç¡®å®šä½ç½®ã€<code>ZRANGE</code>æå–ç»“æœã€<code>ZREM</code>ç§»é™¤è¾¹ç•Œå…ƒç´ ã€‚è€Œè¿™äº›æ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½è¾¾åˆ°ç”šè‡³è¶…è¿‡äº†<code>O(log n)</code>ï¼Œé€Ÿåº¦å½“ç„¶å¿«ä¸èµ·æ¥ã€‚åªèƒ½è¯´ã€ŠRediså®æˆ˜ã€‹è¿™æœ¬ä¹¦æä¾›äº†è¿™æ ·ä¸€ä¸ªæ€è·¯ï¼Œä½†åœ¨å…·ä½“å®ç°ä¸Šè¿˜æ˜¯è¦æ›´æ…é‡ã€‚</p></li></ul><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>è¯»å®Œæ–‡ç« åå¯èƒ½ä¼šæœ‰è¯»è€…å¤§å‘¼ä¸Šå½“ï¼š100ä¸‡çš„æ•°æ®é›†ä¹Ÿå¤ªå°äº†å§ï¼Ÿæ•°æ®çš„æ’å…¥å’Œåˆ é™¤æ€ä¹ˆè§£å†³ï¼Ÿå‰ç¼€æ ‘å‘¢ï¼Ÿå¥½å§ï¼Œè¿™ç¯‡æ–‡ç« ç¡®å®æ²¡æœ‰å›ç­”è¿™äº›é—®é¢˜ã€‚ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡ŒäºŒåˆ†æŸ¥è¯¢æ€§èƒ½ç¡®å®éå¸¸å¥½ï¼Œä½†æ’å…¥å’Œåˆ é™¤æ•°æ®çš„æ—¶é—´å¤æ‚åº¦æ¥åˆ°äº†<code>O(n)</code>ï¼ŒåŒæ—¶ä¹Ÿå¯¹è¶…è¿‡å†…å­˜å®¹é‡é™åˆ¶çš„æ•°æ®é›†æ— èƒ½ä¸ºåŠ›ã€‚ä½†æ˜¯æˆ‘è§‰å¾—ï¼Œå‰è€…å¯ä»¥é€šè¿‡åˆ†ç¦»æ•°æ®çš„ä¿®æ”¹å’ŒæŸ¥è¯¢è§£å†³ï¼ˆåœ¨æ•°æ®åº“ä¸­ä¿®æ”¹ï¼Œç¼“å­˜åˆ°å†…å­˜åæŸ¥è¯¢ï¼‰ï¼Œåè€…å¯ä»¥é€šè¿‡æ°´å¹³æ‰©å±•è§£å†³ï¼ˆæ¯ä¸ªè¿›ç¨‹&#x2F;æœºå™¨ç¼“å­˜éƒ¨åˆ†æ•°æ®é›†ï¼‰ï¼ŒåŒæ—¶ç¬”è€…æ°´å¹³æœ‰é™ï¼Œæ‰€ä»¥æ²¡æœ‰å›ç­”æ›´æ·±å…¥çš„é—®é¢˜ã€‚</p><p>æ–‡ç« æœ€åï¼Œè¡·å¿ƒæ„Ÿè°¢é»„å¥å®è€å¸ˆçš„è‘—ä½œã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹å’Œè¯‘ä½œã€ŠRediså®æˆ˜ã€‹ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>ç®—æ³•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•åœ¨Golangé‡Œå®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„TTLMap</title>
    <link href="/2020/05/24/%E5%A6%82%E4%BD%95%E5%9C%A8Golang%E9%87%8C%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84TTLMap/"/>
    <url>/2020/05/24/%E5%A6%82%E4%BD%95%E5%9C%A8Golang%E9%87%8C%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84TTLMap/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>TTLMap</code>æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®ç”¨çš„æ•°æ®ç»“æ„ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ç¼“å­˜æ•°æ®çš„åœºæ™¯ä¸‹ã€‚<code>TTLMap</code>çš„å®ç°ç°ä¸ç®—å¤æ‚ï¼Œä½†ä¹Ÿæœ‰è®¸å¤šéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè¿™ä¹Ÿæ˜¯è¿™ç¯‡æ–‡ç« å‡ºç°çš„åŸå› ã€‚</p><p>åœ¨<code>TTLMap</code>é‡Œï¼Œç§»é™¤å¤±æ•ˆçš„æ•°æ®æœ‰ä¸‰ç§ç­–ç•¥ï¼šç«‹å³åˆ é™¤ã€æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥ã€‚ç«‹å³åˆ é™¤ç­–ç•¥ä¼šåœ¨æ•°æ®è¿‡æœŸæ—¶ç«‹å³å°†æ•°æ®åˆ é™¤ï¼›æƒ°æ€§åˆ é™¤ç­–ç•¥åªåœ¨ç¢°åˆ°è¿‡æœŸé”®æ—¶æ‰è¿›è¡Œåˆ é™¤æ“ä½œï¼›å®šæœŸåˆ é™¤ç­–ç•¥åˆ™æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œä¸»åŠ¨æŸ¥æ‰¾å¹¶åˆ é™¤è¿‡æœŸé”®ã€‚ç¬¬ä¸€ç§ç­–ç•¥å¯¹CPUä¸å‹å¥½ï¼Œç¬¬äºŒç§ç­–ç•¥å®¹æ˜“é€ æˆå†…å­˜æ³„éœ²ã€‚<code>Redis</code>å¯¹è®¾ç½®äº†TTLçš„æ•°æ®é‡‡å–çš„æ˜¯æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥ï¼Œè€Œæœ¬ç¯‡æ–‡ç« ä¼šå°†é‡ç‚¹æ”¾åœ¨æ€§èƒ½ä¸Šï¼Œæ‰€ä»¥åªä¼šé‡‡å–å®šæœŸåˆ é™¤ç­–ç•¥ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« ä½¿ç”¨<code>go1.13.5 linux/amd64</code></p></blockquote><h1 id="æ¥å£å®šä¹‰"><a href="#æ¥å£å®šä¹‰" class="headerlink" title="æ¥å£å®šä¹‰"></a>æ¥å£å®šä¹‰</h1><p>å…ˆæ¥çœ‹çœ‹<code>TTLMap</code>çš„æ¥å£å®šä¹‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TTLMap <span class="hljs-keyword">interface</span> &#123;<br>Get(key <span class="hljs-type">string</span>) (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">bool</span>)<br>Set(key <span class="hljs-type">string</span>, val <span class="hljs-keyword">interface</span>&#123;&#125;, ex time.Duration)<br>Len() <span class="hljs-type">int</span><br>clean(tick time.Duration)<br>&#125;<br><br><span class="hljs-keyword">type</span> item <span class="hljs-keyword">struct</span> &#123;<br>value  <span class="hljs-keyword">interface</span>&#123;&#125;<br>expire <span class="hljs-type">int64</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Get()</code>å‡½æ•°è´Ÿè´£ä»<code>TTLMap</code>ä¸­è·å–æ•°æ®ï¼Œå¦‚æ•°æ®ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆåˆ™ç¬¬äºŒä¸ªè¿”å›å€¼ä¸º<code>false</code>ï¼Œè¡Œä¸ºå’Œå†…ç½®çš„<code>map</code>ä¿æŒä¸€è‡´ã€‚<code>Set()</code>å‡½æ•°è´Ÿè´£å°†æ•°æ®æ”¾å…¥<code>TTLMap</code>ï¼Œå¹¶æ¥æ”¶ä¸€ä¸ª<code>time.Duration</code>å‚æ•°ç”¨æ¥æ ‡ç¤ºæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚<code>Len()</code>å‡½æ•°è¿”å›<code>TTLMap</code>ä¸­æ•°æ®çš„æ•°é‡ï¼Œä¸è¿‡ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œä¸€èˆ¬ä¸åŒºåˆ†æ•°æ®æ˜¯å¦å·²ç»å¤±æ•ˆã€‚<code>clean()</code>å‡½æ•°åˆ™è´Ÿè´£å®ç°ä¸Šæ–‡æåˆ°çš„å®šæœŸåˆ é™¤ç­–ç•¥ã€‚</p><h1 id="åˆæ­¥å®ç°ï¼ˆV0ç‰ˆæœ¬ï¼‰"><a href="#åˆæ­¥å®ç°ï¼ˆV0ç‰ˆæœ¬ï¼‰" class="headerlink" title="åˆæ­¥å®ç°ï¼ˆV0ç‰ˆæœ¬ï¼‰"></a>åˆæ­¥å®ç°ï¼ˆV0ç‰ˆæœ¬ï¼‰</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TTLMapV0 <span class="hljs-keyword">struct</span> &#123;<br>items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item<br>mux   *sync.Mutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV0)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">bool</span>) &#123;<br>tm.mux.Lock()<br><span class="hljs-keyword">defer</span> tm.mux.Unlock()<br><span class="hljs-keyword">if</span> item, ok := tm.items[key]; !ok || time.Now().UnixNano() &gt; item.expire &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> item.value, <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV0)</span></span> Set(key <span class="hljs-type">string</span>, val <span class="hljs-keyword">interface</span>&#123;&#125;, ex time.Duration) &#123;<br>tm.mux.Lock()<br>tm.items[key] = item&#123;value: val, expire: time.Now().Add(ex).UnixNano()&#125;<br>tm.mux.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV0)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>tm.mux.Lock()<br><span class="hljs-keyword">defer</span> tm.mux.Unlock()<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(tm.items)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV0)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> time.Tick(tick) &#123;<br>tm.mux.Lock()<br><span class="hljs-keyword">for</span> key, item := <span class="hljs-keyword">range</span> tm.items &#123;<br><span class="hljs-keyword">if</span> time.Now().UnixNano() &gt;= item.expire &#123;<br><span class="hljs-built_in">delete</span>(tm.items, key)<br>&#125;<br>&#125;<br>tm.mux.Unlock()<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV0</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapV0 &#123;<br>tm := &amp;TTLMapV0&#123;items: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item&#123;&#125;, mux: <span class="hljs-built_in">new</span>(sync.Mutex)&#125;<br><span class="hljs-keyword">go</span> tm.clean(cleanTick)<br><span class="hljs-keyword">return</span> tm<br></code></pre></td></tr></table></figure><h1 id="é˜²æ­¢å†…å­˜æ³„éœ²ï¼ˆV1ç‰ˆæœ¬ï¼‰"><a href="#é˜²æ­¢å†…å­˜æ³„éœ²ï¼ˆV1ç‰ˆæœ¬ï¼‰" class="headerlink" title="é˜²æ­¢å†…å­˜æ³„éœ²ï¼ˆV1ç‰ˆæœ¬ï¼‰"></a>é˜²æ­¢å†…å­˜æ³„éœ²ï¼ˆV1ç‰ˆæœ¬ï¼‰</h1><p>ä¸Šé¢çš„V0ç‰ˆæœ¬å®ç°åœ¨åŠŸèƒ½ä¸Šå·²ç»åŸºæœ¬å®Œæ•´äº†ï¼Œä½†ç”±äº<code>clean()</code>å‡½æ•°ä¼šä¸€ç›´è¿è¡Œï¼Œæ‰€ä»¥V0ç‰ˆæœ¬çš„<code>TTLMap</code>ä¸ä¼šè¢«Golangçš„åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼Œè¿›è€Œå¼•èµ·å†…å­˜æ³„éœ²ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹V0ç‰ˆæœ¬åšå‡ºä¸€ç‚¹æ”¹è¿›ï¼Œå¹¶å°†æ”¹è¿›åçš„<code>TTLMap</code>åŒ…è£¹èµ·æ¥ä»¥å¯åŠ¨è‡ªåŠ¨å›æ”¶æœºåˆ¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TTLMapV1 <span class="hljs-keyword">struct</span> &#123;<br>*TTLMapV0<br>stop <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV1)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> time.Tick(tick) &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-tm.stop:<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>tm.mux.Lock()<br><span class="hljs-keyword">for</span> key, item := <span class="hljs-keyword">range</span> tm.items &#123;<br><span class="hljs-keyword">if</span> time.Now().UnixNano() &gt;= item.expire &#123;<br><span class="hljs-built_in">delete</span>(tm.items, key)<br>&#125;<br>&#125;<br>tm.mux.Unlock()<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> TTLMapWrapper <span class="hljs-keyword">struct</span> &#123;<br>TTLMap<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV1</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapWrapper &#123;<br>tm0 := &amp;TTLMapV0&#123;items: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item&#123;&#125;, mux: <span class="hljs-built_in">new</span>(sync.Mutex)&#125;<br>tm1 := &amp;TTLMapV1&#123;TTLMapV0: tm0, stop: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)&#125;<br><span class="hljs-keyword">go</span> tm1.clean(cleanTick)<br>tmw := &amp;TTLMapWrapper&#123;TTLMap: tm1&#125;<br>runtime.SetFinalizer(tmw, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123; tm1.stop &lt;- <span class="hljs-literal">true</span> &#125;)<br><span class="hljs-keyword">return</span> tmw<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="éªŒè¯è‡ªåŠ¨å›æ”¶æ˜¯å¦å¯ç”¨"><a href="#éªŒè¯è‡ªåŠ¨å›æ”¶æ˜¯å¦å¯ç”¨" class="headerlink" title="éªŒè¯è‡ªåŠ¨å›æ”¶æ˜¯å¦å¯ç”¨"></a>éªŒè¯è‡ªåŠ¨å›æ”¶æ˜¯å¦å¯ç”¨</h2><p>ä¸ºäº†éªŒè¯ä¸Šæ–‡çš„æ”¹è¿›æ˜¯å¦æœ‰æ•ˆï¼Œå°†ä»£ç æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV0)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;v0.clean() stopped&quot;</span>)<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV0</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapV0 &#123;<br><span class="hljs-comment">// ...</span><br>runtime.SetFinalizer(tm, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;v0 gone&quot;</span>) &#125;)<br><span class="hljs-keyword">return</span> tm<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV1)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;v1.clean() stopped&quot;</span>) &#125;()<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV1</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapWrapper &#123;<br>    <span class="hljs-comment">// ...</span><br>runtime.SetFinalizer(tm1, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;v1 gone&quot;</span>) &#125;)<br>runtime.SetFinalizer(tm0, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;v1.v0 gone&quot;</span>) &#125;)<br><span class="hljs-keyword">return</span> tmw<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç¼–å†™æµ‹è¯•ä»£ç å¹¶è¿è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestTTLMap</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>NewTTLMapV0(time.Millisecond * <span class="hljs-number">100</span>)<br>NewTTLMapV1(time.Millisecond * <span class="hljs-number">100</span>)<br>&#125;()<br>fmt.Println(<span class="hljs-string">&quot;--&gt; first gc&quot;</span>)<br>runtime.GC()<br>time.Sleep(time.Millisecond * <span class="hljs-number">200</span>)<br>fmt.Println(<span class="hljs-string">&quot;--&gt; second gc&quot;</span>)<br>runtime.GC()<br>fmt.Println(<span class="hljs-string">&quot;--&gt; third gc&quot;</span>)<br>runtime.GC()<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">go <span class="hljs-built_in">test</span> .</span><br>=== RUN   TestTTLMap<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">first gc</span><br>v1.clean() stopped<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">second gc</span><br>v1 gone<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">third gc</span><br>v1.v0 gone<br>--- PASS: TestTTLMap (0.20s)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ”¹è¿›åçš„ä»£ç ç¡®å®ç”Ÿæ•ˆäº†ï¼Œæœªè¢«å¼•ç”¨çš„<code>TTLMap</code>ï¼ˆV1ç‰ˆæœ¬ï¼‰ä¼šè¢«è‡ªåŠ¨å›æ”¶ï¼Œä¸ä¼šå‡ºç°å†…å­˜æ³„éœ²ã€‚</p><blockquote><p>PSï¼šåœ¨æ¥ä¸‹æ¥çš„ç‰ˆæœ¬å°†çœç•¥<code>TTLMapWrapper</code>çš„å®ç°éƒ¨åˆ†</p></blockquote><h1 id="ä½¿ç”¨è¯»å†™é”æé«˜æ€§èƒ½ï¼ˆV2ç‰ˆæœ¬ï¼‰"><a href="#ä½¿ç”¨è¯»å†™é”æé«˜æ€§èƒ½ï¼ˆV2ç‰ˆæœ¬ï¼‰" class="headerlink" title="ä½¿ç”¨è¯»å†™é”æé«˜æ€§èƒ½ï¼ˆV2ç‰ˆæœ¬ï¼‰"></a>ä½¿ç”¨è¯»å†™é”æé«˜æ€§èƒ½ï¼ˆV2ç‰ˆæœ¬ï¼‰</h1><p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬é‡Œï¼Œ<code>TTLMap</code>ä½¿ç”¨çš„å¹¶å‘æ§åˆ¶é”éƒ½æ˜¯æ™®é€šçš„<code>sync.Mutex</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ª<code>Goruntime</code>è®¿é—®è¯¥å¯¹è±¡ã€‚ä½†<code>TTLMap</code>åº”ç”¨çš„åœºæ™¯å¤§å¤šæ˜¯è¯»å¤šå†™å°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼Œå³<code>sync.RWMutex</code>æ¥è·å¾—æ›´å¥½æ€§èƒ½ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TTLMapV2 <span class="hljs-keyword">struct</span> &#123;<br>items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item<br>mux   *sync.RWMutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV2)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">bool</span>) &#123;<br>tm.mux.RLock()<br><span class="hljs-keyword">defer</span> tm.mux.RUnlock()<br><span class="hljs-keyword">if</span> item, ok := tm.items[key]; !ok || time.Now().UnixNano() &gt; item.expire &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> item.value, <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV2)</span></span> Set(key <span class="hljs-type">string</span>, val <span class="hljs-keyword">interface</span>&#123;&#125;, ex time.Duration) &#123;<br><span class="hljs-comment">// ... åŒV0ç‰ˆæœ¬</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV2)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-comment">// ... åŒV0ç‰ˆæœ¬</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV2)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>tm.mux.RLock()<br><span class="hljs-keyword">defer</span> tm.mux.RUnlock()<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(tm.items)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV2</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapV2 &#123;<br>tm := &amp;TTLMapV2&#123;<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item&#123;&#125;, <span class="hljs-built_in">new</span>(sync.RWMutex)&#125;<br><span class="hljs-keyword">go</span> tm.clean(cleanTick)<br><span class="hljs-keyword">return</span> tm<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä½¿ç”¨ä¸ç²¾ç¡®çš„æ—¶é—´æé«˜æ€§èƒ½ï¼ˆV3ç‰ˆæœ¬ï¼‰"><a href="#ä½¿ç”¨ä¸ç²¾ç¡®çš„æ—¶é—´æé«˜æ€§èƒ½ï¼ˆV3ç‰ˆæœ¬ï¼‰" class="headerlink" title="ä½¿ç”¨ä¸ç²¾ç¡®çš„æ—¶é—´æé«˜æ€§èƒ½ï¼ˆV3ç‰ˆæœ¬ï¼‰"></a>ä½¿ç”¨ä¸ç²¾ç¡®çš„æ—¶é—´æé«˜æ€§èƒ½ï¼ˆV3ç‰ˆæœ¬ï¼‰</h1><p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬é‡Œï¼Œæ¯æ¬¡è°ƒç”¨<code>Get()</code>å’Œ<code>Set()</code>å‡½æ•°æ—¶éƒ½ä¼šè°ƒç”¨<code>time.Now()</code>ä»¥è·å–ç²¾ç¡®æ—¶é—´ã€‚ä½†åœ¨å¯¹æ—¶é—´çš„ç²¾ç¡®åº¦è¦æ±‚ä¸é‚£ä¹ˆé«˜çš„åœºåˆä¸‹ï¼Œå¯ä»¥ç¼“å­˜<code>time.Now()</code>çš„ç»“æœæ¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TTLMapV3 <span class="hljs-keyword">struct</span> &#123;<br>items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item<br>mux   *sync.RWMutex<br>now   <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV3)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">bool</span>) &#123;<br>tm.mux.RLock()<br><span class="hljs-keyword">defer</span> tm.mux.RUnlock()<br><span class="hljs-keyword">if</span> item, ok := tm.items[key]; !ok || tm.now &gt; item.expire &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> item.value, <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV3)</span></span> Set(key <span class="hljs-type">string</span>, val <span class="hljs-keyword">interface</span>&#123;&#125;, ex time.Duration) &#123;<br>tm.mux.Lock()<br>tm.items[key] = item&#123;value: val, expire: tm.now + ex.Nanoseconds()&#125;<br>tm.mux.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV3)</span></span> Len() <span class="hljs-type">int</span> &#123;<br><span class="hljs-comment">// ... åŒV2ç‰ˆæœ¬</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV3)</span></span> clean(tick time.Duration) &#123;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> time.Tick(tick) &#123;<br>tm.mux.Lock()<br><span class="hljs-keyword">for</span> key, item := <span class="hljs-keyword">range</span> tm.items &#123;<br><span class="hljs-keyword">if</span> tm.now &gt;= item.expire &#123;<br><span class="hljs-built_in">delete</span>(tm.items, key)<br>&#125;<br>&#125;<br>tm.mux.Unlock()<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TTLMapV3)</span></span> updateNow(tick time.Duration) &#123;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> time.Tick(tick) &#123;<br>tm.mux.Lock()<br>tm.now = time.Now().UnixNano()<br>tm.mux.Unlock()<br>&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTTLMapV3</span><span class="hljs-params">(cleanTick time.Duration)</span></span> *TTLMapV3 &#123;<br>tm := &amp;TTLMapV3&#123;<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]item&#123;&#125;,<br><span class="hljs-built_in">new</span>(sync.RWMutex), time.Now().UnixNano()&#125;<br><span class="hljs-keyword">go</span> tm.clean(cleanTick)<br><span class="hljs-keyword">go</span> tm.updateNow(time.Second)<br><span class="hljs-keyword">return</span> tm<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ€§èƒ½æµ‹è¯•-amp-ç»“è¯­"><a href="#æ€§èƒ½æµ‹è¯•-amp-ç»“è¯­" class="headerlink" title="æ€§èƒ½æµ‹è¯•&amp;ç»“è¯­"></a>æ€§èƒ½æµ‹è¯•&amp;ç»“è¯­</h1><p>ç¼–å†™æµ‹è¯•ä»£ç ç”¨äºæµ‹è¯•ä»¥ä¸Šç‰ˆæœ¬çš„æ€§èƒ½å¹¶è¿è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkTTLMap</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>rand.Seed(time.Now().UnixNano())<br>key := RandStringBytesRmndr(<span class="hljs-number">20</span>)<br>tasks := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-type">string</span><br>ttl  TTLMap<br>&#125;&#123;<br>&#123;<span class="hljs-string">&quot;TTLMapV0&quot;</span>, NewTTLMapV0(time.Minute)&#125;,<br>&#123;<span class="hljs-string">&quot;TTLMapV2&quot;</span>, NewTTLMapV2(time.Minute)&#125;,<br>&#123;<span class="hljs-string">&quot;TTLMapV3&quot;</span>, NewTTLMapV3(time.Minute)&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;<br>b.Run(task.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(sb *testing.B)</span></span> &#123;<br>sb.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;<br><span class="hljs-keyword">for</span> pb.Next() &#123;<br>task.ttl.Set(key, key, time.Minute)<br>task.ttl.Get(key)<br>&#125;<br>&#125;)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">go <span class="hljs-built_in">test</span> -bench .</span>  <br>goos: linux<br>goarch: amd64<br>BenchmarkTTLMap/TTLMapV0-8               3972699               301 ns/op<br>BenchmarkTTLMap/TTLMapV2-8               4972598               241 ns/op<br>BenchmarkTTLMap/TTLMapV3-8               9125235               132 ns/op<br>PASS<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼ŒV2ç›¸æ¯”V0æ€§èƒ½æå‡äº†20%å·¦å³ï¼Œè€ŒV3ç›¸æ¯”V0çš„æ€§èƒ½æå‡å¹…åº¦æ›´æ˜¯è¶…è¿‡äº†56%ã€‚è€Œä»PPROFçš„åˆ†æç»“æœæ¥çœ‹ï¼Œå‰©ä¸‹çš„æ—¶é—´ä¸»è¦æ¶ˆè€—åœ¨äº’æ–¥é”ä¸Šï¼Œåº”è¯¥å¾ˆéš¾æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´äº†ã€‚</p><p><img src="/images/2020/05/24/pprof.webp"></p><p>è™½ç„¶ç†è®ºä¸Šæ¥è¯´ç”¨<code>int</code>å½“<code>Map</code>çš„é”®è€Œä¸æ˜¯<code>string</code>æ—¶ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä½†æ˜¯ä»å®é™…æµ‹è¯•æ¥çœ‹ï¼Œå¯¹äºé•¿åº¦ä¸º20çš„<code>string</code>ï¼Œ<code>fnv32</code>ç­‰å“ˆå¸Œç®—æ³•çš„å¼€é”€è¿˜æ˜¯è¶…è¿‡äº†å…¶èƒ½å¸¦æ¥çš„æ”¶ç›Šï¼Œæ›´åˆ«æè¿˜è¦è€ƒè™‘æ½œåœ¨çš„å“ˆå¸Œå†²çªã€‚</p><p>æœ€åè¦é‡ç”³ä¸€ç‚¹çš„æ˜¯ï¼ŒV2å’ŒV3ç‰ˆæœ¬çš„å®ç°çœç•¥äº†V1ä¸­æåˆ°çš„<code>TTLMapWrapper</code>éƒ¨åˆ†ï¼Œæ‰€ä»¥è¯·ä¸è¦ç›´æ¥ä½¿ç”¨V2å’ŒV3ç‰ˆæœ¬çš„ä»£ç ğŸ˜‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><ul><li><a href="https://github.com/golang/go/issues/19780">proposal: a faster, better fnv32 implementation #19780</a></li><li><a href="https://my.oschina.net/solate/blog/3034188">go benchmark æ€§èƒ½æµ‹è¯•</a></li><li><a href="https://zhuanlan.zhihu.com/p/76504936">ä½¿ç”¨runtime.SetFinalizerä¼˜é›…å…³é—­åå°goroutine</a></li><li><a href="http://redisbook.com/preview/database/review.html">é‡ç‚¹å›é¡¾-Redisè®¾è®¡ä¸å®ç°</a></li><li><a href="https://stackoverflow.com/questions/22892120/how-to-generate-a-random-string-of-a-fixed-length-in-go">How to generate a random string of a fixed length in Go?</a></li><li><a href="https://medium.com/justforfunc/analyzing-the-performance-of-go-functions-with-benchmarks-60b8162e61c6">Analyzing the performance of Go functions with benchmarks</a></li><li><a href="https://stackimpact.com/blog/practical-golang-benchmarks/#map-access">Practical Go Benchmarks</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>map</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆç•ªå¤–ï¼‰</title>
    <link href="/2020/05/02/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <url>/2020/05/02/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h1><p>è¿™ç¯‡æ–‡ç« åŸºäºå‰ä¸¤ç¯‡æ–‡ç« <a href="/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆä¸€ï¼‰</a>ã€<a href="/2020/04/25/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89">Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆäºŒï¼‰</a>ï¼Œå°†ç»§ç»­è®²è¿°å…³äºDjangoå¤šæ•°æ®åº“çš„å†é™©è®°ã€‚<br>å¥½å§å…¶å®è¿™ç¯‡æ–‡ç« çš„å†…å®¹å·²ç»å’ŒDjangoå¤šæ•°æ®åº“æ²¡æœ‰å¤ªå¤§å…³ç³»äº†â€¦â€¦åªæ˜¯ä¸ºäº†å’Œå‰ä¸¤ç¯‡æ–‡ç« çš„å‘½åä¿æŒä¸€è‡´æ‰å–äº†è¿™ä¸ªæ ‡é¢˜ã€‚</p><h1 id="ç§˜æŠ€ï¼šé¿å…ç‰©ç†å¤–é”®çº¦æŸ"><a href="#ç§˜æŠ€ï¼šé¿å…ç‰©ç†å¤–é”®çº¦æŸ" class="headerlink" title="ç§˜æŠ€ï¼šé¿å…ç‰©ç†å¤–é”®çº¦æŸ"></a>ç§˜æŠ€ï¼šé¿å…ç‰©ç†å¤–é”®çº¦æŸ</h1><p><a href="https://docs.djangoproject.com/en/2.2/ref/models/fields/#django.db.models.ForeignKey.db_constraint"><img src="/images/2020/05/02/document.webp" alt="document.webp"></a></p><p>å¯¹äºæ•°æ®åº“å±‚é¢çš„ç‰©ç†å¤–é”®ï¼Œå›½å†…äº’è”ç½‘ä¸Šçš„å£°éŸ³æ™®éä¸€è‡´ï¼Œé‚£å°±æ˜¯ä¸æ¨èä½¿ç”¨ï¼ˆæ¯”å¦‚è¿™ä¸ª<a href="https://www.zhihu.com/question/39062169">çŸ¥ä¹é—®é¢˜</a>ï¼‰ï¼Œå…¬å¸çš„DBAä¹ŸæŒè¿™ä¸ªæ€åº¦ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå°±åº”è¯¥æƒ³åŠæ³•åœ¨æ‰§è¡Œ<code>Migrate</code>æ“ä½œæ—¶é¿å…äº§ç”Ÿç‰©ç†å¤–é”®äº†ã€‚<br>å¹¸è¿çš„æ—¶ï¼Œä»å¾ˆæ—©å¼€å§‹ï¼ˆä¸æ™šäº<code>Django1.8</code>ï¼‰Djangoå°±æä¾›äº†ç›´æ¥çš„æ‰‹æ®µæ¥é¿å…äº§ç”Ÿç‰©ç†å¤–é”®ï¼š<code>db_constraint</code>å±æ€§ã€‚ä»Django DBæ¨¡å—çš„æºç ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/db/backends/base/schema.py">schema.py</a>ï¼‰ä¸­å¯ä»¥çœ‹å‡ºï¼ŒDjangoåœ¨åˆ›å»ºModelã€æ·»åŠ &#x2F;ä¿®æ”¹Fieldæ—¶éƒ½ä¼šé€šè¿‡<code>db_constraint</code>å±æ€§çš„å€¼æ¥å†³å®šæ˜¯å¦åŠ å…¥ç‰©ç†å¤–é”®çº¦æŸã€‚å®éªŒä¸€ä¸‹ï¼ˆçœç•¥å†…å®¹è§<a href="/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app_1/models.py</span><br><span class="hljs-comment"># ... ç•¥</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChildModel1</span>(models.Model):<br>    name = models.CharField(max_length=<span class="hljs-number">255</span>)<br>    parent1 = models.ForeignKey(<span class="hljs-string">&quot;Model1&quot;</span>, on_delete=models.CASCADE, db_constraint=<span class="hljs-literal">False</span>)<br>    parent2 = models.ForeignKey(<span class="hljs-string">&quot;app_2.Model2&quot;</span>, on_delete=models.CASCADE, db_constraint=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py makemigrations</span><br>Migrations for &#x27;app_1&#x27;:<br>  app_1/migrations/0002_childmodel1.py<br>    - Create model ChildModel1<br><span class="hljs-meta prompt_">$</span><span class="language-bash"></span><br><span class="language-bash">$ python manage.py migrate app_1 --database db_1</span><br>Operations to perform:<br>  Apply all migrations: app_1<br>Running migrations:<br>  Applying app_2.0001_initial... OK<br>  Applying app_1.0002_childmodel1... OK<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> django_migrations<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> app   <span class="hljs-operator">|</span> name             <span class="hljs-operator">|</span> applied                    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">1</span>  <span class="hljs-operator">|</span> app_1 <span class="hljs-operator">|</span> <span class="hljs-number">0001</span>_initial     <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-operator">-</span>xx<span class="hljs-operator">-</span>xx xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-number">3</span>  <span class="hljs-operator">|</span> app_2 <span class="hljs-operator">|</span> <span class="hljs-number">0001</span>_initial     <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-operator">-</span>xx<span class="hljs-operator">-</span>xx xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-number">3</span>  <span class="hljs-operator">|</span> app_1 <span class="hljs-operator">|</span> <span class="hljs-number">0002</span>_childmodel1 <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-operator">-</span>xx<span class="hljs-operator">-</span>xx xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br>mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> Tables_in_db_1    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> app_1_childmodel1 <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> app_1_model1      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> django_migrations <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br>mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> app_1_model1<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `app_1_childmodel1` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `parent1_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `parent2_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `app_1_childmodel1_parent1_id_8dfbb0b1` (`parent1_id`),<br>  KEY `app_1_childmodel1_parent2_id_db0fdb2e` (`parent2_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci<br></code></pre></td></tr></table></figure><h1 id="ç§˜æŠ€ï¼šmigrationsè½¬SQLè¯­å¥"><a href="#ç§˜æŠ€ï¼šmigrationsè½¬SQLè¯­å¥" class="headerlink" title="ç§˜æŠ€ï¼šmigrationsè½¬SQLè¯­å¥"></a>ç§˜æŠ€ï¼š<code>migrations</code>è½¬SQLè¯­å¥</h1><p><a href="https://docs.djangoproject.com/en/2.2/ref/django-admin/#django-admin-sqlmigrate"><img src="/images/2020/05/02/sqlmigrate.webp" alt="sqlmigrate.webp"></a></p><p>åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚å¤„äºå®‰å…¨è€ƒé‡ï¼‰ï¼ŒDjangoè‡ªå¸¦çš„<code>migrate</code>å‘½ä»¤å¯èƒ½ä¸è¢«å…è®¸è¿è¡Œã€‚å¦‚æœæ­¤æ—¶è¿˜æƒ³ä½¿ç”¨Djangoçš„æ•°æ®è¿ç§»åŠŸèƒ½ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>sqlmigrate</code>å‘½ä»¤æ¥å°†åˆ›å»ºå¥½çš„è¿ç§»æ–¹æ¡ˆè½¬æ¢ä¸ºSQLè¯­å¥ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py sqlmigrate app_1 0001_initial --database db_1</span><br>BEGIN;<br>--<br>-- Create model Model1<br>--<br>CREATE TABLE `app_1_model1` (`id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY, `name` varchar(255) NOT NULL);<br>COMMIT;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡è¿™ä¸ªå‘½ä»¤å¹¶ä¸€æ¬¡åªèƒ½è½¬æ¢ä¸€æ¡è¿ç§»æ–¹æ¡ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å‚è€ƒé­”æ”¹ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># my_sqlmigrate.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">import</span> django<br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.management <span class="hljs-keyword">import</span> execute_from_command_line, CommandParser<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> DEFAULT_DB_ALIAS<br><span class="hljs-keyword">from</span> django.db.migrations.loader <span class="hljs-keyword">import</span> MigrationLoader<br><br>os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;multi_db.settings&#x27;</span>)<br>django.setup()<br><br>parser = CommandParser()<br>parser.add_argument(<br>    <span class="hljs-string">&#x27;app_label&#x27;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>,<br>    <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;App label of an application to synchronize the state.&#x27;</span>,<br>)<br>app_label = parser.parse_args().app_label<br><br>loader = MigrationLoader(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># è·å–æ‰€æœ‰migration</span><br>db = settings.DB_ROUTING.get(app_label, DEFAULT_DB_ALIAS)<br><span class="hljs-comment"># éå†appä¸‹æ‰€æœ‰migration</span><br>migrations = <span class="hljs-built_in">sorted</span>(name <span class="hljs-keyword">for</span> app, name <span class="hljs-keyword">in</span> loader.disk_migrations <span class="hljs-keyword">if</span> app == app_label)<br><span class="hljs-keyword">for</span> migration <span class="hljs-keyword">in</span> migrations:<br>    argv = [<span class="hljs-string">&quot;manage.py&quot;</span>, <span class="hljs-string">&quot;sqlmigrate&quot;</span>, <span class="hljs-string">&quot;--database&quot;</span>, db, app_label, migration]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n-- python &quot;</span> + <span class="hljs-string">&quot; &quot;</span>.join(argv))<br>    execute_from_command_line(argv)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-- my_sqlmigrate complete&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥ä¸€æ¬¡æ€§è½¬æ¢æ‰€æœ‰è¿ç§»æ–¹æ¡ˆäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python my_sqlmigrate.py app_1</span><br><br>-- python manage.py sqlmigrate --database db_1 app_1 0001_initial<br>BEGIN;<br>--<br>-- Create model Model1<br>--<br>CREATE TABLE `app_1_model1` (`id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY, `name` varchar(255) NOT NULL);<br>COMMIT;<br><br>-- python manage.py sqlmigrate --database db_1 app_1 0002_childmodel1<br>BEGIN;<br>--<br>-- Create model ChildModel1<br>--<br>CREATE TABLE `app_1_childmodel1` (`id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY, `name` varchar(255) NOT NULL, `parent1_id` integer NOT NULL, `parent2_id` integer NOT NULL);<br>CREATE INDEX `app_1_childmodel1_parent1_id_8dfbb0b1` ON `app_1_childmodel1` (`parent1_id`);<br>CREATE INDEX `app_1_childmodel1_parent2_id_db0fdb2e` ON `app_1_childmodel1` (`parent2_id`);<br>COMMIT;<br>-- my_sqlmigrate complete<br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ–‡ç« çš„å®ç”¨æ€§å¯èƒ½è°ˆä¸ä¸Šæœ‰å¤šé«˜ï¼Œåªèƒ½è¯´èŠä»¥è‡ªæ…°ã€‚è™½ç„¶æˆ‘åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« çš„å¼€å¤´è¯´<code>å¯¹å¤šæ•°æ®åº“çš„æ”¯æŒâ€¦â€¦å‘æ— å¤„ä¸åœ¨</code>ï¼Œä½†åœ¨æ·±å…¥äº†è§£ä¹‹åï¼Œæˆ‘è¿˜æ˜¯è¢«Djangoå®Œå–„çš„æ¶æ„ç»™æŠ˜æœäº†ï¼šä¸æ„§æ˜¯æœ€ä¼˜ç§€çš„Python Webæ¡†æ¶ï¼Œæˆ‘è¿˜æ˜¯too young, too simpleã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>Django</tag>
      
      <tag>å¤šæ•°æ®åº“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆäºŒï¼‰</title>
    <link href="/2020/04/25/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2020/04/25/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h1><p>è¿™ç¯‡æ–‡ç« åŸºäºä¸Šä¸€ç¯‡æ–‡ç« <a href="/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆä¸€ï¼‰</a>ï¼Œå°†ç»§ç»­è®²è¿°å…³äºDjangoå¤šæ•°æ®åº“çš„å†é™©è®°ã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªDjangoé¡¹ç›®ï¼š<code>multi_db</code>ï¼Œåœ¨è¿™ä¸ªé¡¹ç›®é‡ŒæŒ‡å®šäº†ä¸¤ä¸ªappï¼š<code>app_1</code>å’Œ<code>app_2</code>ï¼Œæ¯ä¸ªappä¸‹å„è‡ªåˆ›å»ºäº†ä¸€ä¸ª<code>Model</code>ï¼š<code>Model1</code>å’Œ<code>Model2</code>ï¼Œå¹¶ä¸ºè¿™ä¸¤ä¸ªappå„è‡ªåˆ†é…äº†ç‹¬ç«‹çš„æ•°æ®åº“<code>db_1</code>å’Œ<code>db_2</code>ã€‚å†é™©ç»§ç»­ï½</p><h1 id="ç¬¬ä¸‰å…³ï¼šTestCase"><a href="#ç¬¬ä¸‰å…³ï¼šTestCase" class="headerlink" title="ç¬¬ä¸‰å…³ï¼šTestCase"></a>ç¬¬ä¸‰å…³ï¼šTestCase</h1><p>åœ¨<code>multi_db</code>è¿™ä¸ªDjangoé¡¹ç›®èƒ½å¤Ÿè¿è¡Œèµ·æ¥ä¹‹åï¼Œä¸‹ä¸€æ­¥è®©æˆ‘ä»¬æ¥è¿è¡Œä¸€äº›TestCaseï¼ˆå¯¹ï¼Œå³ä½¿è¿™ä¸ªé¡¹ç›®é‡Œä¸€ä¸ªè§†å›¾å‡½æ•°éƒ½è¿˜æ²¡æœ‰ï¼Œ<del>æ¯•ç«Ÿæ˜¯TDDğŸ˜‚</del>ï¼‰ã€‚ç¼–è¾‘TestCaseæ–‡ä»¶å¹¶è¿è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># tests/test_multi_db.py</span><br><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase<br><br><span class="hljs-keyword">from</span> app_1.models <span class="hljs-keyword">import</span> Model1<br><span class="hljs-keyword">from</span> app_2.models <span class="hljs-keyword">import</span> Model2<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestDB1</span>(<span class="hljs-title class_ inherited__">TestCase</span>):<br>    databases = [<span class="hljs-string">&quot;db_1&quot;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_query</span>(<span class="hljs-params">self</span>):<br>        count = Model1.objects.count()<br>        self.assertEqual(count, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestDB2</span>(<span class="hljs-title class_ inherited__">TestCase</span>):<br>    databases = [<span class="hljs-string">&quot;db_2&quot;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_query</span>(<span class="hljs-params">self</span>):<br>        count = Model2.objects.count()<br>        self.assertEqual(count, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">time python manage.py <span class="hljs-built_in">test</span> tests/</span><br>Creating test database for alias &#x27;db_1&#x27;...<br>Creating test database for alias &#x27;db_2&#x27;...<br>System check identified no issues (0 silenced).<br>..<br>----------------------------------------------------------------------<br>Ran 2 tests in 0.006s<br><br>OK<br>Destroying test database for alias &#x27;db_1&#x27;...<br>Destroying test database for alias &#x27;db_2&#x27;...<br>python manage.py test tests/  1.02s user 0.04s system 14% cpu 7.288 total<br></code></pre></td></tr></table></figure><p>å¾ˆå¥½ï¼Œä¸¤ä¸ªTestCaseéƒ½æµ‹è¯•é€šè¿‡ï¼ˆæ¯•ç«Ÿæ²¡æœ‰æ¯”è¿™æ›´ç®€å•çš„TestCaseäº†ï¼‰ã€‚ä¸€åˆ‡éƒ½çœ‹èµ·æ¥éå¸¸ç¾å¥½ï¼Œé™¤äº†è¿™æƒŠäººçš„å‘½ä»¤è€—æ—¶ï¼šä¸ºä»€ä¹ˆåˆ›å»º&amp;é”€æ¯ä¸¤ä¸ªæµ‹è¯•æ•°æ®åº“ä¼šæ¶ˆè€—7ç§’ä»¥ä¸Šçš„æ—¶é—´ï¼å¦‚æœä½ çœ‹è¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆä½ å¯èƒ½å·²ç»éšçº¦çŒœåˆ°åŸå› äº†ã€‚æ²¡é”™ï¼Œå¹•åé»‘æ‰‹è¿˜æ˜¯<code>migrate</code>å‘½ä»¤ã€‚</p><p>ä»Djangoæµ‹è¯•æ¨¡å—æºç ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/test/runner.py#L614">runner.py#L614</a>ï¼‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºTestCaseé‡Œæ‰€æœ‰çš„<code>databases</code>ï¼ˆæ¯”å¦‚ä¸Šé¢çš„<code>db_1</code>ã€<code>db_2</code>ï¼‰ï¼ŒDjangoéƒ½ä¼šåˆ›å»ºå¯¹åº”çš„æµ‹è¯•æ•°æ®åº“ï¼ˆ<code>test_db_1</code>ã€<code>test_db_2</code>ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªæµ‹è¯•æ•°æ®åº“æ‰§è¡Œä¸€æ¬¡<code>migrate</code>å‘½ä»¤ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/db/backends/base/creation.py#L67">creation.py#L67</a>ï¼‰ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°±å·²ç»çŸ¥é“<code>migrate</code>å‘½ä»¤ä¼šä¸€è‚¡è„‘åœ°å°†æ‰€æœ‰è¿ç§»æ–¹æ¡ˆéƒ½åº”ç”¨åˆ°æ•°æ®åº“ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ã€‚ç”¨<code>test</code>å‘½ä»¤çš„<code>--keepdb</code>é€‰é¡¹éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py <span class="hljs-built_in">test</span> tests/ --keepdb</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">... ç•¥</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:test_db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+</span><br><span class="hljs-operator">|</span> Tables_in_test_db_1        <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+</span><br><span class="hljs-operator">|</span> app_1_model1               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> app_2_model2               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> auth_group                 <span class="hljs-operator">|</span><br># ... ç•¥<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:test_db_2<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+</span><br><span class="hljs-operator">|</span> Tables_in_test_db_2        <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+</span><br><span class="hljs-operator">|</span> app_1_model1               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> app_2_model2               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> auth_group                 <span class="hljs-operator">|</span><br># ... ç•¥<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠæ³•åœ¨å¯¹<code>db_1</code>è¿›è¡Œæµ‹è¯•æ—¶ï¼Œåªåœ¨<code>test_db_1</code>è¿™ä¸ªæµ‹è¯•æ•°æ®åº“ä¸Šåˆ›å»ºåªå±äº<code>app_1</code>çš„<code>Model</code>å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p><h2 id="allow-migrate"><a href="#allow-migrate" class="headerlink" title="allow_migrate"></a>allow_migrate</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« çš„<code>DBRouter</code>æ•°æ®åº“è·¯ç”±ç±»ä¸­ï¼Œæˆ‘å°†<code>allow_migrate()</code>æ–¹æ³•çš„è¿”å›å€¼å›ºå®šä¸º<code>True</code>ï¼Œæ„å‘³ç€Djangoå¯ä»¥åœ¨ä»»ä½•æ•°æ®åº“ä¸Šã€å¯¹ä»»ä½•appè¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚è¿™å½“ç„¶æ˜¯ä¸€ç§æœ‰ç‚¹ä¸è´Ÿè´£ä»»çš„åšæ³•ï¼Œæ‰€ä»¥ï¼Œåªè¦ä¸¥æ ¼é™åˆ¶åœ¨<code>db_1</code>ä¸Šåªèƒ½è¿›è¡Œ<code>app_1</code>çš„è¿ç§»ã€åœ¨<code>db_2</code>ä¸Šåªèƒ½è¿›è¡Œ<code>app_2</code>çš„è¿ç§»ï¼Œå°±å¯ä»¥è¾¾æˆæˆ‘ä¸Šæ–‡æåˆ°çš„éœ€æ±‚äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-comment"># multi_db/db_routers.py</span><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> DEFAULT_DB_ALIAS<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DBRouter</span>:<br>    <span class="hljs-comment"># ... ç•¥</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">allow_migrate</span>(<span class="hljs-params">self, db, app_label, model_name=<span class="hljs-literal">None</span>, **hints</span>):<br>        <span class="hljs-keyword">return</span> db == settings.DB_ROUTING.get(app_label, DEFAULT_DB_ALIAS)<br></code></pre></td></tr></table></figure><h2 id="å¤§åŠŸå‘Šæˆ"><a href="#å¤§åŠŸå‘Šæˆ" class="headerlink" title="å¤§åŠŸå‘Šæˆ"></a>å¤§åŠŸå‘Šæˆ</h2><p>å†æ¬¡æ‰§è¡Œ<code>test</code>å‘½ä»¤ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾åœ°æ„Ÿå—åˆ°æ•ˆæœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">time python manage.py <span class="hljs-built_in">test</span> tests/</span><br>Creating test database for alias &#x27;db_1&#x27;...<br>Creating test database for alias &#x27;db_2&#x27;...<br><span class="hljs-meta prompt_"># </span><span class="language-bash">... ç•¥</span><br>python manage.py test tests/  0.74s user 0.02s system 57% cpu 1.320 total<br></code></pre></td></tr></table></figure><p>æ€»è€—æ—¶ç”±7ç§’ä¸‹é™è‡³1ç§’ã€‚å†ç”¨<code>--keepdb</code>é€‰é¡¹éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">mariadb root@127.0.0.1:test_db_1&gt; show tables                                   </span><br><span class="hljs-section">+---------------------+</span><br><span class="hljs-section">| Tables_in_test_db_1 |</span><br><span class="hljs-section">+---------------------+</span><br>| app<span class="hljs-emphasis">_1_model1        |</span><br><span class="hljs-emphasis">| django_</span>migrations   |<br><span class="hljs-code">+---------------------+</span><br></code></pre></td></tr></table></figure><p>å®Œç¾ã€‚</p><h1 id="ç¬¬å››å…³ï¼šè·¨åº“å¤–é”®çº¦æŸ"><a href="#ç¬¬å››å…³ï¼šè·¨åº“å¤–é”®çº¦æŸ" class="headerlink" title="ç¬¬å››å…³ï¼šè·¨åº“å¤–é”®çº¦æŸ"></a>ç¬¬å››å…³ï¼šè·¨åº“å¤–é”®çº¦æŸ</h1><p><img src="/images/2020/04/27/document.webp" alt="document.webp"></p><p>å¿…é¡»è¦è¯´çš„æ˜¯ï¼ŒDjangoï¼ˆè‡³å°‘åœ¨æ–‡æ¡£é‡Œï¼‰å¹¶ä¸æ”¯æŒè·¨æ•°æ®åº“çš„å¤–é”®çº¦æŸã€‚å½“ç„¶ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ç‰©ç†çº¦æŸï¼Œå³æ•°æ®åº“å±‚é¢çš„<code>CONSTRAINT</code>å­—æ®µçº¦æŸã€‚ä½†åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œç”±Djangoç®¡ç†çš„ã€é€»è¾‘ä¸Šçš„è·¨åº“å¤–é”®çº¦æŸå´å¹¶ä¸å°‘è§ï¼Œè¿™ç»™ç¨‹åºå‘˜å¸¦æ¥äº†å·¨å¤§çš„ä¾¿åˆ©â€”â€”ä½†ä»£ä»·æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»£ä»·å¾€å¾€æ˜¯æŠ›å¼ƒDjangoçš„æ•°æ®è¿ç§»æœºåˆ¶ã€‚</p><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>åœ¨<code>app_1</code>é‡Œåˆ›å»ºä¸€ä¸ªæ–°Modelï¼ˆçœç•¥å†…å®¹è§<a href="/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ï¼‰ï¼Œå¹¶ç”Ÿæˆå¯¹åº”è¿ç§»æ–¹æ¡ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app_1/models.py</span><br><span class="hljs-comment"># ... ç•¥</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChildModel1</span>(models.Model):<br>    name = models.CharField(max_length=<span class="hljs-number">255</span>)<br>    parent1 = models.ForeignKey(<span class="hljs-string">&quot;Model1&quot;</span>, on_delete=models.CASCADE)<br>    parent2 = models.ForeignKey(<span class="hljs-string">&quot;app_2.Model2&quot;</span>, on_delete=models.CASCADE)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py makemigrations</span>               <br>Migrations for &#x27;app_1&#x27;:<br>  app_1/migrations/0002_childmodel1.py<br>    - Create model ChildModel1<br></code></pre></td></tr></table></figure><h2 id="è¿ç§»"><a href="#è¿ç§»" class="headerlink" title="è¿ç§»"></a>è¿ç§»</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate app_1 --database db_1</span><br>Operations to perform:<br>  Apply all migrations: app_1<br>Running migrations:<br>  Applying app_2.0001_initial... OK<br>  Applying app_1.0002_childmodel1...<br><span class="hljs-meta prompt_"># </span><span class="language-bash">... ç•¥</span><br>django.db.utils.OperationalError: (1005, &#x27;Can\&#x27;t create table `db_1`.`app_1_childmodel1` (errno: 150 &quot;Foreign key constraint is incorrectly formed&quot;)&#x27;)<br></code></pre></td></tr></table></figure><p>æœä¸å…¶ç„¶ï¼ŒæŠ¥é”™äº†ã€‚Djangoæƒ³è¦åœ¨<code>db_1</code>ä¸Šåº”ç”¨<code>app_2</code>çš„è¿ç§»æ–¹æ¡ˆ<code>0001_initial</code>æ¥ä¸º<code>ChildModel1</code>çš„è¿ç§»é“ºè·¯ï¼Œä½†åœ¨ä¸Šä¸€å…³çš„<code>allow_migrate()</code>ä¸­æˆ‘å·²ç»ä¸¥æ ¼é™åˆ¶äº†æ•°æ®åº“å’Œappçš„å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥å®é™…ä¸Š<code>app_2.0001_initial</code>è¢«è·³è¿‡äº†ï¼ˆè™½ç„¶è¿˜æ˜¯åœ¨è¿ç§»è¿›åº¦é‡Œç•™ä¸‹äº†æˆåŠŸæ ‡è®°ï¼‰ã€‚</p><p>äºæ˜¯åˆ°äº†ç‰©ç†çº¦æŸéƒ¨åˆ†ï¼ŒDjangoæƒ³è¦åœ¨<code>db1</code>ä¸Šåˆ›å»ºä»<code>ChildModel1</code>åˆ°<code>Model2</code>çš„<code>CONSTRAINT</code>çº¦æŸå°±ä¸å¯èƒ½æˆåŠŸï¼šå› ä¸º<code>app_2.0001_inital</code>è¿™ä¸ªå‰æå¹¶æ²¡æœ‰å®é™…åº”ç”¨ã€‚æ‰“å¼€æ•°æ®åº“éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables                                        <br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> Tables_in_db_1    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> app_1_childmodel1 <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> app_1_model1      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> django_migrations <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br>mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> django_migrations<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> app   <span class="hljs-operator">|</span> name             <span class="hljs-operator">|</span> applied                    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">1</span>  <span class="hljs-operator">|</span> app_1 <span class="hljs-operator">|</span> <span class="hljs-number">0001</span>_initial     <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-number">-04</span><span class="hljs-number">-27</span> xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-number">2</span>  <span class="hljs-operator">|</span> app_2 <span class="hljs-operator">|</span> <span class="hljs-number">0001</span>_initial     <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-number">-04</span><span class="hljs-number">-27</span> xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-number">3</span>  <span class="hljs-operator">|</span> app_1 <span class="hljs-operator">|</span> <span class="hljs-number">0002</span>_childmodel1 <span class="hljs-operator">|</span> <span class="hljs-number">2020</span><span class="hljs-number">-04</span><span class="hljs-number">-27</span> xx:xx:xx.xxxxxx <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------+------------------+----------------------------+</span><br>mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> app_1_childmodel1<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `app_1_childmodel1` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `parent1_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `parent2_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `xxx` (`parent1_id`),<br>  <span class="hljs-keyword">CONSTRAINT</span> `xxx` <span class="hljs-keyword">FOREIGN</span> KEY (`parent1_id`) <span class="hljs-keyword">REFERENCES</span> `app_1_model1` (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci<br></code></pre></td></tr></table></figure><h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><p>å½“ç„¶ï¼Œå³ä½¿Djangoåœ¨åº”ç”¨è¿ç§»æ–¹æ¡ˆçš„æ—¶å€™æŠ¥é”™äº†ï¼Œä½†ç¼ºå¤±çš„åªæœ‰ä¸€ä¸ªæ•°æ®åº“å±‚é¢çš„çº¦æŸå­—æ®µï¼Œå¹¶ä¸å½±å“é€»è¾‘å±‚é¢çš„å¤–é”®çº¦æŸã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨Djangoé‡Œä½¿ç”¨è¿™ä¸ªModeläº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app_1/views.py</span><br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><span class="hljs-keyword">from</span> app_1.models <span class="hljs-keyword">import</span> ChildModel1, Model1<br><span class="hljs-keyword">from</span> app_2.models <span class="hljs-keyword">import</span> Model2<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">request</span>):<br>    child = ChildModel1.objects.create(<br>        name=<span class="hljs-string">&quot;carl&quot;</span>, parent1=Model1.objects.create(name=<span class="hljs-string">&quot;alice&quot;</span>),<br>        parent2=Model2.objects.create(name=<span class="hljs-string">&quot;bob&quot;</span>),<br>    )<br>    <span class="hljs-keyword">return</span> JsonResponse(&#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: child.name, <span class="hljs-string">&quot;parent1&quot;</span>: child.parent1.name,<br>        <span class="hljs-string">&quot;parent2&quot;</span>: child.parent2.name<br>    &#125;)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># multi_db/urls.py</span><br><span class="hljs-comment"># ... ç•¥</span><br><span class="hljs-keyword">from</span> app_1.views <span class="hljs-keyword">import</span> test<br><br>urlpatterns = [<br>    path(<span class="hljs-string">&#x27;admin/&#x27;</span>, admin.site.urls),<br>    path(<span class="hljs-string">&#x27;&#x27;</span>, test)<br>]<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py runserver 8000</span><br>Performing system checks...<br><br>Watching for file changes with StatReloader<br>System check identified no issues (0 silenced).<br>April 27, 2020 - xx:xx:xx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ–°termial</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl 127.0.0.1:8000</span><br>&#123;&quot;name&quot;: &quot;carl&quot;, &quot;parent1&quot;: &quot;alice&quot;, &quot;parent2&quot;: &quot;bob&quot;&#125;<br></code></pre></td></tr></table></figure><h2 id="TestCase"><a href="#TestCase" class="headerlink" title="TestCase"></a>TestCase</h2><p>åœ¨ä¸Šä¸€èŠ‚ä¸­å¯ä»¥è¿™æ ·è’™æ··è¿‡å…³ï¼Œæ˜¯å› ä¸º<code>migrate</code>å‘½ä»¤çš„å¤±è´¥å¹¶ä¸ä¼šå½±å“<code>runserver</code>å‘½ä»¤çš„æ‰§è¡Œï¼Œä½†åœ¨TestCaseé‡Œè¿™æ ·å°±è¡Œä¸é€šäº†ã€‚åœ¨ç¬¬ä¸‰å…³ä¸­æåˆ°ï¼ŒDjangoåœ¨è¿›è¡ŒTestCaseå‰ä¼šå¯¹æµ‹è¯•æ•°æ®åº“æ‰§è¡Œ<code>migrate</code>å‘½ä»¤ï¼Œè€Œ<code>migrate</code>çš„å¤±è´¥ä¼šå¯¼è‡´TestCaseç›´æ¥ç»“æŸã€‚</p><p>è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰å–æ¶ˆ<code>allow_migrate()</code>å¯¹app&amp;æ•°æ®åº“å¯¹åº”å…³ç³»çš„é™åˆ¶ã€åœ¨è¿è¡ŒTestCaseæ—¶ä½¿ç”¨sqlite3ï¼ˆé»˜è®¤ç¦ç”¨å¤–é”®çº¦æŸï¼‰ä½œä¸ºæµ‹è¯•æ•°æ®åº“ã€‚ä½†è¿™äº›éƒ½ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨æœ¬å…³å¼€å¤´æåˆ°ï¼Œè·¨åº“å¤–é”®çš„ä»£ä»·å¾€å¾€æ˜¯æŠ›å¼ƒDjangoçš„æ•°æ®è¿ç§»æœºåˆ¶ã€‚</p><p>è¦æƒ³ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±åªæœ‰é¿å…å‡ºç°ç‰©ç†ä¸Šçš„å¤–é”®çº¦æŸï¼Œåªç”±Djangoè¿›è¡Œé€»è¾‘ä¸Šçš„å¤–é”®çº¦æŸç®¡ç†ã€‚è¿™ä¸ªè¯é¢˜ï¼Œå°±ç•™åˆ°ä¸‹ç¯‡æ–‡ç« å†è®²å§ã€‚ï¼ˆæˆ‘æ€ä¹ˆæ„Ÿè§‰æˆ‘è¦è¢«æ‰“äº†â€¦â€¦ï¼‰</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>Django</tag>
      
      <tag>å¤šæ•°æ®åº“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoå¤šæ•°æ®åº“å†é™©è®°ï¼ˆä¸€ï¼‰</title>
    <link href="/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2020/04/23/Django%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%86%E9%99%A9%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ¯«æ— ç–‘é—®ï¼ŒDjangoæ˜¯æœ€ä¼˜ç§€çš„Python Webæ¡†æ¶ä¹‹ä¸€ï¼Œç„¶è€Œå…¶å¯¹å¤šæ•°æ®åº“çš„æ”¯æŒå´è®©æˆ‘å†…å¿ƒååˆ†å¤æ‚ã€‚åœ¨æ•°æ®åº“è¿ç§»ã€è·¨åº“å¤–é”®ã€å•å…ƒæµ‹è¯•ç­‰æ–¹é¢ï¼Œå‘æ— å¤„ä¸åœ¨ã€‚äºæ˜¯å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ï¼Œå…³äºDjangoå¤šæ•°æ®åº“çš„å†é™©è®°ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬ç¯‡æ–‡ç« ä½¿ç”¨<code>Python 3.6</code>+<code>Django 2.2</code></p></blockquote><h1 id="å‡†å¤‡å‡ºå‘"><a href="#å‡†å¤‡å‡ºå‘" class="headerlink" title="å‡†å¤‡å‡ºå‘"></a>å‡†å¤‡å‡ºå‘</h1><ol><li><p>åˆ›å»ºDjangoé¡¹ç›®<code>multi_db</code>å’Œä¸¤ä¸ªappï¼š<code>app_1</code>å’Œ<code>app_2</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">django-admin startproject multi_db</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> multi_db/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py startapp app_1</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py startapp app_2</span><br></code></pre></td></tr></table></figure></li><li><p>åœ¨<code>app_1</code>å’Œ<code>app_2</code>é‡Œåˆ†åˆ«æ·»åŠ å„è‡ªçš„<code>Model</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app_1/models.py</span><br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model1</span>(models.Model):<br>    name = models.CharField(max_length=<span class="hljs-number">255</span>)<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Meta</span>:<br>        app_label = <span class="hljs-string">&quot;app_1&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app_2/models.py</span><br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model2</span>(models.Model):<br>    name = models.CharField(max_length=<span class="hljs-number">255</span>)<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Meta</span>:<br>        app_label = <span class="hljs-string">&quot;app_2&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>ä¸ºä¸¤ä¸ªappæŒ‡å®šä¸åŒçš„æ•°æ®åº“å¹¶ä¸ºå…¶ç¼–å†™è·¯ç”±æ–‡ä»¶ï¼ˆçœç•¥éƒ¨åˆ†å†…å®¹ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># multi_db/settings.py</span><br><span class="hljs-comment"># ...</span><br>INSTALLED_APPS = [<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-string">&#x27;app_1&#x27;</span>,<br>    <span class="hljs-string">&#x27;app_2&#x27;</span>,<br>]<br><span class="hljs-comment"># ...</span><br>DATABASES = &#123;<br>    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.sqlite3&#x27;</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="hljs-string">&#x27;db.sqlite3&#x27;</span>),<br>    &#125;,<br>    <span class="hljs-string">&#x27;db_1&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>, <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;db_1&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-string">&#x27;6603&#x27;</span>, <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;password&#x27;</span>, <span class="hljs-string">&#x27;CHARSET&#x27;</span>: <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;TEST&#x27;</span>: &#123;<span class="hljs-string">&#x27;DEPENDENCIES&#x27;</span>: []&#125;,<br>    &#125;,<br>    <span class="hljs-string">&#x27;db_2&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>, <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;db_2&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-string">&#x27;6603&#x27;</span>, <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;password&#x27;</span>, <span class="hljs-string">&#x27;CHARSET&#x27;</span>: <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;TEST&#x27;</span>: &#123;<span class="hljs-string">&#x27;DEPENDENCIES&#x27;</span>: []&#125;,<br>    &#125;,<br>&#125;<br>DB_ROUTING = &#123;<span class="hljs-string">&#x27;app_1&#x27;</span>: <span class="hljs-string">&#x27;db_1&#x27;</span>, <span class="hljs-string">&#x27;app_2&#x27;</span>: <span class="hljs-string">&#x27;db_2&#x27;</span>&#125;<br>DATABASE_ROUTERS = [<span class="hljs-string">&#x27;multi_db.db_routers.DBRouter&#x27;</span>]<br><span class="hljs-comment"># ...</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># multi_db/db_routers.py</span><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DBRouter</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">db_for_read</span>(<span class="hljs-params">self, model, **hints</span>):<br>        <span class="hljs-keyword">return</span> settings.DB_ROUTING.get(model._meta.app_label)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">db_for_write</span>(<span class="hljs-params">self, model, **hints</span>):<br>        <span class="hljs-keyword">return</span> settings.DB_ROUTING.get(model._meta.app_label)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">allow_relation</span>(<span class="hljs-params">self, obj1, obj2, **hints</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">allow_migrate</span>(<span class="hljs-params">self, db, app_label, model_name=<span class="hljs-literal">None</span>, **hints</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure></li></ol><h1 id="ç¬¬ä¸€å…³ï¼šæ•°æ®è¿ç§»"><a href="#ç¬¬ä¸€å…³ï¼šæ•°æ®è¿ç§»" class="headerlink" title="ç¬¬ä¸€å…³ï¼šæ•°æ®è¿ç§»"></a>ç¬¬ä¸€å…³ï¼šæ•°æ®è¿ç§»</h1><p>Djangoé‡Œæ•°æ®åº“è¿ç§»åˆ†ä¸¤éƒ¨åˆ†ï¼Œ<code>makemigrations</code>å’Œ<code>migrate</code>ã€‚å‰è€…è´Ÿè´£åœ¨Modelå‡ºç°å˜åŠ¨æ—¶ç”Ÿæˆè¿ç§»æ–¹æ¡ˆæ–‡ä»¶ï¼Œåè€…åˆ™è´Ÿè´£åœ¨æ•°æ®åº“ä¸­åº”ç”¨å‰è€…çš„è¿ç§»æ–¹æ¡ˆã€‚äºæ˜¯ï¼Œéº»çƒ¦æ¥äº†ã€‚</p><h2 id="makemigrations"><a href="#makemigrations" class="headerlink" title="makemigrations"></a>makemigrations</h2><p><code>makemigrations</code>å‘½ä»¤ä¸æ¶‰åŠæ•°æ®åº“æ“ä½œï¼Œæ‰€ä»¥ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ã€‚ä½¿ç”¨æ—¶å¯ä»¥æŒ‡å®šappä»¥æ£€æµ‹éƒ¨åˆ†Modelï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šappä»¥æ£€æµ‹å…¨éƒ¨Modelã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py makemigrations</span><br>Migrations for &#x27;app_1&#x27;:<br>  app_1/migrations/0001_initial.py<br>    - Create model Model1<br>Migrations for &#x27;app_2&#x27;:<br>  app_2/migrations/0001_initial.py<br>    - Create model Model2<br></code></pre></td></tr></table></figure><p>OKï¼Œä¸¤ä¸ªappçš„è¿ç§»æ–¹æ¡ˆæ–‡ä»¶å°±ç”Ÿæˆå¥½äº†ã€‚Djangoå†…ç½®çš„ä¸€äº›appï¼ˆæ¯”å¦‚<code>django.contrib.auth</code>ï¼‰å·²ç»<a href="https://github.com/django/django/blob/2.2.12/django/contrib/auth/migrations">è‡ªå¸¦è¿ç§»æ–¹æ¡ˆ</a>ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰ç”Ÿæˆè¿ç§»æ–¹æ¡ˆæ–‡ä»¶ã€‚</p><h2 id="migrate"><a href="#migrate" class="headerlink" title="migrate"></a>migrate</h2><p><code>migrate</code>å‘½ä»¤å’Œ<code>makemigrations</code>ä¸€æ ·ï¼Œå¯ä»¥æŒ‡å®šappã€‚è¿™é‡Œæˆ‘ä»¬ä¸æŒ‡å®šappï¼Œç›´æ¥åº”ç”¨æ‰€æœ‰è¿ç§»æ–¹æ¡ˆã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">multi_db python manage.py migrate</span><br>Operations to perform:<br>  Apply all migrations: admin, app_1, app_2, auth, contenttypes, sessions<br>Running migrations:<br>  Applying contenttypes.0001_initial... OK<br>  Applying auth.0001_initial... OK<br>  Applying admin.0001_initial... OK<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">...</span><br>  Applying app_1.0001_initial... OK<br>  Applying app_2.0001_initial... OK<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">...</span><br>  Applying sessions.0001_initial... OK<br></code></pre></td></tr></table></figure><p>å¾ˆå¥½ï¼ŒåŒ…æ‹¬å†…ç½®appã€è‡ªå®šä¹‰appçš„æ‰€æœ‰è¿ç§»æ–¹æ¡ˆå…¨éƒ¨å®Œæˆã€‚æŒ‰ç…§å‰é¢çš„é…ç½®ï¼Œé»˜è®¤çš„<code>db.sqlite3</code>é‡Œåº”è¯¥å‡ºç°Djangoå†…ç½®appçš„Modelã€<code>db_1</code>é‡Œåº”è¯¥å‡ºç°<code>app_1</code>çš„Modelã€<code>db2</code>é‡Œåº”è¯¥å‡ºç°<code>app_2</code>çš„Modelï¼Œå¯¹å§ï¼Ÿ</p><p>ç°å®æ˜¯æ®‹é…·çš„ã€‚ä»<code>migrate</code>æ¨¡å—çš„æºç ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/core/management/commands/migrate.py#L81">migrate.py#L81</a>ï¼‰å¯ä»¥çœ‹å‡ºï¼Œ<code>migrate</code>åœ¨åº”ç”¨è¿ç§»æ–¹æ¡ˆæ—¶æ ¹æœ¬ä¸ä¼šè€ƒè™‘<code>DATABASE_ROUTERS</code>é‡Œçš„<code>db_for_read</code>å’Œ<code>db_for_write</code>ï¼Œåªä¼šå¯¹å‚æ•°<code>--database</code>æŒ‡å®šçš„æ•°æ®åº“ï¼ˆå¦‚ä¸æŒ‡å®šåˆ™ä¸ºé»˜è®¤æ•°æ®åº“ï¼‰è¿›è¡Œæ“ä½œâ€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œæ‰€æœ‰çš„Modeléƒ½è¢«ä¸€è‚¡è„‘å†™å…¥åˆ°äº†é»˜è®¤çš„<code>db.sqlite3</code>ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sqlite3 db.sqlite3 .tables</span><br>app_1_model1                auth_user_groups<br>app_2_model2                auth_user_user_permissions<br>auth_group                  django_admin_log<br>auth_group_permissions      django_content_type<br>auth_permission             django_migrations<br>auth_user                   django_session<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸æ˜¯æˆ‘æƒ³è¦çš„ã€‚å¦‚ä½•è¡¥æ•‘å‘¢ï¼Ÿæªæ–½æœ‰ä¸¤ç§ã€‚</p><h3 id="è¡¥æ•‘æªæ–½1"><a href="#è¡¥æ•‘æªæ–½1" class="headerlink" title="è¡¥æ•‘æªæ–½1"></a>è¡¥æ•‘æªæ–½1</h3><p>ç¬¬ä¸€ç§è¡¥æ•‘æªæ–½æ˜¯åœ¨ç”Ÿæˆè‡ªå®šä¹‰appçš„è¿ç§»æ–¹æ¡ˆä¹‹å‰æŠ¢å…ˆå®Œæˆå¯¹å†…ç½®appçš„è¿ç§»æ–¹æ¡ˆï¼Œç„¶åå†è¿›è¡Œè‡ªå®šä¹‰appçš„è¿ç§»ã€‚è¿™ç§æªæ–½éœ€è¦åˆ é™¤å·²ç»ç”Ÿæˆå¥½çš„è¿ç§»æ–¹æ¡ˆæ–‡ä»¶ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¡¥æ•‘æªæ–½æœ‰ç‚¹è€æ»‘å¤´äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> db.sqlite3</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> app_?/migrations/0001_initial.py</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-comment"># è¿ç§»å†…ç½®app</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate</span><br>Operations to perform:<br>  Apply all migrations: admin, auth, contenttypes, sessions<br>Running migrations:<br>  Applying contenttypes.0001_initial... OK<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-comment"># é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰appçš„modelçš„è¿ç§»æ–¹æ¡ˆ</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py makemigrations</span><br>Migrations for &#x27;app_1&#x27;:<br>  app_1/migrations/0001_initial.py<br>    - Create model Model1<br>Migrations for &#x27;app_2&#x27;:<br>  app_2/migrations/0001_initial.py<br>    - Create model Model2<br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-comment"># è¿ç§»æ—¶æŒ‡å®šæ•°æ®åº“</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate app_1 --database db_1</span><br>Operations to perform:<br>  Apply all migrations: app_1<br>Running migrations:<br>  Applying app_1.0001_initial... OK<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate app_2 --database db_2</span><br>Operations to perform:<br>  Apply all migrations: app_2<br>Running migrations:<br>  Applying app_2.0001_initial... OK<br></code></pre></td></tr></table></figure><h3 id="è¡¥æ•‘æªæ–½2"><a href="#è¡¥æ•‘æªæ–½2" class="headerlink" title="è¡¥æ•‘æªæ–½2"></a>è¡¥æ•‘æªæ–½2</h3><p>ç¬¬äºŒç§è¡¥æ•‘æªæ–½ä¸å¿…åˆ é™¤å·²ç»ç”Ÿæˆå¥½çš„è‡ªå®šä¹‰appçš„è¿ç§»æ–¹æ¡ˆæ–‡ä»¶ï¼Œè€Œæ˜¯å•ç‹¬è¿ç§»å†…ç½®appã€‚è™½ç„¶<code>migrate</code>å‘½ä»¤ä¸€æ¬¡åªèƒ½è¿ç§»ä¸€ä¸ªappï¼Œä½†æ‰€å¹¸éœ€è¦ç”¨åˆ°çš„å†…ç½®appä¸€èˆ¬ä¸ä¼šå¤ªå¤šã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> db.sqlite3</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate admin</span><br>Operations to perform:<br>  Apply all migrations: admin<br>Running migrations:<br>  Applying contenttypes.0001_initial... OK<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate auth</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate contenttypes</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate sessions</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-comment"># å•ç‹¬è¿ç§»å®Œå†…ç½®appåå†è¿ç§»è‡ªå®šä¹‰app</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate app_1 --database db_1</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py migrate app_2 --database db_2</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br><br></code></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰migrate"><a href="#è‡ªå®šä¹‰migrate" class="headerlink" title="è‡ªå®šä¹‰migrate"></a>è‡ªå®šä¹‰migrate</h2><p>å‰æ–‡æåˆ°çš„ä¸¤ä¸ªè¡¥æ•‘æªæ–½ç»ˆç©¶åªæ˜¯ä¸€æ—¶çš„æƒå®œä¹‹è®¡ï¼Œç”¨èµ·æ¥ä¹Ÿå¾ˆéº»çƒ¦ã€‚åæ­£åªæ˜¯å¤šè¿è¡Œå‡ æ¬¡<code>migrate</code>å‘½ä»¤ï¼Œä¸ºä»€ä¹ˆä¸äº¤ç»™pythonæ¥åšå‘¢ï¼Ÿç¼–è¾‘<code>my_migrate.py</code>å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># my_migrate.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">import</span> django<br><span class="hljs-keyword">from</span> django.apps <span class="hljs-keyword">import</span> apps, AppConfig<br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.management <span class="hljs-keyword">import</span> execute_from_command_line, CommandError<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> DEFAULT_DB_ALIAS<br><br>os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;multi_db.settings&#x27;</span>)<br>django.setup()<br><br><span class="hljs-keyword">for</span> app_config <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(apps.get_app_configs()):  <span class="hljs-comment"># type: AppConfig</span><br>    app_label = app_config.label  <span class="hljs-comment"># type: <span class="hljs-built_in">str</span></span><br>    db = settings.DB_ROUTING.get(app_config.label, DEFAULT_DB_ALIAS)<br>    argv = [<span class="hljs-string">&quot;manage.py&quot;</span>, <span class="hljs-string">&quot;migrate&quot;</span>, <span class="hljs-string">&quot;--traceback&quot;</span>, <span class="hljs-string">&quot;--database&quot;</span>, db, app_label]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;python &quot;</span> + <span class="hljs-string">&quot; &quot;</span>.join(argv))<br>    <span class="hljs-keyword">try</span>:<br>        execute_from_command_line(argv)<br>    <span class="hljs-keyword">except</span> CommandError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-built_in">print</span>()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;migrate complete&quot;</span>)<br><br></code></pre></td></tr></table></figure><p>ä¸€è‚¡ç†Ÿæ‚‰çš„å‘³é“â€¦â€¦æ²¡é”™ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯<code>manage.py</code>çš„é­”æ”¹ç‰ˆæœ¬ã€‚ä»£ç åœ¨<code>migrate</code>æŸappä¹‹å‰ä¼šå»é…ç½®æ–‡ä»¶é‡Œçš„<code>DB_ROUTING</code>å­—å…¸æŸ¥æ‰¾è¯¥appå¯¹åº”çš„æ•°æ®åº“ï¼Œå†ç”¨è¿™ä¸ªæ•°æ®åº“æ¥<code>migrate</code>è¿™ä¸ªappã€‚è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python my_migrate.py</span><br>python manage.py migrate --traceback --database default admin<br>Operations to perform:<br>  Apply all migrations: admin<br>Running migrations:<br>  Applying contenttypes.0001_initial... OK<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">... ç•¥</span><br><br>python manage.py migrate --traceback --database db_1 app_1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">... ç•¥</span><br></code></pre></td></tr></table></figure><h2 id="å¤§åŠŸå‘Šæˆ"><a href="#å¤§åŠŸå‘Šæˆ" class="headerlink" title="å¤§åŠŸå‘Šæˆ"></a>å¤§åŠŸå‘Šæˆ</h2><p>äºæ˜¯ï¼Œè¿™ä¸ªDjangoé¡¹ç›®çš„æ•°æ®åº“è¿ç§»å·¥ä½œç»ˆäºå®Œæˆäº†ï¼Œå¤ªä¸å®¹æ˜“äº†â€¦â€¦éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sqlite3 db.sqlite3 .tables</span><br>auth_group                  auth_user_user_permissions<br>auth_group_permissions      django_admin_log<br>auth_permission             django_content_type<br>auth_user                   django_migrations<br>auth_user_groups            django_session<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_1<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> Tables_in_db_1    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> app_1_model1      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> django_migrations <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mariadb root<span class="hljs-variable">@127</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:db_2<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> tables<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> Tables_in_db_2    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> app_2_model2      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> django_migrations <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬äºŒå…³ï¼šè¿è¡Œ"><a href="#ç¬¬äºŒå…³ï¼šè¿è¡Œ" class="headerlink" title="ç¬¬äºŒå…³ï¼šè¿è¡Œ"></a>ç¬¬äºŒå…³ï¼šè¿è¡Œ</h1><p>æ•°æ®åº“è¿ç§»ï¼ˆç»ˆäºï¼‰å®Œæˆåï¼Œè¯¥è¿è¡Œè¿™ä¸ªDjangoé¡¹ç›®äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py runserver</span><br>Watching for file changes with StatReloader<br>Performing system checks...<br>System check identified no issues (0 silenced).<br>You have 2 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): app_1, app_2.<br>Run &#x27;python manage.py migrate&#x27; to apply them.<br>April 23, 2020 - xx:xx:xx<br></code></pre></td></tr></table></figure><p>ç­‰ç­‰ï¼Œä¸ºä»€ä¹ˆæˆ‘åœ¨ä¸Šä¸€æ­¥å·²ç»å®Œæˆäº†å…¨éƒ¨è¿ç§»å·¥ä½œï¼ŒDjangoè¿˜ä¼šæç¤º<code>app_1</code>å’Œ<code>app_2</code>æœªè¿ç§»ï¼Ÿè™½ç„¶è¿™å¹¶ä¸å½±å“è¿è¡Œï¼Œä½†é²œçº¢çš„æç¤ºæ€»æ˜¯ä»¤äººä¸çˆ½ã€‚</p><p>ä»<code>apply_migration()</code>çš„æºç ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/db/migrations/executor.py#L246">executor.py#L246</a>ï¼‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨<code>migrate</code>å‘½ä»¤è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œå®Œä¸€æ¡è¿ç§»ä»»åŠ¡ï¼ŒDjangoéƒ½ä¼šåœ¨åŒæ•°æ®åº“çš„<code>django_migrations</code>è¡¨ä¸­å†™å…¥ä¸€æ¡è¿ç§»å®Œæˆçš„æ ‡è®°ï¼Œç”¨äºè®°å½•è¿ç§»è¿›åº¦ã€‚å®é™…ä¸Šï¼Œ<code>db_1</code>å’Œ<code>db_2</code>çš„<code>django_migrations</code>ä¹Ÿæ˜¯æœ‰å¯¹åº”æ ‡è®°çš„ã€‚</p><p>ä½†ä»æ¨¡å—<code>check_migrations()</code>çš„æºç ï¼ˆ<a href="https://github.com/django/django/blob/2.2.12/django/core/management/base.py#L453">base.py#L453</a>ï¼‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨è¿è¡Œ<code>runserver</code>å‘½ä»¤æ—¶ï¼ŒDjangoåªä¼šåˆ°é»˜è®¤æ•°æ®åº“çš„<code>django_migrations</code>è¡¨ä¸­æŸ¥æ‰¾è¿ç§»è¿›åº¦ï¼Œ<code>db_1</code>å’Œ<code>db_2</code>çš„è¿ç§»è¿›åº¦å°±è¢«æ— è§†äº†â€¦â€¦é‚£ä¹ˆï¼Œæ€æ ·æ‰èƒ½è®©åœ¨è¿è¡Œ<code>runserver</code>æ—¶æ£€æŸ¥éé»˜è®¤æ•°æ®åº“çš„è¿ç§»è¿›åº¦å‘¢ï¼Ÿ</p><h2 id="è‡ªå®šä¹‰check-migrations"><a href="#è‡ªå®šä¹‰check-migrations" class="headerlink" title="è‡ªå®šä¹‰check_migrations"></a>è‡ªå®šä¹‰check_migrations</h2><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¿®æ”¹<code>runserver</code>é‡Œ<code>check_migrations()</code>çš„è¡Œä¸ºã€‚å…ˆæ¥çœ‹çœ‹åŸå§‹çš„<code>check_migrations()</code>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_migrations</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">from</span> django.db.migrations.executor <span class="hljs-keyword">import</span> MigrationExecutor<br>    <span class="hljs-keyword">try</span>:<br>        executor = MigrationExecutor(connections[DEFAULT_DB_ALIAS])<br>    <span class="hljs-keyword">except</span> ImproperlyConfigured:<br>        <span class="hljs-comment"># No databases are configured (or the dummy one)</span><br>        <span class="hljs-keyword">return</span><br><br>    plan = executor.migration_plan(executor.loader.graph.leaf_nodes())<br>    <span class="hljs-keyword">if</span> plan:<br>        <span class="hljs-comment"># æç¤ºæœªmigrateçš„appï¼Œçœç•¥</span><br>        self.stdout.write(self.style.NOTICE(<span class="hljs-string">&quot;Run &#x27;python manage.py migrate&#x27; to apply them.\n&quot;</span>))<br></code></pre></td></tr></table></figure><p>æ€»ä½“é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå…³é”®åœ¨äº<code>executor</code>å¯¹è±¡çš„<code>migration_plan()</code>æ–¹æ³•ã€‚æˆ‘è¦åšçš„å°±æ˜¯å¼•å…¥<code>db_1</code>å’Œ<code>db_2</code>çš„<code>executor</code>ï¼Œè®©æ¯ä¸ªæ•°æ®åº“åªæ£€æŸ¥è‡ªå·±çš„è¿ç§»è¿›åº¦ã€‚ä¸‹é¢æ˜¯æˆ‘è‡ªå·±å®ç°çš„<code>check_migrations()</code>æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># multi_db/my_runserver.py</span><br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict<br><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.management.commands <span class="hljs-keyword">import</span> runserver<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connections, DEFAULT_DB_ALIAS<br><span class="hljs-keyword">from</span> django.db.migrations.executor <span class="hljs-keyword">import</span> MigrationExecutor<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCommand</span>(runserver.Command):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_migrations</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># ä¸ºæ¯ä¸ªæ•°æ®åº“è¿æ¥åˆ›å»ºä¸€ä¸ªexecutorå¹¶æ”¾åˆ°å­—å…¸é‡Œ</span><br>        executors = &#123;&#125;<br>        <span class="hljs-keyword">for</span> alias <span class="hljs-keyword">in</span> connections:<br>            executors[alias] = MigrationExecutor(connections[alias])<br>        default_executor = executors[DEFAULT_DB_ALIAS]<br>        <span class="hljs-comment"># è·å–è¿ç§»ä»»åŠ¡åˆ—è¡¨ï¼ˆnodesï¼‰</span><br>        <span class="hljs-comment"># nodesæ˜¯ä¸€ä¸ªtupleçš„listï¼Œæ¯ä¸ªtupleçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯appçš„åç§°</span><br>        nodes = default_executor.loader.graph.leaf_nodes()<br>        <span class="hljs-comment"># æŒ‰appåç§°å°†nodeåˆ†ç±»</span><br>        node_map = defaultdict(<span class="hljs-built_in">list</span>)<br>        <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> nodes:  <span class="hljs-comment"># type: <span class="hljs-built_in">tuple</span></span><br>            alias = settings.DB_ROUTING.get(node[<span class="hljs-number">0</span>], DEFAULT_DB_ALIAS)<br>            node_map[alias].append(node)<br>        <span class="hljs-comment"># è®©æ¯ä¸ªexecutoræ£€æŸ¥å„è‡ªçš„è¿ç§»ä»»åŠ¡æ˜¯å¦å®Œæˆ</span><br>        plan = []<br>        <span class="hljs-keyword">for</span> alias, executor <span class="hljs-keyword">in</span> executors.items():<br>            plan.extend(executor.migration_plan(node_map[alias]))<br><br>        <span class="hljs-keyword">if</span> plan:<br>            <span class="hljs-comment"># æç¤ºæœªmigrateçš„appï¼ŒåŒåŸå‡½æ•°ï¼Œçœç•¥</span><br>            self.stdout.write(self.style.NOTICE(<span class="hljs-string">&quot;Run &#x27;python manage.py migrate&#x27; to apply them.\n&quot;</span>))<br></code></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥å°±æ˜¯è®©<code>manager.py</code>ä½¿ç”¨æˆ‘è¿™ä¸ª<code>check_migrations()</code>è€Œä¸æ˜¯Djangoå†…ç½®çš„<code>check_migrations()</code>ã€‚åœ¨<code>manager.py</code>çš„æ–‡ä»¶å¤´ä¿®æ”¹ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-string">&quot;&quot;&quot;Django&#x27;s command-line utility for administrative tasks.&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">from</span> multi_db.my_runserver <span class="hljs-keyword">import</span> MyCommand<br><span class="hljs-keyword">from</span> django.core.management.commands <span class="hljs-keyword">import</span> runserver<br><br>runserver.Command = MyCommand<br><span class="hljs-comment"># ... ç•¥</span><br></code></pre></td></tr></table></figure><h2 id="å¤§åŠŸå‘Šæˆ-1"><a href="#å¤§åŠŸå‘Šæˆ-1" class="headerlink" title="å¤§åŠŸå‘Šæˆ"></a>å¤§åŠŸå‘Šæˆ</h2><p>è¿è¡Œçœ‹çœ‹æ•ˆæœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python manage.py runserver</span><br>Watching for file changes with StatReloader<br>Performing system checks...<br><br>System check identified no issues (0 silenced).<br>April 23, 2020 - xx:xx:xx<br></code></pre></td></tr></table></figure><p>ç»ˆäºä¸æç¤ºè¿˜æœ‰<code>unapplied migration</code>äº†â€¦â€¦æˆ‘å“­äº†ï¼Œä½ å‘¢ï¼Ÿ</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>Django</tag>
      
      <tag>å¤šæ•°æ®åº“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoè§†å›¾å‡½æ•°æ€§èƒ½åˆ†æï¼ˆç»­ï¼‰</title>
    <link href="/2020/04/19/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E7%BB%AD%EF%BC%89/"/>
    <url>/2020/04/19/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E7%BB%AD%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2020/04/19/django.png" alt="django.png"></p><p>åœ¨<a href="/2019/03/11/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">ä»¥å‰çš„æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»‹ç»äº†ä¸¤ç§åˆ†æDjangoè§†å›¾å‡½æ•°æ€§èƒ½çš„å·¥å…·ï¼š<code>Django Debug Toolbar</code>å’Œ<code>cProfileä¸­é—´ä»¶</code>ã€‚åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‰è€…çš„SQLæ‰§è¡Œåˆ†ææ˜¯ç›¸å½“å®ç”¨çš„åŠŸèƒ½ã€‚</p><p>ä½†ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œ<code>Django Debug Toolbar</code>åªèƒ½åœ¨æµè§ˆå™¨é‡Œåˆ†æå“åº”ç±»å‹ä¸ºHTMLçš„è§†å›¾å‡½æ•°ï¼Œè¿™å°±å¯¼è‡´å“åº”ç±»å‹ä¸ºJSONçš„è§†å›¾å‡½æ•°å¿…é¡»è¦å€ŸåŠ©<code>Django Rest Framework</code>æ¡†æ¶ä¸­çš„<code>HTMLRenderer</code>ç­‰æ‰‹æ®µä¿®æ”¹è‡ªèº«çš„å“åº”ç±»å‹ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨è¯¥å·¥å…·ã€‚</p><p>é‚£æœ‰æ²¡æœ‰æ›´ç›´æ¥çš„æ‰‹æ®µï¼Œæ¥ä¸ºJSONè§†å›¾å‡½æ•°åˆ†æSQLæ‰§è¡Œæƒ…å†µå‘¢ï¼Ÿè¿™å°±æ˜¯æ–‡æœ¬è¦æ¢ç©¶çš„é—®é¢˜ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬æ–‡æ‰€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒä¸º<code>Python 3.6</code>+<code>Django 2.2</code></p></blockquote><h1 id="Djangoä¸­çš„SQLæ‰§è¡Œ"><a href="#Djangoä¸­çš„SQLæ‰§è¡Œ" class="headerlink" title="Djangoä¸­çš„SQLæ‰§è¡Œ"></a>Djangoä¸­çš„SQLæ‰§è¡Œ</h1><p>åœ¨æŸ¥é˜…äº†ç›¸å…³æ–‡æ¡£åï¼Œæˆ‘å‘ç°äº‹æƒ…æ¯”æˆ‘æƒ³è±¡ä¸­çš„ç®€å•ã€‚åœ¨Djangoå®˜æ–¹æ–‡æ¡£ä¸­çš„<a href="https://docs.djangoproject.com/en/2.2/faq/models/">FAQ: Databases and models</a>æœ‰è¿™æ ·çš„æè¿°ï¼š</p><p><img src="/images/2020/04/19/document.webp" alt="document.webp"></p><p>å¦‚æ­¤ä¸€æ¥æ–¹æ³•å°±å¾ˆæ¸…æ™°äº†ï¼šå†™ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå°†<code>connection.queries</code>é‡Œçš„å†…å®¹æ’å…¥åˆ°JSONå“åº”ä¸­ã€‚ä¸­é—´ä»¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.exceptions <span class="hljs-keyword">import</span> MiddlewareNotUsed<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connections<br><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileMiddleware</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    ignore_sql = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, get_response</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.DEBUG:<br>            <span class="hljs-keyword">raise</span> MiddlewareNotUsed  <span class="hljs-comment"># åªåœ¨DEBUGæ¨¡å¼ä¸‹å¯ç”¨è¯¥ä¸­é—´ä»¶</span><br><br>        self.get_response = get_response<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, request</span>):<br>        response = self.get_response(request)  <span class="hljs-comment"># type: HttpResponse</span><br>        <span class="hljs-comment"># æ ¹æ®urlå‚æ•°å’Œè¿”å›ç±»å‹åˆ¤æ–­æ˜¯å¦åº”è¯¥æ’å…¥SQLæ‰§è¡Œä¿¡æ¯</span><br>        <span class="hljs-keyword">if</span> request.GET.get(<span class="hljs-string">&quot;profile&quot;</span>) == <span class="hljs-string">&quot;db&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;application/json&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">repr</span>(response):<br>            <span class="hljs-keyword">try</span>:<br>                data = json.loads(response.content)<br>            <span class="hljs-keyword">except</span> (TypeError, ValueError):<br>                <span class="hljs-keyword">return</span> response  <span class="hljs-comment"># è§£æjsonå¤±è´¥</span><br>            <span class="hljs-comment"># æ’å…¥sqlæ‰§è¡Œä¿¡æ¯</span><br>            sql_queries = []<br>            <span class="hljs-keyword">for</span> alias <span class="hljs-keyword">in</span> connections:<br>                <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> connections[alias].queries:<br>                    <span class="hljs-keyword">if</span> query[<span class="hljs-string">&quot;sql&quot;</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.ignore_sql:<br>                        query[<span class="hljs-string">&quot;using&quot;</span>] = alias<br>                        sql_queries.append(query)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">dict</span>):<br>                data[<span class="hljs-string">&quot;_debug_sql&quot;</span>] = sql_queries<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">list</span>):<br>                data.append(&#123;<span class="hljs-string">&quot;_debug_sql&quot;</span>: sql_queries&#125;)<br>            response.content = json.dumps(data)<br><br>        <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>å†™ä¸ªç®€å•è§†å›¾å‡½æ•°æ¥éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_count</span>(<span class="hljs-params">request</span>):<br>    data = &#123;<span class="hljs-string">&quot;count&quot;</span>: User.objects.count()&#125;<br>    <span class="hljs-keyword">return</span> JsonResponse(data)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -s localhost:8000/user_count/\?profile=db | python3 -m json.tool</span><br>&#123;<br>    &quot;count&quot;: 0,<br>    &quot;_debug_sql&quot;: [<br>        &#123;<br>            &quot;sql&quot;: &quot;SELECT COUNT(*) AS \&quot;__count\&quot; FROM \&quot;auth_user\&quot;&quot;,<br>            &quot;time&quot;: &quot;0.000&quot;,<br>            &quot;using&quot;: &quot;default&quot;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å’ŒcProfileä¸­é—´ä»¶ç»„åˆ"><a href="#å’ŒcProfileä¸­é—´ä»¶ç»„åˆ" class="headerlink" title="å’ŒcProfileä¸­é—´ä»¶ç»„åˆ"></a>å’ŒcProfileä¸­é—´ä»¶ç»„åˆ</h1><p>åœ¨<a href="/2019/03/11/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">ä»¥å‰çš„æ–‡ç« </a>ä¸­æˆ‘ä¹Ÿä»‹ç»äº†ä½¿ç”¨<code>cProfileä¸­é—´ä»¶</code>æ¥åˆ†æDjangoè§†å›¾å‡½æ•°çš„Pythonä»£ç æ‰§è¡Œæƒ…å†µï¼Œè¿™é‡Œå°±é¡ºä¾¿ç»„åˆèµ·æ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> cProfile<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> pstats<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.exceptions <span class="hljs-keyword">import</span> MiddlewareNotUsed<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connections<br><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileMiddleware</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    ignore_sql = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, get_response</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.DEBUG:<br>            <span class="hljs-keyword">raise</span> MiddlewareNotUsed  <span class="hljs-comment"># åªåœ¨DEBUGæ¨¡å¼ä¸‹å¯ç”¨è¯¥ä¸­é—´ä»¶</span><br><br>        self.get_response = get_response<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, request</span>):<br>        <span class="hljs-keyword">if</span> request.GET.get(<span class="hljs-string">&quot;profile&quot;</span>) == <span class="hljs-string">&quot;cprofile&quot;</span>:<br>            <span class="hljs-comment"># ç”¨cProfileçš„ç»“æœè¦†ç›–åŸå§‹å“åº”</span><br>            profile = cProfile.Profile()<br>            profile.enable()<br>            self.get_response(request)<br>            profile.disable()<br>            ram_file = StringIO()<br>            sort_by = <span class="hljs-string">&#x27;tottime&#x27;</span><br>            stats = pstats.Stats(profile, stream=ram_file)<br>            stats.strip_dirs().sort_stats(sort_by).print_stats()<br>            <span class="hljs-keyword">return</span> HttpResponse(ram_file.getvalue().encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), <span class="hljs-string">&#x27;text/plain&#x27;</span>)<br><br>        response = self.get_response(request)  <span class="hljs-comment"># type: HttpResponse</span><br>        <span class="hljs-comment"># æ ¹æ®urlå‚æ•°å’Œè¿”å›ç±»å‹åˆ¤æ–­æ˜¯å¦åº”è¯¥æ’å…¥SQLæ‰§è¡Œä¿¡æ¯</span><br>        <span class="hljs-keyword">if</span> request.GET.get(<span class="hljs-string">&quot;profile&quot;</span>) == <span class="hljs-string">&quot;db&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;application/json&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">repr</span>(response):<br>            <span class="hljs-keyword">try</span>:<br>                data = json.loads(response.content)<br>            <span class="hljs-keyword">except</span> (TypeError, ValueError):<br>                <span class="hljs-keyword">return</span> response  <span class="hljs-comment"># è§£æjsonå¤±è´¥</span><br>            <span class="hljs-comment"># æ’å…¥sqlæ‰§è¡Œä¿¡æ¯</span><br>            sql_queries = []<br>            <span class="hljs-keyword">for</span> alias <span class="hljs-keyword">in</span> connections:<br>                <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> connections[alias].queries:<br>                    <span class="hljs-keyword">if</span> query[<span class="hljs-string">&quot;sql&quot;</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.ignore_sql:<br>                        query[<span class="hljs-string">&quot;using&quot;</span>] = alias<br>                        sql_queries.append(query)<br>            data[<span class="hljs-string">&quot;_debug_sql&quot;</span>] = sql_queries<br>            response.content = json.dumps(data)<br><br>        <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>åŒæ ·éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -s localhost:8000/user_count/\?profile=cprofile</span><br>         830 function calls (826 primitive calls) in 0.002 seconds<br><br>   Ordered by: internal time<br><br>   ncalls  tottime  percall  cumtime  percall filename:lineno(function)<br>        1    0.000    0.000    0.000    0.000 base.py:379(execute)<br>        1    0.000    0.000    0.000    0.000 &#123;built-in method _sqlite3.connect&#125;<br>        4    0.000    0.000    0.000    0.000 base.py:53(list_aggregate)<br>       20    0.000    0.000    0.000    0.000 functools.py:44(update_wrapper)<br>      158    0.000    0.000    0.000    0.000 &#123;built-in method builtins.getattr&#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">çœç•¥</span><br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸å¾—ä¸æ„Ÿå¹DjangoçœŸæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„ã€ç”Ÿæ€ä¸°å¯Œçš„Webæ¡†æ¶ï¼Œè¿™ç¯‡æ–‡ç« åªæ˜¯ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šå–å¾—äº†ä¸€äº›å¾®ä¸è¶³é“çš„æˆå°±ã€‚<code>Django Debug Toolbar</code>è™½ç„¶ä¹Ÿæ˜¯é€šè¿‡<code>connection.queries</code>çš„æ–¹å¼è·å–äº†SQLæ‰§è¡Œæƒ…å†µï¼ˆ<a href="https://github.com/jazzband/django-debug-toolbar/blob/2.2/debug_toolbar/panels/sql/panel.py#L58">panel.py#L58</a>ï¼‰ï¼Œä½†å…¶æ‰€åšçš„å·¥ä½œè¿œä¸æ­¢å¦‚æ­¤ï¼Œå€¼å¾—ç»†çœ‹ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
      <tag>Django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangæç®€å®ç°WebSocketæ‰¿è½½socks5æµé‡</title>
    <link href="/2020/02/20/Golang%E6%9E%81%E7%AE%80%E5%AE%9E%E7%8E%B0WebSocket%E6%89%BF%E8%BD%BDsocks5%E6%B5%81%E9%87%8F/"/>
    <url>/2020/02/20/Golang%E6%9E%81%E7%AE%80%E5%AE%9E%E7%8E%B0WebSocket%E6%89%BF%E8%BD%BDsocks5%E6%B5%81%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>å‡è®¾æœ‰ä¸€å°è¿œç¨‹æœåŠ¡å™¨ï¼š<code>1.2.3.4</code>ï¼Œä¸Šé¢è¿è¡Œç€ä¸€ä¸ªsocks5ä»£ç†ï¼š<code>127.0.0.1:1080</code>ã€‚ç™»ä¸Šè¿™å°è¿œç¨‹æœåŠ¡å™¨åï¼Œå¯ä»¥é€šè¿‡curléªŒè¯è¿™ä¸ªä»£ç†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl --socks5 127.0.0.1:1080 https://httpbin.org/get</span><br>&#123;<br>  ...<br>  &quot;origin&quot;: &quot;1.2.3.4&quot;,<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ¬æ–‡çš„ç›®æ ‡æ˜¯é€šè¿‡WebSocketçš„æ–¹å¼è®©æœ¬åœ°curlä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªsocks5ä»£ç†ã€‚</p><h1 id="æœåŠ¡å™¨è¿è¡Œä»£ç "><a href="#æœåŠ¡å™¨è¿è¡Œä»£ç " class="headerlink" title="æœåŠ¡å™¨è¿è¡Œä»£ç "></a>æœåŠ¡å™¨è¿è¡Œä»£ç </h1><p>è¿™æ®µä»£ç è¿è¡Œäºè¿œç¨‹æœåŠ¡å™¨ï¼Œä»£ç è¿è¡Œæ—¶ä¼šåœ¨<code>1.2.3.4:5000</code>ä¸Šå¼€å¯ä¸€ä¸ªWebSocketæœåŠ¡ã€‚æ¯æ¥æ”¶åˆ°ä¸€ä¸ªWebSocketè¯·æ±‚ï¼Œä»£ç å°±ä¼šè¿æ¥è‡³æœ¬åœ°çš„socks5ä»£ç†ï¼Œä½¿ç”¨<code>io.Copy</code>è¿›è¡Œæ•°æ®è½¬å‘å·¥ä½œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;golang.org/x/net/websocket&quot;</span><br><span class="hljs-string">&quot;io&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ws2socks</span><span class="hljs-params">(ws *websocket.Conn)</span></span> &#123;<br><span class="hljs-keyword">defer</span> ws.Close()<br>socks, err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:1080&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;dial socks error:&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">defer</span> socks.Close()<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>ioCopy := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dst io.Writer, src io.Reader)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>io.Copy(dst, src)<br>&#125;<br>wg.Add(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">go</span> ioCopy(socks, ws)<br><span class="hljs-keyword">go</span> ioCopy(ws, socks)<br>wg.Wait()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>http.Handle(<span class="hljs-string">&quot;/&quot;</span>, websocket.Handler(ws2socks))<br>log.Fatal(http.ListenAndServe(<span class="hljs-string">&quot;1.2.3.4:5000&quot;</span>, <span class="hljs-literal">nil</span>))<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æœ¬åœ°è¿è¡Œä»£ç "><a href="#æœ¬åœ°è¿è¡Œä»£ç " class="headerlink" title="æœ¬åœ°è¿è¡Œä»£ç "></a>æœ¬åœ°è¿è¡Œä»£ç </h1><p>è¿™æ®µä»£ç è¿è¡Œäºæœ¬åœ°ï¼Œä»£ç è¿è¡Œæ—¶ä¼šç›‘å¬<code>127.0.0.1:8888</code>ã€‚æ¯æ¥æ”¶åˆ°ä¸€ä¸ªTCPè¿æ¥ï¼Œä»£ç å°±ä¼šè¿æ¥è‡³è¿œç¨‹æœåŠ¡å™¨çš„WebSocketæœåŠ¡ï¼ŒåŒæ ·ä½¿ç”¨<code>io.Copy</code>è¿›è¡Œæ•°æ®è½¬å‘å·¥ä½œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;golang.org/x/net/websocket&quot;</span><br><span class="hljs-string">&quot;io&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">socks2ws</span><span class="hljs-params">(socks *net.TCPConn)</span></span> &#123;<br><span class="hljs-keyword">defer</span> socks.Close()<br>    ws, err := websocket.Dial(<span class="hljs-string">&quot;ws://1.2.3.4:5000/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ws://1.2.3.4:5000/&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;dial websocket error:&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">defer</span> ws.Close()<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>ioCopy := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dst io.Writer, src io.Reader)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>io.Copy(dst, src)<br>&#125;<br>wg.Add(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">go</span> ioCopy(ws, socks)<br><span class="hljs-keyword">go</span> ioCopy(socks, ws)<br>wg.Wait()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>listener, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:8888&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;listen tcp at:&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:8888&quot;</span>)<br><br><span class="hljs-keyword">for</span> &#123;<br>conn, _ := listener.Accept()<br><span class="hljs-keyword">go</span> socks2ws(conn.(*net.TCPConn))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å®é™…è¿è¡Œ"><a href="#å®é™…è¿è¡Œ" class="headerlink" title="å®é™…è¿è¡Œ"></a>å®é™…è¿è¡Œ</h1><p>åœ¨è¿œç¨‹æœåŠ¡å™¨ã€æœ¬åœ°åˆ†åˆ«è¿è¡Œå¯¹åº”çš„ä»£ç åï¼Œå°±å¯ä»¥åœ¨æœ¬åœ°ç”¨curlæµ‹è¯•è¿™ä¸ªâ€æœ¬åœ°socks5ä»£ç†â€äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl --socks5 127.0.0.1:8888 https://httpbin.org/get</span><br>&#123;<br>  ...<br>  &quot;origin&quot;: &quot;1.2.3.4&quot;,<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="TLSåŠ å¯†"><a href="#TLSåŠ å¯†" class="headerlink" title="TLSåŠ å¯†"></a>TLSåŠ å¯†</h1><p>å¦‚æœä¸ä½¿ç”¨TLSåŠ å¯†ä¼ è¾“ï¼ŒWebSocketä¸­çš„æ•°æ®å°†ä»¥æ˜æ–‡çš„æ–¹å¼æš´éœ²åœ¨äº’è”ç½‘ä¸Šã€‚ä¸ºäº†å®‰å…¨æ€§è€ƒè™‘ï¼Œä½¿ç”¨TLSåŠ å¯†ä¼ è¾“æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p><h2 id="æœåŠ¡å™¨ç«¯é…ç½®"><a href="#æœåŠ¡å™¨ç«¯é…ç½®" class="headerlink" title="æœåŠ¡å™¨ç«¯é…ç½®"></a>æœåŠ¡å™¨ç«¯é…ç½®</h2><p>å…³äºåŸŸåå’Œè¯ä¹¦çš„æ–‡ç« æœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚å‡è®¾æœ‰åŸŸå<code>test.com</code>çš„è§£ææŒ‡å‘äº†è¿™å°æœåŠ¡å™¨<code>1.2.3.4</code>ï¼Œå·²ç»ç”Ÿæˆè‡ªç­¾åè¯ä¹¦æ–‡ä»¶äº<code>/etc/ssl/1.cert</code>å’Œ<code>/etc/ssl/2.key</code>ã€‚é…ç½®äº†Nginxä¹‹åï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰ï¼ŒWebSocketæœåŠ¡çš„åœ°å€å°±ä¼šä»<code>ws://1.2.3.4:5000/</code>å˜ä¸º<code>wss://test.com/ws</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs conf">server &#123;<br>listen 443 ssl;<br>server_name test.com;<br><br>ssl_certificate     /etc/ssl/1.cert;<br>ssl_certificate_key /etc/ssl/2.key;<br>ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;<br>ssl_ciphers         HIGH:!aNULL:!MD5;<br><br>root /var/www/html;<br>index index.html index.htm index.nginx-debian.html;<br><br>location / &#123;<br>try_files $uri $uri/ =404;<br>&#125;<br><br>location /ws &#123;<br>proxy_pass http://1.2.3.4:5000;<br>proxy_http_version 1.1;<br>proxy_set_header Upgrade $http_upgrade;<br>proxy_set_header Connection &quot;Upgrade&quot;;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æœ¬åœ°ä»£ç å˜åŠ¨"><a href="#æœ¬åœ°ä»£ç å˜åŠ¨" class="headerlink" title="æœ¬åœ°ä»£ç å˜åŠ¨"></a>æœ¬åœ°ä»£ç å˜åŠ¨</h2><p>å¦‚æœä¸æ˜¯è‡ªç­¾åè¯ä¹¦ï¼Œé‚£ä¹ˆæœ¬åœ°ä»£ç åªéœ€è¦æ›´æ”¹WebSocketè¿æ¥åœ°å€ã€‚ä½†å¦‚æœæ˜¯è‡ªç­¾åè¯ä¹¦ï¼Œæœ¬åœ°ä»£ç æœ€å¥½ä¸»åŠ¨æ¥å—è®¤è¯æ–‡ä»¶ï¼ˆå³ä¸Šæ–‡æåˆ°çš„<code>1.cert</code>ï¼‰ï¼Œå› ä¸ºè·³è¿‡è¯ä¹¦è®¤è¯ä¼šå¸¦æ¥é¢å¤–çš„é£é™©ã€‚äºæ˜¯ï¼Œæœ¬åœ°ä»£ç åœ¨å‘WebSocketæœåŠ¡è¯·æ±‚ä¹‹å‰éœ€è¦å…ˆè¯»å–è®¤è¯æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br>...<br><span class="hljs-keyword">var</span> wsConfig *websocket.Config<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// load certificate file</span><br>content, err := ioutil.ReadFile(<span class="hljs-string">&quot;1.cert&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>roots := x509.NewCertPool()<br><span class="hljs-keyword">if</span> ok := roots.AppendCertsFromPEM(content); ok != <span class="hljs-literal">true</span> &#123;<br>log.Fatal(<span class="hljs-string">&quot;cert parse fail&quot;</span>)<br>&#125;<br><span class="hljs-comment">// generate websocket config</span><br>wsConfig, err = websocket.NewConfig(<span class="hljs-string">&quot;wss://test.com/ws&quot;</span>, <span class="hljs-string">&quot;wss://test.com/ws&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>wsConfig.TlsConfig = &amp;tls.Config&#123;RootCAs: roots&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">socks2ws</span><span class="hljs-params">(socks *net.TCPConn)</span></span> &#123;<br><span class="hljs-keyword">defer</span> socks.Close()<br>ws, err := websocket.DialConfig(wsConfig)<br>...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>initConfig()<br>...<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€è·¯å¾ˆç®€å•ï¼Œå®ç°ä¹Ÿç®€å•â€¦â€¦å°±å½“æ˜¯Golangçš„å…¥é—¨ç»ƒä¹ ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼ŒGolangçœŸé¦™ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
      <tag>websocket</tag>
      
      <tag>socks5</tag>
      
      <tag>Golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>APTã€Dockerã€PyPIä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿ</title>
    <link href="/2019/12/17/APT%E3%80%81Docker%E3%80%81PyPI%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/"/>
    <url>/2019/12/17/APT%E3%80%81Docker%E3%80%81PyPI%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2019-12-17.03.webp"></p><p>å› ä¸ºä¸€äº›ä¸å¯æè¿°çš„åŸå› ï¼Œåœ¨ä¸­å›½ç»å¤§å¤šæ•°åœ°åŒºè¿›è¡Œæ›´æ–°APTè½¯ä»¶åŒ…åˆ—è¡¨ï¼ˆ<code>apt-get update</code>ï¼‰&amp;å®‰è£…APTè½¯ä»¶åŒ…ï¼ˆ<code>apt-get isntall</code>ï¼‰ã€æ‹‰å–Dockeré•œåƒï¼ˆ<code>docker pull</code>ï¼‰ã€å®‰è£…PyPIåŒ…ï¼ˆ<code>pip install</code>ï¼‰ç­‰æ“ä½œéƒ½æ˜¯ä¸€ä»¶éå¸¸ç—›è‹¦çš„äº‹ï¼šç½‘ç»œè¿æ¥é€Ÿåº¦å¤ªæ…¢äº†ã€‚ä¸‡å¹¸çš„æ˜¯æˆ‘ä»¬æœ‰è®¸å¤šå¼€æºè½¯ä»¶é•œåƒç«™ç‚¹ï¼Œåˆç†è®¾ç½®é•œåƒç«™ç‚¹èƒ½å¤Ÿæå¤§æå‡å·¥ä½œå’Œå­¦ä¹ æ•ˆç‡ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»çš„å°±æ˜¯åœ¨ä¸Šè¿°ä¸‰ç§åœºæ™¯ä¸‹å¦‚ä½•è®¾ç½®é•œåƒç«™ç‚¹ã€‚</p><h1 id="APTé•œåƒåŠ é€Ÿ"><a href="#APTé•œåƒåŠ é€Ÿ" class="headerlink" title="APTé•œåƒåŠ é€Ÿ"></a>APTé•œåƒåŠ é€Ÿ</h1><p><a href="https://mirror.tuna.tsinghua.edu.cn/help">TUNAé•œåƒç«™ï¼ˆæ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™ï¼‰</a>ä¸Šä»‹ç»äº†ç»å¤§éƒ¨åˆ†Linuxå‘è¡Œç‰ˆçš„é•œåƒåŠ é€Ÿè®¾ç½®æ–¹æ³•ï¼Œè¿™é‡Œåªä»‹ç»Debianç³»å‘è¡Œç‰ˆçš„APTé•œåƒåŠ é€Ÿå¦‚ä½•è®¾ç½®ã€‚<br>APTæ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨çš„ç¬¬ä¸€æ­¥æ˜¯ä»æœ¬åœ°æºåˆ—è¡¨ï¼ˆ<code>/etc/apt/sources.list</code>å’Œ<code>/etc/apt/sources.list.d/*.list</code>ï¼‰ä¸­è¯»å–æ‰€æœ‰è½¯ä»¶æ¥æºç«™ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦æ›´æ–°æœ¬åœ°æºåˆ—è¡¨å°±å¯ä»¥å®ç°é•œåƒåŠ é€Ÿäº†ï¼ˆä¸‹é¢çš„æºåˆ—è¡¨ä¸åŒ…æ‹¬æºä»£ç ç«™ç‚¹ï¼Œå¦‚éœ€å®Œæ•´ç«™ç‚¹å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Šå¯¹åº”è¡Œï¼‰ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¤‡ä»½å·²æœ‰æºåˆ—è¡¨</span><br>sudo cp /etc/apt/sources.list /etc/apt/sources.list.old<br>distrib=$(lsb_release -is | awk &#x27;&#123;print tolower($1)&#125;&#x27;)<br>codename=$(lsb_release -cs)<br>apt_src=&quot;https://mirrors.aliyun.com&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">â†‘é˜¿é‡Œäº‘æº â†“TUNAæº</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">apt_src=<span class="hljs-string">&quot;https://mirrors.tuna.tsinghua.edu.cn&quot;</span></span><br>cat &gt;sources.list&lt;&lt;EOF<br>deb $apt_src/$distrib/ $codename main restricted universe multiverse<br>deb $apt_src/$distrib/ $codename-security main restricted universe multiverse<br>deb $apt_src/$distrib/ $codename-updates main restricted universe multiverse<br>deb $apt_src/$distrib/ $codename-backports main restricted universe multiverse<br><span class="hljs-meta prompt_">#</span><span class="language-bash">deb-src <span class="hljs-variable">$apt_src</span>/<span class="hljs-variable">$distrib</span>/ <span class="hljs-variable">$codename</span> main restricted universe multiverse</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">deb-src <span class="hljs-variable">$apt_src</span>/<span class="hljs-variable">$distrib</span>/ <span class="hljs-variable">$codename</span>-security main restricted universe multiverse</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">deb-src <span class="hljs-variable">$apt_src</span>/<span class="hljs-variable">$distrib</span>/ <span class="hljs-variable">$codename</span>-updates main restricted universe multiverse</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">deb-src <span class="hljs-variable">$apt_src</span>/<span class="hljs-variable">$distrib</span>/ <span class="hljs-variable">$codename</span>-backports main restricted universe multiverse</span><br>EOF<br>sudo mv sources.list /etc/apt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨</span><br>sudo apt-get update<br></code></pre></td></tr></table></figure><h2 id="æ‰‹åŠ¨æ·»åŠ Ubuntu-PPAæº"><a href="#æ‰‹åŠ¨æ·»åŠ Ubuntu-PPAæº" class="headerlink" title="æ‰‹åŠ¨æ·»åŠ Ubuntu PPAæº"></a>æ‰‹åŠ¨æ·»åŠ Ubuntu PPAæº</h2><p>PPAï¼ˆPersonal Package Archivesï¼‰ä½œä¸ºAPTæºçš„è¡¥å……èƒ½è®©Ubuntuç”¨æˆ·åœ¨ç¬¬ä¸€æ—¶é—´ä½“éªŒåˆ°æœ€æ–°å‘å¸ƒçš„è½¯ä»¶ã€‚ä½†åœ¨ç¬”è€…çš„å®é™…ä½“éªŒä¸­ï¼Œé»˜è®¤çš„PPAæºæ·»åŠ å‘½ä»¤ï¼ˆ<code>add-apt-repository</code>ï¼‰å¾€å¾€éœ€è¦æé•¿çš„æ—¶é—´æ‰èƒ½æ·»åŠ å®Œæˆã€‚ç»è¿‡ä¸€æ®µæ—¶é—´æ‘¸ç´¢ï¼Œç¬”è€…å‘ç°å¯ä»¥é€šè¿‡ç®€å•çš„æ–¹å¼æ‰‹åŠ¨æ·»åŠ Ubuntu PPAæºï¼Œåœ¨æ­¤åˆ†äº«ç»™è¯»è€…ã€‚<br><img src="/images/2019-12-17.01.webp"></p><p>ä»¥ä¸Šå›¾ï¼ˆ<a href="https://launchpad.net/~starws-box/+archive/ubuntu/deadbeef-player">deadbeef-player : starws</a>ï¼‰ä¸ºä¾‹ï¼Œç‚¹å¼€å›¾ä¸­çš„â€Technical details about this PPAâ€ï¼Œåœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ç³»ç»Ÿç‰ˆæœ¬åï¼Œå°†ä¸‹æ–¹çš„PPAæºé“¾æ¥ä¿å­˜è‡³æœ¬åœ°æºåˆ—è¡¨ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo &quot;deb http://ppa.launchpad.net/starws-box/deadbeef-player/ubuntu bionic main&quot; &gt; ppa-deadbeef.list<br>sudo mv ppa-deadbeef.list /etc/apt/sources.list.d/<br></code></pre></td></tr></table></figure><p>ç„¶åå†ç‚¹å‡»ä¸Šå›¾ä¸­<code>Signing key</code>ä¸‹æ–¹çš„é“¾æ¥ï¼Œåœ¨å‡ºç°çš„æ–°é¡µé¢ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ä¸­å¤åˆ¶<code>sig</code>å…¬é’¥æ–‡ä»¶çš„åœ°å€ã€‚æœ€åç”¨<code>apt-key</code>æ·»åŠ è¿™ä¸ªå…¬é’¥ï¼Œè¿™ä¸ªPPAæºå°±æ·»åŠ å®Œæˆäº†ã€‚</p><p><img src="/images/2019-12-17.02.webp"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget -qO - https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x446c82dc2dd154a1 | sudo apt-key add -</span><br>OK<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update &amp;&amp; sudo apt-get install deadbeef</span><br></code></pre></td></tr></table></figure><h1 id="å®‰è£…Dockerï¼ˆUbuntu-16-04-ï¼‰"><a href="#å®‰è£…Dockerï¼ˆUbuntu-16-04-ï¼‰" class="headerlink" title="å®‰è£…Dockerï¼ˆUbuntu 16.04+ï¼‰"></a>å®‰è£…Dockerï¼ˆUbuntu 16.04+ï¼‰</h1><p>Debianç³»ç»Ÿç†è®ºä¸Šå¯ä»¥å…¼å®¹è¿™äº›å‘½ä»¤ï¼Œä¸è¿‡ç¬”è€…æ²¡æœ‰è¿›è¡Œè¿‡æµ‹è¯•ã€‚å…¶å®ƒç³»ç»Ÿå‚è§<a href="https://yeasy.gitbooks.io/docker_practice/install/">ã€ŠDockerâ€”â€”ä»å…¥é—¨åˆ°å®è·µã€‹ å®‰è£…Docker</a>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Ubuntu 16.04éœ€è¦å…ˆå®‰è£…è¿™ä¸ªä¾èµ–åŒ…ï¼ŒUbuntu 18.04ä¸ç”¨</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">wget http://launchpadlibrarian.net/344879847/libseccomp2_2.3.1-2.1ubuntu2~16.04.1_amd64.deb</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sudo dpkg -i libseccomp2_2.3.1-2.1ubuntu2~16.04.1_amd64.deb</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">rm</span> libseccomp2_2.3.1-2.1ubuntu2~16.04.1_amd64.deb</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¸è½½æ—§ç‰ˆæœ¬Docker</span><br>sudo apt-get remove docker docker-engine docker.io<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ·»åŠ Docker-ceæºå¹¶å®‰è£…Docker-ce</span><br>echo &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/$(lsb_release -is | awk &#x27;&#123;print tolower($1)&#125;&#x27;) $(lsb_release -cs) stable&quot; &gt; docker-ce.list<br>sudo mv docker-ce.list /etc/apt/sources.list.d/<br>curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -<br>sudo apt-get update &amp;&amp; sudo apt-get install docker-ce<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯åŠ¨DockeræœåŠ¡å¹¶é…ç½®ç”¨æˆ·ç»„</span><br>sudo systemctl enable docker<br>sudo systemctl start docker<br>sudo groupadd docker<br>sudo usermod -aG docker $USER<br><span class="hljs-meta prompt_"># </span><span class="language-bash">é€€å‡ºå½“å‰ç»ˆç«¯å¹¶é‡æ–°ç™»å½•ï¼Œæµ‹è¯•Dockeræ˜¯å¦æ­£å¸¸è¿è¡Œ</span><br>docker version<br></code></pre></td></tr></table></figure><h1 id="Dockeré•œåƒåŠ é€Ÿ"><a href="#Dockeré•œåƒåŠ é€Ÿ" class="headerlink" title="Dockeré•œåƒåŠ é€Ÿ"></a>Dockeré•œåƒåŠ é€Ÿ</h1><p>Dockeråœ¨å®‰è£…å®Œæˆåé»˜è®¤ä»DockerHubæºç«™æ‹‰å–é•œåƒï¼Œè€Œå°†æ‹‰å–ç›®æ ‡ç«™ç‚¹ä»æºç«™æ”¹ä¸ºé•œåƒç«™å¾€å¾€èƒ½è·å¾—æ›´å¿«çš„é•œåƒæ‹‰å–é€Ÿåº¦ã€‚è¯¦ç»†æµç¨‹å‚è§<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html">ã€ŠDockerâ€”â€”ä»å…¥é—¨åˆ°å®è·µã€‹ é•œåƒåŠ é€Ÿå™¨</a>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt;daemon.json&lt;&lt;EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [<br>    &quot;https://dockerhub.azk8s.cn&quot;,<br>    &quot;https://hub-mirror.c.163.com&quot;<br>  ]<br>&#125;<br>EOF<br>sudo mv daemon.json /etc/docker/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">é‡å¯æœåŠ¡</span><br>sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥é€šè¿‡<code>docker info</code>å‘½ä»¤æŸ¥çœ‹é•œåƒåŠ é€Ÿè®¾ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker info -f <span class="hljs-string">&#x27;&#123;&#123;json .RegistryConfig.Mirrors&#125;&#125;&#x27;</span></span><br>[&quot;https://dockerhub.azk8s.cn/&quot;,&quot;https://hub-mirror.c.163.com/&quot;]<br></code></pre></td></tr></table></figure><h1 id="PyPIé•œåƒåŠ é€Ÿ"><a href="#PyPIé•œåƒåŠ é€Ÿ" class="headerlink" title="PyPIé•œåƒåŠ é€Ÿ"></a>PyPIé•œåƒåŠ é€Ÿ</h1><p>è¯¦ç»†è¯´æ˜å‚è§<a href="https://mirror.tuna.tsinghua.edu.cn/help/pypi/">TUNA pypi é•œåƒä½¿ç”¨å¸®åŠ©</a>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">mirror=&quot;https://mirrors.aliyun.com/pypi/simple/&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">â†‘é˜¿é‡Œäº‘æº â†“TUNAæº</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mirror=<span class="hljs-string">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¸´æ—¶å®‰è£…</span><br>pip install -i $mirror requests<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è®¾ä¸ºé»˜è®¤ï¼Œéœ€è¦å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆ&gt;=10.0.0ï¼‰</span><br>pip install -i $mirror pip -U<br>pip config set global.index-url $mirror<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>ç½‘ç»œä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dockerå¿«é€Ÿéƒ¨ç½²ownCloudå¹¶é…ç½®HTTPS</title>
    <link href="/2019/12/16/Docker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2ownCloud%E5%B9%B6%E9%85%8D%E7%BD%AEHTTPS/"/>
    <url>/2019/12/16/Docker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2ownCloud%E5%B9%B6%E9%85%8D%E7%BD%AEHTTPS/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2019-12-16.01.webp"><br>ownCloudä¸€ç›´æ˜¯å¸‚åœºä¸Šæœ€å—æ¬¢è¿çš„ä¸ªäººäº‘å­˜å‚¨è§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼Œæœ‰ç€ä½¿ç”¨å¹¿æ³›ã€å®¢æˆ·ç«¯å…¼å®¹æ€§å¥½ã€è‡ªç”±å¼€æºç­‰ä¼˜ç‚¹ã€‚ä½†ownCloudçš„éƒ¨ç½²æ¶‰åŠLAMPç¯å¢ƒï¼Œéƒ¨ç½²è¿‡ç¨‹è¾ƒä¸ºç¹çã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•ç”¨docker-composeå¿«é€Ÿéƒ¨ç½²ownCloudï¼Œå¹¶é…ç½®Nginxè½¬å‘+HTTPSæé«˜æœåŠ¡å™¨å®‰å…¨æ€§ã€‚</p><h1 id="é…ç½®docker-compose"><a href="#é…ç½®docker-compose" class="headerlink" title="é…ç½®docker-compose"></a>é…ç½®docker-compose</h1><blockquote><p>ä»¥ä¸‹éƒ¨åˆ†å†…å®¹æ¥è‡ª<a href="https://doc.owncloud.com/server/latest/admin_manual/installation/docker/">ownCloudå®˜æ–¹å®‰è£…æ–‡æ¡£</a></p></blockquote><p>é¦–å…ˆï¼Œä¸‹è½½å®˜æ–¹docker-composeæ–‡ä»¶ï¼Œå¹¶åˆ›ç¯å¢ƒå˜é‡æ–‡ä»¶ç”¨ä»¥æŒ‡å®šownCloudç‰ˆæœ¬ã€è´¦æˆ·å¯†ç å’ŒHTTPç«¯å£ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> owncloud-docker-server</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> owncloud-docker-server</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://raw.githubusercontent.com/owncloud/docs/master/modules/admin_manual/examples/installation/docker/docker-compose.yml</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF &gt; .env</span></span><br>OWNCLOUD_VERSION=10.3<br>OWNCLOUD_DOMAIN=localhost<br>ADMIN_USERNAME=admin<br>ADMIN_PASSWORD=admin<br>HTTP_PORT=8080<br>EOF<br></code></pre></td></tr></table></figure><p>ä»ä¸‹è½½ä¸‹æ¥çš„<code>docker-compose.yml</code>æ–‡ä»¶é‡Œå¯ä»¥çœ‹å‡ºï¼ŒownCloudå…±æœ‰ä¸‰ä¸ªdockeræœåŠ¡ï¼š<code>owncloud</code>ã€<code>db</code>ã€<code>redis</code>ï¼Œè¿™ä¸‰ä¸ªdockeræœåŠ¡éƒ½å°†åˆ›å»ºç‹¬ç«‹çš„dockeræ•°æ®å·ï¼Œå°†å„è‡ªçš„æ•°æ®æ–‡ä»¶æŒä¹…åŒ–åˆ°æ•°æ®å·é‡Œã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2.1&#x27;</span><br><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span><br><span class="hljs-string">...</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">owncloud:</span><br><span class="hljs-string">...</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">files:/mnt/data</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä¸ªäººæ›´ä¹ æƒ¯å°†ownCloudçš„æ•°æ®ä¿å­˜ç›®å½•æŒ‡å®šä¸ºæŸä¸ªå…·ä½“æ–‡ä»¶å¤¹ï¼Œæ–¹ä¾¿æˆ‘è¿›è¡Œç®¡ç†ã€‚æ‰€ä»¥æˆ‘å¯¹<code>docker-compose.yml</code>åšå¦‚ä¸‹æ”¹åŠ¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2.1&#x27;</span><br><br><span class="hljs-attr">volumes:</span><br><span class="hljs-comment">#  files:</span><br><span class="hljs-comment">#    driver: local</span><br><span class="hljs-string">...</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">owncloud:</span><br><span class="hljs-string">...</span><br>    <span class="hljs-attr">volumes:</span><br><span class="hljs-comment">#      - files:/mnt/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/path/to/my/data/owncloud:/mnt/data</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><h1 id="ç”¨docker-composeå¯åŠ¨ownCloud"><a href="#ç”¨docker-composeå¯åŠ¨ownCloud" class="headerlink" title="ç”¨docker-composeå¯åŠ¨ownCloud"></a>ç”¨docker-composeå¯åŠ¨ownCloud</h1><p>å¯åŠ¨ownCloudçš„å‘½ä»¤å¾ˆç®€å•ï¼Œåªéœ€è®©docker-composeæŒ‰ç…§é…ç½®å¥½çš„<code>docker-compose.yml</code>å¯åŠ¨å®¹å™¨ã€‚ç¬¬ä¸€æ¬¡è¿è¡Œéœ€è¦æ‹‰å–é•œåƒï¼Œåªéœ€è€å¿ƒç­‰å¾…å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker-compose up -d</span><br></code></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œå®Œæˆåå¯ä»¥é€šè¿‡docker-composeå‘½ä»¤æŸ¥çœ‹æ‹‰å–çš„é•œåƒå’ŒæœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker-compose images</span><br>     Container           Repository        Tag       Image Id      Size<br>-------------------------------------------------------------------------<br>owncloud_db_1         webhippie/mariadb   latest   3f6237885724   626 MB<br>owncloud_owncloud_1   owncloud/server     10.3     b7c82576c651   785 MB<br>owncloud_redis_1      webhippie/redis     latest   42ab00c664c2   56.4 MB<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker-compose ps</span><br>       Name                      Command                  State               Ports<br>--------------------------------------------------------------------------------------------<br>owncloud_db_1         /usr/bin/entrypoint /bin/s ...   Up (healthy)   3306/tcp<br>owncloud_owncloud_1   /usr/bin/entrypoint /usr/b ...   Up (healthy)   0.0.0.0:8080-&gt;8080/tcp<br>owncloud_redis_1      /usr/bin/entrypoint /bin/s ...   Up (healthy)   6379/tcp<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ä¹Ÿå¯ä»¥ç”¨curlæ¥éªŒè¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl 127.0.0.1:8080 -I</span><br>HTTP/1.1 302 Found<br>Date: Mon, 16 Dec 2019 03:14:55 GMT<br>Server: Apache<br>...<br></code></pre></td></tr></table></figure><h1 id="é…ç½®Nginxè½¬å‘-HTTPS"><a href="#é…ç½®Nginxè½¬å‘-HTTPS" class="headerlink" title="é…ç½®Nginxè½¬å‘+HTTPS"></a>é…ç½®Nginxè½¬å‘+HTTPS</h1><p>Nginx+HTTPSçš„é…ç½®ä¸ç®—éº»çƒ¦ï¼Œåªè¦åœ¨Nginxçš„é…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚<code>/etc/nginx/sites-available/default</code>ï¼‰ä¸­æ·»åŠ ä¸€ä¸ªserveré¡¹å³å¯ã€‚åœ¨è¿™é‡Œçš„é…ç½®ä¸­ï¼Œæˆ‘è®©Nginxåœ¨8000ç«¯å£ä¸Šå¯åŠ¨HTTPSæœåŠ¡ï¼Œå¹¶å°†æ‰€æœ‰è¯·æ±‚ä»¥HTTPæ–¹å¼è½¬å‘è‡³8080ç«¯å£ä¸Šçš„ownCloudã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">8000</span> ssl;<br>    <span class="hljs-attribute">server_name</span> owncloud;<br><br>    <span class="hljs-attribute">ssl_certificate</span>     /etc/nginx/ssl/owncloud.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl/owncloud.key;<br>    <span class="hljs-attribute">ssl_protocols</span>       TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;<br>    <span class="hljs-attribute">ssl_ciphers</span>         HIGH:!aNULL:!MD5;<br><br>    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-section">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_set_header</span>   Host             <span class="hljs-variable">$host</span>:<span class="hljs-number">8000</span>;<br>        <span class="hljs-attribute">proxy_redirect</span>     http://          https://;<br>        <span class="hljs-attribute">proxy_pass</span>         http://127.0.0.1:8080/;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…ç½®æ—¶æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p><ul><li><code>client_max_body_size</code>é¡¹ï¼Œå…¶é»˜è®¤çš„å€¼ä¸º<code>1m</code>ï¼Œä¹Ÿå°±æ˜¯è¯´Nginxæœ€å¤§åªèƒ½æ¥å—1Må¤§å°çš„HTTPè¯·æ±‚ï¼Œè¿™å¯¹äºownCloudçš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ã€‚åœ¨è¿™é‡Œæˆ‘å°†å…¶è®¾ä¸º<code>0</code>ï¼Œè®©Nginxä¸é™åˆ¶HTTPè¯·æ±‚çš„å¤§å°ã€‚ç†è®ºä¸Šæ¥è¯´è¿™ä¸ªå‚æ•°åº”è¯¥é™å®šåœ¨æ–‡ä»¶ä¸Šä¼ çš„<code>url</code>ä»¥æé«˜å®‰å…¨æ€§ï¼Œä½†è¿™é‡Œå°±å›¾ä¸ªæ–¹ä¾¿ã€‚</li><li><code>location</code>ä¸­çš„<code>proxy_set_header</code>é¡¹ï¼Œå°†è¯·æ±‚è½¬å‘å¤´çš„Hostè®¾ç½®ä¸ºNginxçš„Hostï¼ˆ$host:8000ï¼‰è€Œä¸æ˜¯ownCloudçš„Hostï¼ˆ$host:8080ï¼‰ï¼Œé¿å…ownCloudåœ¨å“åº”é‡å®šå‘æ—¶è¿”å›8080ç«¯å£åœ°å€ã€‚</li><li><code>location</code>ä¸­çš„<code>proxy_redirect</code>é¡¹ï¼Œå°†æ‰€æœ‰é‡å®šå‘å“åº”ä¸­çš„HTTPåœ°å€è½¬æ¢ä¸ºHTTPSåœ°å€ã€‚</li></ul><p>å½“ç„¶ï¼Œåœ¨é…ç½®äº†ä»¥ä¸Šè½¬å‘è§„åˆ™åï¼ŒownCloudçš„å“åº”è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šç½‘é¡µä¸Šçš„æ³¨é”€é“¾æ¥åœ°å€æ²¡æœ‰åŠ ä¸ŠHTTPSå‰ç¼€ï¼Œå¯¼è‡´ç‚¹å‡»åå‡ºç°400é”™è¯¯ï¼Œéœ€è¦æ‰‹åŠ¨å°†åœ°å€å‰ç¼€æ”¹æˆ<code>https://</code>æ‰èƒ½é¡ºåˆ©æ³¨é”€ã€‚è¿™ä¸ªå°±å±äºownCloudæœ¬èº«çš„BUGäº†ã€‚</p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>ä¸ªäººäº‘å­˜å‚¨çš„ä¼˜åŠ¿åœ¨å…¬å…±äº‘å­˜å‚¨å•†å®¶ä¸æ–­å€’é—­ä¹‹åé€æ¸æ˜¾ç°å‡ºæ¥äº†ã€‚å¦‚æœæœ‰ä½¿ç”¨ä¸ªäººäº‘å­˜å‚¨æœåŠ¡çš„éœ€æ±‚ï¼ŒownCloudæ— ç–‘æ˜¯ä¸€ä¸ªå€¼å¾—å°è¯•çš„é€‰æ‹©ã€‚ä¸ç®¡æ˜¯å±€åŸŸç½‘å†…éƒ¨ä½¿ç”¨ã€å…¬ç½‘IPå®½å¸¦+DDNSã€å†…ç½‘ç©¿é€ï¼Œè¿˜æ˜¯VPSï¼ˆåŒ…æ‹¬ä½ä»·å¤§å¸¦å®½çš„NAT VPSï¼‰ï¼ŒHAVE FUN and ENJOYã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>owncloud</tag>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è‡ªç”¨linux serveræ€§èƒ½æµ‹è¯•</title>
    <link href="/2019/11/18/%E8%87%AA%E7%94%A8linux-server%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
    <url>/2019/11/18/%E8%87%AA%E7%94%A8linux-server%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç”¨å·¥å…·æµ‹è¯•ä¸‹æ‰‹å¤´ç”¨ç€çš„linux serverï¼Œä¸‰ä¸ªvpså¹³å°ã€ä¸€å°ç‰©ç†æœºï¼Œæµ‹è¯•ç»“æœçœ‹çœ‹å°±å¥½ï¼Œä¸ç”¨å¤ªè¾ƒçœŸã€‚</p><h1 id="æµ‹è¯•ç»“æœæ±‡æ€»"><a href="#æµ‹è¯•ç»“æœæ±‡æ€»" class="headerlink" title="æµ‹è¯•ç»“æœæ±‡æ€»"></a>æµ‹è¯•ç»“æœæ±‡æ€»</h1><table><thead><tr><th>æœåŠ¡å•†</th><th>Google Cloud</th><th>Google Cloud</th><th>é˜¿é‡Œäº‘</th><th>æŸNAT VPSå•†å®¶</th><th>ä¸ªäººPC</th></tr></thead><tbody><tr><td>æœºå™¨å‹å·</td><td>f1-micro 1vCPU 0.6GB 10GB</td><td>g1-small 1vCPU 1.7GB 40GB</td><td>ecs.n4.small 1vCPU 2GiB 40GB</td><td>1vCPU 1GB 20GB</td><td>4CPU 8GB 480GB(nvme)</td></tr><tr><td>å‚è€ƒä»·æ ¼</td><td>$6&#x2F;mo</td><td>$20&#x2F;mo</td><td>ï¿¥98&#x2F;mo</td><td>ï¿¥26&#x2F;mo</td><td></td></tr><tr><td>ç³»ç»Ÿ</td><td>Ubuntu 18.04 LTS</td><td>Ubuntu 18.04 LTS</td><td>CentOS 7</td><td>Ubuntu 18.04 LTS</td><td>Ubuntu 18.04 LTS</td></tr><tr><td>CPUä¿¡æ¯</td><td>Xeon(R) CPU @ 2.00GHz</td><td>Xeon(R) CPU @ 2.00GHz</td><td>E5-2682 v4 @ 2.50GHz</td><td>E3-12xx v2 @ 2.50GHz</td><td>i3-8100 CPU @ 3.60GHz</td></tr><tr><td>sysbench(cpu)</td><td>9469 (v1.0.11)</td><td>9477 (v1.0.11)</td><td>7909 (v1.0.17)</td><td>6157 (v1.0.11)</td><td>12799 (v1.0.11)</td></tr><tr><td>4K W&#x2F;R</td><td>6.5 MB&#x2F;s 8.1 MB&#x2F;s</td><td>6.6 MB&#x2F;s 7.8 MB&#x2F;s</td><td>8.3 MB&#x2F;s 8.7 MB&#x2F;s</td><td>1.2 MB&#x2F;s 1.2 MB&#x2F;s</td><td>245 MB&#x2F;s 80 MB&#x2F;s</td></tr><tr><td>1M W&#x2F;R</td><td>37.7 MB&#x2F;s 128 MB&#x2F;s</td><td>37.7 MB&#x2F;s 128 MB&#x2F;s</td><td>109 MB&#x2F;s 111 MB&#x2F;s</td><td>101 MB&#x2F;s 103MB&#x2F;s</td><td>1 GB&#x2F;s 1 GB&#x2F;s</td></tr><tr><td>RAM 4K</td><td>975 MB&#x2F;s 1.5 GB&#x2F;s</td><td>1.2 GB&#x2F;s 2.3 GB&#x2F;s</td><td>1.2 GB&#x2F;s 2.1 GB&#x2F;s</td><td>89.1 MB&#x2F;s 94.2 MB&#x2F;s</td><td>2.2 GB&#x2F;s 2.9 GB&#x2F;s</td></tr><tr><td>MariaDB ENCODE</td><td></td><td>1.457s (19.03.5)</td><td>1.772s (18.06.1)</td><td>2.135s (19.03.5)</td><td>1.126s (19.03.4)</td></tr><tr><td>å…¬ç½‘å¸¦å®½</td><td>&gt;100Mb</td><td>&gt;100Mb</td><td>1Mb</td><td>å…±äº«50Mb</td><td>å®¶å®½</td></tr></tbody></table><h1 id="æµ‹è¯•é¡¹è¯´æ˜"><a href="#æµ‹è¯•é¡¹è¯´æ˜" class="headerlink" title="æµ‹è¯•é¡¹è¯´æ˜"></a>æµ‹è¯•é¡¹è¯´æ˜</h1><h2 id="sysbench-cpu"><a href="#sysbench-cpu" class="headerlink" title="sysbench(cpu)"></a>sysbench(cpu)</h2><p>ç›´æ¥è¿è¡Œå¦‚ä¸‹shellå‘½ä»¤ï¼Œå¹¶å–è¿è¡Œè¾“å‡ºä¸­çš„<code>Threads fairness avg events</code>ä½œä¸ºæµ‹è¯•ç»“æœï¼ˆè¡¨ä¸­æ‹¬å·å†…ä¸ºsysbenchè½¯ä»¶ç‰ˆæœ¬ï¼‰ï¼Œæ•°å€¼è¶Šå¤§è¶Šå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sysbench --test=cpu --cpu-max-prime=10000 run<br></code></pre></td></tr></table></figure><h2 id="4K-W-x2F-R"><a href="#4K-W-x2F-R" class="headerlink" title="4K W&#x2F;R"></a>4K W&#x2F;R</h2><p>ç”¨å¦‚ä¸‹ddå‘½ä»¤ä»¥4Kä¸ºå—å•ä½æµ‹è¯•ç¡¬ç›˜å†™è¯»é€Ÿåº¦ï¼ˆæµ‹3æ¬¡å–å¹³å‡å€¼ï¼‰ï¼Œæ•°å€¼è¶Šå¤§è¶Šå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">dd if=/dev/zero of=tmpfile bs=4096 count=32768 oflag=direct<br>dd of=/dev/null if=tmpfile bs=4096 count=32768 iflag=direct<br></code></pre></td></tr></table></figure><h2 id="1M-W-x2F-R"><a href="#1M-W-x2F-R" class="headerlink" title="1M W&#x2F;R"></a>1M W&#x2F;R</h2><p>ç”¨å¦‚ä¸‹ddå‘½ä»¤ä»¥1Mä¸ºå—å•ä½æµ‹è¯•ç¡¬ç›˜å†™è¯»é€Ÿåº¦ï¼ˆæµ‹3æ¬¡å–å¹³å‡å€¼ï¼‰ï¼Œæ•°å€¼è¶Šå¤§è¶Šå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">dd if=/dev/zero of=tmpfile bs=1048576 count=1024 oflag=direct<br>dd of=/dev/null if=tmpfile bs=1048576 count=1024 iflag=direct<br></code></pre></td></tr></table></figure><h2 id="RAM-4K"><a href="#RAM-4K" class="headerlink" title="RAM 4K"></a>RAM 4K</h2><p>æŒ‚è½½å‡ºä¸€å—å†…å­˜ç›˜ï¼Œç”¨ddå‘½ä»¤ä»¥4Kä¸ºå—å•ä½æµ‹è¯•å†…å­˜å†™è¯»é€Ÿåº¦ï¼ˆç”±äºå†…å­˜ç›˜ä¸æ”¯æŒdirect ioï¼Œç¬¬äºŒæ¬¡ä¹‹åçš„æµ‹è¯•ç»“æœæœ‰è¾ƒå¤§æ³¢åŠ¨ï¼Œæ•…åªå–é¦–æ¬¡è¿è¡Œç»“æœï¼‰ï¼Œæ•°å€¼è¶Šå¤§è¶Šå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir ~/ram<br>sudo mount -t tmpfs -o size=512m ramdisk ~/ram<br>sudo chown $USER:$USER ~/ram<br>cd ~/ram<br>dd if=/dev/zero of=tmpfile bs=4096 count=65536<br>dd of=/dev/null if=tmpfile bs=4096 count=65536<br></code></pre></td></tr></table></figure><h2 id="MariaDB-ENCODING"><a href="#MariaDB-ENCODING" class="headerlink" title="MariaDB ENCODING"></a>MariaDB ENCODING</h2><p>ç”¨Dockerè¿è¡Œä¸€ä¸ªMariaDBå®ä¾‹ï¼Œè¿è¡Œä¹‹åä½¿ç”¨ENCODINGå‘½ä»¤æµ‹è¯•MariaDBè¿è¡Œé€Ÿåº¦ï¼ˆè¡¨ä¸­æ‹¬å·å†…ä¸ºDockerç‰ˆæœ¬ï¼‰ï¼Œæ•°å€¼è¶Šå°è¶Šå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir ~/mariadb_vol<br>docker run -d -v ~/mariadb_vol:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=12345 --name mariadb_test --restart=always mariadb --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci<br>docker exec -it mariadb_test mysql -uroot -p12345<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> BENCHMARK(<span class="hljs-number">10000000</span>,ENCODE(<span class="hljs-string">&#x27;hello&#x27;</span>,<span class="hljs-string">&#x27;goodbye&#x27;</span>));<br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¾¿å®œè‡ªæœ‰ä¾¿å®œçš„é“ç†ï¼ŒNAT VPSæœ‰ç€å¤§å¸¦å®½ï¼ˆè™½ç„¶æ˜¯å…±äº«çš„ï¼‰ã€ä½ä»·æ ¼çš„ä¼˜åŠ¿ï¼Œä½†æ¢æ¥çš„æ˜¯è€æ—§çš„ç¡¬ä»¶å¹³å°ï¼ˆ2012å¹´çš„Ivy Bridge + DDR3ï¼‰å’Œæ¥è¿‘æœºæ¢°ç¡¬ç›˜çš„4Kè¯»å†™é€Ÿåº¦ã€‚<br>é˜¿é‡Œäº‘ã€è°·æ­Œäº‘ç­‰å¤§å‹äº‘å¹³å°çš„VPSè™½ç„¶å¸¦å®½æˆ–æµé‡è´µã€ä»·æ ¼ä¹Ÿè´µï¼Œä½†ç¡¬ä»¶å¹³å°å¾€å¾€æ˜¯è¾ƒæ–°çš„ï¼ˆé˜¿é‡Œäº‘æ˜¯2016å¹´çš„Broadwell + DDR4ï¼Œè°·æ­Œäº‘åˆ™æ›´æ–°ï¼‰ï¼Œç¡¬ç›˜æ€§èƒ½ä¹Ÿæ›´æœ‰ä¿éšœï¼ˆä¸è¿‡è°·æ­Œäº‘å®åœ¨æ˜¯è´µå•Šâ€¦â€¦ï¼‰ã€‚æ€ä¹ˆå–èˆï¼Œè¿˜æ˜¯è¦çœ‹ä¸ªäººéœ€æ±‚ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
      <tag>vps</tag>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¿®æ”¹Kongå®˜æ–¹Dockeré•œåƒ</title>
    <link href="/2019/05/30/%E4%BF%AE%E6%94%B9Kong%E5%AE%98%E6%96%B9Docker%E9%95%9C%E5%83%8F/"/>
    <url>/2019/05/30/%E4%BF%AE%E6%94%B9Kong%E5%AE%98%E6%96%B9Docker%E9%95%9C%E5%83%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2019-05-30.01.png"><br>å¼€æºé¡¹ç›®<a href="https://konghq.com/">Kong</a>æ˜¯å½“ä¸‹æœ€ç«çš„API Gatewayé¡¹ç›®ä¹‹ä¸€ï¼Œå®˜æ–¹ä¹Ÿåœ¨<a href="https://hub.docker.com/_/kong">Docker Hub</a>ä¸Šæä¾›äº†Kongçš„é•œåƒã€‚ä½†æˆ‘åœ¨ä½¿ç”¨å®˜æ–¹é•œåƒæ¥éƒ¨ç½²Kongçš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œæˆ‘éœ€è¦å¯¹å®˜æ–¹é•œåƒåšä¸€äº›æ”¹åŠ¨æ¥é€‚åº”æˆ‘çš„éœ€æ±‚ï¼š</p><ul><li>åœ¨Dockerå¯åŠ¨æ—¶åªéœ€è¦ç»™å®šé•œåƒã€å¯åŠ¨å‘½ä»¤å³å¯å®Œæˆéƒ¨ç½²ï¼ˆåŒ…æ‹¬åˆæ¬¡éƒ¨ç½²ï¼‰ï¼Œæ–¹ä¾¿è¿ç§»k8sï¼›</li><li>æ–¹ä¾¿Kongåˆ‡æ¢ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼›</li><li>å°†Kongæ‰€æœ‰çš„æ—¥å¿—å­˜æ”¾åœ¨æŒ‡å®šç›®å½•ï¼Œæ–¹ä¾¿æŒ‚è½½å­˜å‚¨ã€‚</li></ul><p>è¿™ç¯‡æ–‡ç« è®°å½•çš„å°±æ˜¯æˆ‘æ”¹åŠ¨çš„æ€è·¯å’Œè¿‡ç¨‹ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬æ–‡æ‰€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒä¸º<code>Ubuntu 18.04 LTS</code>+<code>Docker 18.09.6</code>ï¼ŒKongä½¿ç”¨çš„æ•°æ®åº“å‡ä¸º<code>PostgreSQL</code>ï¼Œä½¿ç”¨çš„Kongé•œåƒç‰ˆæœ¬ä¸º<code>1.1.2-alpine</code></p></blockquote><h1 id="å®˜æ–¹é•œåƒåˆ†æ"><a href="#å®˜æ–¹é•œåƒåˆ†æ" class="headerlink" title="å®˜æ–¹é•œåƒåˆ†æ"></a>å®˜æ–¹é•œåƒåˆ†æ</h1><p>Kongçš„å®˜æ–¹æ–‡æ¡£ï¼ˆ<a href="https://docs.konghq.com/install/docker/">Docker Installation</a>ï¼‰ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„Kongéƒ¨ç½²æ•™ç¨‹ï¼Œè®°å½•å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">åˆ›å»ºdockerç½‘ç»œ</span><br>docker network create kong-net<br><span class="hljs-meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ•°æ®åº“</span><br>docker run -d --name kong-database \<br>               --network=kong-net \<br>               -p 5432:5432 \<br>               -e &quot;POSTGRES_USER=kong&quot; \<br>               -e &quot;POSTGRES_DB=kong&quot; \<br>               postgres:9.6<br><span class="hljs-meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ–æ•°æ®åº“</span><br>docker run --rm \<br>     --network=kong-net \<br>     -e &quot;KONG_DATABASE=postgres&quot; \<br>     -e &quot;KONG_PG_HOST=kong-database&quot; \<br>     kong:latest kong migrations bootstrap<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯åŠ¨Kong</span><br>docker run -d --name kong \<br>     --network=kong-net \<br>     -e &quot;KONG_DATABASE=postgres&quot; \<br>     -e &quot;KONG_PG_HOST=kong-database&quot; \<br>     -e &quot;KONG_PROXY_ACCESS_LOG=/dev/stdout&quot; \<br>     -e &quot;KONG_ADMIN_ACCESS_LOG=/dev/stdout&quot; \<br>     -e &quot;KONG_PROXY_ERROR_LOG=/dev/stderr&quot; \<br>     -e &quot;KONG_ADMIN_ERROR_LOG=/dev/stderr&quot; \<br>     -e &quot;KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl&quot; \<br>     -p 8000:8000 \<br>     -p 8443:8443 \<br>     -p 8001:8001 \<br>     -p 8444:8444 \<br>     kong:latest<br></code></pre></td></tr></table></figure><p>ä»ä»¥ä¸Šæ•™ç¨‹å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºå®˜æ–¹é•œåƒè®¾ç½®ç¯å¢ƒå˜é‡æ¥é…ç½®Kongï¼›è€Œä¸”ï¼Œè¯¥é•œåƒè¿˜æœ‰ä¸€ä¸ªé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥å¯åŠ¨Kongä¸»è¿›ç¨‹ã€‚<br>ç„¶åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹<code>kong:1.1.2-alpine</code>è¿™ä¸ªå®˜æ–¹é•œåƒçš„<a href="https://github.com/Kong/docker-kong/blob/bb4efafd0e2272be1c27b9aa2de60cd0022a3fad/alpine/Dockerfile">Dockerfile</a>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.6</span><br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=<span class="hljs-string">&quot;Kong Core Team &lt;team-core@konghq.com&gt;&quot;</span></span><br><br><span class="hljs-keyword">ENV</span> KONG_VERSION <span class="hljs-number">1.1</span>.<span class="hljs-number">2</span><br><span class="hljs-keyword">ENV</span> KONG_SHA256 <span class="hljs-number">0</span>d7509fa2ef653b4aba14a1a1fd20339bccb4f8d386429102c42b7af6d8b6bdb<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> adduser -Su 1337 kong \</span><br><span class="language-bash">... <span class="hljs-comment"># çœç•¥</span></span><br>&amp;&amp; chmod -R g=u /usr/local/kong<br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> docker-entrypoint.sh /docker-entrypoint.sh</span><br><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;/docker-entrypoint.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8000</span> <span class="hljs-number">8443</span> <span class="hljs-number">8001</span> <span class="hljs-number">8444</span><br><br><span class="hljs-keyword">STOPSIGNAL</span> SIGTERM<br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;kong&quot;</span>, <span class="hljs-string">&quot;docker-start&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>ä»Dockerfileå¯ä»¥çœ‹å‡ºï¼Œå®˜æ–¹é•œåƒé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ä¸º<code>ENTRYPOINT</code>+<code>CMD</code>ï¼›å†ç»“åˆå‰æ–‡å®˜æ–¹æ•™ç¨‹é‡Œåˆå§‹åŒ–æ•°æ®åº“çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ul><li>åˆå§‹åŒ–æ•°æ®åº“çš„å®¹å™¨å†…å¯åŠ¨å‘½ä»¤ä¸ºï¼š<code>/docker-entrypoint.sh kong migrations bootstrap</code></li><li>å¯åŠ¨Kongä¸»è¿›ç¨‹çš„å®¹å™¨å†…å¯åŠ¨å‘½ä»¤ä¸ºï¼š<code>/docker-entrypoint.sh kong docker-start</code></li></ul><p>æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å®˜æ–¹é•œåƒè¿›è¡Œä¿®æ”¹äº†ã€‚</p><h1 id="è‡ªå®šä¹‰Dockerfileã€å¯åŠ¨è„šæœ¬"><a href="#è‡ªå®šä¹‰Dockerfileã€å¯åŠ¨è„šæœ¬" class="headerlink" title="è‡ªå®šä¹‰Dockerfileã€å¯åŠ¨è„šæœ¬"></a>è‡ªå®šä¹‰Dockerfileã€å¯åŠ¨è„šæœ¬</h1><p>è€ƒè™‘åˆ°æˆ‘æœ‰å¤šå¥—Kongé…ç½®åˆ†åˆ«ç”¨äºä¸åŒç¯å¢ƒï¼ˆæœ¬åœ°è°ƒè¯•ã€æµ‹è¯•ã€å®é™…åº”ç”¨ç­‰ï¼‰ï¼Œè€Œè¿™äº›é…ç½®ä¸­æœ‰è®¸å¤šé‡å¤çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©å°†è¿™äº›é‡å¤çš„é…ç½®é¡¹æ”¾å…¥Dockerfileä¸­ï¼Œä¸é‡å¤çš„é…ç½®é¡¹æ”¾å…¥è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬ä¸­ã€‚Dockerfileå¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> kong:<span class="hljs-number">1.1</span>.<span class="hljs-number">2</span>-alpine<br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=<span class="hljs-string">&quot;orange_wolf &lt;orange_wolf@163.com&gt;&quot;</span></span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . /gateway</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /gateway</span><br><span class="hljs-comment"># KONG_PREFIXæŒ‡å®šå·¥ä½œç›®å½•ï¼ŒKongçš„æ—¥å¿—é»˜è®¤å­˜å‚¨åœ¨ KONG_PREFIX/logs/ ç›®å½•ä¸‹</span><br><span class="hljs-keyword">ENV</span> KONG_PREFIX=/gateway KONG_ADMIN_LISTEN=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">8001</span> KONG_DATABASE=postgres<br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8000</span> <span class="hljs-number">8001</span><br><span class="hljs-comment"># è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;./run-kong.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/usr/bin/env sh</span><br>case $&#123;1&#125; in<br>&quot;local&quot;)<br>    export KONG_PG_HOST=192.168.0.100<br>    export KONG_PG_USER=xxxxxx<br>    export KONG_PG_PASSWORD=xxxxxx<br>    ... # çœç•¥<br>    ;;<br>&quot;pro&quot;)<br>    export KONG_PG_HOST=xxx.xxx.xxx.xxx<br>    export KONG_PG_USER=xxxxxx<br>    export KONG_PG_PASSWORD=xxxxxx<br>    ... # çœç•¥<br>    ;;<br>... # çœç•¥<br>esac<br><br>/docker-entrypoint.sh kong migrations bootstrap  # åˆå§‹åŒ–æ•°æ®åº“<br>/docker-entrypoint.sh kong docker-start  # å¯åŠ¨Kong<br></code></pre></td></tr></table></figure><p>äºæ˜¯ï¼Œæˆ‘ç”¨è‡ªå®šä¹‰çš„å¯åŠ¨è„šæœ¬ä»£æ›¿äº†åŸæœ‰çš„å¯åŠ¨è„šæœ¬ï¼Œè¿™æ ·å°±èƒ½è®©æˆ‘é€šè¿‡åœ¨å¯åŠ¨å®¹å™¨æ—¶è¾“å…¥ä¸åŒæŒ‡ä»¤æ¥è½½å…¥ä¸åŒKongé…ç½®ï¼Œä¹Ÿèƒ½è®©Kongåœ¨è¿æ¥åˆ°ç©ºæ•°æ®åº“æ—¶è‡ªåŠ¨å®ç°åˆå§‹åŒ–åŠ¨ä½œï¼ˆè€Œä¸æ˜¯ç›´æ¥é€€å‡ºï¼‰ã€‚è€Œè¿™ç§éƒ¨ç½²æ–¹å¼ä¹Ÿæ›´çµæ´»ï¼Œæ›´å®¹æ˜“ä»Dockerè¿ç§»åˆ°k8sç­‰å…¶å®ƒå¹³å°ã€‚å®é™…éƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build . -t my-kong-image<br>docker run -d --name kong -p 8000:8000 -p 8001:8001 my-kong-image local  # è½½å…¥æœ¬åœ°è°ƒè¯•é…ç½®<br>docker run -d --name kong -p 8000:8000 -p 8001:8001 my-kong-image test  # è½½å…¥æµ‹è¯•é…ç½®<br>docker run -d --name kong -p 8000:8000 -p 8001:8001 my-kong-image pro  # è½½å…¥å®é™…åº”ç”¨é…ç½®<br></code></pre></td></tr></table></figure><h1 id="ä»¥rootå‘½ä»¤å¯åŠ¨Nginx"><a href="#ä»¥rootå‘½ä»¤å¯åŠ¨Nginx" class="headerlink" title="ä»¥rootå‘½ä»¤å¯åŠ¨Nginx"></a>ä»¥rootå‘½ä»¤å¯åŠ¨Nginx</h1><p>åœ¨è‡ªå®šä¹‰äº†Dockerfileå’Œå¯åŠ¨è„šæœ¬åï¼Œä¼¼ä¹ä¸€åˆ‡éƒ½èƒ½æ»¡è¶³æˆ‘çš„éœ€æ±‚äº†ã€‚ä½†ä¸å¹¸çš„æ—¶ï¼Œä»¥è¿™ä¸ªé•œåƒå¯åŠ¨å®¹å™¨æ—¶æˆ‘é‡åˆ°äº†å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">nginx: [alert] could not <span class="hljs-keyword">open</span> <span class="hljs-keyword">error</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">file</span>: <span class="hljs-keyword">open</span>() <span class="hljs-string">&quot;/gateway/logs/error.log&quot;</span> failed (13: Permission denied)<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œnginxæ²¡æœ‰è¶³å¤Ÿçš„æƒé™å°†æ—¥å¿—å†™å…¥æˆ‘æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶å¤¹ä¸­ã€‚ç”±äºåœ¨ä¸æŒ‡å®š<code>KONG_PREFIX</code>ç¯å¢ƒå˜é‡æ—¶ï¼Œnginxå’ŒKongèƒ½æ­£å¸¸å°†æ—¥å¿—æ–‡ä»¶å†™å…¥é»˜è®¤çš„<code>/usr/local/kong/logs/</code>ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘å°è¯•åœ¨å¯åŠ¨è„šæœ¬<code>run-kong.sh</code>ä¸­é€šè¿‡<code>chmod</code>ã€<code>chown</code>å‘½ä»¤ï¼Œå°†<code>/gateway/logs/</code>ç›®å½•çš„æƒé™ä¸<code>/usr/local/kong/logs/</code>ç›®å½•çš„æƒé™åŒæ­¥ï¼Œä½†è¿˜æ˜¯å‡ºç°äº†ä¸€æ ·çš„é”™è¯¯æç¤ºã€‚<br>ä¸Šæ–‡æåˆ°ï¼Œå®˜æ–¹é•œåƒçš„å¯åŠ¨è„šæœ¬ä¸º<code>/docker-entrypoint.sh</code>ã€‚æˆ‘æ‰¾åˆ°äº†è¿™ä»½å’Œå®˜æ–¹Dockerfileæ”¾åœ¨ä¸€èµ·çš„<a href="https://github.com/Kong/docker-kong/blob/bb4efafd0e2272be1c27b9aa2de60cd0022a3fad/alpine/docker-entrypoint.sh">å¯åŠ¨è„šæœ¬</a>ï¼Œå‘ç°nginxæ˜¯ä»¥<code>kong</code>ç”¨æˆ·çš„èº«ä»½è¿è¡Œçš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>      ...  # çœç•¥<br>      exec su-exec kong /usr/local/openresty/nginx/sbin/nginx \<br>        -p &quot;$PREFIX&quot; \<br>        -c nginx.conf<br>    fi<br>  fi<br>fi<br><br>exec &quot;$@&quot;<br></code></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæˆ‘åœ¨è‡ªå·±çš„å¯åŠ¨è„šæœ¬å†…ä¿®æ”¹å®˜æ–¹çš„å¯åŠ¨è„šæœ¬ï¼Œè®©nginxä»¥rootæƒé™è¿è¡Œå°±å¯ä»¥è§£å†³é—®é¢˜äº†ã€‚ä¿®æ”¹åçš„è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">...  # çœç•¥<br><br>sed -i &#x27;s/su-exec kong/su-exec root/g&#x27; /docker-entrypoint.sh  # ä¿®æ”¹å¯åŠ¨è„šæœ¬ï¼Œä»¥rootèº«ä»½å¯åŠ¨nginx<br>/docker-entrypoint.sh kong migrations bootstrap  # åˆå§‹åŒ–æ•°æ®åº“<br>/docker-entrypoint.sh kong docker-start  # å¯åŠ¨Kong<br></code></pre></td></tr></table></figure><p>é¡ºä¾¿ä¸€æï¼Œå¦‚æœæƒ³åœ¨å®¹å™¨å†…è®©Kongçš„é»˜è®¤ç«¯å£ç”±<code>8000</code>å˜ä¸º<code>80</code>ï¼ˆ<code>KONG_PROXY_LISTEN=0.0.0.0:80</code>ï¼‰æˆ–å…¶å®ƒä½äº<code>1024</code>çš„ç«¯å£ï¼ŒåŒæ ·éœ€è¦è®©nginxä»¥rootèº«ä»½è¿è¡Œã€‚</p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>å¼€æºé¡¹ç›®å®˜æ–¹æä¾›çš„Dockeré•œåƒï¼Œå¾€å¾€è¦æ¯”è‡ªå·±ç”¨<code>Alpine</code>ã€<code>CentOS</code>ã€<code>Debian</code>ç­‰åŸºç¡€é•œåƒä¸€æ­¥æ­¥å®‰è£…é¡¹ç›®æ„æˆçš„é•œåƒæ¥å¾—æ–¹ä¾¿ã€ç¨³å®šã€å¥½ç”¨ï¼›ä½†åè€…åˆå¾€å¾€æ‹¥æœ‰å‰è€…æ— å¯æ¯”æ‹Ÿçš„è‡ªç”±åº¦ã€‚å…¶å®ï¼Œé€šè¿‡åˆ†æå¹¶â€œ<code>ç»§æ‰¿</code>â€å®˜æ–¹Dockerfileã€ç¼–å†™è‡ªå·±çš„å¯åŠ¨è„šæœ¬ï¼Œå¾€å¾€èƒ½å¤ŸåŒæ—¶æ‹¥æœ‰å‰ä¸¤ç§é•œåƒçš„ä¼˜ç‚¹â€”â€”æ—¢æ–¹ä¾¿ï¼Œåˆè‡ªç”±ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>API GATEWAY</tag>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoè§†å›¾å‡½æ•°æ•æ‰å¼‚å¸¸</title>
    <link href="/2019/05/23/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%8D%95%E6%8D%89%E5%BC%82%E5%B8%B8/"/>
    <url>/2019/05/23/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%8D%95%E6%8D%89%E5%BC%82%E5%B8%B8/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2019-05-23.01.png"><br>ä¸å­˜åœ¨æ²¡æœ‰BUGçš„ä»£ç ï¼Œä¹Ÿä¸å­˜åœ¨ä¸ä¼šå‡ºç°å¼‚å¸¸çš„è§†å›¾å‡½æ•°ã€‚å½“Djangoè§†å›¾å‡½æ•°ä¸­çš„ä»£ç å‡ºç°å¼‚å¸¸æ—¶ï¼Œè®¿é—®è¿™ä¸ªURLçš„ç”¨æˆ·å°±ä¼šæ”¶åˆ°çŠ¶æ€ç ä¸º<code>500 Internal Server Error</code>çš„HTTP å“åº”ã€‚å¦‚ä½•æ•æ‰è§†å›¾å‡½æ•°é‡Œå‡ºç°çš„å¼‚å¸¸ï¼Œè¿™æ˜¯æœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„é—®é¢˜ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬æ–‡æ‰€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒä¸º<code>uWSGI 2.0.18</code>+<code>Python3.6</code>+<code>Django 2.2</code></p></blockquote><h1 id="åœ¨uWSGIçš„æ—¥å¿—ä¸­æ˜¾ç¤ºTraceback"><a href="#åœ¨uWSGIçš„æ—¥å¿—ä¸­æ˜¾ç¤ºTraceback" class="headerlink" title="åœ¨uWSGIçš„æ—¥å¿—ä¸­æ˜¾ç¤ºTraceback"></a>åœ¨uWSGIçš„æ—¥å¿—ä¸­æ˜¾ç¤ºTraceback</h1><p>è¿™ç§æ–¹æ³•ç®—æ˜¯ä¸€ç§æ¯”è¾ƒæ¶ˆæçš„å¼‚å¸¸æ•æ‰æ–¹å¼â€”â€”ä»…å°†<code>Traceback</code>å¼‚å¸¸ä¿¡æ¯è®°å½•åœ¨uWSGIçš„æ—¥å¿—ä¸­ï¼Œä¸åšè¿›ä¸€æ­¥å¤„ç†ã€‚æ—¥å¿—å¯ä»¥ç”¨äºæ—¥ååˆ†æï¼Œä½†ç”¨æˆ·æ”¶åˆ°çš„ä»ç„¶æ˜¯<code>500 Internal Server Error</code>å“åº”ã€‚è€Œè¿™ç§æ•æ‰æ–¹å¼ä¹Ÿæ˜¯é»˜è®¤å¯ç”¨çš„ï¼Œåªè¦æ‰€ä½¿ç”¨çš„Djangoç‰ˆæœ¬é«˜äºæˆ–ç­‰äº<code>1.9</code>å°±è¡Œã€‚ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># django_test/urls.py</span><br><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> path<br><span class="hljs-keyword">from</span> .views <span class="hljs-keyword">import</span> index<br><br>urlpatterns = [<br>    path(<span class="hljs-string">&#x27;index&#x27;</span>, index),<br>]<br><br><span class="hljs-comment"># django_test/views.py</span><br><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-number">1</span> / <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">b&#x27;hello world&#x27;</span>)<br></code></pre></td></tr></table></figure><p>é…ç½®å¥½è·¯ç”±å’Œè§†å›¾å‡½æ•°å¹¶ç”¨<code>uWSGI</code>å¯åŠ¨åº”ç”¨åï¼Œè®¿é—®<code>/index</code>é¡µé¢å°±ä¼šè§¦å‘<code>ZeroDivisionError</code>å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸çš„Tracebackä¿¡æ¯ä¹Ÿä¼šè¾“å‡ºè‡³<code>uWSGI</code>çš„æ—¥å¿—ä¸­ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">uwsgi --module django_test.wsgi --http 0.0.0.0:5000</span><br>*** Starting uWSGI 2.0.18 (64bit) on [Thu May 23 16:27:42 2019] ***<br>......<br>spawned uWSGI worker 1 (and the only) (pid: 13888, cores: 1)<br>Traceback (most recent call last):<br>  ......<br>  File &quot;./django_test/views.py&quot;, line 3, in index<br>    1 / 0<br>ZeroDivisionError: division by zero<br>[pid: 13888|app: 0|req: 1/1] 127.0.0.1 () &#123;40 vars in 964 bytes&#125; [Thu May 23 08:27:44 2019] GET /index =&gt; generated 55641 bytes in 47 msecs (HTTP/1.1 500) 1 headers in 63 bytes (1 switches on core 0)<br></code></pre></td></tr></table></figure><h1 id="ç”¨å‡½æ•°è£…é¥°å™¨æ•æ‰å¼‚å¸¸"><a href="#ç”¨å‡½æ•°è£…é¥°å™¨æ•æ‰å¼‚å¸¸" class="headerlink" title="ç”¨å‡½æ•°è£…é¥°å™¨æ•æ‰å¼‚å¸¸"></a>ç”¨å‡½æ•°è£…é¥°å™¨æ•æ‰å¼‚å¸¸</h1><p>Djangoä¸­çš„è§†å›¾å‡½æ•°åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼ˆåºŸè¯ï¼‰ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªèƒ½å¤Ÿæ•æ‰å¼‚å¸¸çš„å‡½æ•°è£…é¥°å™¨æ¥åŒ…è£¹è¿™ä¸ªè§†å›¾å‡½æ•°ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># django_test/views.py</span><br><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">catch_exc</span>(<span class="hljs-params">func</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> func(*args, **kwargs)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-comment"># put your code here</span><br>            <span class="hljs-comment"># logger.error(traceback.format_exc())</span><br><br>            <span class="hljs-comment"># return Response or just raise</span><br>            <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-built_in">str</span>(ex))<br><br>    <span class="hljs-keyword">return</span> wrapper<br><br><br><span class="hljs-meta">@catch_exc</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-number">1</span> / <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">b&#x27;hello world&#x27;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨ä¾‹å­ç¬¬18è¡Œï½ç¬¬19è¡Œï¼Œæˆ‘ç”¨<code>catch_exc</code>è¿™ä¸ªè£…é¥°å™¨åŒ…è£¹äº†<code>index</code>è¿™ä¸ªè§†å›¾å‡½æ•°ã€‚è€Œåœ¨<code>catch_exc</code>è¿™ä¸ªè£…é¥°å™¨å†…éƒ¨ï¼Œæˆ‘ç”¨<code>except Exception</code>è¯­å¥æ•æ‰äº†<code>index</code>å‡½æ•°æ‰€æœ‰å¯èƒ½å‡ºç°çš„å¼‚å¸¸ã€‚ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§éœ€è¦æ¥è¿›è¡Œå„ç§æ“ä½œäº†ï¼Œæ¯”å¦‚ï¼š</p><ul><li>ç”¨<code>traceback.format_exc()</code>è·å–è¯¦ç»†çš„<code>Traceback</code>ä¿¡æ¯ï¼›</li><li>å°†é”™è¯¯ä¿¡æ¯è¾“å‡ºè‡³æ—¥å¿—ï¼›</li><li>é€šçŸ¥æŸäººï¼›</li></ul><p>ç­‰ç­‰ç­‰ç­‰ã€‚å¯¹å¼‚å¸¸çš„å¤„ç†å®Œæˆåï¼Œæˆ‘ä»¬æ—¢å¯ä»¥é€šè¿‡<code>raise</code>è¯­å¥è®©ç”¨æˆ·ä»ç„¶æ”¶åˆ°<code>500 Internal Server Error</code>å“åº”ï¼Œä¹Ÿå¯ä»¥åƒä¸Šé¢çš„ä¾‹å­ä¸­è¿”å›ä¸€ä¸ªå…³äºå¼‚å¸¸ä¿¡æ¯çš„<code>200 OK</code>å“åº”ï¼Œè¿˜å¯ä»¥æ¸²æŸ“ä¸€ä¸ªæç¤ºHTMLé¡µé¢è¿”å›ç»™ç”¨æˆ·ã€‚æ€»ä¹‹ï¼ŒEverything is under control.</p><h1 id="ç”¨Djangoä¸­é—´ä»¶æ•æ‰å¼‚å¸¸"><a href="#ç”¨Djangoä¸­é—´ä»¶æ•æ‰å¼‚å¸¸" class="headerlink" title="ç”¨Djangoä¸­é—´ä»¶æ•æ‰å¼‚å¸¸"></a>ç”¨Djangoä¸­é—´ä»¶æ•æ‰å¼‚å¸¸</h1><p>å‡½æ•°è£…é¥°å™¨å¾ˆå¥½ç”¨ï¼Œä½†è£…é¥°å™¨åªèƒ½é’ˆå¯¹å•ä¸ªè§†å›¾å‡½æ•°ã€‚æœ‰æ²¡æœ‰ä¸€ç§åº”ç”¨äºæ‰€æœ‰è§†å›¾å‡½æ•°ä¹‹ä¸Šçš„å¼‚å¸¸æ•æ‰æ–¹æ³•ï¼Ÿæœ‰çš„ï¼Œè¿™å°±æ˜¯Djangoçš„ä¸­é—´ä»¶ã€‚å’Œæˆ‘ä¸Šä¸€ç¯‡æ–‡ç« ï¼ˆ<a href="/2019/03/11/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">ä½¿ç”¨ä¸­é—´ä»¶å¯¹è§†å›¾å‡½æ•°è¿›è¡Œæ€§èƒ½åˆ†æ</a>ï¼‰ä¸åŒçš„æ˜¯ï¼Œé‚£ç¯‡æ–‡ç« é‡Œæ‰€ä½¿ç”¨çš„ä¸­é—´ä»¶hookä¸º<code>process_request&amp;process_response</code>ï¼Œè€Œè¿™é‡Œä½¿ç”¨ä¸­é—´ä»¶hookä¸º<code>process_exception</code>ï¼Œå› ä¸ºå‰è€…æ— æ³•æ•æ‰å¼‚å¸¸ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># django_test/my_middleware.py</span><br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CatchExcMiddleware</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, get_response</span>):<br>        self.get_response = get_response<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, request</span>):<br>        <span class="hljs-keyword">return</span> self.get_response(request)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_exception</span>(<span class="hljs-params">self, request, exception</span>):<br>        <span class="hljs-comment"># put your code here</span><br>        <span class="hljs-comment"># logging.error(traceback.format_exc())</span><br><br>        <span class="hljs-comment"># return Response or None</span><br>        <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-built_in">str</span>(exception))<br><br><span class="hljs-comment"># django_test/settings.py</span><br><span class="hljs-comment"># ......</span><br>MIDDLEWARE = [<br>    <span class="hljs-comment"># ......</span><br>    <span class="hljs-string">&#x27;django_test.my_middleware.CatchExcMiddleware&#x27;</span>,  <span class="hljs-comment"># å¯ç”¨ä¸­é—´ä»¶</span><br>]<br><span class="hljs-comment"># ......</span><br></code></pre></td></tr></table></figure><p>å’Œä¸Šä¸€èŠ‚çš„è£…é¥°å™¨ç±»ä¼¼ï¼Œå½“è§†å›¾å‡½æ•°å‡ºç°å¼‚å¸¸æ—¶ï¼ŒDjangoå°±ä¼šéå†æ‰€æœ‰ä¸­é—´ä»¶çš„<code>process_exception</code>hookï¼ŒåŒ…æ‹¬ä¾‹å­é‡Œçš„ã€‚åœ¨è¿™ä¸ª<code>process_exception</code>æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥å®Œæˆä¸Šä¸€èŠ‚æåˆ°çš„å„ç§æ“ä½œï¼Œæ“ä½œå®Œæˆåå¯ä»¥é€šè¿‡<code>return None</code>è¯­å¥è®©ç”¨æˆ·ä»ç„¶æ”¶åˆ°<code>500 Internal Server Error</code>å“åº”ï¼Œä¹Ÿå¯ä»¥åƒä¸Šé¢çš„ä¾‹å­ä¸­è¿”å›ä¸€ä¸ªå…³äºå¼‚å¸¸ä¿¡æ¯çš„<code>200 OK</code>å“åº”â€¦â€¦è¿™é‡Œå°±ä¸å†é‡å¤äº†ã€‚</p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>å…¶å®åœ¨éDEBUGæ¨¡å¼ï¼ˆ<code>settings.py</code>é‡Œ<code>DEBUG = False</code>ï¼‰ä¸‹ï¼ŒDjangoå¯ä»¥å°†è§†å›¾å‡½æ•°é‡Œå‡ºç°çš„å¼‚å¸¸ä¿¡æ¯ä»¥ç”µå­é‚®ä»¶çš„å½¢å¼å‘é€ç»™<code>ADMINS</code>é‡Œé…ç½®çš„é‚®ç®±åœ°å€ã€‚è¿™ä¸ªåŠŸèƒ½éœ€è¦é…ç½®é‚®ç®±å‚æ•°ã€LOGGINGï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥æŸ¥çœ‹<a href="https://docs.djangoproject.com/en/2.2/howto/error-reporting/">Django2.2å®˜æ–¹æ–‡æ¡£(Error reporting)</a>æˆ–æœç´¢ç›¸å…³æ•™ç¨‹ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>Django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangoè§†å›¾å‡½æ•°æ€§èƒ½åˆ†æ</title>
    <link href="/2019/03/11/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    <url>/2019/03/11/Django%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è™½ç„¶æ ¹æ®ç»éªŒæ¥çœ‹ï¼Œè®¸å¤šç®€å•Djangoåº”ç”¨çš„æ€§èƒ½é—®é¢˜éƒ½æ¥æºäºæ•°æ®åº“IOï¼ˆè€Œè¿™å¯ä»¥é€šè¿‡èšåˆæŸ¥è¯¢ç­‰æ‰‹æ®µè¿›è¡Œä¼˜åŒ–ï¼‰ï¼Œä½†<code>premature optimization is the root of all evil</code>ï¼Œå®šä½æ€§èƒ½é—®é¢˜çš„å…·ä½“ä½ç½®ä»ç„¶æ˜¯æœ€åº”è¯¥å…ˆåšçš„äº‹ã€‚<br>å’Œå…¶å®ƒç›¸å¯¹ç‹¬ç«‹çš„Pythonä»£ç ä¸åŒï¼ŒDjangoçš„è§†å›¾å‡½æ•°ä»£ç ä¸Djangoæ¡†æ¶çš„è€¦åˆåº¦å¾ˆé«˜ï¼Œè¿™ç»™å¯¹ä»£ç çš„æ€§èƒ½åˆ†æå¸¦æ¥äº†ä¸€äº›å›°éš¾ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼ŒDjangoä¸°å¯Œçš„ç”Ÿæ€ç¯å¢ƒä¸­æœ‰è¶³å¤Ÿå¤šçš„æ‰‹æ®µèƒ½è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°å®Œæˆè¿™ä»¶äº‹ã€‚</p><blockquote><p>æ³¨ï¼šæœ¬æ–‡æ‰€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒä¸º<code>Python 3.6</code>+<code>Django 2.1.7</code></p></blockquote><h1 id="Django-Debug-Toolbar"><a href="#Django-Debug-Toolbar" class="headerlink" title="Django Debug Toolbar"></a>Django Debug Toolbar</h1><p>Django Debug Toolbarå¯èƒ½æ˜¯Djangoç”Ÿæ€ç¯å¢ƒä¸­æœ€çŸ¥åã€æœ€å¼ºå¤§çš„é¡µé¢è°ƒè¯•å·¥å…·äº†ï¼ˆ<a href="https://django-debug-toolbar.readthedocs.io/en/latest/">å®˜æ–¹æ–‡æ¡£è¿æ¥</a>ï¼‰ã€‚è¿™ä¸ªå·¥å…·å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†ï¼šé¡µé¢è€—æ—¶ã€è®¾ç½®ã€è¯·æ±‚&#x2F;å“åº”ã€æ¨¡æ¿ã€SQLæ“ä½œç­‰ä¸€ç³»åˆ—ä¿¡æ¯ä»¥ä¾§è¾¹æ çš„å½¢å¼å±•ç¤ºåœ¨ç½‘é¡µå³ä¾§ï¼Œå®˜æ–¹å®£ä¼ å›¾å¦‚ä¸‹ã€‚<br><img src="/images/2019-03-11.01.png"><br>ç”±äºè¯¥å·¥å…·èƒ½å¤Ÿå±•ç¤ºé¡µé¢è€—æ—¶ã€SQLæ“ä½œè€—æ—¶ç­‰ä¿¡æ¯ï¼ˆç‰¹åˆ«æ˜¯åè€…ï¼‰ï¼Œæ‰€ä»¥è¯¥å·¥å…·åœ¨è§†å›¾å‡½æ•°æ€§èƒ½åˆ†ææ–¹é¢ä¹Ÿèƒ½èµ·åˆ°éå¸¸å…³é”®çš„ä½œç”¨ã€‚<br>å…¶æœ€å°åŒ–çš„éƒ¨ç½²æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><p>é€šè¿‡<code>pip</code>å®‰è£…è¯¥å·¥å…·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip install django-debug-toolbar<br><span class="hljs-meta prompt_"># </span><span class="language-bash">é€šè¿‡æºä»£ç å®‰è£…å¼€å‘ç‰ˆ</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">pip install -e git+https://github.com/jazzband/django-debug-toolbar.git<span class="hljs-comment">#egg=django-debug-toolbar</span></span><br></code></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹Djangoé…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤ä¸º<code>settings.py</code>ï¼‰ï¼ŒåŒ…æ‹¬ä¿®æ”¹<code>INSTALLED_APPS</code>ã€<code>MIDDLEWARE</code>é¡¹ï¼Œæ–°å¢<code>INTERNAL_IPS</code>é¡¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">INSTALLED_APPS = [<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-string">&#x27;django.contrib.staticfiles&#x27;</span>,  <span class="hljs-comment"># ç¡®ä¿å·²é…ç½®é™æ€æ–‡ä»¶</span><br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-string">&#x27;debug_toolbar&#x27;</span>,<br>]<br><br>STATIC_URL = <span class="hljs-string">&#x27;/static/&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">MIDDLEWARE = [<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-string">&#x27;debug_toolbar.middleware.DebugToolbarMiddleware&#x27;</span>,<br>    <span class="hljs-comment"># ...</span><br>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">INTERNAL_IPS = [<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>]  <span class="hljs-comment"># åªå¯¹æœ¬æœºè®¿é—®å¯ç”¨</span><br></code></pre></td></tr></table></figure></li><li><p>é…ç½®Django URLè§„åˆ™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> include, path<br><br>urlpatterns = [<br>    <span class="hljs-comment"># ...</span><br>]<br><br><span class="hljs-keyword">if</span> settings.DEBUG:  <span class="hljs-comment"># åªåœ¨DEBUGæ¨¡å¼ä¸‹å¯ç”¨</span><br>    <span class="hljs-keyword">import</span> debug_toolbar<br><br>    urlpatterns.append(<br>        path(<span class="hljs-string">&#x27;__debug__/&#x27;</span>, include(debug_toolbar.urls))<br>    )<br></code></pre></td></tr></table></figure></li></ol><p>æ­¤æ—¶æ‰“å¼€ä»»æ„ä¸€ä¸ªé¡µé¢å³å¯çœ‹åˆ°å¯¹åº”æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/2019-03-11.02.png"><br>å¦å¤–ï¼Œå¯¹äºè¿”å›JSONã€XMLç­‰æ•°æ®çš„æ¥å£å‹è§†å›¾å‡½æ•°æ¥è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡åŠæ³•ä½¿ç”¨Django Debug Toolçš„ã€‚ä¸è¿‡åœ¨æœ¬åœ°è°ƒè¯•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ªç©ºçš„HTMLé¡µé¢ï¼ˆåªéœ€åŒ…å«ä¸€ä¸ªé—­åˆçš„<code>body</code>æ ‡ç­¾ï¼‰æ¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse, JsonResponse<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">view_func</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-comment"># return JsonResponse(&#123;&#x27;data&#x27;: &#x27;...&#x27;&#125;)  # æ— æ³•å¯ç”¨Django Debug Tool</span><br><br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;&lt;body&gt;&lt;/body&gt;&#x27;</span>)  <span class="hljs-comment"># å¯ä»¥å¯ç”¨Django Debug Tool</span><br></code></pre></td></tr></table></figure><h1 id="cProfile-Djangoä¸­é—´ä»¶"><a href="#cProfile-Djangoä¸­é—´ä»¶" class="headerlink" title="cProfile+Djangoä¸­é—´ä»¶"></a>cProfile+Djangoä¸­é—´ä»¶</h1><p>è™½ç„¶Django Debug Toolbaræ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä½†å®ƒå¯¹äºè§†å›¾å‡½æ•°å†…éƒ¨çš„ä»£ç å…·ä½“æ‰§è¡Œè€—æ—¶ä¾ç„¶æ— èƒ½ä¸ºåŠ›ã€‚å¦‚æœæƒ³è¦è¿›è¡Œæ›´æ·±å±‚æ¬¡çš„ä»£ç æ€§èƒ½åˆ†æï¼Œå°±è¦ä½¿ç”¨æˆ‘<a href="/2019/03/08/Python%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E5%90%8E%E7%AF%87%EF%BC%89/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä»‹ç»çš„<code>cProfile</code>è¿™ç±»å·¥å…·äº†ã€‚ä½†ä¸é‚£ç¯‡æ–‡ç« ä¸­æåˆ°çš„ä½¿ç”¨æ–¹æ³•ä¸åŒï¼Œè¿™æ¬¡æˆ‘ä»¬å¿…é¡»å…ˆç¼–å†™Djangoä¸­é—´ä»¶æ‰èƒ½å¯¹Djangoè§†å›¾å‡½æ•°è¿›è¡Œæ€§èƒ½åˆ†æã€‚</p><blockquote><p>æ³¨ï¼šæœ¬èŠ‚å†…å®¹çµæ„Ÿæ¥è‡ªåšæ–‡ï¼š<a href="https://rock-it.pl/how-to-profile-django-views/">How to profile Django views</a></p></blockquote><ol><li><p>ç¼–å†™ä¸­é—´ä»¶ä»£ç ä¸»ä½“ï¼ˆå‡è®¾ä½äº<code>django_profile/my_middleware.py</code>ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> cProfile<br><span class="hljs-keyword">import</span> pstats<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings<br><span class="hljs-keyword">from</span> django.core.exceptions <span class="hljs-keyword">import</span> MiddlewareNotUsed<br><span class="hljs-keyword">from</span> django.http.response <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileMiddleware</span>(<span class="hljs-title class_ inherited__">object</span>):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, get_response</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.DEBUG:<br>            <span class="hljs-keyword">raise</span> MiddlewareNotUsed  <span class="hljs-comment"># åªåœ¨DEBUGæ¨¡å¼ä¸‹å¯ç”¨è¯¥ä¸­é—´ä»¶</span><br><br>        self.get_response = get_response<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, request</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;profile&#x27;</span> <span class="hljs-keyword">in</span> request.GET:  <span class="hljs-comment"># å½“è¯·æ±‚URLä¸­å­˜åœ¨profileå‚æ•°æ—¶è¿›è¡Œæ€§èƒ½åˆ†æ</span><br>            profile = cProfile.Profile()<br>            profile.enable()<br>            self.get_response(request)<br>            profile.disable()<br>            ram_file = StringIO()<br>            sort_by = <span class="hljs-string">&#x27;tottime&#x27;</span><br>            stats = pstats.Stats(profile, stream=ram_file)<br>            stats.strip_dirs().sort_stats(sort_by).print_stats()<br>            response = HttpResponse(ram_file.getvalue().encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), <span class="hljs-string">&#x27;text/plain&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            response = self.get_response(request)<br><br>        <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure></li><li><p>åœ¨Djangoé…ç½®æ–‡ä»¶ä¸­å¯ç”¨è¯¥ä¸­é—´ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">MIDDLEWARE = [<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-string">&#x27;django_profile.my_middleware.ProfileMiddleware&#x27;</span>,<br>    <span class="hljs-comment"># ...</span><br>]<br></code></pre></td></tr></table></figure></li></ol><p>è¯¥ä¸­é—´ä»¶å¤§æ¦‚çš„æ€è·¯ä¸ºï¼šåœ¨DjangoçœŸæ­£è°ƒç”¨è§†å›¾å‡½æ•°ï¼ˆ23è¡Œï¼Œ<code>self.get_response(request)</code>ï¼‰æ—¶ï¼Œä½¿ç”¨<code>cProfile</code>å¯¹è¯¥è§†å›¾å‡½æ•°è¿›è¡Œæ€§èƒ½åˆ†æï¼Œå¹¶ç”¨åˆ†æç»“æœæ‰“åŒ…æˆçš„<code>HttpResponse</code>å–ä»£è§†å›¾å‡½æ•°çš„<code>Response</code>è¿”å›ç»™Djangoï¼ˆæˆ–è€…è¯´ç”¨æˆ·ï¼‰ã€‚å½“ç„¶ï¼Œç”±äºæˆ‘åŠ äº†ä¸€ç³»åˆ—çš„é™åˆ¶ï¼Œè¯¥æµç¨‹åªä¼šåœ¨DEBUGæ¨¡å¼ä¸‹ã€ä¸”URLä¸­åŒ…å«<code>profile</code>å‚æ•°æ—¶æ‰ä¼šå¯ç”¨ã€‚<br>æ­¤æ—¶åœ¨ä»»ä½•ä¸€ä¸ªé¡µé¢URLï¼ˆ<code>HTTP Parameters</code>ï¼‰ä¸­å¢åŠ <code>profile</code>å‚æ•°æ—¶ï¼Œå³å¯çœ‹åˆ°å¯¹åº”æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/2019-03-11.03.png"></p><p>è¿™é‡Œä»‹ç»çš„åªæ˜¯<code>cPorfile</code>ä¸­é—´ä»¶çš„ä¸€ä¸ªç®€å•ç”¨ä¾‹ã€‚å®é™…ä¸Š<code>cProfile</code>ä¸Djangoä¸­é—´ä»¶å‡å…·æœ‰æ¯”è¾ƒå¼ºçš„å¯å®šåˆ¶æ€§ï¼Œ<a href="https://github.com/safarijv/yet-another-django-profiler">yet-another-django-profiler</a>å°±æ˜¯ä¸€ä¸ªæ€è·¯ç±»ä¼¼ä½†æ›´åŠ å¤æ‚å’Œå®Œå–„çš„é¡¹ç›®ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œäº†è§£ã€‚å¦å¤–ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œ<code>cProfile</code>å¯ä»¥å’Œä»»æ„ä¸€ä¸ªæœ‰ç±»ä¼¼Djangoä¸­é—´ä»¶æ¨¡å¼çš„Python Webæ¡†æ¶æ­é…æ¥è¾¾æˆç±»ä¼¼çš„æ•ˆæœï¼Œè¿™é‡Œå°±ä¸æ‰©å±•æ¥è¯´äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Webå¼€å‘</tag>
      
      <tag>Python</tag>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
      <tag>Django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pythonä»£ç æ€§èƒ½åˆ†æï¼ˆåç¯‡ï¼‰</title>
    <link href="/2019/03/08/Python%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E5%90%8E%E7%AF%87%EF%BC%89/"/>
    <url>/2019/03/08/Python%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E5%90%8E%E7%AF%87%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†æµ‹é‡æ‰§è¡ŒPythonä»£ç æ‰€éœ€è¦çš„æ€»ä½“æ—¶é—´çš„å‡ ç§æ–¹æ³•ã€‚è€Œåœ¨å®é™…çš„æ€§èƒ½åˆ†æåœºæ™¯ä¸­ï¼Œç›®æ ‡ä»£ç çš„é€»è¾‘å¾€å¾€æ¯”è¾ƒå¤æ‚ï¼Œå…‰é æ€»ä½“æ‰§è¡Œè€—æ—¶å¹¶ä¸èƒ½å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦è¯·å‡ºPythonçš„æ ‡å‡†åº“ï¼š<code>cProfile</code>ï¼ˆ<a href="https://docs.python.org/3.6/library/profile.html">å®˜æ–¹æ–‡æ¡£</a>ï¼‰æ¥å¯¹ä»£ç è¿›è¡Œç»†è‡´çš„æ€§èƒ½åˆ†æäº†ã€‚<br>å’Œå‰ä¸€ç¯‡æ–‡ç« ä¸€æ ·ï¼Œæœ¬æ–‡æ‰€ä½¿ç”¨çš„æµ‹è¯•å¹³å°ä¸º<code>Ubuntu 18.04</code>+<code>Python 3.6</code>ï¼Œå¹¶ä½¿ç”¨ä»£ç æ–‡ä»¶<code>slow_func.py</code>ä½œä¸ºæ ·ä¾‹è¿›è¡Œæ€§èƒ½åˆ†æï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>():<br>    time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># ç­‰å¾…ä¸€ç§’</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func2</span>():<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span> ** <span class="hljs-number">24</span>):<br>        random.random()  <span class="hljs-comment"># ç”Ÿæˆ1600ä¸‡ä¸ªéšæœºæ•°</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    func1()<br>    func2()<br></code></pre></td></tr></table></figure><h1 id="å‘½ä»¤è¡Œä½¿ç”¨cProfile"><a href="#å‘½ä»¤è¡Œä½¿ç”¨cProfile" class="headerlink" title="å‘½ä»¤è¡Œä½¿ç”¨cProfile"></a>å‘½ä»¤è¡Œä½¿ç”¨cProfile</h1><p>å¯¹äºå•ç‹¬çš„Pythonä»£ç æ–‡ä»¶æ¥è¯´ï¼Œé€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨cProfileæ— ç–‘æ˜¯æœ€æ–¹ä¾¿çš„é€‰æ‹©ã€‚<br>æ‰§è¡Œå¦‚ä¸‹shellå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python3 -m cProfile -s tottime slow_func.py<br></code></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆç”¨<code>python3</code>çš„<code>-m</code>é€‰é¡¹è°ƒç”¨<code>cProfile</code>æ¨¡å—ï¼Œç„¶åç”¨<code>cProfile</code>çš„<code>-s</code>é€‰é¡¹è®©è¾“å‡ºç»“æœæŒ‰<code>tottime</code>è¿›è¡Œæ’åºï¼Œæœ€åæ‰§è¡Œ<code>slow_func.py</code>æ–‡ä»¶ã€‚<br>å®Œæ•´è°ƒç”¨æ ¼å¼ä¸ºï¼š<code>python -m cProfile [-o output_file] [-s sort_order] myscript.py</code></p></blockquote><p>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">        16778563 function calls (16778520 primitive calls) in 3.176 seconds<br><br>  Ordered by: internal time<br><br>  ncalls  tottime  percall  cumtime  percall filename:lineno(function)<br>       1    1.456    1.456    2.172    2.172 slow_func.py:8(func2)<br>       1    1.001    1.001    1.001    1.001 &#123;built-in method time.sleep&#125;<br>16777216    0.716    0.000    0.716    0.000 &#123;method &#x27;random&#x27; of &#x27;_random.Random&#x27; objects&#125;<br>       1    0.001    0.001    0.001    0.001 &#123;built-in method _imp.create_dynamic&#125;<br>       3    0.000    0.000    0.000    0.000 &#123;built-in method marshal.loads&#125;<br>       # ...çœç•¥åç»­100å¤šè¡Œ<br></code></pre></td></tr></table></figure><ul><li>è¾“å‡ºçš„ç¬¬1è¡Œè¡¨æ˜ï¼Œè„šæœ¬æ–‡ä»¶æ‰§è¡Œä¸­å­˜åœ¨1600å¤šä¸‡æ¬¡çš„å‡½æ•°è°ƒç”¨ï¼Œå…±è€—è´¹3.268ç§’ã€‚<ul><li>è€Œæ ¹æ®å‰ä¸€ç¯‡æ–‡ç« çš„æµ‹è¯•ç»“æœï¼Œç›´æ¥æ‰§è¡Œè¯¥è„šæœ¬æ–‡ä»¶åªéœ€è¦2ç§’å·¦å³çš„æ—¶é—´ï¼Œé‚£å¤šå‡ºæ¥çš„1ç§’å¤šèŠ±åœ¨äº†å“ªé‡Œï¼Ÿè¿™æ˜¯å› ä¸º<code>cProfile</code>éœ€è¦å¯¹æ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨è¿›è¡Œç›‘æ§å’Œè®°å½•ï¼Œç”±äºè¯¥æ–‡ä»¶å­˜åœ¨è¾ƒå¤šçš„å‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥æ€»æ‰§è¡Œè€—æ—¶ä¹Ÿå°±å¢é•¿äº†è®¸å¤šäº†ã€‚</li></ul></li><li>ç¬¬3è¡Œè¡¨æ˜ï¼Œä¸‹è¡¨å†…å®¹æŒ‰ç…§<code>internal time</code>ï¼ˆå†…éƒ¨æ‰§è¡Œæ—¶é—´ï¼Œ<code>tottime</code>ï¼‰æ’åºï¼Œè¿™æ˜¯ç”±æ‰§è¡Œå‘½ä»¤ä¸­çš„<code>-s tottime</code>å‚æ•°å†³å®šçš„ã€‚</li><li>ç¬¬5è¡Œä¸ºåˆ†æç»“æœè¡¨çš„è¡¨å¤´ï¼Œä¾æ¬¡ä¸º<code>ncalls</code>ï¼šè°ƒç”¨æ¬¡æ•°ã€<code>tottime</code>ï¼šå†…éƒ¨æ‰§è¡Œè€—æ—¶ã€<code>percall</code>ï¼šå†…éƒ¨æ‰§è¡Œè€—æ—¶&#x2F;è°ƒç”¨æ¬¡æ•°ã€<code>cumtime</code>ï¼šç´¯è®¡æ‰§è¡Œè€—æ—¶ã€<code>percall</code>ï¼šç´¯è®¡æ‰§è¡Œè€—æ—¶&#x2F;è°ƒç”¨æ¬¡æ•°ï¼Œä»¥åŠæœ€åçš„<code>æ–‡ä»¶å+è¡Œå·+å‡½æ•°åç§°</code>ã€‚<ul><li><code>tottime</code>å’Œ<code>cumtime</code>çš„åŒºåˆ«åœ¨äºï¼Œ<code>tottime</code>ä¸åŒ…æ‹¬å­å‡½æ•°æ‰§è¡Œæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œè€Œ<code>cumtime</code>æ˜¯åŒ…æ‹¬çš„ã€‚</li></ul></li><li>ç¬¬6è¡Œè¡¨æ˜ï¼Œ<code>slow_func.py</code>ä¸­ç¬¬8è¡Œçš„<code>func2</code>å‡½æ•°å…±æ‰§è¡Œäº†1æ¬¡ï¼Œå†…éƒ¨è€—æ—¶1.456ç§’ï¼Œç´¯è®¡è€—æ—¶2.172ç§’ã€‚</li><li>ç¬¬7è¡Œè¡¨æ˜ï¼ŒPythonå†…ç½®çš„<code>sleep</code>å‡½æ•°å…±æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè€—æ—¶1.001ç§’ã€‚</li><li>ç¬¬8è¡Œè¡¨æ˜ï¼ŒPythonå†…ç½®çš„<code>random</code>å‡½æ•°å…±æ‰§è¡Œäº†1600å¤šä¸‡æ¬¡ï¼Œè€—æ—¶0.716ç§’ã€‚<ul><li>ç”±äº<code>random</code>å‡½æ•°æ˜¯è¢«<code>func2</code>å‡½æ•°è°ƒç”¨çš„ï¼Œæ‰€ä»¥è¿™0.716ç§’å’Œ<code>func2</code>å‡½æ•°çš„å†…éƒ¨æ‰§è¡Œè€—æ—¶1.456ç§’ï¼Œå…±åŒç»„æˆäº†<code>func2</code>å‡½æ•°çš„ç´¯è®¡æ‰§è¡Œè€—æ—¶ï¼š2.172ç§’ã€‚</li></ul></li><li>ç”±äºæ˜¯ç”¨<code>cProfile</code>åˆ†ææ•´ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œæ‰€ä»¥è®¸å¤šPythonè‡ªèº«æ‰€éœ€çš„å‡½æ•°è°ƒç”¨ä¹Ÿè¢«å±•ç¤ºåœ¨äº†ç»“æœé‡Œï¼Œæ‰€ä»¥åˆ†æç»“æœè¡¨æ‰ä¼šæœ‰100å¤šè¡Œçš„è§„æ¨¡ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥åœ¨ä¸‹ä¸€å°èŠ‚ä¸­è§£å†³ã€‚</li></ul><h1 id="ä»£ç é‡Œä½¿ç”¨cProfile"><a href="#ä»£ç é‡Œä½¿ç”¨cProfile" class="headerlink" title="ä»£ç é‡Œä½¿ç”¨cProfile"></a>ä»£ç é‡Œä½¿ç”¨cProfile</h1><p>ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œé€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨<code>cProfile</code>ç›¸å½“äºåœ¨ä»£ç é‡Œä½¿ç”¨<code>cProfile</code>çš„ä¸€ä¸ªç®€åŒ–æ“ä½œã€‚è€Œåœ¨å‘½ä»¤è¡Œé‡Œåˆ†æä»£ç æœ‰ç€æ˜æ˜¾çš„å±€é™æ€§ï¼šç›®æ ‡ä»£ç å¿…é¡»ç‹¬ç«‹æˆæ–‡ä»¶ã€è¾“å‡ºæ ¼å¼å›ºå®šç­‰ç­‰ã€‚æ‰€ä»¥ï¼Œåœ¨ä»£ç é‡Œä½¿ç”¨<code>cProfile</code>å¾€å¾€æ˜¯ä¸€ä¸ªæ›´ä¼˜çš„é€‰æ‹©ã€‚<br>æ‰§è¡Œå¦‚ä¸‹Pythonä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cProfile<br><span class="hljs-keyword">import</span> pstats<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><span class="hljs-keyword">from</span> slow_func <span class="hljs-keyword">import</span> func1, func2<br><br>profile = cProfile.Profile()<br>profile.enable()  <span class="hljs-comment"># åˆ†æå¼€å§‹</span><br>func1()<br>func2()<br>profile.disable()  <span class="hljs-comment"># åˆ†æç»“æŸ</span><br>ram_file = StringIO()<br>sort_by = <span class="hljs-string">&#x27;tottime&#x27;</span><br>stats = pstats.Stats(profile, stream=ram_file)  <span class="hljs-comment"># è¯»å–ç»“æœ</span><br>stats.strip_dirs().sort_stats(sort_by).print_stats()  <span class="hljs-comment"># æŒ‰æ ¼å¼è¾“å‡ºè‡³ram_file</span><br><br><span class="hljs-built_in">print</span>(ram_file.getvalue())<br></code></pre></td></tr></table></figure><blockquote><p>ä»£ç çš„æ ¸å¿ƒé€»è¾‘æ˜¯ä½¿ç”¨<code>cProfile</code>æ¨¡å—çš„<code>Profile</code>ç±»å¯¹ä»£ç å—è¿›è¡Œæ€§èƒ½åˆ†æï¼Œåˆ†æå®Œæˆåä½¿ç”¨<code>pstats</code>æ¨¡å—çš„<code>Stats</code>ç±»å°†åˆ†æç»“æœæŒ‰ä¸€å®šæ ¼å¼å†™å…¥è‡³å†…å­˜æ–‡ä»¶ï¼Œæœ€åè¾“å‡ºè¯¥æ–‡ä»¶é‡Œå†™å…¥çš„å†…å®¹ã€‚<br>å®é™…ä¸Šè¿™åªæ˜¯ä¸€ä¸ªè¾ƒä¸ºç®€å•çš„æ ·ä¾‹ï¼Œ<code>pstats</code>æ¨¡å—è¿˜å¯ä»¥è·å¾—å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€å°†ç»“æœæŒä¹…åŒ–ã€æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„ç­‰ç­‰ï¼Œæ›´å®Œæ•´çš„è¯´æ˜å¯ä»¥å‚è€ƒ<a href="https://docs.python.org/3.6/library/profile.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p></blockquote><p>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">        16777220 function calls in 3.225 seconds<br><br>  Ordered by: internal time<br><br>  ncalls  tottime  percall  cumtime  percall filename:lineno(function)<br>       1    1.517    1.517    2.224    2.224 slow_func.py:8(func2)<br>       1    1.001    1.001    1.001    1.001 &#123;built-in method time.sleep&#125;<br>16777216    0.707    0.000    0.707    0.000 &#123;method &#x27;random&#x27; of &#x27;_random.Random&#x27; objects&#125;<br>       1    0.000    0.000    1.001    1.001 slow_func.py:5(func1)<br>       1    0.000    0.000    0.000    0.000 &#123;method &#x27;disable&#x27; of &#x27;_lsprof.Profiler&#x27; objects&#125;<br></code></pre></td></tr></table></figure><h1 id="cProfileç»“æœå¯è§†åŒ–"><a href="#cProfileç»“æœå¯è§†åŒ–" class="headerlink" title="cProfileç»“æœå¯è§†åŒ–"></a>cProfileç»“æœå¯è§†åŒ–</h1><p>ä¸€èˆ¬æ¥è¯´ï¼Œé€šè¿‡ä»¥ä¸Šä¸¤ä¸ªä¾‹å­å°±å¯ä»¥è·å¾—å®Œå–„çš„æ€§èƒ½åˆ†ææŠ¥å‘Šäº†ã€‚ä½†é€šè¿‡ä¸€äº›å¯è§†åŒ–å·¥å…·å¯¹<code>cProfile</code> çš„æŠ¥å‘Šè¿›è¡ŒäºŒæ¬¡å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ¸…æ™°åœ°è§‚å¯Ÿå‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€æ›´è½»æ¾åœ°æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆï¼Œç®—æ˜¯ä¸€ä¸ªä¸é”™çš„è¾…åŠ©æ‰‹æ®µã€‚åœ¨è¿™é‡Œåªä»‹ç»ä¸€ç§å¯è§†åŒ–å·¥å…·ï¼šJetBrain PyCharmè‡ªå¸¦çš„<code>Profile</code>å·¥å…·ã€‚</p><ul><li><p>ç‚¹å‡»Pycharmä¸­<code>Run</code>èœå•é‡Œçš„<code>Profile &#39;xxx&#39;é¡¹ç›®</code>ï¼Œå³å¯å¯¹å½“å‰è¿è¡Œæ‰§è¡Œæ–¹æ¡ˆä½¿ç”¨<code>cProfile</code>è¿›è¡Œæ€§èƒ½åˆ†æï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/images/2019-03-08.01.png"></p></li><li><p>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å…¶ä¸­ï¼Œ<code>Time</code>å¯¹åº”<code>cProfile</code>ä¸­çš„<code>cumtime</code>ï¼Œå³ç´¯è®¡æ‰§è¡Œè€—æ—¶ï¼›<code>Own Time</code>å¯¹åº”<code>cProfile</code>ä¸­çš„<code>tottime</code>ï¼Œå³å†…éƒ¨æ‰§è¡Œè€—æ—¶ã€‚<br><img src="/images/2019-03-08.02.png"></p><p><img src="/images/2019-03-08.03.png"></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pythonä»£ç æ€§èƒ½åˆ†æï¼ˆå‰ç¯‡ï¼‰</title>
    <link href="/2019/03/06/Python%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E5%89%8D%E7%AF%87%EF%BC%89/"/>
    <url>/2019/03/06/Python%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%88%E5%89%8D%E7%AF%87%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘ä»¬æ€æ ·çŸ¥é“æ‰§è¡ŒæŸä¸ªPythonæ–‡ä»¶ã€æŸä¸ªå‡½æ•°ã€æŸæ®µä»£ç æ‰€è€—è´¹çš„æ€»ä½“æ—¶é—´ï¼Ÿè¿™æ˜¯è¿™ç¯‡æ–‡ç« å°è¯•å»å›ç­”çš„é—®é¢˜ã€‚<br>ä½œä¸ºæ ·ä¾‹ï¼Œæœ¬æ–‡ä½¿ç”¨<code>slow_func.py</code>æ¥è¿›è¡Œæ€§èƒ½åˆ†æï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func1</span>():<br>    time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># ç­‰å¾…ä¸€ç§’</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">func2</span>():<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span> ** <span class="hljs-number">24</span>):<br>        random.random()  <span class="hljs-comment"># ç”Ÿæˆ1600ä¸‡ä¸ªéšæœºæ•°</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    func1()<br>    func2()<br></code></pre></td></tr></table></figure><p>å‡½æ•°<code>func1</code>å’Œ<code>func2</code>çš„åŒºåˆ«åœ¨äºï¼šCPUåœ¨æ‰§è¡Œ<code>func1</code>æ—¶åŸºæœ¬å¤„åœ¨é—²ç½®çŠ¶æ€ï¼Œåœ¨æ‰§è¡Œ<code>func2()</code>æ—¶åŸºæœ¬å¤„äºå¿™ç¢ŒçŠ¶æ€ã€‚è¿™ç‚¹ä¼šåœ¨ä¹‹åçš„æµ‹è¯•ä¸­æœ‰æ‰€ä½“ç°ã€‚<br>åœ¨ç¬”è€…çš„æµ‹è¯•å¹³å°ï¼ˆ<code>Ubuntu 18.04</code>+<code>Python 3.6</code>ï¼‰ä¸Šï¼Œä¸¤ä¸ªå‡½æ•°æ‰€è€—è´¹çš„æ—¶é—´å‡åœ¨<code>1s</code>å·¦å³ã€‚</p><h1 id="timeå‘½ä»¤"><a href="#timeå‘½ä»¤" class="headerlink" title="timeå‘½ä»¤"></a>timeå‘½ä»¤</h1><p>ç±»UNIXå¹³å°æä¾›äº†<code>time</code>å‘½ä»¤ä»¥ç»Ÿè®¡æ‰§è¡Œæ‰§è¡Œå‘½ä»¤æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé€šç”¨å‹çš„å·¥å…·ï¼Œè€Œä¸å±€é™äºPythonã€‚<br>æ‰§è¡Œå¦‚ä¸‹shellå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">time python3 slow_func.py<br></code></pre></td></tr></table></figure><p>è·å¾—å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">real0m1.960s  # å‘½ä»¤æ‰§è¡Œæ—¶é—´<br>user0m0.946s  # ç”¨æˆ·æ€CPUæ—¶é—´<br>sys 0m0.008s<br></code></pre></td></tr></table></figure><p>æ ¹æ®å‰ä¸¤è¡Œç»“æœä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œ<code>slow_func.py</code>ä»å¼€å§‹åˆ°ç»“æŸå…±æ¶ˆè€—äº†2ç§’å·¦å³çš„æ—¶é—´ï¼Œä½†å®é™…æ¶ˆè€—çš„ç”¨æˆ·æ€CPUæ—¶é—´åªæœ‰1ç§’å·¦å³ã€‚è¿™æ˜¯å› ä¸ºCPUåœ¨æ‰§è¡Œ<code>func1()</code>æ—¶å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆ<code>sleep</code>ï¼‰ï¼Œè¿™æ®µæ—¶é—´é‡Œæ˜¯ä¸æ¶ˆè€—CPUæ—¶é—´çš„ã€‚</p><h1 id="timeåº“"><a href="#timeåº“" class="headerlink" title="timeåº“"></a>timeåº“</h1><p>Pythonæä¾›äº†æ ‡å‡†åº“<code>time</code>æ¥è¿›è¡Œå…³äºæ—¶é—´çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåº“æ¥æµ‹é‡ä»£ç æ‰§è¡Œæ‰€è€—è´¹çš„æ—¶é—´ã€‚<br>æ‰§è¡Œå¦‚ä¸‹Pythonä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> slow_func <span class="hljs-keyword">import</span> func1, func2<br><br>start1, start2 = time.perf_counter(), time.process_time()<br>func1()<br>func2()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;perf_counter: &#123;:.4f&#125;s&#x27;</span>.<span class="hljs-built_in">format</span>(time.perf_counter() - start1))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;process_time: &#123;:.4f&#125;s&#x27;</span>.<span class="hljs-built_in">format</span>(time.process_time() - start2))<br></code></pre></td></tr></table></figure><p>è·å¾—å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">perf_counter: 2.1201s<br>process_time: 1.1119s<br></code></pre></td></tr></table></figure><p><code>time.perf_counter()</code>çš„æ—¶é—´å·®æ˜¯ä»£ç å¼€å§‹ä¸ä»£ç ç»“æŸä¸¤ä¸ªæ—¶é—´ç‚¹çš„æ—¶é—´å·®ï¼Œè€Œ<code>time.process_time()</code>çš„æ—¶é—´å·®æ˜¯æ¶ˆè€—çš„CPUæ—¶é—´é•¿åº¦ï¼Œæ‰€ä»¥å¾—å‡ºäº†ä¸åŒçš„ç»“æœï¼Œè¿™ä¸å…ˆå‰çš„<code>time</code>å‘½ä»¤çš„åŸå› å’Œç»“æœç›¸ç±»ä¼¼ã€‚</p><h1 id="timeåº“-ä¸Šä¸‹æ–‡ç®¡ç†å™¨"><a href="#timeåº“-ä¸Šä¸‹æ–‡ç®¡ç†å™¨" class="headerlink" title="timeåº“+ä¸Šä¸‹æ–‡ç®¡ç†å™¨"></a>timeåº“+ä¸Šä¸‹æ–‡ç®¡ç†å™¨</h1><p>ä¸Šé¢æåˆ°çš„ç”¨timeåº“æ¥æµ‹é‡ä»£ç è€—æ—¶ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†å¦‚æœç»å¸¸è¦ç”¨åˆ°çš„è¯å†™èµ·æ¥ä¹Ÿå¾ˆç¹çã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥é¿å…é‡å¤ä»£ç ã€‚<br>æ‰§è¡Œå¦‚ä¸‹Pythonä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager<br><br><span class="hljs-meta">@contextmanager</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">time_block</span>(<span class="hljs-params">label</span>):  <span class="hljs-comment"># ä»£ç å—è®¡æ—¶ä¸Šä¸‹æ–‡ç®¡ç†å™¨</span><br>    <span class="hljs-comment"># è¿›å…¥ä¸Šä¸‹æ–‡</span><br>    start = time.perf_counter()<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">yield</span>  <span class="hljs-comment"># æ‰§è¡Œä»£ç å—</span><br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-comment"># æ‰§è¡Œå®Œæˆåè¾“å‡ºä»£ç å—è€—æ—¶</span><br>        used = time.perf_counter() - start<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#123;&#125;: &#123;:.4f&#125;s&#x27;</span>.<span class="hljs-built_in">format</span>(label, used))<br><br><span class="hljs-comment"># ç”¨æ³•</span><br><span class="hljs-keyword">with</span> time_block(<span class="hljs-string">&#x27;sleep&#x27;</span>):<br>    time.sleep(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è·å¾—å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sleep: 1.0011s<br></code></pre></td></tr></table></figure><h1 id="timeåº“-å‡½æ•°è£…é¥°å™¨"><a href="#timeåº“-å‡½æ•°è£…é¥°å™¨" class="headerlink" title="timeåº“+å‡½æ•°è£…é¥°å™¨"></a>timeåº“+å‡½æ•°è£…é¥°å™¨</h1><p>ä¸Šä¸‹æ–‡ç®¡ç†å™¨é’ˆå¯¹çš„æ˜¯ä»£ç å—ï¼Œå¦‚æœåªæƒ³ç»Ÿè®¡å‡½æ•°æ‰§è¡Œæ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œç”¨å‡½æ•°è£…é¥°å™¨æ›´ä¸ºæ–¹ä¾¿å’Œå¿«æ·ã€‚<br>æ‰§è¡Œå¦‚ä¸‹Pythonä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">time_wrap</span>(<span class="hljs-params">func</span>):  <span class="hljs-comment"># å‡½æ•°è®¡æ—¶è£…é¥°å™¨</span><br><span class="hljs-meta">    @wraps(<span class="hljs-params">func</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        start = time.perf_counter()<br>        r = func(*args, **kwargs)<br>        used = time.perf_counter() - start<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#123;f.__module__&#125;.&#123;f.__name__&#125;: &#123;t:.4f&#125;s&#x27;</span>.<span class="hljs-built_in">format</span>(f=func, t=used))<br>        <span class="hljs-keyword">return</span> r<br><br>    <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-meta">@time_wrap  </span><span class="hljs-comment"># å‡½æ•°å®šä¹‰æ—¶ä½¿ç”¨è£…é¥°å™¨</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_func</span>():<br>    time.sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># æ‰§è¡Œå‡½æ•°æ—¶è‡ªåŠ¨è°ƒç”¨è£…é¥°å™¨</span><br>slow_func()<br></code></pre></td></tr></table></figure><p>è·å¾—å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">__main__.slow_func: 1.0008s<br></code></pre></td></tr></table></figure><h1 id="timeitåº“"><a href="#timeitåº“" class="headerlink" title="timeitåº“"></a>timeitåº“</h1><p>å½“éœ€è¦å¤šæ¬¡é‡å¤æµ‹é‡Pythonä»£æ—¶ä»¥è·å–ç²¾ç¡®çš„è€—æ—¶ç»“æœæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¾ªç¯æ§åˆ¶é…åˆä¸Šæ–‡æåˆ°çš„æ–¹æ³•æ¥å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªæ›´ä¾¿æ·çš„ã€é€‚åˆé‡å¤æµ‹è¯•çš„æ ‡å‡†åº“ï¼š<code>timeit</code>æ¥å®ç°ã€‚<br>æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> timeit<br><br>setup = <span class="hljs-string">&#x27;from slow_func import func1&#x27;</span><br><br>used = timeit.timeit(<span class="hljs-string">&#x27;func1()&#x27;</span>, setup=setup, number=<span class="hljs-number">5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#123;:.4f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(used))<br></code></pre></td></tr></table></figure><p>è·å¾—å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">5.0039<br></code></pre></td></tr></table></figure><p><code>timeit</code>åº“é»˜è®¤ä½¿ç”¨çš„è®¡æ—¶å™¨ä¸º<code>time.perf_counter()</code>ï¼Œå¦‚æœæƒ³æ¢æˆæµ‹é‡CPUè€—æ—¶çš„è®¡æ—¶å™¨ï¼Œåªéœ€è¦é™„åŠ ä¸Š<code>timer</code>å‚æ•°å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">...<br><span class="hljs-keyword">import</span> time<br>timer = time.process_time<br><br>used = timeit.timeit(<span class="hljs-string">&#x27;func1()&#x27;</span>, timer=timer, setup=setup, number=<span class="hljs-number">5</span>)  <span class="hljs-comment"># é™„åŠ timerå‚æ•°</span><br>...<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx&amp;uWSGIé™æ€æ–‡ä»¶æ€§èƒ½å¯¹æ¯”</title>
    <link href="/2019/02/20/Nginx-uWSGI%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/"/>
    <url>/2019/02/20/Nginx-uWSGI%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="/images/2019-02-20.01.png"><br>åœ¨å®é™…éƒ¨ç½²Python Webåº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡‡ç”¨ç±»ä¼¼<code>Nginx-&gt;uWSGI/Gunicorn-&gt;Python</code>çš„ä¸‰å±‚æ¶æ„ã€‚ä½¿ç”¨Nginxè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨uWSGIæ¥å¤„ç†HTTPè¯·æ±‚çš„ç†ç”±ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>Nginxæ›´å®‰å…¨ï¼›</li><li>éœ€è¦å®ç°è´Ÿè½½å‡è¡¡&#x2F;URLè½¬å‘ï¼›</li><li>Nginxå¤„ç†é™æ€æ–‡ä»¶æ›´å¿«ï¼Œç¼“å­˜å¤´æ›´å®Œå–„ã€‚</li></ul><p>ä½†åœ¨æŸäº›è¯¸å¦‚ç®€å•Webåº”ç”¨ã€å¤–éƒ¨ç»Ÿä¸€ç½‘å…³ã€å•æœºå•å®¹å™¨ã€å†…ç½‘ç¯å¢ƒç­‰éƒ¨ç½²åœºæ™¯ï¼ŒNginxçš„ä¼˜åŠ¿å¹¶ä¸ä¸€å®šé‚£ä¹ˆæ˜æ˜¾ã€‚æœ¬æ–‡ç€é‡åˆ†æNginxã€uWSGIçš„é™æ€æ–‡ä»¶æ€§èƒ½é—®é¢˜ï¼Œè¾…åŠ©åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨Nginxã€‚</p><h1 id="æ€§èƒ½æµ‹è¯•æµç¨‹"><a href="#æ€§èƒ½æµ‹è¯•æµç¨‹" class="headerlink" title="æ€§èƒ½æµ‹è¯•æµç¨‹"></a>æ€§èƒ½æµ‹è¯•æµç¨‹</h1><ol><li>åˆ›å»ºæµ‹è¯•æ–‡ä»¶<br>  ç”Ÿæˆå¤§å°ä¸º4k~512kçš„éšæœºå­—ç¬¦ä¸²æ–‡ä»¶ä½œä¸ºæµ‹è¯•æ ·æœ¬</li></ol>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl rand -hex $(bc &lt;&lt;&lt; 2^11-1) &gt; 4k.hex<br>openssl rand -hex $(bc &lt;&lt;&lt; 2^12-1) &gt; 8k.hex<br>...<br>openssl rand -hex $(bc &lt;&lt;&lt; 2^18-1) &gt; 512k.hex<br></code></pre></td></tr></table></figure><ol start="2"><li><p>å¯åŠ¨æµ‹è¯•å®¹å™¨</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -v $(pwd):/static --name pytest python:3.6-jessie tail -f /dev/null<br>docker exec -it pytest bash<br></code></pre></td></tr></table></figure></li><li><p>é…ç½®å¹¶å¯åŠ¨Nginxå’ŒuWSGI</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt update &amp;&amp; apt install -y nginx apache2-utils<br>pip install uwsgi<br><br>cat &gt;/etc/nginx/conf.d/default.conf&lt;&lt;EOF<br>server &#123;<br>    listen 81 default_server;<br><br>    location / &#123;<br>        root /static;<br>    &#125;<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯åŠ¨nginxå’ŒuWSGI</span><br>service nginx start<br>uwsgi --master --http 0.0.0.0:82 --static-map /=/static<br></code></pre></td></tr></table></figure></li><li><p>å¼€å§‹æµ‹è¯•<br>  ä½¿ç”¨<code>Apache Benchmark</code>å¯¹Nginxå’ŒuWSGIçš„é™æ€æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œå¹¶å‘æ•°ä¸º100ï¼Œå…±è¯·æ±‚20000æ¬¡ã€‚æå–æµ‹è¯•ç»“æœä¸­çš„å…³é”®å‚æ•°ï¼š<code>Requests per second</code>ã€‚</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /static<br>for fn in *.hex; do<br>  echo -e &quot;\n$fn&quot;<br>  echo &quot;nginx (keep alive)&quot;<br>  ab -q -k -c 100 -n 20000 127.0.0.1:81/$fn | grep -Po &#x27;Requests per second:[ \d]+&#x27;<br>  echo &quot;nginx&quot;<br>  ab -q -c 100 -n 20000 127.0.0.1:81/$fn | grep -Po &#x27;Requests per second:[ \d]+&#x27;<br>  echo &quot;uwsgi&quot;<br>  ab -q -c 100 -n 20000 127.0.0.1:82/$fn | grep -Po &#x27;Requests per second:[ \d]+&#x27;<br>done<br></code></pre></td></tr></table></figure></li></ol><h1 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h1><p><img src="/images/2019-02-20.02.png"></p><p>å…¶ä¸­<code>nginx (keep-alive)</code>é¡¹ä¸ºç†è®ºæœ€å¥½æƒ…å†µï¼Œå®é™…åº”ç”¨ä¸­å¾ˆéš¾è¾¾åˆ°ã€‚uWSGIåœ¨å¤„ç†é™æ€æ–‡ä»¶æ—¶ä¸æ”¯æŒ<code>keep-alive</code>æ¨¡å¼ã€‚</p><p>å‡è®¾å°†æœªä½¿ç”¨<code>keep-alive</code>çš„Nginxæ€§èƒ½ä½œä¸ºåŸºå‡†ï¼Œå¯å¾—å‡ºä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">æ–‡ä»¶å¤§å°</th><th align="center">nginx(keep-alive)</th><th align="center">nginx</th><th align="center">uwsgi</th></tr></thead><tbody><tr><td align="center">4k</td><td align="center">157%</td><td align="center">100%</td><td align="center">43%</td></tr><tr><td align="center">8k</td><td align="center">204%</td><td align="center">100%</td><td align="center">42%</td></tr><tr><td align="center">16k</td><td align="center">202%</td><td align="center">100%</td><td align="center">34%</td></tr><tr><td align="center">32k</td><td align="center">207%</td><td align="center">100%</td><td align="center">26%</td></tr><tr><td align="center">64k</td><td align="center">173%</td><td align="center">100%</td><td align="center">20%</td></tr><tr><td align="center">128k</td><td align="center">160%</td><td align="center">100%</td><td align="center">14%</td></tr><tr><td align="center">256k</td><td align="center">151%</td><td align="center">100%</td><td align="center">11%</td></tr><tr><td align="center">512k</td><td align="center">125%</td><td align="center">100%</td><td align="center">10%</td></tr></tbody></table><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼ŒuWSGIåœ¨å¤„ç†å°ä½“ç§¯é™æ€æ–‡ä»¶ä¸Šçš„æ•ˆç‡èƒ½è¾¾åˆ°Nginxçš„ä¸‰ã€å››æˆï¼Œä½†å½“é™æ€æ–‡ä»¶ä½“ç§¯å¢åŠ åˆ°64kåŠä»¥ä¸Šæ—¶ï¼Œå…¶æ•ˆç‡å°±è¿œæ¯”ä¸ä¸ŠNginxäº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Nginx</tag>
      
      <tag>uWSGI</tag>
      
      <tag>æ€§èƒ½æµ‹è¯•</tag>
      
      <tag>Webå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
